<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content=" 这里假定你已经安装好了pve，并且有一定的linux和macos基本基础，本文基于最新版pve7.2-11 其次，pve折腾一个流畅好用的黑苹果是一个非常漫长的过程，很多参数和配置，别人的教程都是仅供你参考，尤其是硬件直通，还是很复杂，你要有时间研究折腾 我的pve 是 用ventoy启动的硬盘vhd文件放在exfat分区 所以后面一部分内容可能和ventoy有关，如果你是直接安装在硬盘上的 可以跳过这部分内容\n我的硬盘只有两块 - 第一块硬盘 nvme ssd 512G - 硬盘安装了ventoy - 三个分区\n- 第一分区 是放ventoy的启动文件也可以作为第二efi分区 分区大小800M左右fat32格式 - 第二分区是ventoyefi 32m fat16格式 ， - 第三分区我主要数据分区也是ventoy的保留分区实际大小465G，pve系统的虚拟磁盘文件也放在这里 - 第二硬盘 1T 古董盘 存放一些备份文件\n准备文件 macos的恢复镜像Ventura-recovery.img OSX-KVM 已经支持在linux下直接获取Ventura的恢复镜像了 opencore镜像，基于kvm优化过的OpenCore OpenCore-v19.iso https://github.com/thenickdude/KVM-Opencore/releases/ 可选：集成virtio的winpe，方便改错ocpencore后进pe修复， https://blog.csdn.net/flydream3618/article/details/47357895 可选：win10安装盘iso 以及Windows的virtio-win.iso 驱动 https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/ 可选：显卡直通需要的vbois文件 我的是uhd630 你如果是同款核显可以直接用 https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm vbios_gvt_uefi.rom 都放到 机械盘的 iso目录里面\npve的准备工作 pve 删除 local-lvm（非必须，但是你是新手的话，建议删掉） lvremove pve/data lvextend -l +100%FREE -r pve/root 在数据中心-存储中删除local-lvm分区，并编辑local，在内容一项中勾选所有可选项\n"><title>在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos</title><link rel=canonical href=https://dev.leiyanhui.com/pve/install-macos-ventura/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos"><meta property='og:description' content=" 这里假定你已经安装好了pve，并且有一定的linux和macos基本基础，本文基于最新版pve7.2-11 其次，pve折腾一个流畅好用的黑苹果是一个非常漫长的过程，很多参数和配置，别人的教程都是仅供你参考，尤其是硬件直通，还是很复杂，你要有时间研究折腾 我的pve 是 用ventoy启动的硬盘vhd文件放在exfat分区 所以后面一部分内容可能和ventoy有关，如果你是直接安装在硬盘上的 可以跳过这部分内容\n我的硬盘只有两块 - 第一块硬盘 nvme ssd 512G - 硬盘安装了ventoy - 三个分区\n- 第一分区 是放ventoy的启动文件也可以作为第二efi分区 分区大小800M左右fat32格式 - 第二分区是ventoyefi 32m fat16格式 ， - 第三分区我主要数据分区也是ventoy的保留分区实际大小465G，pve系统的虚拟磁盘文件也放在这里 - 第二硬盘 1T 古董盘 存放一些备份文件\n准备文件 macos的恢复镜像Ventura-recovery.img OSX-KVM 已经支持在linux下直接获取Ventura的恢复镜像了 opencore镜像，基于kvm优化过的OpenCore OpenCore-v19.iso https://github.com/thenickdude/KVM-Opencore/releases/ 可选：集成virtio的winpe，方便改错ocpencore后进pe修复， https://blog.csdn.net/flydream3618/article/details/47357895 可选：win10安装盘iso 以及Windows的virtio-win.iso 驱动 https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/ 可选：显卡直通需要的vbois文件 我的是uhd630 你如果是同款核显可以直接用 https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm vbios_gvt_uefi.rom 都放到 机械盘的 iso目录里面\npve的准备工作 pve 删除 local-lvm（非必须，但是你是新手的话，建议删掉） lvremove pve/data lvextend -l +100%FREE -r pve/root 在数据中心-存储中删除local-lvm分区，并编辑local，在内容一项中勾选所有可选项\n"><meta property='og:url' content='https://dev.leiyanhui.com/pve/install-macos-ventura/'><meta property='og:site_name' content='小类随手记'><meta property='og:type' content='article'><meta property='article:section' content='Pve'><meta property='article:published_time' content='2022-10-29T08:29:20+08:00'><meta property='article:modified_time' content='2022-10-29T08:29:20+08:00'><meta name=twitter:title content="在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos"><meta name=twitter:description content=" 这里假定你已经安装好了pve，并且有一定的linux和macos基本基础，本文基于最新版pve7.2-11 其次，pve折腾一个流畅好用的黑苹果是一个非常漫长的过程，很多参数和配置，别人的教程都是仅供你参考，尤其是硬件直通，还是很复杂，你要有时间研究折腾 我的pve 是 用ventoy启动的硬盘vhd文件放在exfat分区 所以后面一部分内容可能和ventoy有关，如果你是直接安装在硬盘上的 可以跳过这部分内容\n我的硬盘只有两块 - 第一块硬盘 nvme ssd 512G - 硬盘安装了ventoy - 三个分区\n- 第一分区 是放ventoy的启动文件也可以作为第二efi分区 分区大小800M左右fat32格式 - 第二分区是ventoyefi 32m fat16格式 ， - 第三分区我主要数据分区也是ventoy的保留分区实际大小465G，pve系统的虚拟磁盘文件也放在这里 - 第二硬盘 1T 古董盘 存放一些备份文件\n准备文件 macos的恢复镜像Ventura-recovery.img OSX-KVM 已经支持在linux下直接获取Ventura的恢复镜像了 opencore镜像，基于kvm优化过的OpenCore OpenCore-v19.iso https://github.com/thenickdude/KVM-Opencore/releases/ 可选：集成virtio的winpe，方便改错ocpencore后进pe修复， https://blog.csdn.net/flydream3618/article/details/47357895 可选：win10安装盘iso 以及Windows的virtio-win.iso 驱动 https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/ 可选：显卡直通需要的vbois文件 我的是uhd630 你如果是同款核显可以直接用 https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm vbios_gvt_uefi.rom 都放到 机械盘的 iso目录里面\npve的准备工作 pve 删除 local-lvm（非必须，但是你是新手的话，建议删掉） lvremove pve/data lvextend -l +100%FREE -r pve/root 在数据中心-存储中删除local-lvm分区，并编辑local，在内容一项中勾选所有可选项\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_6049d840d4e2d14.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐟</span></figure><div class=site-meta><h1 class=site-name><a href=/>小类随手记</a></h1><h2 class=site-description>just so so.</h2></div></header><ol class=menu-social><li><a href=https://github.com/joyanhui/dev.leiyanhui.com-src target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>列表</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>站内搜索</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>links</span></a></li><li><a href=/contact/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>contact</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#准备文件>准备文件</a></li><li><a href=#pve的准备工作>pve的准备工作</a><ol><li><a href=#pve-删除-local-lvm非必须但是你是新手的话建议删掉>pve 删除 local-lvm（非必须，但是你是新手的话，建议删掉）</a></li><li><a href=#更新国内源码>更新国内源码</a></li><li><a href=#处理一下kve的一点小问题>处理一下kve的一点小问题</a></li><li><a href=#重启pve>重启pve</a></li></ol></li><li><a href=#准备主要文件-opencore和macos的恢复镜像>准备主要文件 opencore和macos的恢复镜像</a><ol><li><a href=#下载-kvm-opencore目前最新版是v19>下载 kvm-opencore，目前最新版是v19</a></li><li><a href=#获取-macos-13-ventura-恢复镜像>获取 macos 13 ventura 恢复镜像</a><ol><li><a href=#使用容器搭建一个编译环境>使用容器搭建一个编译环境</a></li><li><a href=#更新一下这个ct容器>更新一下这个CT容器</a></li><li><a href=#安装工具包>安装工具包</a></li><li><a href=#克隆>克隆 <a href=https://github.com/thenickdude/OSX-KVM.git>https://github.com/thenickdude/OSX-KVM.git</a></a></li><li><a href=#编译获取恢复镜像>编译获取恢复镜像</a></li><li><a href=#拉到pve里面>拉到pve里面</a></li></ol></li></ol></li><li><a href=#创建虚拟机>创建虚拟机</a></li><li><a href=#开机之前手动编辑虚拟机配置>开机之前手动编辑虚拟机配置</a><ol><li><a href=#修改两个cdrom>修改两个cdrom</a></li><li><a href=#修改args参数>修改args参数</a></li><li><a href=#参考我的>参考我的</a></li></ol></li><li><a href=#安装基本的macos>安装基本的macos</a></li><li><a href=#macos的简单优化>macos的简单优化</a><ol><li><a href=#中文化和时区>中文化和时区</a></li><li><a href=#可选操作打开macos的远程桌面-方便不使用网页控制他>可选操作：打开macos的远程桌面 方便不使用网页控制他</a></li></ol></li><li><a href=#opencore的简单优化>opencore的简单优化</a><ol><li><a href=#准备工作1把opencore-到硬盘-方便后续修改>准备工作1：把opencore 到硬盘 方便后续修改</a></li><li><a href=#准备工作2安装使用opencore-configurator>准备工作2：安装使用opencore configurator</a></li><li><a href=#opencore开机打印信息>opencore开机打印信息</a></li><li><a href=#opencore开机倒计时启动>opencore开机倒计时启动</a></li></ol></li><li><a href=#备份-准备做硬件直通>备份 准备做硬件直通</a></li><li><a href=#进阶>进阶</a><ol><li><a href=#板载声卡-板载wifi直通-usb设备直通>板载声卡 板载wifi直通 usb设备直通</a></li><li><a href=#显卡直通并再hdmi口输出显示>显卡直通，并再HDMI口输出显示</a><ol><li><a href=#显卡直通先完成win10下的直通>显卡直通先完成win10下的直通</a></li></ol></li><li><a href=#只有一个usb控制器的情况下的pcie蓝牙直通>只有一个usb控制器的情况下的pcie蓝牙直通</a></li></ol></li><li><a href=#本文参考文章>本文参考文章</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/pve/install-macos-ventura/>在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022-10-29</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 4 分钟</time></div></footer></div></header><section class=article-content><blockquote><p>这里假定你已经安装好了pve，并且有一定的linux和macos基本基础，本文基于最新版pve7.2-11<br>其次，pve折腾一个流畅好用的黑苹果是一个非常漫长的过程，很多参数和配置，别人的教程都是仅供你参考，尤其是硬件直通，还是很复杂，你要有时间研究折腾
我的pve 是 用ventoy启动的硬盘vhd文件放在exfat分区 所以后面一部分内容可能和ventoy有关，如果你是直接安装在硬盘上的 可以跳过这部分内容<br>我的硬盘只有两块
- 第一块硬盘 nvme ssd 512G
- 硬盘安装了ventoy
- 三个分区<br>- 第一分区 是放ventoy的启动文件也可以作为第二efi分区 分区大小800M左右fat32格式
- 第二分区是ventoyefi 32m fat16格式 ，
- 第三分区我主要数据分区也是ventoy的保留分区实际大小465G，pve系统的虚拟磁盘文件也放在这里
- 第二硬盘 1T 古董盘 存放一些备份文件</p></blockquote><h2 id=准备文件>准备文件</h2><ul><li>macos的恢复镜像Ventura-recovery.img<ul><li>OSX-KVM 已经支持在linux下直接获取Ventura的恢复镜像了</li></ul></li><li>opencore镜像，基于kvm优化过的OpenCore OpenCore-v19.iso <a class=link href=https://github.com/thenickdude/KVM-Opencore/releases/ target=_blank rel=noopener>https://github.com/thenickdude/KVM-Opencore/releases/</a></li><li>可选：集成virtio的winpe，方便改错ocpencore后进pe修复， <a class=link href=https://blog.csdn.net/flydream3618/article/details/47357895 target=_blank rel=noopener>https://blog.csdn.net/flydream3618/article/details/47357895</a></li><li>可选：win10安装盘iso 以及Windows的virtio-win.iso 驱动 <a class=link href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/ target=_blank rel=noopener>https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/</a></li><li>可选：显卡直通需要的vbois文件 我的是uhd630 你如果是同款核显可以直接用 <a class=link href=https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm target=_blank rel=noopener>https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm</a> vbios_gvt_uefi.rom</li></ul><p>都放到 机械盘的 iso目录里面</p><h2 id=pve的准备工作>pve的准备工作</h2><h3 id=pve-删除-local-lvm非必须但是你是新手的话建议删掉>pve 删除 local-lvm（非必须，但是你是新手的话，建议删掉）</h3><pre><code>  lvremove pve/data
  lvextend -l +100%FREE -r pve/root
</code></pre><p>在数据中心-存储中删除local-lvm分区，并编辑local，在内容一项中勾选所有可选项</p><h3 id=更新国内源码>更新国内源码</h3><pre><code>mkdir /root/bakfile
cp /etc/apt/sources.list //root/bakfile/sources.list
nano  /etc/apt/sources.list
## deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free
## deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free
## deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free
## deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free
cp /etc/apt/sources.list.d/pve-enterprise.list /root/bakfile/pve-enterprise.list
nano /etc/apt/sources.list.d/pve-enterprise.list
https://mirrors.tuna.tsinghua.edu.cn/proxmox/debian bullseye pve-no-subscription
cp /usr/share/perl5/PVE/APLInfo.pm /root/bakfile/APLInfo.pm
sed -i 's|http://download.proxmox.com|https://mirrors.tuna.tsinghua.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm
systemctl restart pvedaemon.service 
apt-get update &amp;&amp; apt upgrade
</code></pre><h3 id=处理一下kve的一点小问题>处理一下kve的一点小问题</h3><p>这步骤非必须的，如果你的macos虚拟机一直无限重启，就要在kve执行</p><pre><code>echo &quot;options kvm ignore_msrs=Y&quot; &gt;&gt; /etc/modprobe.d/kvm.conf &amp;&amp; update-initramfs -k all -u
</code></pre><p>提示<code>No /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.</code> 没关系的，添加此行后 pve主机控制台会提示 一个 类似<code>kvm [1219]: ignored </code>的信息，你如果感觉烦躁 你可以 修改成<code>options kvm ignore_msrs=Y report_ignored_msrs=N</code> 忽略这个提示</p><h3 id=重启pve>重启pve</h3><h2 id=准备主要文件-opencore和macos的恢复镜像>准备主要文件 opencore和macos的恢复镜像</h2><h3 id=下载-kvm-opencore目前最新版是v19>下载 kvm-opencore，目前最新版是v19</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>cd</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>vz</span><span class=o>/</span><span class=n>template</span><span class=o>/</span><span class=n>iso</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=n>wget</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>ghproxy</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>github</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>thenickdude</span><span class=o>/</span><span class=n>KVM</span><span class=o>-</span><span class=n>Opencore</span><span class=o>/</span><span class=n>releases</span><span class=o>/</span><span class=n>download</span><span class=o>/</span><span class=n>v19</span><span class=o>/</span><span class=n>OpenCore</span><span class=o>-</span><span class=n>v19</span><span class=o>.</span><span class=n>iso</span><span class=o>.</span><span class=n>gz</span>
</span></span><span class=line><span class=cl><span class=n>gzip</span> <span class=o>-</span><span class=n>d</span> <span class=n>OpenCore</span><span class=o>-</span><span class=n>v19</span><span class=o>.</span><span class=n>iso</span><span class=o>.</span><span class=n>gz</span>
</span></span></code></pre></td></tr></table></div></div><p>或者自定下载后上传到pve的iso里面</p><blockquote><p>注意这个虽然后缀是iso，但是实际上是raw格式的img文件，后面优化macos的时候我们还要对他进行一些处理。</p></blockquote><h3 id=获取-macos-13-ventura-恢复镜像>获取 macos 13 ventura 恢复镜像</h3><h4 id=使用容器搭建一个编译环境>使用容器搭建一个编译环境</h4><p>虽然pve也是一个完整的debian系统，但是本着各负其责的简单管理原则，尽量避免对pve本身进行太多的修改。所以建议从容器里面搞。你只要按照下面步骤操作 必定可以。</p><h5 id=获取一个ct容器的ubuntu镜像>获取一个ct容器的ubuntu镜像</h5><p>修改源从 pve后台： local>CT模板，获取一个Ubuntu18的镜像<br>或者直接下载后上传到pve</p><pre><code>cd /var/lib/vz/template/cache/
wget https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/ubuntu-18.04-standard_18.04.1-1_amd64.tar.gz
</code></pre><h5 id=创建一个ubuntu18的ct容器>创建一个ubuntu18的CT容器</h5><pre><code>容器名称 ubuntu18 密码 记住 这个密码是容器的root密码
模板选ubuntu18这个
磁盘大小16G
cpu 给几个 无所谓给4个
内存swap都给1024
网络dhcp 其他不用设置
控制台 用root 和上面的密码登录
</code></pre><h4 id=更新一下这个ct容器>更新一下这个CT容器</h4><pre><code>mv  /etc/apt/sources.list   /etc/apt/sources.list-bak
nano /etc/apt/sources.list
</code></pre><p>换国内源,清华源 应该是已经停止了对ubuntu18 的支持，建议调用 中科大的源，阿里的也可以用，但是阿里云的源从今年3月开始抽风，经常限速非常慢</p><pre><code>#中科大源
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse
</code></pre><p>更新系统</p><pre><code>apt update
apt upgrade
</code></pre><h4 id=安装工具包>安装工具包</h4><pre><code>sudo apt install qemu-utils make git
</code></pre><h4 id=克隆>克隆 <a class=link href=https://github.com/thenickdude/OSX-KVM.git target=_blank rel=noopener>https://github.com/thenickdude/OSX-KVM.git</a></h4><pre><code>cd ~
#我这里用了ghproxy的代理加速，你也可以挂梯子 或者找别的代理加速
git clone https://ghproxy.com/https://github.com/thenickdude/OSX-KVM.git
</code></pre><h4 id=编译获取恢复镜像>编译获取恢复镜像</h4><pre><code>cd ~/OSX-KVM/scripts/ventura
make Ventura-recovery.dmg
# 实际下载地址：http://oscdn.apple.com/content/downloads/29/26/071-09012/dt7dmh4ttm1v5ze5989bid4gkovavkykjz/RecoveryImage/BaseSystem.dmg
</code></pre><p>根据提示，他最后一部 有执行 qemu-img convert BaseSystem.dmg -O raw Ventura-recovery.dmg 那么这个最终的dmg其实已经是raw文件了</p><h4 id=拉到pve里面>拉到pve里面</h4><p>pve 执行</p><pre><code>pct pull 101 /root/OSX-KVM/scripts/ventura/Ventura-recovery.dmg /var/lib/vz/template/iso/Ventura-recovery.img
</code></pre><p>这样我们就拿到了Ventura-recovery.img</p><p>ubuntu18的 容器可以关掉，也可以删除了</p><h2 id=创建虚拟机>创建虚拟机</h2><p>主要参数</p><pre><code>操作系统 ： other iso文件：就是那个 OpenCore-vXX.iso 下一步   
显卡：Vmware兼容 Qemu代理：勾选 机器：q35 BIOS：UEFI UEFI下面：预注册密钥 去掉,efi储存到local  
总线：VirtIO 缓存：Write Back（不安全）格式qcow2 容量 28G+,建议32G+   
CPU核心: 是2的次幂 2 4 8 16 我12核心的,只能给8 ，不可以12 10 18 这样的核心数，类型：penryn Numa启用  
内存  4G以上，我这里 8192
网络模型：virtIO   
</code></pre><p>创建了虚拟主机 102（macos），102 ，你的可能是别的</p><p>在硬件里面，添加以恶搞cdrom到Ventura-recovery.img</p><h2 id=开机之前手动编辑虚拟机配置>开机之前手动编辑虚拟机配置</h2><p>有两个地方需要修改 /etc/pve/qemu-server/虚拟机编号.conf</p><ul><li><p>前面挂载的opencoreXX.iso 以及 Ventura-recovery.img 改为硬盘模式</p></li><li><p>添加kvm的args 硬件欺骗</p><pre><code>nano /etc/pve/qemu-server/102.conf
</code></pre></li></ul><h3 id=修改两个cdrom>修改两个cdrom</h3><p>找到前面opencoreXX.iso 以及 Ventura-recovery.img 两行，两个 <code>media=cdrom</code>删掉改为 <code>cache=unsafe</code></p><h3 id=修改args参数>修改args参数</h3><p>在第二行添加</p><pre><code>  args: -device isa-applesmc,osk=&quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&quot; -smbios type=2 -device usb-kbd,bus=ehci.0,port=2 -global nec-usb-xhci.msi=off -cpu host,kvm=on,vendor=GenuineIntel,+kvm_pv_unhalt,+kvm_pv_eoi,+hypervisor,+invtsc
</code></pre><p>如果你是amd的cpu 写法不同</p><pre><code>  args: -device isa-applesmc,osk=&quot;这里得自己找~&quot; -smbios type=2 -device usb-kbd,bus=ehci.0,port=2 -global nec-usb-xhci.msi=off -cpu Penryn,kvm=on,vendor=GenuineIntel,+kvm_pv_unhalt,+kvm_pv_eoi,+hypervisor,+invtsc,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+avx2,+aes,+fma,+fma4,+bmi1,+bmi2,+xsave,+xsaveopt,check
</code></pre><p>osk 是白苹果的一个类似设备编号的代码，同型号的macos都有相同这个代码，你可以网上搜索一下其他的代码</p><h3 id=参考我的>参考我的</h3><p><a class=link href=https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/102.%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84macos13.conf target=_blank rel=noopener>点这里查看</a></p><h2 id=安装基本的macos>安装基本的macos</h2><blockquote><p>只所以说是基本的macos，是因为macos非常依赖显卡，这里暂时只搞到一个可以启动的macos13 动画部分会比较卡，也不支持硬件加速。<br>安装过程中，第一次 启动选 macos base，然后格式硬盘 卷标输入自定义一个，比如我就输入的<code>kvm</code>，后面会重启多次，有 macos installer的时候 选macos install，有前面输入的卷标<code>kvm</code>的时候选择kvm
其他安装过程和白苹果一样，并不复杂，进mac桌面后，自己修改成中文
开机自动倒计时进macos的优化 看后面章节
核显直通和蓝牙直通接力 等 请看 后面的进阶教程</p></blockquote><h2 id=macos的简单优化>macos的简单优化</h2><p>安装完成后，在pve里面删除 挂载的 Ventura-recovery.img</p><h3 id=中文化和时区>中文化和时区</h3><p>OSX-KVM拉回来的镜像是英文版的，<br>点左上角苹果，system setting，搜索 lang，添加中文 删除英文。提示重启，重启一下<br>重启后，右上角键盘位置 设置输入法，通用设置 时间日期 时区 输入上海，回车。
提示重启的时候，建议不重启直接关机</p><h3 id=可选操作打开macos的远程桌面-方便不使用网页控制他>可选操作：打开macos的远程桌面 方便不使用网页控制他</h3><p>系统偏好设置，搜索 共享，打开共享设置， 打开远程管理（vnc+ard） 和远程登陆（ssh）<br>可选：点击 远程管理 后面那个叹号 ，再点 电脑设置 设置一个vnc 密码<br>点网络 以太网 查看一下ip，然后用vnc客户端远程，后面的操作用vnc客户端来操作，会比pve 的vnc网页控制台好用一些。</p><h2 id=opencore的简单优化>opencore的简单优化</h2><h3 id=准备工作1把opencore-到硬盘-方便后续修改>准备工作1：把opencore 到硬盘 方便后续修改</h3><blockquote><p>为了方便，强烈建议你 吧opencore复制到一个独立的虚拟硬盘。而不是和其他人的教程一样dd到macos所在的硬盘</p></blockquote><p>关机，删除前面挂载的Ventura-recovery.img 恢复镜像，我们已经用不到他了 pve添加一个硬盘 大小0.5 就好我这里用0.5 用来做efi分区。 建议 ide挂载，格式raw（文件不大，兼容性比qcow2好也方便其他软件修改编辑）。<br>macos 开始会提示 不能识别按照提示初始化，选择这个500M左右的硬盘 点抹掉 卷标 OPENCORE，格式fat，分区格式主引导记录。<br>格式完成后，再方达里面推出 这个OPENCORE卷，不然没法进行下一步
打开macos的终端 <code>diskutil list</code>查看所有硬盘，可以看到 500多M这个硬盘是对应的硬盘编号是disk1 分区是 disk1s1
另外有一个 150M左右的 是我们前面的opencore的iso。 对应 disk0s1。我们用dd命令把oencore 弄到这个500M的虚拟磁盘上</p><pre><code>sudo dd if=/dev/disk0s1 of=/dev/disk1s1
</code></pre><p>DD会同时把卷标OPENCORE 改成disk0s1的卷标EFI这个不影响。关机，在pve中删除前面的opencoer.iso ，选项里面 启动启动顺序 只选中这个 500M的 raw ，再次开机 就ok了</p><p>如果要编辑efi，在磁盘工具里面直接装载 这个硬盘即可。</p><h3 id=准备工作2安装使用opencore-configurator>准备工作2：安装使用opencore configurator</h3><p>用macos自带的safari 打开本站，然后在本站搜索本页面标题打开下面的地址下载 opencore configurator，或者你也可以用你喜欢的其他工具 比如 ProperTree也不错</p><p><a class=link href=https://mackie100projects.altervista.org/download-opencore-configurator/ target=_blank rel=noopener>https://mackie100projects.altervista.org/download-opencore-configurator/</a></p><p>safari下载后会自动解压。双击运行，然后打开 ，提示安全性问题，新版macos 在设置的隐私与安全性 地方，滚动到下面 找到 对应名称的 仍要打开，输入密码打开。</p><p>如果你前面和我一样的操作，opencore的那个虚拟磁盘，会自动挂载到 /Volumos/OPENCORE ,否则请点击工具 挂载efi</p><p>文件打开 找到 efi目录 oc 下的 config.plist, 就可以进行一些配置编辑工作了</p><h3 id=opencore开机打印信息>opencore开机打印信息</h3><p>开机不再显示白苹果进度条，而且跑代码显示操作，方便后续处理
opencore configurator依次找到</p><p>NVRAM ，里面一般有三个，找到一个带 bootarge的，在他原来的选项后面 输入 空格-v ,新版 直接右键 选择 -v 就可以了</p><h3 id=opencore开机倒计时启动>opencore开机倒计时启动</h3><p>opencore configurator依次找到</p><pre><code>MISC-&gt;Security-&gt;AllowSetDefault  勾选
Misc-&gt;Boot-&gt;Timeout  倒计时 时间 输入 5
</code></pre><p>文件 保存</p><p>重启以后，选择 卷标 按 ctrl+回车 以后启动就会自动选择这个了。<br>注意 倒计时 不会显示时间的，到时间 就会自动启动了<br>修改前的文件备份 <a class=link href=https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config-1.plist target=_blank rel=noopener>https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config-1.plist</a><br>修改后的 <a class=link href=https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config.2.plist target=_blank rel=noopener>https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config.2.plist</a></p><h2 id=备份-准备做硬件直通>备份 准备做硬件直通</h2><p>查看 ：<a class=link href=https://dev.leiyanhui.com/pve/mac-bak/ target=_blank rel=noopener>https://dev.leiyanhui.com/pve/mac-bak/</a></p><h2 id=进阶>进阶</h2><h3 id=板载声卡-板载wifi直通-usb设备直通>板载声卡 板载wifi直通 usb设备直通</h3><p>最新版pve7.2-11 直接添加pci设备 就可以了，不需要额外处理</p><p>usb3.0设备 如果使用端口模式直通的话，需要在同一个端口上分别插入usb3 和usb1-2的设备，分别添加两次，如果基于供应商设备的直通，好像不可热拔插。</p><h3 id=显卡直通并再hdmi口输出显示>显卡直通，并再HDMI口输出显示</h3><h4 id=显卡直通先完成win10下的直通>显卡直通先完成win10下的直通</h4><p>在macos这个主机上，添加一个16G左右的硬盘，挂载一个win10安装盘，设置好引导顺序安装一个win10进去，</p><p>然后查看文章 <a class=link href=https://dev.leiyanhui.com/pve/win-gpu/ target=_blank rel=noopener>https://dev.leiyanhui.com/pve/win-gpu/</a> 先搞定win10下可以点亮屏幕</p><p>其他处理中</p><h3 id=只有一个usb控制器的情况下的pcie蓝牙直通>只有一个usb控制器的情况下的pcie蓝牙直通</h3><p>简单的方案 就是把唯一的一个usb控制器给到虚拟机，在硬件里面 添加pice 直接选中这个usb，就把所有usb口直通进去了。。。那就导致 你鼠标键盘 U盘 都无法在pve下宿主机使用。
。另外一个方案 就是增加硬件 另外价格pcieusb控制器 ，其他方案 可能会复杂很多
我选择直接 直通进去
查看usb控制器</p><pre><code>lspci -nn  | grep USB
00:14.0 USB controller [0c03]: Intel Corporation 100 Series/C230 Series Chipset Family USB 3.0 xHCI Controller [8086:a12f] (rev 31)
</code></pre><h2 id=本文参考文章>本文参考文章</h2><p><a class=link href=https://www.nicksherlock.com/2021/10/installing-macos-12-monterey-on-proxmox-7/ target=_blank rel=noopener>https://www.nicksherlock.com/2021/10/installing-macos-12-monterey-on-proxmox-7/</a></p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//xiao-lei-sui-shou-ji.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 小类随手记</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>