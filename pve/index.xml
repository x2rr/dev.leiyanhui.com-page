<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Pves on 小类随手记</title><link>https://dev.leiyanhui.com/pve/</link><description>Recent content in Pves on 小类随手记</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 31 Oct 2023 19:14:20 +0800</lastBuildDate><atom:link href="https://dev.leiyanhui.com/pve/index.xml" rel="self" type="application/rss+xml"/><item><title>pve 在线迁移lxc和kvm</title><link>https://dev.leiyanhui.com/pve/move/</link><pubDate>Tue, 31 Oct 2023 19:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/move/</guid><description>&lt;p>局域网内非集群pve 迁移&lt;/p>
&lt;p>迁移 ct/lxc 从10.1.1.5 迁移到10.1.1.6&lt;/p>
&lt;p>我这里直接用 直接用scp迁移，我这里还是手动逐个迁移。先确定两边的储存路径&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">pveid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh root@10.1.1.5 &lt;span class="s2">&amp;#34;pct stop &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scp -r root@10.1.1.5:/var/lib/vz/images/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span> /autofs_my/btrfs/images/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scp root@10.1.1.5:/etc/pve/lxc/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>.conf /etc/pve/lxc/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@rootfs: local:@rootfs: nvme_btrfs:@g&amp;#34;&lt;/span> /etc/pve/lxc/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果没有配置key登陆，可以用sshpass 避免每次输入密码&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">apt install sshpass
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">rootpsw&lt;/span>&lt;span class="o">=&lt;/span>xxxx你的root密码
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">pveid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sshpass -p &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">rootpsw&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> ssh root@10.1.1.5 &lt;span class="s2">&amp;#34;pct stop &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sshpass -p &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">rootpsw&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> scp -r root@10.1.1.5:/var/lib/vz/images/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span> /autofs_my/btrfs/images/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sshpass -p &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">rootpsw&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> scp root@10.1.1.5:/etc/pve/lxc/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>.conf /etc/pve/lxc/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@rootfs: local:@rootfs: nvme_btrfs:@g&amp;#34;&lt;/span> /etc/pve/lxc/&lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/pct start &lt;span class="si">${&lt;/span>&lt;span class="nv">pveid&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>上面是迁移容器，因为容器的虚拟磁盘文件我们一般都按需分配的，体积一般不会太大。但是vm的话 最好先用 qm-img 转换一下 qcow2
kvm的配置文件目录修改为：/etc/pve/qemu-server/${pveid}.conf&lt;/p></description></item><item><title>pve 直通钩子 - pve桌面环境日用，win11 三机器钩子脚本自动占用核显 快速实现</title><link>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-1/</link><pubDate>Wed, 27 Sep 2023 22:14:22 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-1/</guid><description>&lt;p>本文内容是 &lt;a class="link" href="https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-all" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-all&lt;/a> 的后续。 主要是为了实现：
pve 宿主机器安装桌面作为日用机使用（lightdm+i3w）此步骤略。
win11-1 （1101）开机后不直通任何设备不影响pve宿主桌面，只能通过rdp远程访问。
win11-2 （1102）开机后接管核显 和usb键鼠等，关机后硬件退还给宿主机。
win11-3 （1103）和 win11-2 一样，不同的是win11-3支持pve网页控制台的vnc屏幕，也就是双屏可以在另外一个设备上简单的实现分屏功能。但是没有开机启动画面会短暂黑屏无信号，一直到win登陆界面才可以点亮核显。
三个vm 磁盘和系统内容完全一样，共享虚拟磁盘文件 但是只能有一个开机处于开机状态。&lt;/p>
&lt;blockquote>
&lt;p>本文内容参考zhing 和 ledIsBeat 两位大神，并进一步优化和精简。 其他内容例如 bios配置和csm等参考 前文 。&lt;/p>&lt;/blockquote>
&lt;h2 id="pve和bios配置">pve和bios配置
&lt;/h2>&lt;p>简单的说，就是 不要黑名单，不要vfio配置。grub只&lt;code>intel_iommu=on&lt;/code> 。&lt;/p>
&lt;p>bios配置参考前文&lt;/p>
&lt;h3 id="grub">grub
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">nano /etc/default/grub &lt;span class="c1"># 修改下面内容，这里不要别的内容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GRUB_CMDLINE_LINUX_DEFAULT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;quiet intel_iommu=on&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="其他">其他
&lt;/h3>&lt;p>/etc/modules 需要添加 四行 vfio vfio_iommu_type1 vfio_pci vfio_virqfd（有的设备不需要）
/etc/modprobe.d/pve-blacklist.conf 删除 blacklist i915 、 blacklist snd_hda_intel 、blacklist snd_hda_codec_hdmi 不需要屏蔽，不然宿主机核显没显示了。如果你需要屏蔽才能直通。本文不适合你。
/etc/modprobe.d/vfio.conf 如果你之前做了vfio ，直接删掉这个文件，不需要。
ls /etc/modprobe.d/ 检查有没有多于的文件 应该只有一个 pve-blacklist.conf 文件才可以 如果你没有独显pve-blacklist.conf也可以删掉。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">update-grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-initramfs -u -k all &lt;span class="c1"># 可能需要更新gurb后重启后再运行这行&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="准备文件">准备文件
&lt;/h2>&lt;p>win11 安装镜像： &lt;a class="link" href="https://www.microsoft.com/zh-cn/software-download/windows11" target="_blank" rel="noopener"
>https://www.microsoft.com/zh-cn/software-download/windows11&lt;/a>
win virio驱动iso ：https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/
钩子脚本 ： &lt;a class="link" href="https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-igpu-hooks" target="_blank" rel="noopener"
>https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-igpu-hooks&lt;/a>
技嘉 B150M-PIO-SI R3 主板虚拟bios文件：https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-igpu-hooks/b150m.bin （&lt;code>大大帅&lt;/code>大佬给修改的）&lt;/p>
&lt;h2 id="安装win11-11101">安装win11-1（1101）
&lt;/h2>&lt;p>有很多种模式可以实现，我这里用q35+ovmf+tpm 正常在pve 网页控制台 安装标准版win11 22H2 。这里就不说了，直接贴配置文件&lt;code>/etc/pve/qemu-server/1101.conf&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">agent: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bios: ovmf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: &lt;span class="nv">order&lt;/span>&lt;span class="o">=&lt;/span>virtio0&lt;span class="p">;&lt;/span>ide2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:1101/vm-1101-disk-0.qcow2,efitype&lt;span class="o">=&lt;/span>4m,pre-enrolled-keys&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide0: local:iso/virtio-win-0.1.240.iso,media&lt;span class="o">=&lt;/span>cdrom,size&lt;span class="o">=&lt;/span>612812K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide2: local:iso/Win11_22H2_Chinese_Simplified_x64v2.iso,media&lt;span class="o">=&lt;/span>cdrom,size&lt;span class="o">=&lt;/span>5723780K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: pc-q35-8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: &lt;span class="m">10240&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu&lt;span class="o">=&lt;/span>8.0.2,ctime&lt;span class="o">=&lt;/span>&lt;span class="m">1695966414&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: win11-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: &lt;span class="nv">virtio&lt;/span>&lt;span class="o">=&lt;/span>72:57:35:2C:58:36,bridge&lt;span class="o">=&lt;/span>vmbr0,firewall&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: win11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>9263edd9-30d2-43e7-8907-46bc55fbe996
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:1101/vm-1101-disk-1.raw,size&lt;span class="o">=&lt;/span>4M,version&lt;span class="o">=&lt;/span>v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:1101/vm-1101-disk-2.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>12G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 9a7d17fc-bc6b-4b76-87d2-f523834aee4a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>找不到硬盘驱动的时候，点击浏览，选择cdrom（virtio）中的 amd64目录下的win11，其他驱动进桌面后再装
联网界面，在pve的网页控制台界面 点一下左侧悬浮的 小箭头，然后依次点 A &amp;gt; ctrl(可能需要点两下) 再点一下键盘的 Shift+F10(Fn+F10)。然后在弹出的cmd命令输入 &lt;code>oobe\bypassnro&lt;/code> 回车 重启，然后重新选国家键盘等就可以选择不联网。
进入桌面后就可以安装光驱里面的驱动了。然后联网，关闭休眠，关闭C页面文件，修改计算机名称或者ip配置，打开远程桌面，本地账号设置密码，测试远程桌面是否可以正常连接。顺带装个dism++ 可以简单清理一下。&lt;/p>
&lt;h2 id="配置win11-2-以及直通">配置win11-2 以及直通
&lt;/h2>&lt;h3 id="钩子脚本准备">钩子脚本准备
&lt;/h3>&lt;p>上面下载的钩子脚本 复制到 &lt;code>/opt/pve-igpu-hooks&lt;/code> 要cd进去加执行权限 &lt;code>chmod a+x *.sh *.pl&lt;/code> 而后复制文件或者ln&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir -p /var/lib/vz/snippets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/lib/vz/snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ln -sf /opt/pve-igpu-hooks/hooks-igpupt.pl /var/lib/vz/snippets/hooks-igpupt.pl#cp hooks-igpupt.pl /var/lib/vz/snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="win11-1-小调整">win11-1 小调整
&lt;/h3>&lt;p>然后上面创建的硬盘只有12G大小再小装不机。可以备份一下&lt;code>sudo cp /var/lib/vz/images/1101/vm-1101-disk-2.qcow2 /home/yanhui/pve-files/w11-q35-12G.qcow2&lt;/code> 。然后返回pve网页控制台选中这个虚拟磁盘文件磁盘操作调整大小，增加88G容量。而后可以返回win的磁盘管理里面 扩容磁盘（开机状态下 virio可以扩容）&lt;/p>
&lt;p>另外额外挂载一个磁盘，并去掉多余的光驱。&lt;/p>
&lt;h3 id="复制出win11-2-并配置">复制出win11-2 并配置
&lt;/h3>&lt;p>&lt;code>cp /etc/pve/qemu-server/1101.conf /etc/pve/qemu-server/1102.conf&lt;/code> 这样1102 和1101 共享磁盘文件。&lt;/p>
&lt;h3 id="编辑win11-21102">编辑win11-2（1102）
&lt;/h3>&lt;p>显示 None ，机型i440fx，添加usb设备和核显 板载声卡。然后编辑&lt;code>1102.conf&lt;/code> 添加args 修改 核显的配置 以及添加hookscript，另外bios设置为默认seaf最终配置文件如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">agent: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">args: -bios /opt/pve-igpu-hooks/b150m.bin -set device.hostpci0.addr&lt;span class="o">=&lt;/span>02.0 -set device.hostpci0.x-igd-gms&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> -set device.hostpci0.x-igd-opregion&lt;span class="o">=&lt;/span>on -smbios &lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> -global nec-usb-xhci.msi&lt;span class="o">=&lt;/span>off -global ICH9-LPC.acpi-pci-hotplug-with-bridge-support&lt;span class="o">=&lt;/span>off -cpu host,vendor&lt;span class="o">=&lt;/span>GenuineIntel,+invtsc,+hypervisor,kvm&lt;span class="o">=&lt;/span>on,vmware-cpuid-freq&lt;span class="o">=&lt;/span>on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: &lt;span class="nv">order&lt;/span>&lt;span class="o">=&lt;/span>virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:1101/vm-1101-disk-0.qcow2,efitype&lt;span class="o">=&lt;/span>4m,pre-enrolled-keys&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hookscript: local:snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostpci0: 0000:00:02.0,legacy-igd&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: pc-i440fx-8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: &lt;span class="m">10240&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu&lt;span class="o">=&lt;/span>8.0.2,ctime&lt;span class="o">=&lt;/span>&lt;span class="m">1695966414&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: win11-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: &lt;span class="nv">virtio&lt;/span>&lt;span class="o">=&lt;/span>72:57:35:2C:58:36,bridge&lt;span class="o">=&lt;/span>vmbr0,firewall&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: win11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>9263edd9-30d2-43e7-8907-46bc55fbe996
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:1101/vm-1101-disk-1.raw,size&lt;span class="o">=&lt;/span>4M,version&lt;span class="o">=&lt;/span>v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb0: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>1ea7:0064,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb1: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>260d:0013,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vga: none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:1101/vm-1101-disk-2.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>100G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:1101/vm-1101-disk-3.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>120G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 9a7d17fc-bc6b-4b76-87d2-f523834aee4a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>主板vbios文件&lt;code>-bios /opt/pve-igpu-hooks/b150m.bin&lt;/code> 仅适合我的主板，不是所有平台都需要这个文件，你可以删掉args里面的这段内容先看看能不能启动。也可以从/usr/share/kvm/ 手动指定一个。args后面的内容 是一些显卡的配置还有防止被检测虚拟机等。&lt;/p>
&lt;p>开机后，usb设备和核显正常时可以点亮的。扩容C盘，用系统更新功能安装显卡驱动（win11-3 因为是q35模式需要先有驱动才能点核显）。&lt;/p>
&lt;h2 id="win11-31103">win11-3（1103）
&lt;/h2>&lt;p>&lt;code>cp /etc/pve/qemu-server/1101.conf /etc/pve/qemu-server/1103.conf&lt;/code> 这样1103 也 和1101 共享磁盘文件。只添加args和钩子 然后添加usb设备即可，最终配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">agent: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">args: -device vfio-pci,host&lt;span class="o">=&lt;/span>00:02.0,addr&lt;span class="o">=&lt;/span>0x02,x-igd-opregion&lt;span class="o">=&lt;/span>on,romfile&lt;span class="o">=&lt;/span>vbios_gvt_uefi.rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bios: ovmf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: &lt;span class="nv">order&lt;/span>&lt;span class="o">=&lt;/span>virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:1101/vm-1101-disk-0.qcow2,efitype&lt;span class="o">=&lt;/span>4m,pre-enrolled-keys&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hookscript: local:snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: pc-q35-8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: &lt;span class="m">10240&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu&lt;span class="o">=&lt;/span>8.0.2,ctime&lt;span class="o">=&lt;/span>&lt;span class="m">1695966414&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: win11-q35-x2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: &lt;span class="nv">virtio&lt;/span>&lt;span class="o">=&lt;/span>72:57:35:2C:58:36,bridge&lt;span class="o">=&lt;/span>vmbr0,firewall&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: win11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>9263edd9-30d2-43e7-8907-46bc55fbe996
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:1101/vm-1101-disk-1.raw,size&lt;span class="o">=&lt;/span>4M,version&lt;span class="o">=&lt;/span>v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb0: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>1ea7:0064,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb1: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>260d:0013,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:1101/vm-1101-disk-2.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>100G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:1101/vm-1101-disk-3.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>120G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 9a7d17fc-bc6b-4b76-87d2-f523834aee4a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>q35 模式 可以双屏幕，启动的时候会提示一个 IGD不支持legacy的警告信息，不用理会。&lt;/p>
&lt;p>如果提示vfio/xx/0 不存在的错误 重启再启动一下就可以，可以用手机 ssh过来 &lt;code>qm start 1103&lt;/code> 这样启动&lt;/p>
&lt;p>更多可以参考 ：&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/win-gpu/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/win-gpu/&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-all" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-all&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhing.fun/pve_igpupt/" target="_blank" rel="noopener"
>https://zhing.fun/pve_igpupt/&lt;/a>&lt;/p></description></item><item><title>pve 核显直通钩子 实现 vm开机直通关机换给pve- 初步尝试</title><link>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-all/</link><pubDate>Wed, 27 Sep 2023 22:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-all/</guid><description>&lt;blockquote>
&lt;p>本文部分内容过期，请查看新版&lt;/p>&lt;/blockquote>
&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-1" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/pve-uhd-hook-win-11-1&lt;/a>&lt;/p>
&lt;p>另外文中没有直通声卡进去，所以虚拟机HDMI也没有声音。 请另外加进去即可&lt;/p>
&lt;h3 id="目标">目标
&lt;/h3>&lt;p>pve 桌面环境日用&lt;!-- raw HTML omitted -->win和macos 偶尔使用。&lt;br>
win1 开机 ，不直通 usb 和 显卡，使用rdp远程桌面操作。&lt;br>
win2 开机 独占显卡 声卡和usb键鼠 以及其他usb设备。 win2关机后 直通的硬件 返给pve.&lt;br>
macos 也是一样（本文目前只有win部分的内容，macos的稍后整理）。&lt;/p>
&lt;blockquote>
&lt;p>注意 部分cpu/主板 暂时是不能完全支持的。我这里可以正常挂载和自动退还给宿主。但是实际使用存在一下几个问题：&lt;/p>
&lt;ul>
&lt;li>开机画面，Q35模式下没搞定i440fx下可用，但是需要挂载定制主板bios文件，可以和macos直通核显需要的bios文件通用。这个不是大问题。&lt;/li>
&lt;li>vm开机后，显卡会直通给vm 宿主机桌面的软件都会退出，这个挺不爽的哈。这个后期可以修改ledisbest大佬的脚本来实现，可以考虑把桌面下的所有软件丢到vnc,而后vm模式下可以用vnc继续操作，vm关机后再返给宿主的桌面。暂时留一个坑。&lt;/li>
&lt;/ul>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&amp;gt; 我的硬件配置 :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- qnct i7 8850h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 技嘉 B150M-PIO-SI R3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- OS: Proxmox VE 8.0.3 x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Kernel: 6.2.16-3-pve pve版本8.0.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 核显 uhd630
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 桌面是i3w 桌面管理器本来是用的 xinit,但是发现zhing和ledisbest大佬的脚本不支持，所以干脆先换了lightdm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>硬件QNCT 实际测试有几种方案（均不限制win版本和驱动版本）&lt;/p>
&lt;p>1、i440fx seaf 实际测试 效果不好，操作有卡顿感，系统更新的时候重启黑屏无法环境 可以有开机画面，winpe之类无驱动模式 可用&lt;br>
2、i440fx ovmf 性能可以 操作流畅 可以有开机画面，winpe之类无驱动模式 可用&lt;br>
3、q35 ovmf 性能可以 操作流畅 暂时没研究明白怎么添加开机画面，pve控制台屏幕可用，winpe之类驱动模式 无法使用。win要安装驱动后才可以点亮直通核显。&lt;/p>
&lt;p>关于tpm，可以用win下用bat脚本处理iso文件然后就脱离tpm安装。也可以 q35 ovmf+tpm 安装成功后修改为 i440fx。&lt;/p>
&lt;blockquote>
&lt;p>后面内容有一部分使用了显卡的rom文件，但是实际测试在我的设备上不需要&lt;/p>&lt;/blockquote>
&lt;h2 id="bios的配置">bios的配置
&lt;/h2>&lt;p>只需要开启 vt-d 即可，gms无要求，可以uefi也可以传统模式启动pve.&lt;/p>
&lt;h2 id="pve安装一个windows">pve安装一个windows
&lt;/h2>&lt;p>VM ID 是 811 用uefi q35机型,驱动用的 虚拟化驱动用的 virtio-win-0.1.215.iso。参考配置如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">agent: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bios: ovmf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: &lt;span class="nv">order&lt;/span>&lt;span class="o">=&lt;/span>virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:811/vm-811-disk-0.qcow2,efitype&lt;span class="o">=&lt;/span>4m,pre-enrolled-keys&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide0: local:iso/virtio-win-0.1.240.iso,media&lt;span class="o">=&lt;/span>cdrom,size&lt;span class="o">=&lt;/span>612812K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide2: local:iso/Win11_22H2_Chinese_Simplified_x64v2.iso,media&lt;span class="o">=&lt;/span>cdrom,size&lt;span class="o">=&lt;/span>5723780K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: pc-q35-8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: &lt;span class="m">10240&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu&lt;span class="o">=&lt;/span>8.0.2,ctime&lt;span class="o">=&lt;/span>&lt;span class="m">1695825773&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: &lt;span class="nv">virtio&lt;/span>&lt;span class="o">=&lt;/span>0E:01:BC:9D:02:51,bridge&lt;span class="o">=&lt;/span>vmbr0,firewall&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: win11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>37977c80-49d4-49f8-8cda-cc03b4ca2fc6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:811/vm-811-disk-1.raw,size&lt;span class="o">=&lt;/span>4M,version&lt;span class="o">=&lt;/span>v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:811/vm-811-disk-2.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>30G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:811/vm-811-disk-3.qcow2,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>64G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 6328352c-225d-4a86-b7ee-643a781aafe0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>正常安装，找不到硬盘的时候 加载一下驱动，提示联网的时候，正常跳过: fn + shift + f10 然后终端输入 oobe\bypassnro.cmd 回车重启&lt;br>
装完后 安装驱动 关闭休眠（必须关闭）安装完成后，固定win11的ip(也可以修改计算机名或者路由器里面查看),并打开远程桌面（要先测试确定没问题） 关闭休眠等。&lt;/p>
&lt;h3 id="复制一个虚拟机">复制一个虚拟机
&lt;/h3>&lt;p>这样可以在不影响811单独启动的情况下 创建一个新的911虚拟机，两个虚拟机磁盘一样 所以不能同时启动。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo cp /etc/pve/qemu-server/811.conf /etc/pve/qemu-server/911.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编辑这个文件 添加三行 args设置 核显直通（vbios_gvt_uefi.rom是非必须的，如果需要可以放到/usr/share/kvm/）和 钩子脚本（后文获取）&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">args: -set device.hostpci0.addr&lt;span class="o">=&lt;/span>02.0 -set device.hostpci0.x-igd-gms&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> -set device.hostpci0.x-igd-opregion&lt;span class="o">=&lt;/span>on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostpci0: 0000:00:02.0,legacy-igd&lt;span class="o">=&lt;/span>1,romfile&lt;span class="o">=&lt;/span>vbios_gvt_uefi.rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hookscript: local:snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后返回pve 网页控制台给911 添加一个usb设备。并设置显示none,机型修改为i440fx。&lt;/p>
&lt;p>启动911后 pve 会黑屏。 用另外一个设备比如iphone iSH 连接到pve,运行 &lt;code>qm start 911&lt;/code>​ 手动启动并看下能否启动，而后用 远程桌面app 连接到win（可以用win计算机名或者路由器查看ip）&lt;/p>
&lt;h6 id="最终参考如下">最终参考如下
&lt;/h6>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">agent: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">args: -set device.hostpci0.addr&lt;span class="o">=&lt;/span>02.0 -set device.hostpci0.x-igd-gms&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> -set device.hostpci0.x-igd-opregion&lt;span class="o">=&lt;/span>on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bios: ovmf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: &lt;span class="nv">order&lt;/span>&lt;span class="o">=&lt;/span>virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:811/vm-811-disk-0.qcow2,efitype&lt;span class="o">=&lt;/span>4m,pre-enrolled-keys&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hookscript: local:snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostpci0: 0000:00:02.0,legacy-igd&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostpci1: 0000:00:1f.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide0: local:iso/virtio-win-0.1.240.iso,media&lt;span class="o">=&lt;/span>cdrom,size&lt;span class="o">=&lt;/span>612812K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide2: local:iso/Win11_22H2_Chinese_Simplified_x64v2.iso,media&lt;span class="o">=&lt;/span>cdrom,size&lt;span class="o">=&lt;/span>5723780K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: pc-i440fx-8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: &lt;span class="m">10240&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu&lt;span class="o">=&lt;/span>8.0.2,ctime&lt;span class="o">=&lt;/span>&lt;span class="m">1695825773&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: &lt;span class="nv">virtio&lt;/span>&lt;span class="o">=&lt;/span>0E:01:BC:9D:02:51,bridge&lt;span class="o">=&lt;/span>vmbr0,firewall&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: win11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>37977c80-49d4-49f8-8cda-cc03b4ca2fc6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:811/vm-811-disk-1.raw,size&lt;span class="o">=&lt;/span>4M,version&lt;span class="o">=&lt;/span>v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb0: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>4037:2804,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb1: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>1ea7:0064,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb2: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>260d:0013,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vga: none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:811/vm-811-disk-2.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>30G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:811/vm-811-disk-3.qcow2,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>64G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 6328352c-225d-4a86-b7ee-643a781aafe0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>不出以外的话，在驱动安装完成后，屏幕可以被点亮。&lt;/p>
&lt;h3 id="进阶">进阶
&lt;/h3>&lt;p>上面的操作911 这个虚拟机有三个问题&lt;/p>
&lt;ul>
&lt;li>没有开机画面&lt;/li>
&lt;li>会直接关掉当前宿主机器的所有软件&lt;/li>
&lt;/ul>
&lt;p>开机画面不显示这个问题在q35机型上 好像是无法避免的。在i440fx有的机器可以直接显示,有的需要特殊方法。&lt;/p>
&lt;h4 id="开机画面">开机画面
&lt;/h4>&lt;h5 id="主板vbios方案---有开机画面">主板vbios方案 - 有开机画面
&lt;/h5>&lt;p>尝试继续处理 这次创建一个新的711 的虚拟机 这次先解决开机画面问题，我这次引用了一个修改后的主板bios文件。如果你没有，可以不加args里面的bios的配置，或从ls -lh /usr/share/kvm/*.bin 里自带的逐个试试，我这里不引用修改后的bios的话，可以显示kvm的bios界面但是最终，会卡到 boot form disk 的命令界面。&lt;/p>
&lt;p>最终配置文件参考如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">args: -bios /opt/pve-igpu-hooks/b150m.bin -set device.hostpci0.addr&lt;span class="o">=&lt;/span>02.0 -set device.hostpci0.x-igd-gms&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> -set device.hostpci0.x-igd-opregion&lt;span class="o">=&lt;/span>on -smbios &lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> -global nec-usb-xhci.msi&lt;span class="o">=&lt;/span>off -global ICH9-LPC.acpi-pci-hotplug-with-bridge-support&lt;span class="o">=&lt;/span>off -cpu host,vendor&lt;span class="o">=&lt;/span>GenuineIntel,+invtsc,+hypervisor,kvm&lt;span class="o">=&lt;/span>on,vmware-cpuid-freq&lt;span class="o">=&lt;/span>on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: &lt;span class="nv">order&lt;/span>&lt;span class="o">=&lt;/span>virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostpci0: 0000:00:02.0,legacy-igd&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostpci1: 0000:02:00.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: &lt;span class="m">10241&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu&lt;span class="o">=&lt;/span>8.0.2,ctime&lt;span class="o">=&lt;/span>&lt;span class="m">1695825773&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: w11-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: &lt;span class="nv">virtio&lt;/span>&lt;span class="o">=&lt;/span>0E:01:BC:9D:02:51,bridge&lt;span class="o">=&lt;/span>vmbr0,firewall&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: other
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>0c5111fb-3e27-41eb-80f7-c097ad453e7b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb0: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>4037:2804,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb1: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>1ea7:0064,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb2: &lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>260d:0013,usb3&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vga: none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:811/vm-811-disk-1.raw,size&lt;span class="o">=&lt;/span>4M,version&lt;span class="o">=&lt;/span>v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:811/vm-811-disk-0.qcow2,efitype&lt;span class="o">=&lt;/span>4m,pre-enrolled-keys&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:811/vm-811-disk-2.qcow2,cache&lt;span class="o">=&lt;/span>unsafe,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>30G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:811/vm-811-disk-3.qcow2,iothread&lt;span class="o">=&lt;/span>1,size&lt;span class="o">=&lt;/span>64G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 6328352c-225d-4a86-b7ee-643a781aafe0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hookscript: local:snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="继续研究-q35方案---无开机画面">继续研究 q35方案 - 无开机画面
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">agent: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">args: -device vfio-pci,host=00:02.0,addr=0x02,x-igd-opregion=on,romfile=igd.rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bios: ovmf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: order=virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: 12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:811/vm-811-disk-0.qcow2,efitype=4m,pre-enrolled-keys=1,size=528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hookscript: local:snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide0: local:iso/virtio-win-0.1.240.iso,media=cdrom,size=612812K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ide2: local:iso/Win11_22H2_Chinese_Simplified_x64v2.iso,media=cdrom,size=5723780K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: pc-q35-8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: 10240
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu=8.0.2,ctime=1695825773
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: virtio=0E:01:BC:9D:02:51,bridge=vmbr0,firewall=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: win11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-single
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: uuid=37977c80-49d4-49f8-8cda-cc03b4ca2fc6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tpmstate0: local:811/vm-811-disk-1.raw,size=4M,version=v2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb0: host=4037:2804,usb3=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb1: host=1ea7:0064,usb3=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usb2: host=260d:0013,usb3=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vga: none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:811/vm-811-disk-2.qcow2,cache=unsafe,iothread=1,size=30G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:811/vm-811-disk-3.qcow2,iothread=1,size=64G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: 6328352c-225d-4a86-b7ee-643a781aafe0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以启动，但是 卡开机画面&lt;/p>
&lt;h5 id="尝试黑名单">尝试黑名单
&lt;/h5>&lt;p>/etc/modprobe.d/pve-blacklist.conf 修改完成后 sudo update-initramfs -u -k all&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This file contains a list of modules which are not supported by Proxmox VE &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># nvidiafb see bugreport https://bugzilla.proxmox.com/show_bug.cgi?id=701&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist nvidiafb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist i915
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist snd_hda_intel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist snd_hda_codec_hdmi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>实际测试 在pve8下，这个黑名单在直通核显的时候，屏蔽后除了会导致pve没有显示之外并没有别的任何作用。&lt;/p>
&lt;p>‍&lt;/p>
&lt;h3 id="获取钩子">获取钩子
&lt;/h3>&lt;p>我这里所有操作都放到 /opt/pve-uhd630-hooks/ 这个目录&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo mkdir -p /opt/pve-igpu-hooks/ &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> /opt/pve-igpu-hooks/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo wget https://github.com/HelloZhing/pvevm-hooks/archive/refs/heads/main.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo unzip main.zip &lt;span class="c1"># apt install unzip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo chown -R yanhui:yanhui /opt/pve-igpu-hooks/ &lt;span class="c1"># 临时修改为当前用户yanhui所有方便后面直接在pve桌面下修改编辑&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv /opt/pve-igpu-hooks/pvevm-hooks-main/*.sh /opt/pve-igpu-hooks/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv /opt/pve-igpu-hooks/pvevm-hooks-main/hooks-igpupt.pl /opt/pve-igpu-hooks/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm main.zip &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -r pvevm-hooks-main &lt;span class="c1"># 删掉无用文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod a+x *.sh *.pl &lt;span class="c1"># 运行权限&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>需要几个地方修改&lt;/p>
&lt;ul>
&lt;li>
&lt;p>hooks-igpupt.pl 里面的 路径 &lt;code>/root/pvevm-hooks&lt;/code>​ 全部替换为 &lt;code>/opt/pve-igpu-hooks&lt;/code>​&lt;/p>
&lt;/li>
&lt;li>
&lt;p>vm-start.sh 里面的 &lt;code>#$(dirname0)/vfio-startup.sh&lt;/code>​ 这行注射下面 添加一行 &lt;code>/opt/pve-igpu-hooks/vfio-startup.sh&lt;/code>​ 同理把 vm-stop.sh中 有 &lt;code>vfio-teardown.sh&lt;/code>​ 那行注射下面添加一行 &lt;code>/opt/pve-igpu-hooks/vfio-teardown.sh&lt;/code>​&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>钩子函数复制到&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo rm /var/lib/vz/snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp /opt/pve-igpu-hooks/hooks-igpupt.pl /var/lib/vz/snippets/hooks-igpupt.pl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="新虚拟配置">新虚拟配置
&lt;/h3>&lt;p>返回到pve平台，编辑多出来的911的虚拟机，添加直通设备，我这里暂时只直通usb键鼠标&lt;/p>
&lt;p>然后编辑&lt;code>/etc/pve/qemu-server/911.conf&lt;/code>​&lt;/p>
&lt;ul>
&lt;li>顶部添加一行 &lt;code>​ args: -devive vfio-pci,host=00:02.0,addr=0x02,x-idg-gms=1,x-ide-opregion-on ​&lt;/code>​&lt;/li>
&lt;/ul>
&lt;p>然后在pve 运行命令 添加 hooks&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo qm &lt;span class="nb">set&lt;/span> &lt;span class="m">911&lt;/span> --hookscript local:snippets/hooks-igpupt.pl &lt;span class="c1"># 会多出一行 hookscript: local:snippets/hooks-igpupt.pl&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="准备另外一台设备">准备另外一台设备
&lt;/h3>&lt;p>可能需要另外一个设备操作pve 和 win11的远程桌面。&lt;br>
我这里用iphone + ish+RD Client&lt;!-- raw HTML omitted -->上面 win11 我固定了ip是 10.1.1.11 所以 在启动911 后，在手机 ish 一直ping 这个ip 就好&lt;/p>
&lt;p>‍&lt;/p>
&lt;p>‍&lt;/p>
&lt;p>本文参考，并做了一些小修改：https://zhing.fun/pve_igpupt/&lt;/p>
&lt;p>‍&lt;/p></description></item><item><title>lxc搭建自己的对象储存s3 mino over ssl/tls</title><link>https://dev.leiyanhui.com/pve/lxc-minio/</link><pubDate>Sun, 09 Apr 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-minio/</guid><description>&lt;h3 id="场景">场景
&lt;/h3>&lt;p>对象储存是一个简单的网络文件储存协议，Simple Storage Service 基于http。性能要超过webdav。&lt;br>
因为云厂商的s3价格比较贵，免费的限制很多。所以在部分情况下，还是用自己的搭建的。&lt;/p>
&lt;h3 id="minio">minio
&lt;/h3>&lt;p>golang写的 绿色环保 轻量 高性能 开源 免费&lt;/p>
&lt;h3 id="环境准备">环境准备
&lt;/h3>&lt;p>我这里是pve平台，采用lxc alpine搭建。创建以一个ct容器 id 9000 ，镜像选择alpine3.17 硬盘8g，另外直通一个物理盘进来，lxc直通教程请站内搜索。 ip 固定10.1.1.90 &lt;br>
alpine 启动后，修改源 市区&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">repositories&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">zoneinfo&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">localtime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;Asia/Shanghai&amp;#34;&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">timezone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">del&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="安装minio">安装minio
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add wget
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget https://dl.min.io/server/minio/release/linux-amd64/minio #活跃软件更新比较频繁
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod +x minio
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="启动测试">启动测试
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">MINIO_ROOT_USER=admin MINIO_ROOT_PASSWORD=123456 ./minio server /mnt/data --console-address &amp;#34;:9001&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># http://10.1.1.90:9001
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 用户名：admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 密码： 123456
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ctrl -c 结束&lt;/p>
&lt;h3 id="配置证书">配置证书
&lt;/h3>&lt;p>我的证书文件 均由 github action 托管，所以我这里直接拉取回来即可。&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-get-ssl/" target="_blank" rel="noopener"
>详情&lt;/a>&lt;br>
minio要求 私钥为private.key，公共证书为public.crt。
&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-updatessl-form-github/" target="_blank" rel="noopener"
>配置自动更新证书的脚本&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cat&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">auto&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">updatessl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">form&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sh&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span>&lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">cdn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jsdelivr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">gh&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sXXXX&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span> &lt;span class="c1">#https://github.com/XXXXXXXXXXXXX.zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="o">!&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="s2">&amp;#34;/root/ssl.zip&amp;#34;&lt;/span> &lt;span class="p">];&lt;/span> &lt;span class="n">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wget&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">O&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">null&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">q&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">day&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="err">你的&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">SSL&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">err&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">mino&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">?&lt;/span>&lt;span class="n">sound&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">birdsong&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">amp&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">isArchive&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">ssl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">7&lt;/span>&lt;span class="n">z&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p密码&lt;/span> &lt;span class="c1">#密码和p之间不能有空格&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">supervisorctl&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">minio&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nginx&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="n">reload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;15 8 * * * sh /root/auto-updatessl-form-github.sh&amp;#34;&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">crontabs&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">cat&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">crontabs&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="启用证书">启用证书
&lt;/h3>&lt;p>minio 支持tls通讯，但是理解起来有一点困难，本着能不用脑子的时候，绝对不用的前提。
我还是选 用nginx来搞定,下面操作依旧是基于alpine 其他linux系统注意一下 路径&lt;/p>
&lt;blockquote>
&lt;p>aio环境也可以集中到 nginxWebUI处理&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add nginx boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv /etc/nginx/http.d/default.conf /etc/nginx/http.d/default.conf-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/nginx/http.d/mino.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>内容,&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-zed" data-lang="zed">&lt;span class="line">&lt;span class="cl">&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">server_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">jia&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#管理面板&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">listen&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">51443&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">http2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ssl_certificate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nn">root/ssl/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cer&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ssl_certificate_key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nn">root/ssl/&lt;/span>&lt;span class="n">XXX&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ssl_protocols&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">3&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">listen&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">51442&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">scheme&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">301&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//$host:51443$request_uri;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">error_page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">497&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//$host:51443;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Allow&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">special&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">characters&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ignore_invalid_headers&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Allow&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">any&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">be&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">uploaded&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">such&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">1000&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">restrict&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">specific&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client_max_body_size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Disable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buffering&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_buffering&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_request_buffering&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Host&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Real&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">remote_addr&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">For&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Proto&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">scheme&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">NginX&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Proxy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">This&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">necessary&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pass&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">the&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correct&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">be&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hashed&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">real_ip_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Real&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IP&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_connect_timeout&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">300&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">To&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">support&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">websocket&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_http_version&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Upgrade&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">http_upgrade&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Connection&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">&amp;#34;&lt;/span>&lt;span class="n">upgrade&lt;/span>&lt;span class="err">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">chunked_transfer_encoding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_pass&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//10.1.1.90:9001/; # This uses the upstream directive definition to load balance and assumes a static Console port of 9001
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">server_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s3api&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">域名&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nv">#api&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">listen&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">51443&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">http2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ssl_certificate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nn">root/ssl/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cer&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ssl_certificate_key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nn">root/ssl/&lt;/span>&lt;span class="n">XXX&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ssl_protocols&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TLSv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">3&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">listen&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">51442&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">scheme&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">301&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//$host:51443$request_uri;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">error_page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">497&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//$host:51443;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Allow&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">special&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">characters&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ignore_invalid_headers&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Allow&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">any&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">be&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">uploaded&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">such&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">1000&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">restrict&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">specific&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client_max_body_size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Disable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buffering&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_buffering&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_request_buffering&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Host&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Real&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">remote_addr&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">For&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Proto&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="n">scheme&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_connect_timeout&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">300&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Default&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">HTTP/&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keepalive&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">only&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">HTTP/&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_http_version&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_set_header&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Connection&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">chunked_transfer_encoding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">proxy_pass&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//10.1.1.90:9000/; # This uses the upstream directive definition to load balance
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>上文参考：https://min.io/docs/minio/linux/integrations/setup-nginx-proxy-with-minio.html&lt;br>
去掉了负载均衡部分&lt;/p>
&lt;h4 id="测试ssl">测试ssl
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">service nginx start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MINIO_ROOT_USER=admin MINIO_ROOT_PASSWORD=12345678 ./minio server /mnt/data --console-address &amp;#34;:9001&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="写入服务">写入服务
&lt;/h3>&lt;h4 id="配置和环境变量">配置和环境变量
&lt;/h4>&lt;p>通常 都是使用 supervisorctl，使用也比较简单。但是今天准备尝试用 alpine的rc服务管理器来处理。
minio 已经不建议用 &amp;ndash;config-dir 来管理配置文件，而是把配置文件 放到了 目录的 .minio.sys&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ls /mnt/data/.minio.sys
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我这里直接export 放到 start_pre
~~
我这里直接改环境变量
echo &amp;ldquo;export MINIO_ROOT_USER=admin&amp;rdquo;&amp;raquo;/etc/profile&lt;br>
echo &amp;ldquo;export MINIO_ROOT_PASSWORD=123456&amp;rdquo;&amp;raquo;/etc/profile&lt;br>
source /etc/profile
~~&lt;/p>
&lt;h4 id="添加系统服务">添加系统服务
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">vi&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">init&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">minio&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-----------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/sbin/openrc-run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;minio&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">command&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/root/minio &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">command_args&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;server /mnt/data --console-address &amp;#39;:9001&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">command_background&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;yes&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">pidfile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/run/$RC_SVCNAME.pid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">start_pre&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">export&lt;/span> &lt;span class="n">MINIO_ROOT_USER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">admin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">export&lt;/span> &lt;span class="n">MINIO_ROOT_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">12345678&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">depend&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">need&lt;/span> &lt;span class="n">localmount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">need&lt;/span> &lt;span class="n">logger&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>此处有一个小坑 ，密码长度不能低于8位 用户名不能低于三位。 另外这个账户密码 是 面板 以及 mc的管理里面。面板可以禁用 mc的不确定，所以密码强度最好高一点&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">chmod +x /etc/init.d/minio
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-service --list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add minio boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service minio start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve下使用lxc 直通硬盘搭建 nas 服务 全面替代群晖 freenas OMV 等 总览</title><link>https://dev.leiyanhui.com/pve/lxc-nas/</link><pubDate>Mon, 27 Feb 2023 18:55:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas/</guid><description>&lt;h2 id="前言">前言
&lt;/h2>&lt;p>不想花钱，为什么不用黑群晖。原因&lt;br>
1、首先我这个是家用为主，兼顾小团队工作使用。 主要的需求很明确。&lt;br>
2、遭遇过黑群晖突然无法引导的问题，人在异地无法处理。 &lt;br>
3、所谓&lt;/p>
&lt;h2 id="宿主机环境">宿主机环境
&lt;/h2>&lt;p>宿主机器 pve 7.3-4 cpu：i8850h qnct 6核12线程 内存32G nvme 硬盘1块 机械硬盘 N块 &lt;br>
pve 使用 ventoy启动，核显开启了gvt-g&lt;/p>
&lt;h3 id="替代">替代
&lt;/h3>&lt;p>对标群晖&lt;/p>
&lt;ul>
&lt;li>lxc alpine 开 smb sftp webdav 用 cloudreve开webdav rclone挂载后开smb 和sftp&lt;/li>
&lt;li>lxc alpine Aria2 + nginx+AriaNG 下载工具&lt;/li>
&lt;li>lxc alpine docker 跑 duplicati 核心数据异地备份 rclone +alist网盘同步&lt;/li>
&lt;li>lxc alpine docker+ 思源在线md 同步到minio&lt;/li>
&lt;li>lxc alpine 跑minio 私有s3对象储存&lt;/li>
&lt;li>lxc alpine 跑 gogs + SQLite3 私有git&lt;/li>
&lt;li>独立lxc 跑 nginx+acme.sh 处理一切证书。后改为 github action&lt;/li>
&lt;li>视频 plex、emby、jellyfin tinyMediaManager&lt;/li>
&lt;li>音乐 webdav+ nPlayer AVplayer AcePlayer ES文件浏览器&lt;/li>
&lt;li>在线office cloudreve + onlyoffice 比群晖 兼容性更好！&lt;/li>
&lt;li>人脸识别相册 无解 我这里无需求。实在要用 只能群晖挂载smb后用别人破解的so文件搞。&lt;/li>
&lt;li>在线 golang 开发 docker debian golang + codeserver + chrome&lt;/li>
&lt;/ul>
&lt;h3 id="完整解决方案">完整解决方案
&lt;/h3>&lt;blockquote>
&lt;p>查看下面的文章之前，你如果对lxc和alpine不熟悉，最好先看本文后面的lxc和alpine的内容。尤其是特权容器和docker 以及 目录挂载的一些权限问题。 &lt;br>
2023-02-17 后使用的方案为：全lxc 每个lxc运行1-多个服务 分开管理&lt;/p>&lt;/blockquote>
&lt;ul>
&lt;li>&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-get-ssl" target="_blank" rel="noopener"
>github actione自动处理证书 并加密&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-updatessl-form-github" target="_blank" rel="noopener"
>本地自动获取前面的证书&lt;/a>&lt;/li>
&lt;li>lxc 10000 &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve" target="_blank" rel="noopener"
>alpine 运行 cloudereve + rclone（挂载cr的webdav） + smb + sftp &lt;/a>&lt;/li>
&lt;li>lxc 10001 &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-alist" target="_blank" rel="noopener"
>alpine 运行 alist 挂网盘 &lt;/a>&lt;/li>
&lt;li>lxc 10002 &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-cloudreve-aria2" target="_blank" rel="noopener"
>alpine 运行 aria2+ariaNG 和 cloudereve 直通同一个硬盘 处理离线下载&lt;/a>&lt;/li>
&lt;li>lxc 10003 &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-autobackup/" target="_blank" rel="noopener"
>alpine 运行 docker版duplicati 同步 以及 加密备份文件 到 云盘&lt;/a>&lt;/li>
&lt;li>lxc 10010 &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-office-onlyoffice" target="_blank" rel="noopener"
>alpine 运行 nginx + docker版onlyoffice 处理在线文档&lt;/a>&lt;/li>
&lt;li>众多端口号和域名自己记不住的问题：gitcode.net 开一个私有库，创建一个md文件 就完事，不需要再去折腾导航站。、&lt;/li>
&lt;li>未完待续&lt;/li>
&lt;/ul>
&lt;h2 id="lxc基本使用">lxc基本使用
&lt;/h2>&lt;p>ct镜像 全部选择alpine3.17， alpine的优点不用说了，小巧干净！无可替代！&lt;br>
国内下载地址： &lt;a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/alpine-3.17-default_20221129_amd64.tar.xz" target="_blank" rel="noopener"
>https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/alpine-3.17-default_20221129_amd64.tar.xz&lt;/a>&lt;/p>
&lt;p>因为是小团队使用，所以全部使用特权容器 启动。&lt;/p>
&lt;h3 id="创建一个lxc--ct">创建一个lxc CT
&lt;/h3>&lt;p>CT ID 输入：10080 名称 nas-core 输入root密码 去掉 无特权容器 勾号。模板选择 alpine3.17，磁盘1G，cpu 12核心，内存1024，交换分区0，网络开dhcp，稍后在路由器中绑定静态分配到 10.1.1.80，其他默认，先不启动。选项里面，勾选上 开机自动启动，功能里面勾选上嵌套。&lt;/p>
&lt;p>这个lxc 如果不需要运行docker所以不需要额外处理。只需要挂机械硬盘进去， 硬盘只有一个分区已经格式化为brtfs。在pve下没有挂载，节点在/dev/sda1&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pct &lt;span class="nb">set&lt;/span> &lt;span class="m">10080&lt;/span> -mp0 /dev/sda1,mp&lt;span class="o">=&lt;/span>/mnt/sda1 &lt;span class="c1">#把 第一个硬盘的第一个分区挂到 lxc的/mnt/sda1 下 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pct start &lt;span class="m">10080&lt;/span> &lt;span class="c1">#启动&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="alpine系统准备">alpine系统准备
&lt;/h3>&lt;h4 id="配置alpine的源和时区">配置alpine的源和时区
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置源和时区 alpine内运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> /etc/apk/repositories
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add tzdata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Asia/Shanghai&amp;#34;&lt;/span> &amp;gt; /etc/timezone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk del tzdata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/cache/apk/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># vim替换为nano&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add nano
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk del vim &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> ln -s /usr/bin/nano /usr/bin/vim &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -rf /usr/bin/vi &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> ln -s /usr/bin/nano /usr/bin/vi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="特权lxc运行docker">特权lxc运行docker
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-docker-err" target="_blank" rel="noopener"
>alpine特权容器安装运行docker&lt;/a>&lt;/p></description></item><item><title>lxc alpine下使用cloudreve替代nginx搭建webdav 之aria2离线下载</title><link>https://dev.leiyanhui.com/pve/lxc-nas-cloudreve-aria2/</link><pubDate>Fri, 17 Feb 2023 18:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-cloudreve-aria2/</guid><description>&lt;p>单独一个lxc运行 aria2，系统alpine 并挂载 硬盘进来&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pct set 10002 -mp0 /dev/sda1,mp=/mnt/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个硬盘 要求运行 cloudreve的lxc容器也可以访问。不然cloudreve没法移动文件进去。&lt;/p>
&lt;h3 id="安装aria2">安装aria2
&lt;/h3>&lt;p>用p3terx的最后版本，需要科学环境&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">apk&lt;/span> &lt;span class="nx">add&lt;/span> &lt;span class="nx">bash&lt;/span> &lt;span class="nx">wget&lt;/span> &lt;span class="nx">ca&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">certificates&lt;/span> &lt;span class="nx">curl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">wget&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">N&lt;/span> &lt;span class="nx">git&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">aria2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sh&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">chmod&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="nx">x&lt;/span> &lt;span class="nx">aria2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">aria2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sh&lt;/span> &lt;span class="err">#&lt;/span> &lt;span class="nx">安装&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装完成后 在aria2.sh 配置修改一下,主要修改下载目录。
安装完成后 会提示 RPC 密钥 还有NG的地址。&lt;/p>
&lt;p>BT下载功能 需要开 51413端口，另外aria2是不支持 ed2k协议的。冷门bt下载，还是用开迅雷去吧。其他都不好用。&lt;/p>
&lt;p>开机自动启动,因为p3terx的脚本不支持alpine，需要处理一下，我这里为了省事直接用supervisor&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apk add supervisor
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add supervisord boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service supervisord restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo_supervisord_conf &amp;gt; /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;[include]&amp;#34;&lt;/span>&amp;gt;&amp;gt;/etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;files = /root/supervisor/*.ini&amp;#34;&lt;/span>&amp;gt;&amp;gt;/etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /root/supervisor/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#supervisor aria2 配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat &amp;gt; /root/supervisor/aria2.ini &lt;span class="s">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">[program:aria2c]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">directory=/root/.aria2c/
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">command=/usr/local/bin/aria2c --conf-path=/root/.aria2c/aria2.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">autostart=true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">autorestart=true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">;stderr_logfile=/tmp/aria2c.err
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">;stdout_logfile=/tmp/aria2c.log
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">environment=CODENATION_ENV=prod
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 其他指令&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisord -c /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl start aria2c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl stop aria2c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl status aria2c
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ariang">AriaNg
&lt;/h3>&lt;p>可视化的Aria 管理界面，用nginx跑吧&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apk add nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/cache/apk/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add nginx boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service nginx start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir ng-html &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> ng-html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget https://github.com/mayswind/AriaNg/releases/download/1.3.2/AriaNg-1.3.2.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unzip AriaNg*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm AriaNg*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>配置nginx ，还有修改一下 nginx的运行用户 或者 目录所有者&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mv /etc/nginx/http.d/default.conf /etc/nginx/http.d/default.conf-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat &amp;gt; /etc/nginx/http.d/ariang.conf &lt;span class="s">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">server {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> listen 80 ;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> server_name _ ;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> root /root/ng-html;# 站点根目录
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> index index.html;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试 http://10.1.1.82/#!/settings/rpc/set/ws/10.1.1.82/6800/jsonrpc/XXXXXXXXXXX&lt;/p>
&lt;p>如果你的 ariaNG 要外网使用，再去处理一下ssl和端口映射就好。&lt;/p></description></item><item><title>pve下lxc运行alpine + alist + ssl 非docker方式</title><link>https://dev.leiyanhui.com/pve/lxc-nas-alist/</link><pubDate>Wed, 15 Feb 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-alist/</guid><description>&lt;p>pve下 可以把lxc当作应用容器使用，所以系统肯定选择只有3m的alpinelinux&lt;br>
不用docker配置，优点体积小，缺点略微繁琐一丢。&lt;/p>
&lt;h3 id="创建alpine-lxc容器">创建alpine lxc容器
&lt;/h3>&lt;p>pve下操作，特权容器，创建完成后，选项功能 里面 最好勾选 嵌套和 fuse，磁盘大小0.3G。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置源和时区 alpine内运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> /etc/apk/repositories
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add tzdata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Asia/Shanghai&amp;#34;&lt;/span> &amp;gt; /etc/timezone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk del tzdata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/cache/apk/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># vim替换为nano&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add nano
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk del vim &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> ln -s /usr/bin/nano /usr/bin/vim &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -rf /usr/bin/vi &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> ln -s /usr/bin/nano /usr/bin/vi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="安装alist">安装alist
&lt;/h3>&lt;p>官网一键安装命令 不支持alpine，手动装，alpine 没有 glibc，我用musl版本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">akp&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">wget&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">~&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">alist&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">alist&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">releases&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">v3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">11.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">alist&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">musl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tar&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">zxvf&lt;/span> &lt;span class="n">alist&lt;/span>&lt;span class="o">-*.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">rm&lt;/span> &lt;span class="n">alist&lt;/span>&lt;span class="o">-*.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chmod&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="n">alist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">./&lt;/span>&lt;span class="n">alist&lt;/span> &lt;span class="n">server&lt;/span> &lt;span class="c1"># 运行程序 查看有没有异常&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ctrl +c 停止&lt;/p>
&lt;blockquote>
&lt;p>如果要更新alist，上面命令简单修改一下即可&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">./alist admin # 获得管理员用户名和密码信息 kT0voJRZ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./alist server &amp;amp; # 临时后台运行，然后去后台配置 配置完成后 killall alist
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="alpine下配置alist守护进程">alpine下配置alist守护进程
&lt;/h3>&lt;p>可以用 rc.local , 我这里使用supervisor 更简单一些&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add supervisor nano
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add supervisord boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service supervisord restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>初始化配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">echo_supervisord_conf &amp;gt; /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编辑或者添加文件末尾两行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[include]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">files = /etc/supervisord_conf/*.ini
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir -p /etc/supervisord_conf/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/supervisord_conf/alist.ini
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>根据自己的情况配置 注意这个文件是ini格式的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[program:alist]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">directory=/root/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">command=/root/alist server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">autostart=true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">autorestart=true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">;stderr_logfile=/tmp/alist.err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">;stdout_logfile=/tmp/alist.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">environment=CODENATION_ENV=prod
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>管理&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">supervisord -c /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl start alist
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl stop alist
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl status alist
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reboot # 重启后检查alist是否已经ok
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置外网ssl">配置外网ssl
&lt;/h3>&lt;h4 id="获取证书">获取证书
&lt;/h4>&lt;p>获取你的域名证书。我这里是 部署到github上的acme.sh，直接拉回来解压。你可以自签，也可以单独装acmesh 甚至宝塔 自己随意就好。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">wget https://github.com/joyanhui/ssl/raw/main/ssl.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add p7zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7z x ssl.zip -p密码 #密码和p字母之间没有空格
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置nginx">配置nginx
&lt;/h4>&lt;p>alpine下nginx的配置文件 是在 http.d 目录下哈&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">service&lt;/span> &lt;span class="n">nginx&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nginx&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="n">reload&lt;/span> &lt;span class="c1"># 重载&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mv /etc/nginx/http.d/default.conf /etc/nginx/http.d/default.conf-bak #非必须
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/nginx/http.d/alist.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>内容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">listen&lt;/span> &lt;span class="err">端口号码&lt;/span> &lt;span class="n">ssl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_name&lt;/span> &lt;span class="err">你的域名&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ssl_certificate&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ddns&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cer&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># fullchain.pem&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ssl_certificate_key&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ddns&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">#privkey.pem&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ssl_verify_client&lt;/span> &lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_tokens&lt;/span> &lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">root&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginx&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">For&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Proto&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">scheme&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Real&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ne">IP&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="ne">Range&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_range&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">If&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ne">Range&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_if_range&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_redirect&lt;/span> &lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">5244&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># the max size of file to upload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client_max_body_size&lt;/span> &lt;span class="mi">20000&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="结束">结束
&lt;/h3>&lt;p>重载nginx，路由器设置好ip绑定和端口转发 完毕&lt;br>
windows下 挂载后，尝试复制大文件正常。&lt;/p></description></item><item><title>pve下lxc运行archlinux</title><link>https://dev.leiyanhui.com/pve/lxc-archlinux/</link><pubDate>Wed, 15 Feb 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-archlinux/</guid><description>&lt;p>pve自带的archlinux的 CT模板 会延迟几个月，archlinux因为是滚动更新，直接使用会无法正常更新。 &lt;br>
在 梦中大佬指点搞定&lt;/p>
&lt;h3 id="准备ct模板">准备ct模板
&lt;/h3>&lt;p>选择 archlinux-base_20221111-1_amd64.tar.zst 。现在是2023 02 15，直接更新会出错。&lt;/p>
&lt;h3 id="修改源">修改源
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nano /etc/pacman.d/mirrorlist
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在最前面添加一行，后面的不要删除。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="开始更新">开始更新
&lt;/h3>&lt;p>更新&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -Syy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>继续&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -Su
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>出错，按照提示&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman-key --init
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>继续&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">pacman&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">populate&lt;/span> &lt;span class="c1">#Reload the default keys from the (given) keyrings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">pacman&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="n">archlinux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">keyring&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">pacman&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Su&lt;/span> &lt;span class="n">archlinux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">keyring&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定，可以继续装其他软件了。&lt;/p>
&lt;h3 id="总结">总结
&lt;/h3>&lt;p>首先要 初始化key后需要 然后 从密钥环中重新加载默认密钥，最后先单独装keyring 再更新&lt;/p></description></item><item><title>pve下lxc运行archlinux桌面环境 包括输入法 远程桌面 3d加速等</title><link>https://dev.leiyanhui.com/pve/lxc-arch-desktop-xrdp/</link><pubDate>Wed, 15 Feb 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-arch-desktop-xrdp/</guid><description>&lt;h2 id="安装arch并更新到最新版">安装arch并更新到最新版
&lt;/h2>&lt;p>&lt;a class="link" href="../lxc-archlinux" >参考之前文章&lt;/a>&lt;/p>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;p>安装yay sudo 添加新用户&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nano /etc/pacman.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[archlinuxcn]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pacman -Sy archlinuxcn-keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pacman -S yay
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pacman -S doas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;#34;permit persist :wheel&amp;#34; &amp;gt; /etc/doas.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -c root:root /etc/doas.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod -c 0400 /etc/doas.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">doas -C /etc/doas.conf &amp;amp;&amp;amp; echo &amp;#34;config ok&amp;#34; || echo &amp;#34;config error&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">useradd -m -G wheel -s /bin/bash leiyanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">passwd leiyanhui
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="选择桌面和输入法">选择桌面和输入法
&lt;/h2>&lt;p>我这里选 xorg kde 了 如果安装i3 参考 &lt;a class="link" href="https://dev.leiyanhui.com/arch/xinitc-xrdp/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/arch/xinitc-xrdp/&lt;/a>&lt;/p>
&lt;h3 id="xorg">xorg
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -S xorg-server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="显示管理器">显示管理器
&lt;/h3>&lt;p>我这里用 xinitrc&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -S xorg-xinit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/X11/xinit/xinitrc /etc/X11/xinit/xinitrc-bak
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nano /etc/X11/xinit/xinitrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#注释掉下面几行 这几乎是启动一个时钟 几个 xterm，实际上会导致xrdp无法登录
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#twm &amp;amp;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#xclock -geometry 50x50-1+1 &amp;amp;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#xterm -geometry 80x50+494+51 &amp;amp;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#xterm -geometry 80x20+494-0 &amp;amp;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#exec xterm -geometry 80x66+0+0 -name login
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="安装kde">安装kde
&lt;/h3>&lt;p>我这里直接装 plasma 整个包，然后卸载开发包 。 因为plasma-desktop 其实不全，后期弄起来麻烦。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -S plasma
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pacman -Rscn plasma-sdk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pacman -Rscn `pacman -Qqs kde games`
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="网络管理">网络管理
&lt;/h3>&lt;p>lxc下没必要&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl enable NetworkManager
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="xrdp-处理">xrdp 处理
&lt;/h2>&lt;blockquote>
&lt;p>注意科学环境&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">yay -S xrdp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="声音">声音
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -S pulseaudio
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其他参考 &lt;a class="link" href="https://dev.leiyanhui.com/c/arch-install-xrdp/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/c/arch-install-xrdp/&lt;/a>&lt;/p></description></item><item><title>lxc alpine下使用cloudreve 和 LibreOffice 的配置</title><link>https://dev.leiyanhui.com/pve/lxc-nas-office/</link><pubDate>Mon, 13 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-office/</guid><description>&lt;p>接上一篇，在pve lxc下以cloudreve为核心搭建了nas &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve&lt;/a>&lt;/p>
&lt;p>下面需要配置 在线编辑功能，考虑到alpine的依赖问题，单独配置一个lxc容器来运行office部分&lt;/p>
&lt;p>特权容器 安装docker 方法：&lt;a class="link" href="https://dev.leiyanhui.com/pve/docker-mini/#lxc-%E7%89%B9%E6%9D%83%E5%AE%B9%E5%99%A8-%E5%92%8C%E9%9D%9E%E7%89%B9%E6%9D%83%E5%AE%B9%E5%99%A8%E7%9A%84%E9%80%89%E6%8B%A9" target="_blank" rel="noopener"
>查看这里&lt;/a>&lt;/p>
&lt;p>office的选择，肯定是选大名鼎鼎的LibreOffice，另外Office Online Server微软的 ，在部分授权情况下可以免费使用，但是需要window server主机。另外一个OnlyOffice 不知为什么我这里没成功&lt;/p>
&lt;h3 id="安装配置docker">安装配置docker
&lt;/h3>&lt;p>基本配置和安装docker &lt;a class="link" href="https://dev.leiyanhui.com/pve/alpine-docker" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/alpine-docker&lt;/a>&lt;/p>
&lt;h3 id="运行docker">运行docker
&lt;/h3>&lt;p>因为Office Online Server收费，OnlyOffice的兼容性也没看到，并且我这里配置只能预览无法编辑，所以选择LibreOffice.&lt;/p>
&lt;h4 id="尝试使用--collabora-online-libreoffice-online">尝试使用 Collabora Online (LibreOffice Online)
&lt;/h4>&lt;p>建议用ubuntu22.04运行，直接安装 不使用docker。 创建一个lxc 至少需要2.8G 建议 5G。 内存要1G+&lt;/p>
&lt;p>修改源 那些不用说了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="k">export&lt;/span> &lt;span class="n">customer_hash&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Example&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">413539&lt;/span>&lt;span class="n">ece39485afc35b4a469adfde0a279d2fd2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">keyrings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">collaboraoffice&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">downloads&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">gpg&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">collaboraonline&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">release&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">keyring&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gpg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cat&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">EOF&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">collaboraonline&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Types&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">deb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">URIs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">www&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collaboraoffice&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">repos&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">CollaboraOnline&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">22.05&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">customer&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ubuntu2204&lt;/span>&lt;span class="o">-$&lt;/span>&lt;span class="n">customer_hash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Suites&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">./&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Signed&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">By&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">keyrings&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">collaboraonline&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">release&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">keyring&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gpg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apt&lt;/span> &lt;span class="n">update&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apt&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="n">coolwsd&lt;/span> &lt;span class="n">collabora&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">online&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">brand&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker stop code &amp;amp;&amp;amp; docker rm code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -t -d -p 9980:9980 --name code --hostname code \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e TZ=Asia/Shanghai \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e dictionaries=zh-CN \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &amp;#34;aliasgroup1=https://pan.jia.leiyanhui.com:5213&amp;#34; \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &amp;#34;username=admin&amp;#34; \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &amp;#34;password=admin&amp;#34; \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --restart always collabora/code
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置ssl">配置ssl
&lt;/h3>&lt;p>我这里使用github actions集中管理的ssl证书 &lt;a class="link" href="https://dev.leiyanhui.com/web/auto-get-ssl" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/web/auto-get-ssl&lt;/a>&lt;br>
直接下载回来 用 7z 带密码解压 （unzip部分发行版不支持密码）&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">wget https://github.com/joyanhui/ssl/raw/main/ssl.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add p7zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7z x ssl.zip -p密码 #密码和p字母之间没有空格
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装nginx 处理ssl&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">service&lt;/span> &lt;span class="n">nginx&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nginx&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="n">reload&lt;/span> &lt;span class="c1"># 重载&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nano&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginx&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">code&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">listen&lt;/span> &lt;span class="mi">8443&lt;/span> &lt;span class="n">ssl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_name&lt;/span> &lt;span class="n">office&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jia&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ssl_certificate&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">jia&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cer&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ssl_certificate_key&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">jia&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># static files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">^~&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">browser&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9980&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># WOPI discovery URL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">^~&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">hosting&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">discovery&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9980&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Capabilities&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">^~&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">hosting&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">capabilities&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9980&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># main websocket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">~&lt;/span> &lt;span class="o">^/&lt;/span>&lt;span class="n">cool&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">.*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ws&lt;/span>&lt;span class="o">$&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9980&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Upgrade&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_upgrade&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Connection&lt;/span> &lt;span class="s2">&amp;#34;Upgrade&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_read_timeout&lt;/span> &lt;span class="mi">36000&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># download, presentation and image upload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">~&lt;/span> &lt;span class="o">^/&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">ool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9980&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Admin Console websocket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">location&lt;/span> &lt;span class="o">^~&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">cool&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">adminws&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9980&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Upgrade&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_upgrade&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Connection&lt;/span> &lt;span class="s2">&amp;#34;Upgrade&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_read_timeout&lt;/span> &lt;span class="mi">36000&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="管理">管理
&lt;/h5>&lt;p>https://&lt;!-- raw HTML omitted -->/browser/dist/admin/admin.html&lt;/p>
&lt;h3 id="配置cloudreve">配置cloudreve
&lt;/h3>&lt;p>管理员登陆 ，到后台，参数设施 图像预览 WOPI 客户端 启用&lt;/p>
&lt;h3 id="进阶">进阶
&lt;/h3>&lt;h4 id="安装中文字体">安装中文字体
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -c https://ghproxy.com/https://github.com/joyanhui/file.leiyanhui.com/archive/refs/heads/windows_font.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unzip windows_font.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv file.leiyanhui.com-windows_font win_font
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重建docker&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker stop code &amp;amp;&amp;amp; docker rm code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -t -d -p 9980:9980 --name code --hostname code \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v /root/win_font:/usr/share/fonts/win_font \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e TZ=Asia/Shanghai \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e dictionaries=zh-CN \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &amp;#34;aliasgroup1=https://pan.jia.leiyanhui.com:5213&amp;#34; \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &amp;#34;username=admin&amp;#34; \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &amp;#34;password=admin&amp;#34; \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --restart always collabora/code
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入docker 继续处理&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># docker exec -u 0 -it code /bin/bash #必须带 -u 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /etc/issue # Ubuntu 18.04.6 LTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fc-cache -fv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coolwsd-systemplate-setup /opt/cool/systemplate /opt/collaboraoffice
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt install collaboraofficebasis-zh-cn # 发现已经安装
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt -y install language-pack-zh-hans language-pack-zh-hans-base
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">exit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># docker restart code
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>本文参考官方手册：https://docs.cloudreve.org/use/wopi&lt;/p>
&lt;p>&lt;a class="link" href="https://sdk.collaboraonline.com/docs/installation/CODE_Docker_image.html#code-docker-image" target="_blank" rel="noopener"
>https://sdk.collaboraonline.com/docs/installation/CODE_Docker_image.html#code-docker-image&lt;/a>&lt;/p></description></item><item><title>lxc alpine下使用cloudreve 和 onlyoffice 的配置 包括onlyoffice的配置</title><link>https://dev.leiyanhui.com/pve/lxc-nas-office-onlyoffice/</link><pubDate>Mon, 13 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-office-onlyoffice/</guid><description>&lt;p>因为对LibreOffice的兼容性不看好，加上Collabora Online (LibreOffice Online)的界面语言显示不知道到底和什么有关。加上网络上关于他的资料多数较老。所以继续尝试onlyoffice。&lt;br>
onlyoffice 社区开源版本，限制20个文件同时编辑。但是因为开源，所以是可以绕过去的。我这里用不到所以没有尝试修改这个限制。&lt;br>
本文主要内容：&lt;/p>
&lt;ul>
&lt;li>搭建公网环境可用的onlyoffice&lt;/li>
&lt;li>限制仅限自己可用的onlyoffice&lt;/li>
&lt;/ul>
&lt;p>基于 pve7.3-4 lxc alpine3.17&lt;/p>
&lt;h2 id="初步搭建">初步搭建。
&lt;/h2>&lt;h3 id="lxc-alpine安装docker">lxc alpine安装docker
&lt;/h3>&lt;p>参考之前的文章：基本配置和安装docker &lt;a class="link" href="https://dev.leiyanhui.com/pve/alpine-docker" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/alpine-docker&lt;/a>&lt;/p>
&lt;h3 id="准备证书">准备证书
&lt;/h3>&lt;p>我这里是 部署到github上的acme.sh，直接拉回来解压&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">wget https://github.com/joyanhui/ssl/raw/main/ssl.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add p7zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7z x ssl.zip -p密码 #密码和p字母之间没有空格
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>自动更新 参考 ：&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-updatessl-form-github" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/web/auto-updatessl-form-github&lt;/a>&lt;/p>
&lt;h3 id="docker安装onlyoffice">docker安装onlyoffice
&lt;/h3>&lt;p>onlyoffice 依赖不少，直接docker弄吧。 我这里证书用nginx处理，方便后面禁止别人使用。&lt;br>
也可以把证书挂载到 /var/www/onlyoffice/Data/certs/ &lt;code>onlyoffice.crt onlyoffice.key&lt;/code> 直接开443。如果你有80和443的话，他好像会自动帮你申请证书。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run -itd -p 8080:80 --name office2 -e WOPI_ENABLED=true --restart always -e TZ=Asia/Shanghai onlyoffice/documentserver
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打开检查&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">http://10.1.1.84:8080
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>群友的,可以参考&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">run&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">9001&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">80&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">9002&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">443&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">WOPI_ENABLED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">DocumentServer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">logs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">DocumentServer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">www&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Data&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">DocumentServer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">DocumentServer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rabbitmq&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">DocumentServer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">redis&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">redis&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">DocumentServer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">postgresql&lt;/span> &lt;span class="n">onlyoffice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">documentserver&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="nginx反代">nginx反代
&lt;/h3>&lt;p>alpine下nginx的配置文件 是在 http.d 目录下哈&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">service&lt;/span> &lt;span class="n">nginx&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nginx&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="n">reload&lt;/span> &lt;span class="c1"># 重载&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mv /etc/nginx/http.d/default.conf /etc/nginx/http.d/default.conf-bak #非必须
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/nginx/http.d/office.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>内容，如果你还有其他虚拟主机，记得处理 段落位置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">upstream docservice {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server 127.0.0.1:8080;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">map $http_host $this_host {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;&amp;#34; $host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default $http_host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">map $http_x_forwarded_proto $the_scheme {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default $http_x_forwarded_proto;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;&amp;#34; $scheme;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">map $http_x_forwarded_host $the_host {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default $http_x_forwarded_host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;&amp;#34; $this_host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">map $http_upgrade $proxy_connection {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default upgrade;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;&amp;#34; close;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">proxy_set_header Upgrade $http_upgrade;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">proxy_set_header Connection $proxy_connection;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">proxy_set_header X-Forwarded-Host $the_host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">proxy_set_header X-Forwarded-Proto $the_scheme;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#陷阱主机 为了拦截域名错误的请求
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">server {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 10011 ssl;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name trap.ddns.leiyanhui.com *.ddns.leiyanhui.com *.leiyanhui.com;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate /root/ssl/ddns.leiyanhui.com.cer; # fullchain.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate_key /root/ssl/ddns.leiyanhui.com.key; #privkey.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_verify_client off;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_tokens off;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /usr/share/nginx/html;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#真实主机
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">server {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 10011 ssl;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name office.ddns.leiyanhui.com;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_tokens off;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /usr/share/nginx/html;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 证书位置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate /root/ssl/ddns.leiyanhui.com.cer; # fullchain.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate_key /root/ssl/ddns.leiyanhui.com.key; #privkey.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_verify_client off;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_ciphers &amp;#34;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&amp;#34;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_session_cache builtin:1000 shared:SSL:10m;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_prefer_server_ciphers on;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add_header Strict-Transport-Security &amp;#34;max-age=1209600; includeSubDomains&amp;#34; always;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add_header X-Content-Type-Options nosniff;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8080;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_http_version 1.1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>另外找到 nginx.conf 的 &lt;code>ssl_session_cache shared:SSL:2m;&lt;/code> 注释掉&lt;br>
重载nginx &lt;code>nginx -s reload&lt;/code>&lt;/p>
&lt;h3 id="测试">测试
&lt;/h3>&lt;p>打开网站 &lt;a class="link" href="https://office.ddns.leiyanhui.com:10011/" target="_blank" rel="noopener"
>https://office.ddns.leiyanhui.com:10011/&lt;/a> 没问题了，在cloudreve 后台面板中 图像预览中配置
&lt;code>https://office.ddns.leiyanhui.com:10011/hosting/discovery&lt;/code> 打开office文档测试&lt;/p>
&lt;blockquote>
&lt;p>注意和Collabora Online (LibreOffice Online)不同的地方。onlyoffice 对 doc xsl ppt 旧版格式 是不支持的，这个困扰我好久，最后在 cloudreve作者的提醒下 才知道，必须用 docx xslx pptx&lt;/p>&lt;/blockquote>
&lt;h2 id="限制只能自己使用">限制只能自己使用
&lt;/h2>&lt;p>因为onlyoffice 没有验证功能，所以任何人知道你接口地址 后 都可以访问你。那么就会导致 很容易超过20个文件的限制。而且自己资源被别人白嫖你心理也不爽。&lt;/p>
&lt;h3 id="初步解决方案">初步解决方案
&lt;/h3>&lt;p>前面 nginx 配置的 server_name 的 域名弄一个复杂的子域名 ，例如上例中的 &lt;code>office.ddns.leiyanhui.com&lt;/code> 修改成 &lt;code>office-ankN35wvy5owLv-3JtR8cCguagRct.ddns.leiyanhui.com&lt;/code>&lt;br>
如果要这样做，这个子域名 必须是泛域名的一个下级域名，dns解析记录里面 不应该有他。&lt;br>
比如，我的*.ddns.leiyanhui.com cname 到ddns.leiyanhui.com，ddns.leiyanhui.com 配置了ddns。这样几乎没有被扫到可能性。&lt;/p>
&lt;p>然后分享预览，最好也关闭。不然依旧会暴露。&lt;/p>
&lt;h3 id="限制referers">限制referers
&lt;/h3>&lt;p>前面的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8080;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_http_version 1.1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改为&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_referers none blocked 调用域名.com onlyoffice的域名.com;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if ($invalid_referer) {return 403;}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8080;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_http_version 1.1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>同时把 cloudreve和onlyoffice 的地址添加进去即可&lt;/p>
&lt;h3 id="限制wopisrc">限制wopisrc
&lt;/h3>&lt;p>在前面的 location / 再添加一段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> location /hosting/wopi {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if ( $args ~ wopisrc=https%3A%2F%2F你的域名.com%3A ) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8080;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_http_version 1.1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>%3A 是冒号转义符 后面跟的端口号，如果你的没有记得删除%3A。&lt;/p>&lt;/blockquote></description></item><item><title>lxc alpine下使用cloudreve替代nginx搭建webdav 并开启smb/nfs和sftp</title><link>https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve/</link><pubDate>Mon, 13 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve/</guid><description>&lt;blockquote>
&lt;p>2023年6月30日 补充：因cloudreve 的webui其实完成度并不高，office的wopi也有一些问题，issues基本停滞在你提你的作者自己有自己的想法，或者说压根无人处理的状态。 我最终选了filerun 并搭上了filerun的最后一班免费10用户的车。nextcloud 因为web界面一直卡卡的感觉处于备用状态。自己尝试用go 或者rust重写一个webui来用，但是尚未有太多进展。 核心的webdav sftp smb 我全部改为rclone server实现。具体站内搜索。&lt;/p>&lt;/blockquote>
&lt;p>cloudreve 是优秀的国产开源程序，使用golang写的，轻量高性能，3.7版本以后开始支持 wopi扩展office在线编辑。而且可以直接加ssl 以及对象储存支持等&lt;/p>
&lt;p>要说缺点。。。就是ios客户端 收费。。。不过有第三方webdav 客户端这个也不算太大缺点。&lt;/p>
&lt;p>但是 cloudreve 貌似不支持默认路径储存，也就是无法和smb无缝配合,而且他的数据库功能也就限制了，你要使用smb的话，就必须要要 先挂载webdav 再开启smb套娃&amp;hellip;&lt;/p>
&lt;p>买断的话 实际最少价格 是 399 + 398 不便宜，不过好在免费版本也可以用&lt;/p>
&lt;p>本文主要内容&lt;/p>
&lt;blockquote>
&lt;p>利用 几个开源golang程序 搭建 轻量但是灵活高性能nas
cloudreve 搭建在线web网盘和webdav，acme.sh获取域名证书，rclone挂载到本地，samba wsdd搭建smb，openssh搭建sftp&lt;/p>&lt;/blockquote>
&lt;h2 id="alpine的配置">alpine的配置
&lt;/h2>&lt;p>宿主机器 依旧是使用lxc的alpine alpine 容器的创建和基本配置 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;/p>
&lt;p>创建特权容器 10000 ，模板 alpine 3.17 ，磁盘0.5G cpu12核 ，内存 1024 swap 0 开dhcp 并且在选项里面 打开 嵌套 和fuse。
挂载 pve上的物理过来&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pct set 10000 -mp0 /dev/sda1,mp=/mnt/sda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pct start 10000 #启动
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其他修改源 时区 还有常用工具安装 参考 &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;/p>
&lt;h2 id="安装-cloudreve">安装 cloudreve
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sda1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">wget&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cloudreve&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Cloudreve&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">releases&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cloudreve_3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">7.0&lt;/span>&lt;span class="n">_linux_amd64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tar&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">zxvf&lt;/span> &lt;span class="n">cloudreve&lt;/span>&lt;span class="o">*.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">LICENSE&lt;/span> &lt;span class="n">README&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">cloudreve&lt;/span>&lt;span class="o">*.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">./&lt;/span>&lt;span class="n">cloudreve&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动后会自动显示 端口和 用户密码等&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[Info] 02-13 14:38:39 Admin user name: admin@cloudreve.org
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[Info] 2023-02-13 14:38:39 Admin password: HMLXclhK
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>cloudreve 的本机储存 是放在同目录的upload目录下，所以。。cloudreve 可以直接放到 lxc直通硬盘里面。&lt;/p>
&lt;h3 id="配置cloudreve本地储存路径">配置cloudreve本地储存路径
&lt;/h3>&lt;p>这个步骤可以省略，我这里直接放到了/mnt/sda1/ 并在 另外一个容器中用duplicati+alist 整体备份sda1 到阿里云盘
1、增加一个本地储存策略 名称“本地机械硬盘” /mnt/sda1/cloudreve/{uid}/{path}&lt;br>
2、修改对应用户组 储存策略 为 “本地机械硬盘”&lt;/p>
&lt;h3 id="alpine下配置自动启动和守护">alpine下配置自动启动和守护
&lt;/h3>&lt;p>用supervisor 更简单一些&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add supervisor nano
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add supervisord boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service supervisord restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>初始化配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">echo_supervisord_conf &amp;gt; /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编辑或者添加文件末尾两行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[include]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">files = /mnt/sda1/conf/supervisor/*.ini
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir -p /mnt/sda1/conf/supervisor/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /mnt/sda1/conf/supervisor/cloudreve.ini
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>根据自己的情况配置 注意这个文件是ini格式的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[program:cloudreve]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">directory=/mnt/sda1/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">command=/mnt/sda1/cloudreve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">autostart=true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">autorestart=true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">;stderr_logfile=/tmp/cloudreve.err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">;stdout_logfile=/tmp/cloudreve.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">environment=CODENATION_ENV=prod
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>管理&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">supervisord -c /etc/supervisord.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl start cloudreve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl restart cloudreve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl stop cloudreve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">supervisorctl status cloudreve
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置ssl">配置ssl
&lt;/h3>&lt;p>我这里为了避免麻烦，直接用cloudreve+acme.sh&lt;/p>
&lt;h4 id="acmesh">acme.sh
&lt;/h4>&lt;h5 id="安装">安装
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add curl openssl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl https://get.acme.sh | sh -s email=joyanhui@qq.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>acme.sh 依赖openssl，国内手动安装&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add wget unzip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget https://ghproxy.com/https://github.com/acmesh-official/acme.sh/archive/refs/heads/master.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unzip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv acme.sh-master .acme.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf master.zip .acme.sh/.githu
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="配置dns">配置dns
&lt;/h5>&lt;p>我这里用的dnspod,先登录到 dnspod 账号, 生成你的 api id 和 api key, 这个简单，自己看dnspod操作即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">vi /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>末尾添加&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="k">export&lt;/span> &lt;span class="n">DP_Id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;1243354&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">export&lt;/span> &lt;span class="n">DP_Key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;XXXXXXXXXXXXXXXXXXXX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">alias&lt;/span> &lt;span class="n">acme&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sh&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/.&lt;/span>&lt;span class="n">acme&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sh&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">acme&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sh&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启用和测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">source /etc/profile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo $DP_Id
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="创建证书">创建证书
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">acme.sh --register-account -m joyanhui@qq.com --issue --dns dns_dp -d jia.leiyanhui.com -d *.jia.leiyanhui.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其他参数&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">--server letsencrypt # 更换letsencrypt证书，默认是zerossl的
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>检查计划任务, 顺带修改一下时间，避开高峰期。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">crontab -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">========
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">20 14 * * * &amp;#34;/root/.acme.sh&amp;#34;/acme.sh --cron --home &amp;#34;/root/.acme.sh&amp;#34; &amp;gt; /dev/null
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置cloudreve-使用ssl证书">配置cloudreve 使用ssl证书
&lt;/h4>&lt;p>&lt;code>conf.ini&lt;/code> 添加一段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[SSL]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Listen = :5213
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CertPath = /root/.acme.sh/jia.leiyanhui.com_ecc/fullchain.cer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">KeyPath = /root/.acme.sh/jia.leiyanhui.com_ecc/jia.leiyanhui.com.key
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启 &lt;code>supervisorctl restart cloudreve&lt;/code>&lt;/p>
&lt;p>打开 &lt;code>https://10.1.1.80:5213/&lt;/code> 查看 当然证书肯定是有问题的，但是可以看到证书对应到域名了。&lt;/p>
&lt;h3 id="进阶">进阶
&lt;/h3>&lt;h4 id="数据库">数据库
&lt;/h4>&lt;p>文件多，或者用户数比较多的情况下，最好启用mysql数据库。&lt;/p>
&lt;h4 id="在线编辑office">在线编辑office
&lt;/h4>&lt;p>使用wopi &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-office" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas-office&lt;/a>&lt;/p>
&lt;h3 id="其他问题">其他问题
&lt;/h3>&lt;p>目前cloudreve webdav上传的文件不能自动创建缩略图，作者表示3.8版本会修复。&lt;/p>
&lt;h2 id="本机挂载webdav-为smb和sftp准备">本机挂载webdav 为smb和sftp准备
&lt;/h2>&lt;h3 id="创建webdav密码">创建webdav密码
&lt;/h3>&lt;p>cloudreve的webdav密码是独立的，帐号是和用户名的邮箱通用的。&lt;br>
前台登录后，点击 链接 webdav 创建新帐号，输入备注，然后密码是自动生成的，用户名是当前用户。&lt;/p>
&lt;h3 id="挂载">挂载
&lt;/h3>&lt;h4 id="rclone">rclone
&lt;/h4>&lt;p>davfs2 的挂载后有一些小问题，不太确定原因。推荐使用rclone&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">curl&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">O&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">downloads&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rclone&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rclone&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">current&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">unzip&lt;/span> &lt;span class="n">rclone&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">current&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="n">rclone&lt;/span>&lt;span class="o">-*-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="n">rclone&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chown&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rclone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chmod&lt;/span> &lt;span class="mi">755&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rclone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rclone&lt;/span> &lt;span class="n">config&lt;/span> &lt;span class="c1">#按照提示创建一个webdav节点 名称 cloudreve，vendor选择nextcloud就行，按照提示配置账户密码，其他默认&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>rclone的配置文件如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[cloudreve]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">type = webdav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">url = https://外网地址:5213/dav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vendor = nextcloud
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user = 你的邮箱
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pass = 加密后的密码
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="手动挂载">手动挂载
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /mnt/dav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add fuse
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rclone mount cloudreve:/ /mnt/dav
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="开机自动挂载">开机自动挂载
&lt;/h3>&lt;p>这里一方面 需要开机自动运行，一方面还需要cloudreve启动后 才可以。
证书忽略 &lt;code>--insecure &lt;/code> 或者 &lt;code>-k&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">serv_http_code=`curl -I -k -m 10 -o /dev/null -s -w %{http_code} https://localhost:5213/`
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo $serv_http_code
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>创建一个脚本 &lt;code>nano /etc/local.d/mount_webdav.start&lt;/code> 后台启动一个脚本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sh /mnt/sda1/mount_webdav.sh &amp;amp;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>chmod +x /etc/local.d/mount_webdav.start&lt;/code> &lt;br>
以及一个shell用来判断cloudreve的状态，如果没启动 那么尝试去启动，代码很简单。&lt;br>
&lt;code>nano /mnt/sda1/mount_webdav.sh&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">while :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">do
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> serv_http_code=`curl -I -k -m 10 -o /dev/null -s -w %{http_code} https://localhost:5213/`
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> echo &amp;#34;检查cloudreve状态：&amp;#34;${serv_http_code}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if [ &amp;#34;$serv_http_code&amp;#34; -eq &amp;#34;200&amp;#34; ];then
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if grep -qs &amp;#39;/mnt/dav&amp;#39; /proc/mounts; then
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> echo &amp;#34;已经挂载 不需要做任何事情&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> echo &amp;#34;备份数据库文件&amp;#34; &amp;amp;&amp;amp; cp /root/cloudreve.db /mnt/dav/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> echo &amp;#34;未曾挂载，尝试挂载&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nohup rclone mount cloudreve:/ /mnt/dav &amp;amp;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> #echo &amp;#34;备份数据库文件&amp;#34; &amp;amp;&amp;amp; cp /root/cloudreve.db /mnt/dav/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> umount /mnt/dav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> supervisorctl restart cloudreve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">done
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rc-update add local #添加一个local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service local restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启测试，&lt;code>ls /mnt/dav&lt;/code> 应该可以看到 lost+found 那就是没问题了。&lt;/p>
&lt;h2 id="配置smb">配置smb
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add samba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add samba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbpasswd -a root # 配置用户的 smb密码 注意这个用户和运行cloudreve的用户 必须是同一个 否则会有权限冲突。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add wsdd #发现服务
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add wsdd boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service wsdd restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 创建一个文件夹给 pve用 `mkdir /mnt/dav/pve-node`
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/samba/smb.conf &amp;amp;&amp;amp; nano /etc/samba/smb.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># nano /etc/samba/smb.conf 编辑完成后重启 samba start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">allow insecure wide &lt;span class="nv">links&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">workgroup&lt;/span> &lt;span class="o">=&lt;/span> WORKGROUP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp866
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> utf-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>webdav&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span> &lt;span class="o">=&lt;/span> /mnt/dav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">writable&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">write &lt;span class="nv">list&lt;/span> &lt;span class="o">=&lt;/span> root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">valid &lt;span class="nv">users&lt;/span> &lt;span class="o">=&lt;/span> root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">display &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp936
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>sda1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span> &lt;span class="o">=&lt;/span> /mnt/sda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">writable&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">write &lt;span class="nv">list&lt;/span> &lt;span class="o">=&lt;/span> root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">valid &lt;span class="nv">users&lt;/span> &lt;span class="o">=&lt;/span> root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">display &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp936
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#下面这段给pve挂载用 mkdir /mnt/sda1/pve&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>pve-node&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span> &lt;span class="o">=&lt;/span> /mnt/dav/pve-node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">writable&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">write &lt;span class="nv">list&lt;/span> &lt;span class="o">=&lt;/span> root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">valid &lt;span class="nv">users&lt;/span> &lt;span class="o">=&lt;/span> root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">display &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp936
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">rc-service samba restart &lt;span class="c1">#重启&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>windows下应该可以直接能访问了。如果不可以 可能需要 重启几次。&lt;/p>
&lt;h3 id="sftp配置">sftp配置
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add openssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add sshd boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service sshd restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>允许root 密码登录&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># nano /etc/ssh/sshd_config 添加或者编辑下面内容 然后重启 service sshd restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PermitRootLogin yes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve下使用lxc 直通硬盘搭建 nas 服务 全面替代群晖 freenas OMV 等 异地备份</title><link>https://dev.leiyanhui.com/pve/lxc-nas-autobackup/</link><pubDate>Wed, 08 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-autobackup/</guid><description>&lt;p>本文 是 pve lxc 搭建nas 的系列文章 的一部分。 因为篇幅较长，所以分开。&lt;/p>
&lt;p>原文索引 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;/p>
&lt;p>本文主要内容 本地重要数据的异地备份 的相关记录。&lt;/p>
&lt;p>duplicati 不支持alpine 直接安装，官网的包用的 zst 压缩的deb，alpine下的dpkg 弄不死&lt;/p>
&lt;h3 id="alpine-容器的创建和基本配置">alpine 容器的创建和基本配置
&lt;/h3>&lt;p>原文索引 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;br>
硬盘要分2G，duplicati体积不小&lt;/p>
&lt;h3 id="挂载物理硬盘">挂载物理硬盘
&lt;/h3>&lt;p>查看前面的alpine 容器的创建和基本配置,简单说就一行命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pct set 10081 -mp0 /dev/sda1,mp=/mnt/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="安装docker">安装docker
&lt;/h3>&lt;p>特权容器安装docker 需要打开嵌套，并手动修改一下cnf文件
原文索引 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-docker-err" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-docker-err&lt;/a>&lt;/p>
&lt;h3 id="alist-挂载网盘">alist 挂载网盘
&lt;/h3>&lt;p>支持很多网盘的一个小程序，适合把网盘转webdav。目录列表功能可以加密。 alist具体安装过程掠过，官网文档很全。&lt;/p>
&lt;h3 id="docker-运行">docker 运行
&lt;/h3>&lt;p>我这里选择duplicati，比自己写shell脚本简单很多，而且支持可视化界面，支持加密备份。&lt;br>
缺点是体积比较大，不算轻量。 这个lxc要&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run -d \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --name=duplicati --hostname=duplicati \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e PUID=1000 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e PGID=1000 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e TZ=Asia/Shanghai \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p 80:8200 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v /root/config-duplicati:/config \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v /root/backups-duplicati:/backups \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v /mnt/sda1:/mnt/sda1 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --restart unless-stopped \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> linuxserver/duplicati:latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>backups 这个目录是本地存放备份的目录，因为我主要是异地备份到 阿里云盘 和 对象储存，所以这里就保持默认 &lt;br>
source 是原始目录。可以配置为在前面挂载过来的物理硬盘. &lt;br>
因为这个lxc只运行这一个docker，所以80端口直接分给他&lt;/p>&lt;/blockquote>
&lt;h3 id="配置duplicati">配置duplicati
&lt;/h3>&lt;p>打开网页 http://lxc的ip+端口 例如 http://10.1.1.213/ 刚刚加载进来页面是英文的，先提示创建密码，点yes。然后界面就自动转换中文了。&lt;/p>
&lt;p>设置完成密码后 重新登录，而后 新增备份即可。&lt;/p>
&lt;p>文件可加密后备份，也可以分卷 也可以定时清理过期数据 还是很方便的。&lt;/p></description></item><item><title>pve下使用lxc 直通硬盘搭建 nas 服务 全面替代群晖 freenas OMV 等 服务套ssl</title><link>https://dev.leiyanhui.com/pve/lxc-nas-ssl/</link><pubDate>Wed, 08 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-ssl/</guid><description>&lt;p>本文 是 pve lxc 搭建nas 的系列文章 的一部分。 因为篇幅较长，所以分开。&lt;/p>
&lt;p>原文索引 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;/p>
&lt;p>本文主要内容 webdav https-git minio s3对象储存 思源 套ssl的相关记录。&lt;/p>
&lt;p>我这里使用 nginxwebui的修改版本，具体看看之前文章&lt;a class="link" href="https://dev.leiyanhui.com/openwrt/nginx-proxy-ssl/" target="_blank" rel="noopener"
>点这里&lt;/a>。这里只记录最终配置文件。&lt;/p>
&lt;h2 id="nginx反代思源">nginx反代思源
&lt;/h2>&lt;p>需要ws，最终配置如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">server {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name 域名;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 50443 ssl http2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate /home/nginxWebUI/.acme.sh/域名/fullchain.cer;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate_key /home/nginxWebUI/.acme.sh/域名/jia.leiyanhui.com.key;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 50080;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if ($scheme = http) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return 301 https://$host:50443$request_uri;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> error_page 497 https://$host:50443; #解决http到ssl端口的400错误;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://10.1.1.68/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_redirect http:// https://;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location /ws {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://10.1.1.68;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_http_version 1.1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Upgrade $http_upgrade;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Connection &amp;#34;upgrade&amp;#34;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_redirect http:// https://;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_read_timeout 60s;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="nginx反代网盘类">nginx反代网盘类
&lt;/h2>&lt;p>需要安装模块 &lt;code>more_set_headers&lt;/code> alpine下包名称&lt;code>nginx-mod-http-headers-more&lt;/code>
在nginx.conf配置文件的http块（注意 不是 server块）中添加map指令，将请求头Destination中的https替换为http，并解决webdav重命名中文文件夹的乱码问题：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">map $http_destination $webdav_dest {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ~*https://(.+) http://$1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default $http_destination;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">location&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">For&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Forwarded&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Proto&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">scheme&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">Host&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Real&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ne">IP&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="ne">Range&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_range&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_set_header&lt;/span> &lt;span class="n">If&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ne">Range&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">http_if_range&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_redirect&lt;/span> &lt;span class="n">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proxy_pass&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">5244&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># the max size of file to upload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client_max_body_size&lt;/span> &lt;span class="mi">20000&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve下使用lxc 直通硬盘搭建 nas 服务 全面替代群晖 freenas OMV 等 核心 之 smb sftp webdav</title><link>https://dev.leiyanhui.com/pve/lxc-nas-core/</link><pubDate>Wed, 08 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-nas-core/</guid><description>&lt;p>本文已经更新为 使用cloudreve和davfs 搭建多合1 文件中心 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas-core-cloudreve&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>2023年6月30日 补充：因cloudreve 的webui其实完成度并不高，office的wopi也有一些问题，issues基本停滞在你提你的作者自己有自己的想法，或者说压根无人处理的状态。 我最终选了filerun 并搭上了filerun的最后一班免费10用户的车。nextcloud 因为web界面一直卡卡的感觉处于备用状态。自己尝试用go 或者rust重写一个webui来用，但是尚未有太多进展。 核心的webdav sftp smb 我全部改为rclone server实现。具体站内搜索。&lt;/p>&lt;/blockquote>
&lt;p>本文 是 pve lxc 搭建nas 的系列文章 的一部分。 因为篇幅较长，所以分开。&lt;/p>
&lt;p>原文索引 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;/p>
&lt;p>本文主要内容 是 直通 硬盘 以及配置 smb sftp webdav 相关 nas的基础应用。&lt;/p>
&lt;h4 id="alpine-容器的创建和基本配置">alpine 容器的创建和基本配置
&lt;/h4>&lt;p>原文索引 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-nas" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-nas&lt;/a>&lt;/p>
&lt;h4 id="安装sudo-nano">安装sudo nano
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 用更加轻量的doas 替代sudo nano替代vi lxc 内运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add doas nano
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk del vim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ln -s /usr/bin/doas /usr/bin/sudo &lt;span class="c1">#替代sudo&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="添加用户">添加用户
&lt;/h4>&lt;p>先添加一个用户 作为 三个服务的登录用户 并给他sudo权限，lxc 内运行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">adduser -g yanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">adduser yanhui -G wheel &lt;span class="c1">#添加用戶到wheel 输入密码 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;permit persist :wheel&amp;#34;&lt;/span>&amp;gt;/etc/doas.d/doas.conf &lt;span class="c1">#把用户添加到doas&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置磁盘目录所有者权限">配置磁盘目录所有者权限
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">chown -R yanhui:wheel /mnt/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="开启配置sftp-smb-webdav">开启配置sftp smb webdav
&lt;/h2>&lt;h3 id="sftp">sftp
&lt;/h3>&lt;p>直接安装openssh ，不推荐dropbear&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apk add openssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add sshd boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service sshd restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="smb">smb
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apk add samba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add samba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbpasswd -a yanhui &lt;span class="c1"># 配置用户的 smb密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/samba/smb.conf &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> nano /etc/samba/smb.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># nano /etc/samba/smb.conf 编辑完成后重启 samba start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">allow insecure wide &lt;span class="nv">links&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">workgroup&lt;/span> &lt;span class="o">=&lt;/span> WORKGROUP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp866
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> utf-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>cloudreve&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span> &lt;span class="o">=&lt;/span> /mnt/sda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">writable&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">write &lt;span class="nv">list&lt;/span> &lt;span class="o">=&lt;/span> yanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">valid &lt;span class="nv">users&lt;/span> &lt;span class="o">=&lt;/span>yanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">display &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp936
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#下面这段给pve挂载用 mkdir /mnt/sda1/pve&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>pve&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span> &lt;span class="o">=&lt;/span> /mnt/sda1/pve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">writable&lt;/span> &lt;span class="o">=&lt;/span> yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">write &lt;span class="nv">list&lt;/span> &lt;span class="o">=&lt;/span> yanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">valid &lt;span class="nv">users&lt;/span> &lt;span class="o">=&lt;/span>yanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">display &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unix &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dos &lt;span class="nv">charset&lt;/span> &lt;span class="o">=&lt;/span> cp936
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">rc-service samba restart &lt;span class="c1">#重启&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>windows资源管理器 打开 &lt;code>\\10.1.1.80&lt;/code>​ 即可访问，windows无法发现，是因为没有开始 wdds，需要的话继续&lt;/p>
&lt;h4 id="wsdd">wsdd
&lt;/h4>&lt;p>wsdd 就是 是 smb的网络发现服务。alpine仓库自带&lt;br>
&lt;a class="link" href="https://github.com/christgau/wsdd" target="_blank" rel="noopener"
>https://github.com/christgau/wsdd&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add wsdd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add wsdd boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service wsdd restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="webdav">webdav
&lt;/h3>&lt;p>选择最熟悉的nginx来处理。nginx搭建的webdav有一些小问题。 推荐使用 cloudreve&lt;/p>
&lt;p>cloudreve搭建网盘 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-cloudreve" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-cloudreve&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apk add nginx nginx-mod-http-dav-ext openssl nginx-mod-http-headers-more
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;yanhui:&lt;/span>&lt;span class="k">$(&lt;/span>openssl passwd 123456&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;/etc/nginx/.passwords.list &lt;span class="c1"># 这个用户和系统用户完全不相关,只是重名&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>配置nginx运行用户&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">nano /etc/nginx/nginx.conf &lt;span class="c1"># 把 user nginx; 这行注释掉，添加一行 user yanhui wheel; access_log 这行如果不需要日志也注释掉&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="nginx一些小问题">nginx一些小问题
&lt;/h4>&lt;p>首行添加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">load_module&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginx&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">modules&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ngx_http_headers_more_filter_module&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">so&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>后面添加一段,http部分&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">map $http_destination $webdav_dest {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ~*https://(.+) http://$1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default $http_destination;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>创建webdav用户，通过上面的ngin.conf 我们知道 alpine下配置文件 在 &lt;code>/etc/nginx/http.d/&lt;/code>​&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mv /etc/nginx/http.d/default.conf /etc/nginx/http.d/default.conf-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/nginx/http.d/webdav.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 80&lt;span class="p">;&lt;/span> &lt;span class="c1">#这个端口号如果要用80 需要另外处理一下/etc/nginx/nginx.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name localhost&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#打开目录浏览功能&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> autoindex on&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#默认为on，显示出文件的确切大小，单位是bytes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#显示出文件的大概大小，单位是kB或者MB或者GB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> autoindex_exact_size off&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#时间显示默认为off，显示的文件时间为GMT时间。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#改为on后，显示的文件时间为文件的服务器时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> autoindex_localtime on&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add_header Cache-Control no-store&lt;span class="p">;&lt;/span> &lt;span class="c1">#让浏览器不保存临时文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 设置使用utf-8编码,防止中文文件名乱码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> charset utf-8&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 默认存放文件的路径&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /mnt/sda1&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_basic realm_name&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 用户密码文件存放位置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_basic_user_file /etc/nginx/.passwords.list&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># dav 允许的操作&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dav_methods PUT DELETE MKCOL COPY MOVE&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dav_ext_methods PROPFIND OPTIONS&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 创建文件的默认权限&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dav_access user:rw group:rw all:r&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 临时文件位置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client_body_temp_path /tmp&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 最大上传文件限制, 0表示无限制&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client_max_body_size 0&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 允许自动创建文件夹(如果有需要的话)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> create_full_put_path on&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">rc-update add nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-service nginx start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx -s reload &lt;span class="c1"># 重载&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>Windows下挂载webdav 建议用第三方工具 (RaiDrive CyberDuck WinSCP)， 默认不支持 非https，大文件 写入有问题&lt;/p>&lt;/blockquote>
&lt;h3 id="清理和备份">清理和备份
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===========================&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/issue
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;==== nas core ====&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/issue
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===========================&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/issue
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===========================&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;==== nas core ====&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===========================&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;/etc/doas.d/doas.conf&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;/etc/samba/smb.conf &amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;WebDav paswd /etc/nginx/.passwords.list &amp;#34;&lt;/span>&amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;/etc/nginx/nginx.conf&amp;#34;&lt;/span>&amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;/etc/nginx/http.d/webdav.conf&amp;#34;&lt;/span>&amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===========================&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;rc-service samba restart&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;rc-service nginx restart&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;rc-service sshd restart&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===========================&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/motd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/cache/apk/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm .ash_history
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">poweroff
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>lxc 关机备份，备份完成后 系统只有区区的 37M 舒服&lt;/p>
&lt;h3 id="webdav套ssl">webdav套ssl
&lt;/h3>&lt;p>我这里用一个单独的lxc运行 nginx和acme.sh&lt;/p>
&lt;p>详情查看 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-ssl" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-ssl&lt;/a>&lt;/p></description></item><item><title>pve lxc 修改名字</title><link>https://dev.leiyanhui.com/pve/lxc-rename/</link><pubDate>Tue, 07 Feb 2023 07:10:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-rename/</guid><description>&lt;p>pve下 vm 可以在选项里面直接修改名字，lxc容器需要自行修改文件。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lxc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="err">容器的&lt;/span>&lt;span class="n">id编号&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">config&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lxc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="err">容器的&lt;/span>&lt;span class="n">id编号&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>只修改后面这个文件也可以&lt;/p></description></item><item><title>pve 装群晖 系统盘分多大合适 / pve上黑群晖的更舒服的使用姿势</title><link>https://dev.leiyanhui.com/pve/pve-qh-vdisksize/</link><pubDate>Mon, 06 Feb 2023 19:11:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/pve-qh-vdisksize/</guid><description>&lt;p>本文不适合linux纯小白，对linux有所了解的可以看。&lt;/p>
&lt;p>国内 openwrt esxi pve unraid 包括 群晖 等 群体，是一个 比较有特色的人相对比较集中的群体。。。。
切莫轻信这些群里一些人言之凿凿的一些言语。&lt;code>高手&lt;/code> 太多了&lt;/p>
&lt;p>群晖系统跟Windows不同,Windows有个盘要当成系统盘,而群晖会在每个硬盘上自动安装系统。&lt;br>
对于黑群晖来说也就是 你可以只插入一个引导盘和一个数据盘就可以启动起来群晖。&lt;br>
但是在pve上，我们可以 1引导盘 1虚拟数据盘 多lxc外挂smb/nfs硬盘的方式来使用。&lt;br>
这样群晖对我们来说只是一个简单易用的nas管理工具。离开群晖，我们的硬盘依旧可以正常访问，甚至群晖关机后依旧不影响我们nas的使用。&lt;/p>
&lt;blockquote>
&lt;p>缺点： 1、门槛略高一点 2、群晖需要替换.so文件 3、cpu要参与群晖和物理硬盘之间的数据交互，会增加一点负载。&lt;/p>&lt;/blockquote>
&lt;p>这种情况下的 硬盘的分配
1、引导盘，黑群晖必须的。
2、系统盘，就是黑群晖自身的系统安装的盘，此盘多余空间 可以作为 群晖的储存池 ，也就是你可用的空间。这个磁盘用虚拟磁盘即可。
3、数据盘 N个 或者raid，一般是直通过来的硬盘，或者 挂虚拟磁盘也可以。 pve下因为有先天优势，如果你pve性能过得去，可以把硬盘先挂载到lxc开启smb/nfs后，再把盘以万兆pve内置交换挂到群晖。&lt;/p>
&lt;blockquote>
&lt;p>smb和nfs挂载的目录，群晖默认不支持照片和视频的那些操作，网上有对应的补丁可以处理。&lt;/p>&lt;/blockquote>
&lt;h4 id="引导盘">引导盘
&lt;/h4>&lt;p>通常情况下，引导盘 大家都是用 arpl 的img直接转换qcow2，然后导入到群晖中。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">qm importdisk 虚拟ID arpl镜像路径 local --format=qcow2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个磁盘是1g 实际占用空间 要看驱动集成情况。&lt;/p>
&lt;h4 id="系统盘">系统盘
&lt;/h4>&lt;p>群晖 920+ 7.1.1 42962 大概需要 10G左右空间。实际 1G多 他自己留了一部分空间 用于安装套件。低于13G会导致系统盘上无法创建储存空间。&lt;br>
众所周知的 pve的备份功能的速度 和 磁盘标注容量有关系。所以肯定是越小越好。
所以系统盘的尺寸 必须13G以上，另外部分套件占用这个储存空间，套件装基本全的话差不多，另外需要10G左右空间。
至少建议16G。 看个人需求。 我实际使用25G。
这个第二块磁盘（第一个是黑群晖引导盘），承担群晖套件和储存卷，姑且就叫系统盘&lt;/p>
&lt;h4 id="数据盘">数据盘
&lt;/h4>&lt;p>看个人情况。 重要数据，一定一定 异地备份。
既然是已经pve运行群晖了，除非你pve宿主性能非常拉跨，否则不建议硬盘直通给群晖。
更灵活方便的方式： 硬盘直通给lxc容器，开smb/nfs/webdav/sftp，而后在群晖中挂载，并替换群晖文件实现 一些不支持的套件使用。
系统盘可以现行在lxc中组raid。关于lxc系统的选择。&lt;/p>
&lt;h4 id="关于系统的备份和恢复">关于系统的备份和恢复
&lt;/h4>&lt;p>因为我们是黑群晖，引导盘和系统盘 要定期备份，群晖关机后用 pve复制对应的qcow2文件出来即可。&lt;br>
系统重装后，重新挂载smb/nfs即可。&lt;/p>
&lt;h3 id="数据盘系统">数据盘系统
&lt;/h3>&lt;h4 id="硬盘根据自己情况组建raid">硬盘根据自己情况组建raid
&lt;/h4>&lt;p>自己看情况来，软硬都可以&lt;/p>
&lt;h4 id="lxc系统">lxc系统
&lt;/h4>&lt;p>技术不到位可以omv，技术可以的话，直接 alpine / debian 装smb/nfs/nginx/sshd 配置好权限和目录 就完了。&lt;/p>
&lt;h3 id="关于-部分套件不支持--smbnfs挂载的目录问题">关于 部分套件不支持 smb/nfs挂载的目录问题
&lt;/h3>&lt;p>感谢jinlife&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">The patch for libsynosdk.so.7 will allow remote NFS/CIFS shared folder be used in VideoStation, AudioStation and Photos etc.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /volume1/homes/jinlife/libsynosdk.so.7 /usr/lib/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a class="link" href="https://github.com/jinlife/Synology_Photos_Face_Patch" target="_blank" rel="noopener"
>https://github.com/jinlife/Synology_Photos_Face_Patch&lt;/a>&lt;/p>
&lt;h3 id="关于担心黑群晖挂掉的问题">关于担心黑群晖挂掉的问题。
&lt;/h3>&lt;p>如果担心群晖升级后无法使用，不如一次性弄好以后，把所有可能要用的套件配置好。然后把虚拟机的群晖整机备份一次。&lt;br>
就此养老，天荒地老了&lt;/p></description></item><item><title>pve 用lxc容器运行docker最小化部署，以及lxc所有问题汇总！</title><link>https://dev.leiyanhui.com/pve/docker-mini/</link><pubDate>Mon, 06 Feb 2023 00:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/docker-mini/</guid><description>&lt;p>为什么用lxc运行docker，因为更轻量，相对vm运行 管理更方便。 &lt;br>
比如 家用环境的 aio上， 可以把路由器常用的功能 全部集成到一个或者多个lxc里面。 &lt;br>
pve 跑vm 再去跑docker 虽然上手简单，但是会有一些其他问题。&lt;br>
之所以用lxc去运行docker，因为很多软件只有docker版本 或为了部署/更新/备份/更方便。&lt;/p>
&lt;h3 id="最小化部署docker">最小化部署docker
&lt;/h3>&lt;p>模板选择alpine，改一下ct源。不改也可以直接去国内镜像下载，例如： &lt;a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/" target="_blank" rel="noopener"
>https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/alpine-3.17-default_20221129_amd64.tar.xz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>去掉无特权容器的勾号，ip的地方选择dhcp，然后先不开机。其他按照默认设置即可&lt;br>
点选项 功能，选中 fuse 和 嵌套。
编辑&lt;code>nano ​ /etc/pve/lxc/容器id.conf&lt;/code> 具体查看本文 &lt;code>lxc 特权容器 和非特权容器的选择&lt;/code> 章节，编辑完成后启动
启动后逐行运行，都有注释&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 替换国内源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">repositories&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装时区设置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">zoneinfo&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">localtime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;Asia/Shanghai&amp;#34;&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">timezone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 卸载时区&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">del&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="c1">#nano&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 开机启动启动docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="n">boot&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 手动启动docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">service&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看docker版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">version&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>这样运行的docker 不会有兼容性问题，也不会存在那些一知半解的人说的 什么什么不能运行的问题。&lt;/p>&lt;/blockquote>
&lt;h3 id="lxc模板的选择">lxc模板的选择
&lt;/h3>&lt;p>主要是 debian/ubuntu 和 alpine的 二选一&lt;br>
如果lxc 只打算用来跑docker 那么 肯定是首选alpine，alpine宿主lxc只有几M。如果要跑一些非docker的软件。
有几种情况下，建议选 debian/ubuntu&lt;/p>
&lt;ul>
&lt;li>alpine因为musl 和 rc的问题 和部分软件兼容性不好，可能需要手动处理一些东西。 如果你没有时间弄那些&lt;/li>
&lt;li>部分软件的发行版 不支持alpine&lt;/li>
&lt;li>想直接装deb&lt;/li>
&lt;/ul>
&lt;h3 id="lxc-特权容器-和非特权容器的选择">lxc 特权容器 和非特权容器的选择
&lt;/h3>&lt;p>无特殊情况，首选特权容器。特权容器外挂pve的目录更方便，而且特权容器也是支持docker的。&lt;code>nano ​ /etc/pve/lxc/容器id.conf&lt;/code> 添加下面几行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lxc.apparmor.profile: unconfined
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.cgroup.devices.allow: a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.cap.drop:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="lxc内运行的服务-是直接安装还是再套一次docker">lxc内运行的服务 是直接安装还是再套一次docker
&lt;/h3>&lt;p>看服务的软件情况。优选直接安装，尤其是依赖很少的服务。 &lt;br>
例如 ddns-go 作者提供二进制包，而且支持alpine，那么就没必要再套docker了。&lt;br>
再比如 思源笔记，作者没有提供二进制包，服务版只有docker版，那么就肯定就是docker来运行了。&lt;br>
再比如 alist ，如果你lxc跑的alpine ，alist能运行，但是不支持安装的启动服务里面，那么手写启动脚本，还是直接docker 那就随便你了。&lt;/p>
&lt;h3 id="一个lxc里面可以运行多少个服务多少个docker">一个lxc里面可以运行多少个服务，多少个docker
&lt;/h3>&lt;p>没有限制，但lxc也是容器，通常而言最好也遵循 一个容器一个服务的原则。 比如
lxc 100 运行openwrt 做旁路由/网关
lxc 101 运行 mosdns
lxc 102 运行 alist
lxc 103 运行 rustdesk 的两个中继服务
lxc 104 跑一个nginx webdav网盘
互相独立，这样最合理，备份和管理也方便一些。 但是你全部放到一个lxc里面 也没毛病。&lt;/p>
&lt;h3 id="lxc-创建那么多内容够用嘛">lxc 创建那么多内容够用嘛？
&lt;/h3>&lt;p>lxc 的内存 是上限内存 不是分给他就就全占用了。 所以创建你几十个lxc，但是都没有太大负载，每个都分给他10G内存，也是没问题的。&lt;/p>
&lt;h3 id="lxc-里面可以再套一次pve嘛">lxc 里面可以再套一次pve嘛？
&lt;/h3>&lt;p>理论上可以，直接套kvm 再去跑一个windows 是可以的。&lt;/p>
&lt;h3 id="lxc-内部的ssh反映慢">lxc 内部的ssh反映慢
&lt;/h3>&lt;p>选项里面 勾选 嵌套 。重启即可&lt;/p>
&lt;h3 id="lxc-内无法运行appimage-程序">lxc 内无法运行appimage 程序
&lt;/h3>&lt;p>选项里面 勾选 fuse 。重启即可&lt;/p>
&lt;h3 id="lxc-挂载外部目录-没有写权限">lxc 挂载外部目录 没有写权限
&lt;/h3>&lt;p>非特权容器需要处理用户映射，特权容器可以直接读写。详情查看 本站内文章： &lt;a class="link" href="https://dev.leiyanhui.com/pve/lxc-mount-dir/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/lxc-mount-dir/&lt;/a>&lt;/p>
&lt;h3 id="lxc-无法直接导入-openwrt的包">lxc 无法直接导入 openwrt的包
&lt;/h3>&lt;p>因为ostype 的问题，pve的webui界面操作里面不支持这个配置。用命令行导入即可,例子：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">pct&lt;/span> &lt;span class="n">create&lt;/span> &lt;span class="mi">2008&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">openwrt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">dmz&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">02.05&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">x86&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">generic&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rootfs__1_&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">arch&lt;/span> &lt;span class="n">amd64&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">hostname&lt;/span> &lt;span class="n">dmz&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">OpenWrt&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">rootfs&lt;/span> &lt;span class="n">local&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">memory&lt;/span> &lt;span class="mi">2048&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">swap&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">cores&lt;/span> &lt;span class="mi">12&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">ostype&lt;/span> &lt;span class="n">unmanaged&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">unprivileged&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">net0&lt;/span> &lt;span class="n">bridge&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">vmbr0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">eth0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="lxc-可以运行出来一个桌面嘛">lxc 可以运行出来一个桌面嘛
&lt;/h3>&lt;p>当然可以，你正常在lxc里面 安装桌面包就ok了。比如 gnome kde i3w 等等 都是可以的，而且可以开显卡加速&lt;/p>
&lt;h3 id="lxc-里面可以运行一个windows嘛">lxc 里面可以运行一个windows嘛
&lt;/h3>&lt;p>可以，甚至 运行一个macos都是可以的。当然就是和docker里面跑win跑macos一样 都是需要 lxc 里面套kvm了。&lt;/p>
&lt;h3 id="现有虚拟机导入lxc-可以嘛">现有虚拟机导入lxc 可以嘛？
&lt;/h3>&lt;p>可以，但是仅限linux虚拟机 ： &lt;a class="link" href="https://dev.leiyanhui.com/pve/kvm-to-lxc/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/kvm-to-lxc/&lt;/a>&lt;/p></description></item><item><title>pve lxc 挂载宿主机 目录 最简单方法 （特权容器）</title><link>https://dev.leiyanhui.com/pve/lxc-mount-dir/</link><pubDate>Sat, 04 Feb 2023 07:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-mount-dir/</guid><description>&lt;p>主要有两种情况，1特权容器 2 无特权容器&lt;/p>
&lt;h2 id="特权容器">特权容器
&lt;/h2>&lt;p>如果lxc创建的时候 没有勾选 无特权容器 那么直接挂载即可&lt;/p>
&lt;p>例如 lxc 的id是50443(就是pve里面显示的虚拟机和ct的那个数字) ，要把pve的 &lt;code>/nvme/lxc_mount/nginxWebUI&lt;/code>挂载到lxc容器里面的 &lt;code>/home/nginxWebUI&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>范例挂载这个目录出来是为了pve能使用nginxwebui自己签名的ssl证书，以及其他服务也可以用。&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pct set 50443 -mp1 /nvme/lxc_mount/nginxWebUI,mp=/home/nginxWebUI
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行完成后 不需要重启 即可生效。
上面的命令等同 在 &lt;code>/etc/pve/lxc/50443.conf&lt;/code> 添加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mp1: /nvme/lxc_mount/nginxWebUI,mp=/home/nginxWebUI
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>往后就mp1、mp2、mp3 。。。。&lt;/p>&lt;/blockquote>
&lt;h2 id="非特权容器">非特权容器
&lt;/h2>&lt;p>基于安全性考虑，以及嵌套docker的时候的一些问题，创建ct容器的时候，通常使用非特权容器。 这个时候直接挂载的目录可能会有权限问题。
其实可以用特权用户运行docker 查看 : &lt;a class="link" href="http://dev.leiyanhui.com/pve/kxc-docker-err" target="_blank" rel="noopener"
>http://dev.leiyanhui.com/pve/kxc-docker-err&lt;/a>&lt;/p>
&lt;h3 id="查看root用户情况">查看root用户情况
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">grep root /etc/subgid /etc/subuid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/subgid:root:100000:65536
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/subuid:root:100000:65536
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>root的从属用户起始id为100000，数量65536个。&lt;/p>&lt;/blockquote>
&lt;h3 id="修改lxc的用户">修改lxc的用户
&lt;/h3>&lt;p>把lxc里面的用户映射到pve的root用户&lt;br>
容器内root(id=0)映射为pve 服务器id 100000，递增65536个，即容器内用户id 0-65535对应服务器100000-165535
&lt;code>nano /etc/pve/lxc/50443.conf &lt;/code> 添加两行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lxc.idmap: u 0 100000 65536
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.idmap: g 0 100000 65536
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置目录权限">配置目录权限
&lt;/h3>&lt;p>将挂载目录让容器内root可读写的话在服务器内将所有者更改为id 100000。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">chown -R 100000:100000 /nvme/lxc_mount/nginxWebUI
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>对应目录不可以是非linux原生文件系统，比如ntfs exfat均不可以&lt;/p>&lt;/blockquote>
&lt;h3 id="pve上映射用户">pve上映射用户
&lt;/h3>&lt;blockquote>
&lt;p>映射pve用户，服务器和容器内有相同ID的用户。
&lt;code>nano /etc/subuid&lt;/code> 添加一行&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lxc.idmap = u 1000 1000 1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>nano /etc/subgid&lt;/code> 添加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lxc.idmap = g 1000 1000 1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>本文参考：https://www.haiyun.me/archives/1419.html&lt;/p></description></item><item><title>pve lxc 里面运行docker的一些错误</title><link>https://dev.leiyanhui.com/pve/lxc-docker-err/</link><pubDate>Sat, 04 Feb 2023 07:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/lxc-docker-err/</guid><description>&lt;h3 id="错误提示">错误提示
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker: Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: unable to apply caps: operation not permitted: unknown.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ERRO[0005] error waiting for container: context canceled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>先运行 hello word 试试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run hello-world
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个问题 发生在 特权容器上.&lt;/p>
&lt;h3 id="简单的解决方法---非特权容器">简单的解决方法 - 非特权容器
&lt;/h3>&lt;p>不使用特权容器&lt;/p>
&lt;p>然后关于非特权容器的 目录挂载 比较麻烦，可以查看&lt;/p>
&lt;p>查看 (&lt;a class="link" href="http://dev.leiyanhui.com/pve/lxc-mount-dir%29[http://dev.leiyanhui.com/pve/lxc-mount-dir]" target="_blank" rel="noopener"
>http://dev.leiyanhui.com/pve/lxc-mount-dir)[http://dev.leiyanhui.com/pve/lxc-mount-dir]&lt;/a>&lt;/p>
&lt;h3 id="使用-特权容器">使用 特权容器
&lt;/h3>&lt;p>使用特权容器 其实是可以安装docker的，创建的lxc的时候 去掉 无特权容器的 勾选，创建完成后 在选项里面 功能 勾选上 嵌套
在lxc的配置文件 添加三行 可以用特权容器开启docker &lt;code> /etc/pve/lxc/容器id.conf&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lxc.apparmor.profile: unconfined
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.cgroup.devices.allow: a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.cap.drop:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>另外 pve的webui里面 这个容器也要打开嵌套，也就是conf文件里面要有 &lt;code>features: nesting=1&lt;/code>&lt;/p>
&lt;h4 id="安裝docker">安裝docker
&lt;/h4>&lt;p>以alpine为例&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">repositories&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">zoneinfo&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">localtime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;Asia/Shanghai&amp;#34;&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">timezone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">del&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">repositories&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="c1">#nano&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="n">boot&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">service&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">version&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>alpine 一键安装docker</title><link>https://dev.leiyanhui.com/pve/alpine-docker/</link><pubDate>Sat, 04 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/alpine-docker/</guid><description>&lt;p>pve运行docker，母系统使用lxc的alpine是多数情况下的最佳选择了。&lt;br>
原因：体积小，占用资源小，启动快。 可以一个lxc运行一个docker服务。&lt;/p>
&lt;p>缺点：musl 和 gcc 有一些不兼容，不过这对使用docker没有任何影响。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置源和时区 alpine内运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="s1">&amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">repositories&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">zoneinfo&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">localtime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;Asia/Shanghai&amp;#34;&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">timezone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">del&lt;/span> &lt;span class="n">tzdata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apk&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># vim替换为nano&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">nano&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">del&lt;/span> &lt;span class="n">vim&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nano&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vim&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vi&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nano&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sed -i &amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39; /etc/apk/repositories #替换源
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add docker #nano # 安装docker 和 nano
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add docker boot # 开机启动启动
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service docker start # 启动
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker version # 查看版本
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果是特权容器，需要修改lxc的配置&lt;/p>
&lt;p>如果要挂载目录，最好要用特权创建，并开启嵌套，然后在lxc的配置文件 添加三行 可以用特权容器开启docker &lt;code>​ /etc/pve/lxc/容器id.conf&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">lxc.apparmor.profile: unconfined
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.cgroup.devices.allow: a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lxc.cap.drop:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve下以lxc模式运行 ipsec （套docker）</title><link>https://dev.leiyanhui.com/pve/ipsec/</link><pubDate>Fri, 03 Feb 2023 16:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/ipsec/</guid><description>&lt;p>因为 安卓和ios 都默认支持ipsec 而不需要另外安装软件。所以 作为内网服务使用还是非常方便。&lt;/p>
&lt;p>加上之前openwrt迁移到lxc后，发现自带的ipsec 有问题。所以干脆lxc单独运行一个，独立运行 备份和使用都方便太多了。&lt;/p>
&lt;p>lxc 也应该遵守 one 容器 one server&lt;/p>
&lt;p>废话到此为止&lt;/p>
&lt;h3 id="创建-一个lxc">创建 一个lxc
&lt;/h3>&lt;p>母盘 我选的 alpine 3.16 , dhcp分配ip，然后在dhcp路由上绑定静态ip 。 系统盘1g就够用 内存随便给一点 swap关闭，cpu给12核心
运行一下命令先安装配置docker&lt;/p>
&lt;blockquote>
&lt;p>之所以lxc套docker 是因为懒得折腾，而且alpine体积很小。&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sed -i &amp;#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&amp;#39; /etc/apk/repositories
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apk add docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add docker boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service docker start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker version
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="准备配置文件">准备配置文件
&lt;/h3>&lt;blockquote>
&lt;p>下面的命令 要一次性输入&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cat&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ipsec&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">env&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Define your own values for these variables&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - DO NOT put &amp;#34;&amp;#34; or &amp;#39;&amp;#39; around values, or add space around =&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - DO NOT use these special characters within values: \ &amp;#34; &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># psk密钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_IPSEC_PSK&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">密钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置用于登陆VPN的账号和密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_USER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">主用户名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">主用户名的密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如下应该填写本机的外网IP 不强制&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># VPN_PUBLIC_IP=10.1.1.45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (Optional) Define additional VPN users&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - Uncomment and replace with your own values&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - Usernames and passwords must be separated by spaces&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置额外的用户名和密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_ADDL_USERS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">用户&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="err">用户&lt;/span>&lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_ADDL_PASSWORDS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">用户&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="err">的密码&lt;/span> &lt;span class="err">用户&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="err">的密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (Optional) Use alternative DNS servers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - By default, clients are set to use Google Public DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - Example below shows using Cloudflare&amp;#39;s DNS service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_DNS_SRV1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">1.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VPN_DNS_SRV2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">223.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="启动docker">启动docker
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --name ipsec --network=host \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --env-file /root/ipsec.env \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --restart=always \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v ikev2-vpn-data:/etc/ipsec.d \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v /lib/modules:/lib/modules:ro \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p 500:500/udp \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p 4500:4500/udp \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -d --privileged \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hwdsl2/ipsec-vpn-server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="查看状态">查看状态
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker exec -it ipsec ipsec status
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="查看用户链接">查看用户链接
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker exec -it ipsec ipsec whack --trafficstatus
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="测试和公网访问">测试和公网访问
&lt;/h3>&lt;p>主路由上 或者 dmz上，创建 端口映射 500 和4500 两个端口的 udp即可。&lt;/p>
&lt;h3 id="备份">备份
&lt;/h3>&lt;p>lxc 容器，直接在pve后台备份即可&lt;/p>
&lt;h3 id="更多">更多
&lt;/h3>&lt;p>查看作者的：https://github.com/hwdsl2/docker-ipsec-vpn-server/blob/master/docs/advanced-usage-zh.md&lt;/p></description></item><item><title>pve下虚拟机kvm转lxc docker转lxc 正在运行的虚拟机也可以， 以及lxc和docker kvm之间的对比</title><link>https://dev.leiyanhui.com/pve/kvm-to-lxc/</link><pubDate>Fri, 03 Feb 2023 12:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/kvm-to-lxc/</guid><description>&lt;p>如果是linux 不需要显示屏显示的话，建议lxc运行。&lt;/p>
&lt;h3 id="对比">对比
&lt;/h3>&lt;h4 id="lxc-和-虚拟机kvm对比">lxc 和 虚拟机kvm对比
&lt;/h4>&lt;p>lxc没办法支持 macos win 以及黑群晖 爱快等非常规系统，支持常见linux类服务，支持嵌套docker&lt;br>
lxc 支持热备份&lt;br>
lxc 性能更高，几乎就是原声性能，尤其是是需要硬件的服务，例如 openwrt jellyfin 等差距很大&lt;br>
kvm多了一层转换，性能略低于lxc，部分情况下差距很大！ 例如 openwrt&lt;/p>
&lt;h4 id="lxc-和-docker-对比">lxc 和 docker 对比
&lt;/h4>&lt;p>lxc 和docker 差不多。&lt;br>
lxc 没有分层文件系统，在频繁需要修改东西上。比如数据库，openwrt这种经常修改配置的服务上，更适合。&lt;br>
lxc 可以在创建完成后 修改挂载 甚至不需要中断服务&lt;br>
lxc 在pve上 约等于一个独立的 linux虚拟机，比docker的更完整&lt;br>
pve上的lxc 在网络配置上可以直接使用桥接接入宿主机器物理网络&lt;br>
lxc 可以独立且简单方便的嵌套docker &lt;br>
docker 优势：更多的原始镜像的支持&lt;br>
但是在pve下 因为自带lxc的支持，所以能用lxc跑的 就不要麻烦docker了。 实要用docker 可以 lxc套docker 或者 pve直接装docker 都可以。&lt;/p>
&lt;blockquote>
&lt;p>lxc 有一个小小的缺点： 无特权容器 外挂目录有权限问题要处理否则只能只读，特权容器跑docker有一点点问题，需要额外处理。你可以在本站找到相关教程。&lt;/p>&lt;/blockquote>
&lt;h4 id="pve官网建议">pve官网建议
&lt;/h4>&lt;p>原文&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">If you want to run application containers, for example, Docker images, it is recommended that you run them inside a Proxmox Qemu VM. This will give you all the advantages of application containerization, while also providing the benefits that VMs offer, such as strong isolation from the host and the ability to live-migrate, which otherwise isn’t possible with containers.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>大概就是说 vm跑docker 迁移性和强制隔离效果更好。&lt;br>
实际使用中，你会发现 lxc套docker 一个lxc 跑一个alpine 套1-N个更方便。一些家用必须有的服务，比如 ipsec nginx反代&lt;/p>
&lt;h3 id="关于lxc-导入的格式">关于lxc 导入的格式
&lt;/h3>&lt;p>就是带权限的压缩包，比如 tar gz zst等格式。所以 无论原始是什么，我们只要最终 打包文件就可以了。&lt;/p>
&lt;h3 id="虚拟机">虚拟机
&lt;/h3>&lt;p>虚拟机如果可以关机的话，直接转换原来磁盘文件为img即可，qcow2 也可以直接在pve下挂载，下面以img为例。 其他格式 包括 vmware 和 virtualbox的 都可以转换。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mkdir&lt;/span> &lt;span class="n">op&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">root_partition&lt;/span>&lt;span class="o">=$&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">fdisk&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">l&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">img&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">grep&lt;/span> &lt;span class="o">.&lt;/span>&lt;span class="n">img2&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">awk&lt;/span> &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="err">`&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">512&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mount&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">o&lt;/span> &lt;span class="n">loop&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">offset&lt;/span>&lt;span class="o">=$&lt;/span>&lt;span class="n">root_partition&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">img&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">op&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="n">op&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">tar&lt;/span> &lt;span class="n">zcf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">op&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="n">cd&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="c1"># 打包至PVE中LXC模板路径&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">umount&lt;/span> &lt;span class="n">op&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">op&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#rm -rf 固件名称.img&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最终拿到压缩包 op.tar.gz，然后就可以直接在pve 创建ct容器了。&lt;/p>
&lt;p>如果是 openwrt等系统，可能还需要另外处理一下。 参考：https://dev.leiyanhui.com/openwrt/pve-lxc-install-op/&lt;/p>
&lt;h3 id="正在运行的虚拟机">正在运行的虚拟机
&lt;/h3>&lt;p>如果是pve的话，直接备份，然后 再导入到虚拟机，然后再处理磁盘即可。&lt;/p>
&lt;p>参考：https://dev.leiyanhui.com/openwrt/pve-lxc-install-op/&lt;/p>
&lt;h3 id="docker的话直接导出">docker的话，直接导出
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">save&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">o&lt;/span> &lt;span class="n">centos&lt;/span>&lt;span class="o">.&lt;/span> &lt;span class="n">tar&lt;/span> &lt;span class="n">centos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">latest&lt;/span> &lt;span class="c1">#将centos:latest 镜像导出 为centos. tar&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="n">debian&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">go&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">codeserver&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">git&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">debian11&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sshd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tar&lt;/span> &lt;span class="c1"># 将正在运行的容器 不保留历史记录 直接导出&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>部分容器 导出的后的 压缩包不能直接导入到lxc，建议 lxc 嵌套docker&lt;/p>&lt;/blockquote></description></item><item><title>pve 7.3 升级到 linux6.1内核</title><link>https://dev.leiyanhui.com/pve/update-to-linux6/</link><pubDate>Fri, 27 Jan 2023 11:24:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/update-to-linux6/</guid><description>&lt;p>pve7.3 基于debian11 。。这种非滚动发行的版本内核相对来说都是比较陈旧的，目前还是在&lt;code>pve-kernel-5.15 (7.3-1) / 5.15.83 &lt;/code>&lt;/p>
&lt;p>在跑docker的时候 会非常不爽。 甚至部分软件还有一些兼容性问题。&lt;/p>
&lt;p>当然最简单方法是，虚拟机跑一个archlinux或CachyOS ，然后再去跑docker 也就没问题了。当然性能会差一点&lt;/p></description></item><item><title>pve 虚拟磁盘安装 目录移动以及硬件直通等 全部常用内容</title><link>https://dev.leiyanhui.com/pve/pve-ventoy-7g-all-use/</link><pubDate>Fri, 27 Jan 2023 02:12:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/pve-ventoy-7g-all-use/</guid><description>&lt;p>最终目的，实现 在虚拟磁盘启动的物理机运行的pve，并最终开始使用。 期间结合我这几年来折腾的经验给出建议。&lt;/p>
&lt;h2 id="vhd安装pve">vhd安装pve
&lt;/h2>&lt;blockquote>
&lt;p>why? 因为不影响磁盘分区，可以随意移动。&lt;br>
我是硬盘gpt按爪给你的ventoy，ventoy分区为fat32格式，里面放了几个pe和linux live盘，以及 ventoy配置文件，黑苹果的opencore引导，以及 一些vhd的vtoy链接文件。如果不懂这些，建议先去了解一下ventoy。&lt;br>
win下用virtualbox7 创建虚拟机名称pve 磁盘格式vhd 7G就够用了。分配全部空间，开启efi 开启 vm嵌套 网卡配置为桥接。挂上pve的安装镜像开始，安装pve7.3 用ext4格式安装。
安装完成后自动重启，挂载ventoy的vtoyboot-1.0.25.iso镜像,&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mount /dev/cdrom /mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /mnt/vtoyboot*.tar.gz .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxvf vtoyboot*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd vtoyboot*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行完成后，输入&lt;code>poweroff&lt;/code> 关机，然后打开虚拟机的目录找到 pve.vhd 移动到自己需要的位置（注意分区格式，最好不要ntfs分区，最次exfat）重命名为 pve-7g-ext4.vhd.vtoy&lt;br>
打开 ventoy的工具 VentoyVlnk.exe，创建lnk文件到 ventoy的第一分区，文件名为：1.pve-7g-ext4.vhd.vlnk.vtoy&lt;br>
ventoy分区的&lt;code>/ventoy/ventoy.json&lt;/code>内容如下，大概就是跳过win11检测，运行linux挂载镜像所在目录，自动启动超时时间3秒（即默认启动第一个可启动文件，也就是为什么上面要重命名vlnk文件为&lt;code>1.***&lt;/code>）&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;control&amp;#34;:[
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> { &amp;#34;VTOY_WIN11_BYPASS_CHECK&amp;#34;: &amp;#34;1&amp;#34; },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> { &amp;#34;VTOY_LINUX_REMOUNT&amp;#34;: &amp;#34;1&amp;#34; },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> { &amp;#34;VTOY_MENU_TIMEOUT&amp;#34;: &amp;#34;3&amp;#34; }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>万事后重启，会自动重启到vhd版的pve。&lt;/p>
&lt;blockquote>
&lt;p>如果首选启动是 &lt;code>.vtoy&lt;/code>这个不存在的文件，那就是ventoy搜到了回收站的文件，自己去pe或者win下或者pve下删除ventoy分区 回收站文件 就好了。pve下处理&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mount /dev/nvme0n1p1 /mnt # nvme0n1p1是我的ventoy的分区
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd mnt &amp;amp;&amp;amp; rm -rf &amp;#39;$RECYCLE.BIN&amp;#39; &amp;amp;&amp;amp; rm -rf System\ Volume\ Information/ &amp;amp;&amp;amp; umount /mnt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="网络配置">网络配置
&lt;/h2>&lt;p>因为刚刚是虚拟机环境，启动到物理机后是无法联网的。还需要修改一下ip和绑定的网卡。 &lt;a class="link" href="https://dev.leiyanhui.com/pve/changip-and-netcard/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/changip-and-netcard/&lt;/a>
如果前面是桥接网络安装的pve，已经配置好了ip，这里就只需要修改网卡名称就可以了。&lt;/p>
&lt;h2 id="pve-web界面套ssl">pve web界面套ssl
&lt;/h2>&lt;p>建议直接在openwrt路由器上用nginxWebUI套ssl，当然。。也可以手动配置证书文件。&lt;/p>
&lt;h2 id="修改国内源">修改国内源
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/guonei/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/guonei/&lt;/a>&lt;/p>
&lt;h2 id="开启x11-转发">开启x11 转发
&lt;/h2>&lt;p>方便 在pve上远程跑个浏览器啥的 &lt;a class="link" href="https://dev.leiyanhui.com/pve/x11/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/x11/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apt install -y xauth
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart sshd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="开启sftp">开启sftp
&lt;/h2>&lt;p>方便openwrt上的alist挂载 &lt;a class="link" href="https://dev.leiyanhui.com/pve/open-sftp/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/open-sftp/&lt;/a>&lt;/p>
&lt;h2 id="安装fish">安装fish
&lt;/h2>&lt;p>apt install -y fish # 非必须看个人喜好&lt;/p>
&lt;h2 id="自动挂载其他分区">自动挂载其他分区
&lt;/h2>&lt;p>&lt;code>fdisk -l&lt;/code>查看 分区情况，挂载必要的分区&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /nvme /exfat /ventoy-fat32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># mkdir /root/other-etc-bak &amp;amp;&amp;amp; cp /etc/fstab /root/other-etc-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/fstab # 添加三行
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># -----------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/nvme0n1p1 /ventoy-fat32 vfat defaults 0 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/nvme0n1p5 /nvme btrfs defaults 0 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/nvme0n1p6 /exfat exfat defaults 0 2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>检查好再重启，可能会导致无法自动启动，需要物理键盘操作。&lt;/p>&lt;/blockquote>
&lt;h2 id="移动虚拟机和lxc-iso目录">移动虚拟机和lxc iso目录
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/pve-mv-dir/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/pve-mv-dir/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">images&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span> &lt;span class="n">images&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">iso&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">iso&lt;/span> &lt;span class="n">iso&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">cache&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lxc_cache&lt;/span> &lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="pic和显卡直通">pic和显卡直通
&lt;/h2>&lt;p>以核显为例
&lt;a class="link" href="https://dev.leiyanhui.com/pve/igpu-pass/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/igpu-pass/&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>因为显卡可以在虚拟机挂机的情况下直通给其他虚拟机，所以我考虑到偶尔的游戏需求这没有用gvt（性能差一些，而且一些非win系统里面驱动处理起来更加复杂）&lt;/p>&lt;/blockquote></description></item><item><title>pve安装群晖最新版7.2 物理机安装同理</title><link>https://dev.leiyanhui.com/pve/qunhui/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/qunhui/</guid><description>&lt;p>最近开始对在线文档 和 第三方云备份有较大的需求，尝试过几次后，决定在pve上跑一个群晖来处理这些问题。&lt;br>
有很多开源免费项目都可以实现这些功能，但是群晖肯定是实现起来最简单功能也是最强的。&lt;/p>
&lt;blockquote>
&lt;p>再次感谢 群晖公司对黑群晖的容忍&lt;/p>&lt;/blockquote>
&lt;p>本文不适合linux纯小白，但是部分内容适合pve新手&lt;/p>
&lt;h1 id="pve运行群晖">pve运行群晖
&lt;/h1>&lt;h2 id="个人期望和解决方案">个人期望和解决方案
&lt;/h2>&lt;p>因为黑群晖出过问题，所以有以下需求。&lt;/p>
&lt;p>1、方便备份整机&lt;/p>
&lt;p>2、群晖挂了不影响数据访问&lt;/p>
&lt;h3 id="解决方案">解决方案
&lt;/h3>&lt;p>为了满足我上面的要求，我才用 硬盘直通一个单独的lxc容器，然后开smb和webdav/sftp，这个容器称为 filecenter 。群晖用补丁实现 smb挂载的文件的 photo audio video的支持。&lt;/p>
&lt;h3 id="额外的支持">额外的支持
&lt;/h3>&lt;p>群晖不做ssl 和 ddns 。&lt;/p>
&lt;h5 id="ssl">ssl
&lt;/h5>&lt;p>用一个单独的lxc 运行 我自己修改过的 nginxWebUI 处理。&lt;/p>
&lt;h5 id="ddns">ddns
&lt;/h5>&lt;p>用一个单独的lxc 运行 ddns-go&lt;/p>
&lt;h5 id="对象储存">对象储存
&lt;/h5>&lt;p>用一个单独的 lxc 运行 minio&lt;/p>
&lt;h5 id="git仓库">git仓库
&lt;/h5>&lt;p>可以用gitlab实现 我这里直接用阿里的codeup了&lt;/p>
&lt;h4 id="核心数据异地备份功能">核心数据异地备份功能
&lt;/h4>&lt;h6 id="群晖整机定时的备份">群晖整机定时的备份
&lt;/h6>&lt;p>lxc单独运行一个alpine，定时任务ssh到pve实现。备份出来的oma，同步到 filecenter的sftp&lt;/p>
&lt;h6 id="备份到百度云">备份到百度云
&lt;/h6>&lt;p>群晖cloud sysnc实现&lt;/p>
&lt;h6 id="备份到阿里云盘">备份到阿里云盘
&lt;/h6>&lt;p>群晖cloud sysnc + alist webdav&lt;/p>
&lt;p>‍&lt;/p>
&lt;h2 id="安装">安装
&lt;/h2>&lt;h3 id="pve准备">pve准备
&lt;/h3>&lt;h4 id="开启核显直通或者gvt-g">开启核显直通或者gvt-g。
&lt;/h4>&lt;p>过程 ： &lt;a class="link" href="https://dev.leiyanhui.com/pve/igpu-one-key/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/igpu-one-key/&lt;/a> 创建虚拟机，硬盘Sata，然后稍后删掉&lt;/p>
&lt;h4 id="准备引导镜像">准备引导镜像
&lt;/h4>&lt;p>&lt;a class="link" href="https://github.com/fbelavenuto/arpl/releases" target="_blank" rel="noopener"
>https://github.com/fbelavenuto/arpl/releases&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">qemu-img convert -p -f raw -O qcow2 arpl-1.0-beta13a.img arpl-1.0-beta13a.qcow2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 导入
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qm importdisk 5000 /exfat/vm-cnf-and-vdisk-bak/Synology/arpl-1.0-beta13a.qcow2 local --format=qcow2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="编译引导的说明">编译引导的说明
&lt;/h4>&lt;p>启动虚拟机，然后按照提示打开网页&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">m&lt;/span> &lt;span class="err">是选择机型，我这里选&lt;/span> &lt;span class="n">DS920&lt;/span>&lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">n&lt;/span> &lt;span class="err">是选择版本，选最新的&lt;/span> &lt;span class="mi">42962&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">然后随机序列号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">其他都不用改动，然后&lt;/span> &lt;span class="err">选择&lt;/span> &lt;span class="n">build&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">loader&lt;/span> &lt;span class="err">会自动编译&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>恢复引导&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">qm&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="mi">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Synology&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">arpl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">beta13a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># http://10.1.1.70:7681/&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>清理引导和系统 到空白&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">qm&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="mi">7000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">arpl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">beta13a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">temp&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">120&lt;/span>&lt;span class="n">g&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看核显&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ls /dev/dri
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>系统和引导备份&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">backuppath&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Synology&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date&lt;/span> &lt;span class="o">+%&lt;/span>&lt;span class="n">Y&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">-%&lt;/span>&lt;span class="n">H&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">M&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mkdir&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">qm&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">pvevmid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">load&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">qemu&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">img&lt;/span> &lt;span class="nb">convert&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="n">qcow2&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">O&lt;/span> &lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">qemu&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/qunhui" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/qunhui&lt;/a>&lt;/p>
&lt;p>‍&lt;/p></description></item><item><title>pve 下虚拟机过游戏检测 -原神</title><link>https://dev.leiyanhui.com/pve/game-vm/</link><pubDate>Sun, 25 Dec 2022 19:16:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/game-vm/</guid><description>&lt;p>关闭虚拟机，必须关闭，不能重启 假设102是你的虚拟机编号&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nano /etc/pve/qemu-server/102.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>顶部添加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">args: -cpu host,-hypervisor,+kvm_pv_unhalt,+kvm_pv_eoi,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_reset,hv_vpindex,hv_runtime,hv_relaxed,kvm=off,hv_vendor_id=intel&amp;#39;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>开机后，任务管理器 查看 cpu 不提示虚拟机，然后打开游戏即可&lt;/p>
&lt;p>PS： 游戏检测虚拟机 有千千万种办法，所以这东西 当前能用就行，以后不能用再想办法&lt;/p></description></item><item><title>pve 7.3 一键开启核显直通</title><link>https://dev.leiyanhui.com/pve/igpu-one-key/</link><pubDate>Sat, 24 Dec 2022 23:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/igpu-one-key/</guid><description>&lt;p>本文基于&lt;code>Virtual Environment 7.3-3&lt;/code> 理论上pve7系列通用。显卡是uhd630核显，如果你是其他显卡，需要修改一下vfio.conf这个文件里面的ids=&lt;/p>
&lt;h2 id="一键关闭-核显直通-和-gvt-g">一键关闭 核显直通 和 gvt-g
&lt;/h2>&lt;blockquote>
&lt;p>从核显直通到gvt 必须 关闭 再 开启&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -c https://file.leiyanhui.com/pve-unraid-kvm/igpu-etc-bak.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxvf igpu-etc-bak.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/default/grub &amp;amp;&amp;amp; cp /root/igpu-etc-bak/grub /etc/default/grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-grub # cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 最好重启一下再继续
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modules &amp;amp;&amp;amp; cp /root/igpu-etc-bak/modules /etc/modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/pve-blacklist.conf &amp;amp;&amp;amp; cp /root/igpu-etc-bak/pve-blacklist.conf /etc/modprobe.d/pve-blacklist.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/kvm.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/iommu_unsafe_interrupts.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/vfio.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-initramfs -u # cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 重启后检查 lsmod | grep vfio
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="一键切换-核显直通">一键切换 核显直通
&lt;/h2>&lt;blockquote>
&lt;p>需要先关闭gvt-g&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -c https://file.leiyanhui.com/pve-unraid-kvm/igpu-etc-passed-bak.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxvf igpu-etc-passed-bak.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/default/grub &amp;amp;&amp;amp; cp /root/igpu-etc-passed-bak/grub /etc/default/grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-grub # cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 最好重启一下再继续
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/module &amp;amp;&amp;amp; cp /root/igpu-etc-passed-bak/modules /etc/modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/pve-blacklist.conf &amp;amp;&amp;amp; cp /root/igpu-etc-passed-bak/pve-blacklist.conf /etc/modprobe.d/pve-blacklist.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/kvm.conf &amp;amp;&amp;amp; cp /root/igpu-etc-passed-bak/kvm.conf /etc/modprobe.d/kvm.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/iommu_unsafe_interrupts.conf &amp;amp;&amp;amp; cp /root/igpu-etc-passed-bak/iommu_unsafe_interrupts.conf /etc/modprobe.d/iommu_unsafe_interrupts.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/vfio.conf &amp;amp;&amp;amp; cp /root/igpu-etc-passed-bak/vfio.con /etc/modprobe.d/vfio.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-initramfs -u # cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 重启后检查 lsmod | grep vfio
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="一键切换-gvt-g">一键切换 gvt-g
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -c https://file.leiyanhui.com/pve-unraid-kvm/igpu-etc-gvt-g-bak.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxvf igpu-etc-gvt-g-bak.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/default/grub &amp;amp;&amp;amp; cp /root/igpu-etc-gvt-g-bak/grub /etc/default/grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-grub # cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 最好重启一下再继续
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modules &amp;amp;&amp;amp; cp /root/igpu-etc-gvt-g-bak/modules /etc/modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/pve-blacklist.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/kvm.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/iommu_unsafe_interrupts.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /etc/modprobe.d/vfio.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-initramfs -u # cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 重启后检查 lsmod | grep vfio
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="gvt-g-备份">gvt-g 备份
&lt;/h3>&lt;blockquote>
&lt;p>关闭状态开启gvt-g 只需要修改两个文件&lt;/p>&lt;/blockquote>
&lt;ul>
&lt;li>&lt;code>nano /etc/default/grub&lt;/code> 编辑&lt;code>GRUB_CMDLINE_LINUX_DEFAULT=&amp;quot;quiet intel_iommu=on iommu=pt i915.enable_gvt=1&amp;quot;&lt;/code> &lt;code>update-grub&lt;/code>&lt;/li>
&lt;li>&lt;code>nano /etc/modules &lt;/code> 添加 一行一个 &lt;code>vfio vfio_iommu_type1 vfio_pci vfio_virqfd kvmgt&lt;/code> &lt;code>update-initramfs -u -k all&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /root/igpu-etc-gvt-g-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/default/grub /root/igpu-etc-gvt-g-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modules /root/igpu-etc-gvt-g-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zcvf igpu-etc-gvt-g-bak.tar.gz igpu-etc-gvt-g-bak
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="手动处理过程">手动处理过程
&lt;/h2>&lt;h3 id="备份需要处理的文件">备份需要处理的文件
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /root/igpu-etc-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/default/grub /root/igpu-etc-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modules /root/igpu-etc-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modprobe.d/pve-blacklist.conf /root/igpu-etc-bak
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="压缩备份文件">压缩备份文件
&lt;/h4>&lt;p>cd /root
tar -zcvf igpu-etc-bak.tar.gz igpu-etc-bak&lt;/p>
&lt;h3 id="处理文件">处理文件
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/igpu-pass/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/igpu-pass/&lt;/a>&lt;/p>
&lt;h3 id="备份处理过的文件">备份处理过的文件
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/default/grub /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modules /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modprobe.d/pve-blacklist.conf /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modprobe.d/kvm.conf /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modprobe.d/iommu_unsafe_interrupts.conf /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/modprobe.d/vfio.conf /root/igpu-etc-passed-bak
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="压缩备份文件-1">压缩备份文件
&lt;/h4>&lt;p>cd /root
tar -zcvf igpu-etc-passed-bak.tar.gz igpu-etc-passed-bak&lt;/p></description></item><item><title>pve 7.3开启核显/独显直通pic设备直通简易教程</title><link>https://dev.leiyanhui.com/pve/igpu-pass/</link><pubDate>Sat, 24 Dec 2022 23:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/igpu-pass/</guid><description>&lt;h2 id="grub处理">grub处理
&lt;/h2>&lt;p>&lt;code>nano &lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#GRUB_CMDLINE_LINUX_DEFAULT=&amp;#34;quiet&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">GRUB_CMDLINE_LINUX_DEFAULT=&amp;#34;quiet intel_iommu=on&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>有可能还需要&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">GRUB_CMDLINE_LINUX_DEFAULT=&amp;#34;quiet intel_iommu=on video=efifb:off&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>intel_iommu=on 是开启分组&lt;br>
video=efifb:off 是关闭pve的显示&lt;br>
vesafb:off 禁用legacy启动的显示设备 非必须&lt;br>
更新grub后重启&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">update-grub
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ventoy的pve 还需要处理一下 再重启&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="开启vfio模块">开启vfio模块
&lt;/h2>&lt;p>&lt;code>nano /etc/modules&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">vfio
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_iommu_type1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_pci
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_virqfd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="创建黑名单">创建黑名单
&lt;/h2>&lt;p>&lt;code>nano /etc/modprobe.d/pve-blacklist.conf&lt;/code> 屏蔽常见设备和核显等&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">blacklist i915
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist snd_hda_intel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist snd_hda_codec_hdmi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其他的显卡 自己按需要屏蔽&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># block AMD driver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist radeon
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist amdgpu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># block NVIDIA driver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist nouveau
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist nvidia
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blacklist nvidiafb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="避免-无限重启">避免 无限重启
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">echo &amp;#34;options kvm ignore_msrs=1&amp;#34; &amp;gt; /etc/modprobe.d/kvm.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="允许不安全的中断">允许不安全的中断
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">echo &amp;#34;options vfio_iommu_type1 allow_unsafe_interrupts=1&amp;#34; &amp;gt; /etc/modprobe.d/iommu_unsafe_interrupts.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="查看要屏蔽的设备的id">查看要屏蔽的设备的id，
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lspci -nn | grep UHD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">00:02.0 VGA compatible controller [0300]: Intel Corporation CoffeeLake-H GT2 [UHD Graphics 630] [8086:3e9b]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>记住前面和最后的地址 &lt;code>00:02&lt;/code> 和 &lt;code>8086:3e9b&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">echo &amp;#34;options vfio-pci ids=8086:3e9b&amp;#34; &amp;gt; /etc/modprobe.d/vfio.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ps：执行此操作后可能无法输出到外接显示器，若出现此情况，请撤回该步骤.另外有一个 参数 disable_vga=1 也可能会影响&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">echo &amp;#34;options vfio-pci ids=8086:3e9b disable_vga=1&amp;#34; &amp;gt; /etc/modprobe.d/vfio.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="更新initramfs">更新initramfs
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">update-initramfs -u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># ventoy启动的pve.vhd 还需要处理一下vtoyboot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd /root/vtoyboot**/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再重启&lt;/p>
&lt;h2 id="检查">检查
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">root@pve ~# lsmod | grep vfio
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_pci 16384 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_pci_core 73728 1 vfio_pci
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_virqfd 16384 1 vfio_pci_core
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">irqbypass 16384 16 vfio_pci_core,kvm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio_iommu_type1 40960 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vfio 45056 2 vfio_pci_core,vfio_iommu_type1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>完毕
其他问题 参考以前的记录 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/win-gpu/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/win-gpu/&lt;/a>&lt;/p></description></item><item><title>pve 安装图形界面软件：文件管理器，浏览器等 用于基本配置和云备份等</title><link>https://dev.leiyanhui.com/pve/brower-filemanage/</link><pubDate>Sat, 24 Dec 2022 23:10:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/brower-filemanage/</guid><description>&lt;p>你可以直接安装完整的 gnome kde等桌面系统。&lt;/p>
&lt;p>我这里的pve 没有显卡（都直通给你虚拟机了），也不会经常用他桌面系统，所以我这里是用x11转发，由控制pve的远程电脑来显示图形界面。软件也尽量用appimages，以便减少对pve系统的修改。&lt;/p>
&lt;h2 id="开启x11-转发">开启x11 转发
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/x11/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/x11/&lt;/a>&lt;/p>
&lt;h2 id="准备客户端工具">准备客户端工具
&lt;/h2>&lt;p>这里是win客户机，我用 MobaXterm&lt;/p>
&lt;h2 id="清理系统">清理系统
&lt;/h2>&lt;p>我原来是apt安装的火狐和thunar 卸载掉&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apt-get purge firefox-esr thunar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt-get autoremove
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="安装appimages常用软件">安装appimages常用软件
&lt;/h2>&lt;p>存放目录&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir appimages
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd appimages
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="火狐">火狐
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">apprepo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">de&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">appimage&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">firefox&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">document&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Firefox&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chmod&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">./*.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">./&lt;/span>&lt;span class="n">Firefox&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>需要一点依赖 我们这里自己装一下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># apt-get install libgtk-3-0 # apprepo.de的不需要
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt-get install libdbus-glib-1-2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>火狐appimages 仓库：https://github.com/srevinsaju/Firefox-Appimage/&lt;br>
pve 自带了Lynx ，可以浏览一些文本类型为主的网站&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">lync dev.leiyanhui.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="图形化文件管理工具">图形化文件管理工具
&lt;/h3>&lt;p>可选 Far2l ，这是一个基于命令行的图形界面的软件，支持鼠标操作，x11 转发毕竟没有终端方便&lt;/p>
&lt;h4 id="far2l">Far2l
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">apprepo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">de&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">appimage&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">far2l&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">document&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Far2l&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chmod&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">./&lt;/span>&lt;span class="n">Far2l&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">./&lt;/span>&lt;span class="n">Far2l&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>DFileManager 依赖QT&lt;/p>
&lt;p>一些其他的常用软件的appimages整理&lt;/p>
&lt;p>&lt;a class="link" href="https://appimage.github.io" target="_blank" rel="noopener"
>https://appimage.github.io&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://apprepo.de/" target="_blank" rel="noopener"
>https://apprepo.de/&lt;/a>&lt;/p></description></item><item><title>pve 更换国内源，完整操作</title><link>https://dev.leiyanhui.com/pve/guonei/</link><pubDate>Wed, 21 Dec 2022 23:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/guonei/</guid><description>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">mkdir&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 企业源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">install&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">repo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sources&lt;/span> &lt;span class="c1">#这个文件新版不存在了 这行不需要执行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">enterprise&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nano&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">enterprise&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-----------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">deb&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">mirrors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tuna&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tsinghua&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">edu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cn&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">proxmox&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">debian&lt;/span> &lt;span class="n">bullseye&lt;/span> &lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">subscription&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># debian源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#apt update&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#apt install apt-transport-https ca-certificates&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nano&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-----------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">deb&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">mirrors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tuna&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tsinghua&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">edu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cn&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">debian&lt;/span>&lt;span class="o">/&lt;/span> &lt;span class="n">bullseye&lt;/span> &lt;span class="n">main&lt;/span> &lt;span class="n">contrib&lt;/span> &lt;span class="n">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">free&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">deb&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">mirrors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tuna&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tsinghua&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">edu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cn&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">debian&lt;/span>&lt;span class="o">/&lt;/span> &lt;span class="n">bullseye&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">updates&lt;/span> &lt;span class="n">main&lt;/span> &lt;span class="n">contrib&lt;/span> &lt;span class="n">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">free&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">deb&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">mirrors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tuna&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tsinghua&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">edu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cn&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">debian&lt;/span>&lt;span class="o">/&lt;/span> &lt;span class="n">bullseye&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">backports&lt;/span> &lt;span class="n">main&lt;/span> &lt;span class="n">contrib&lt;/span> &lt;span class="n">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">free&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">deb&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">mirrors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tuna&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tsinghua&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">edu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cn&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">debian&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">security&lt;/span> &lt;span class="n">bullseye&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">security&lt;/span> &lt;span class="n">main&lt;/span> &lt;span class="n">contrib&lt;/span> &lt;span class="n">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">free&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># CT/LXC 源 备份后替换，然后重启pvedaemon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">perl5&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">PVE&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">APLInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pm&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="s1">&amp;#39;s|http://download.proxmox.com|https://mirrors.tuna.tsinghua.edu.cn/proxmox|g&amp;#39;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">perl5&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">PVE&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">APLInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pm&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">systemctl&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">pvedaemon&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>更新到最新版 不建议&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apt update &amp;amp;&amp;amp; apt full-upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd /root/vtoyboot-*/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve 开机自动挂载exfat分区</title><link>https://dev.leiyanhui.com/pve/auto-mount-exfat/</link><pubDate>Wed, 21 Dec 2022 22:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/auto-mount-exfat/</guid><description>&lt;p>pve已经内置了exfat支持，直接挂载即可。 其他linux内建支持的分区格式用同样方法挂载即可。nfts格式的话需要先&lt;code>apt install ntfs-3g&lt;/code>
先手动挂载&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 查看分区
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fdisk -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 目标分区 /dev/nvme0n1p3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 挂载
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /nvme
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/nvme0n1p3 /nvme
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 检查
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls /nvme
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>自动挂载&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nano /etc/fstab
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>添加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># &amp;lt;file system&amp;gt; &amp;lt;mount point&amp;gt; &amp;lt;type&amp;gt; &amp;lt;options&amp;gt; &amp;lt;dump&amp;gt; &amp;lt;pass&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/nvme0n1p3 /nvme exfat defaults 0 2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>/dev/nvme0n1p3 是分区, /nvmek是挂载的文件夹, exfat是磁盘格式, defaults 默认.&lt;br>
第一个数字：0表示开机不检查磁盘，1表示开机检查磁盘；&lt;br>
第二个数字：0表示交换分区，1代表启动分区（Linux），2表示普通分区&lt;/p>
&lt;p>重启测试&lt;/p>
&lt;p>读写速度测试
读取&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">hdparm -t /dev/nvme0n1p3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code> Timing buffered disk reads: 3874 MB in 3.00 seconds = 1291.26 MB/sec&lt;/code>
写入&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">dd if=/dev/zero of=/nvme/test.for.write bs=1M count=8000 oflag=direct #写入一个8G的文件
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">8000+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8000+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8388608000 bytes (8.4 GB, 7.8 GiB) copied, 12.7129 s, 660 MB/s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>写入速度有点拉跨，不过也还好，马马马虎虎，考虑到兼容性和方便性exfat分区还是值得&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@pve-yanhui ~# dd if=/dev/zero of=/nvme/test.for.write bs=1M count=8000 oflag=direct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8000+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8000+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8388608000 bytes (8.4 GB, 7.8 GiB) copied, 12.7129 s, 660 MB/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@pve-yanhui ~# rm -rf /nvme/test.for.write
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@pve-yanhui ~# dd if=/dev/zero of=/nvme/test.for.write bs=100M count=80 oflag=direct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">80+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">80+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8388608000 bytes (8.4 GB, 7.8 GiB) copied, 16.8002 s, 499 MB/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@pve-yanhui ~# dd if=/dev/zero of=/nvme/test.for.write bs=100M count=80 oflag=direct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">80+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">80+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8388608000 bytes (8.4 GB, 7.8 GiB) copied, 16.7228 s, 502 MB/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@pve-yanhui ~# dd if=/dev/zero of=/nvme/test.for.write bs=10M count=800 oflag=direct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">800+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">800+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8388608000 bytes (8.4 GB, 7.8 GiB) copied, 14.3473 s, 585 MB/s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="结语">结语
&lt;/h2>&lt;p>对于nvme 硬盘来说，exfat真的不合适，linux下性能损耗太大了，上面的测试可以看到性能损耗差不多一半！血亏&lt;/p>
&lt;p>多系统使用强烈建议 使用brtfs格式。linux肯定没问题
win和winpe 可以使用 本文方法：https://dev.leiyanhui.com/win/winbtrfs/&lt;/p>
&lt;p>macos的话，目前好像只有用虚拟机映射分区的方法访问，然后sftp或者其他方式再挂载出来。&lt;/p></description></item><item><title>pve开启虚拟化嵌套，方便后续使用esxi嵌套黑苹果以便使用核显</title><link>https://dev.leiyanhui.com/pve/pve-vm-esxi/</link><pubDate>Thu, 15 Dec 2022 00:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/pve-vm-esxi/</guid><description>&lt;h2 id="检查">检查
&lt;/h2>&lt;p>cat /sys/module/kvm_intel/parameters/nested&lt;/p>
&lt;p>如果输出Y 那就是支持 就不用搞了&lt;/p>
&lt;h3 id="如果没有打开">如果没有打开
&lt;/h3>&lt;p>注意 必须关闭所有虚拟机，最好连容器一起关闭
然后&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">modprobe -r kvm_intel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">modprobe kvm_intel nested=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 再次检查nested,输出Y，即为开启成功。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /sys/module/kvm_intel/parameters/nested
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="设置每次开机都打开">设置每次开机都打开
&lt;/h3>&lt;pre>&lt;code>echo &amp;quot;options kvm_intel nested=1&amp;quot; &amp;gt;&amp;gt; /etc/modprobe.d/modprobe.conf
&lt;/code>&lt;/pre>
&lt;h2 id="虚拟机设置">虚拟机设置
&lt;/h2>&lt;p>设置需要直通的虚拟机的cpu类型为host&lt;/p>
&lt;h2 id="完毕">完毕
&lt;/h2>&lt;h2 id="开启intel-gvt---vgpu">开启intel gvt - vgpu
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/kvm/gvt-g-vgpu/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/kvm/gvt-g-vgpu/&lt;/a>&lt;/p>
&lt;h2 id="简单安装esxi黑苹果">简单安装esxi黑苹果
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/esxi/macos13/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/esxi/macos13/&lt;/a>&lt;/p></description></item><item><title>pve 开启x11转发</title><link>https://dev.leiyanhui.com/pve/x11/</link><pubDate>Sun, 11 Dec 2022 23:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/x11/</guid><description>&lt;p>基于pve7.3 理论上7.x 通用&lt;/p>
&lt;p>pve7.3 默认安装后不需要编辑sshd_config，直执行 &lt;code>apt install -y xauth&lt;/code> 即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apt install -y xauth
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X11Forwarding yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X11UseLocalhost no
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启ssh&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl restart sshd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>用 Xming 或者MobaXterm 重新连接上，安装一个图形界面软件 测试，比如 apt install firefox&lt;/p>
&lt;p>而后测试&lt;/p></description></item><item><title>pve 修改网卡和ip 主机名称</title><link>https://dev.leiyanhui.com/pve/changip-and-netcard/</link><pubDate>Sun, 11 Dec 2022 23:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/changip-and-netcard/</guid><description>&lt;h2 id="修改网卡">修改网卡
&lt;/h2>&lt;p>需要修改配置文件的两处地方&lt;/p>
&lt;h3 id="查看网卡">查看网卡
&lt;/h3>&lt;p>&lt;code>ip a&lt;/code> 除去lo和vmbr0 之外的网卡 就是我们需要用的网卡，如果是wifi网卡（一般wl开头的）的话需要额外处理 这里不在记录
我这里的实际需要的网卡名称为 enp1s0&lt;/p>
&lt;h3 id="编辑interfaces">编辑interfaces
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nano /etc/network/interfaces
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把 iface xxx inet manual 这行里面的网卡名称修改为enp1s0 &lt;br>
再把 bridge-ports XXX 后面的网卡名称修改为enp1s0&lt;/p>
&lt;h2 id="修改ip">修改ip
&lt;/h2>&lt;p>需要修改3个文件,注意网关掩码 都根据你的情况修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">/etc/network/interfaces
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/issue
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/hosts
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启PVE&lt;/p>
&lt;h2 id="修改主机名">修改主机名
&lt;/h2>&lt;p>需要修改两个文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">/etc/hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/hosts
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果用邮件服务，还要修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">/etc/postfix/main.cf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve 移动默认目录</title><link>https://dev.leiyanhui.com/pve/pve-mv-dir/</link><pubDate>Tue, 29 Nov 2022 23:34:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/pve-mv-dir/</guid><description>&lt;p>以 移动local节点的目录为例，先配置分区自动挂载到pve 查看本文 &lt;a class="link" href="https://dev.leiyanhui.com/pve/auto-mount-exfat" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/auto-mount-exfat&lt;/a>&lt;/p>
&lt;p>我这里主要是移动images目录，也就是虚拟机的lxc的目录&lt;br>
关闭所有虚拟机和lxc，&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="n">images&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve_vm_images&lt;/span> &lt;span class="c1"># mkdir /nvme/pve_vm_images&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>pve 会自动新建image目录，所以我们要同时执行rm 和ln&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rm -rf images &amp;amp;&amp;amp; ln -s /nvme/pve_vm_images images
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>注意新装的pve 有可能是没有images目录的
完毕&lt;/p>&lt;/blockquote>
&lt;p>template 目录 不建议直接移动，毕竟要用的iso的和lxc镜像并不多，直接在对应目录下ln -s 可能更简单一些。&lt;/p>
&lt;p>如果要处理 一样 执行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#mv iso /exfat/iso&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">iso&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">iso&lt;/span> &lt;span class="n">iso&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">iso&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">iso&lt;/span> &lt;span class="n">iso&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其他的目录也可以修改 dump private snippets&lt;/p>
&lt;p>/var/lib/vz/dump&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="n">dump&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dump&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">back&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">dump&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dump&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">back&lt;/span> &lt;span class="n">dump&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="n">snippets&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">snippets&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pve&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">snippets&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">snippets&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pve&lt;/span> &lt;span class="n">snippets&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve 删除运行日志</title><link>https://dev.leiyanhui.com/pve/del-log/</link><pubDate>Tue, 29 Nov 2022 23:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/del-log/</guid><description>&lt;p>运行太久了 会越来越大。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ls&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pveproxy&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">access.log access.log.1 access.log.2.gz access.log.3.gz access.log.4.gz access.log.5.gz access.log.6.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="清理">清理
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mkdir&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pveproxy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">touch&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pveproxy&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">access&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chown&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">R&lt;/span> &lt;span class="n">www&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">www&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">data&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pveproxy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">systemctl&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">pveproxy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="删除历史命令">删除历史命令
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">history -c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;gt; $HOME/.bash_history
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve/debian11 开启smb和 虚拟机以及局域网其他设备共享</title><link>https://dev.leiyanhui.com/pve/open-smb/</link><pubDate>Tue, 29 Nov 2022 00:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/open-smb/</guid><description>&lt;blockquote>
&lt;p>win8以后的win系统默认不支持smb1，记得添加smb1的支持后方可&lt;/p>&lt;/blockquote>
&lt;h3 id="更新源到国内">更新源到国内
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/guonei/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/guonei/&lt;/a>&lt;/p>
&lt;h3 id="安装smb">安装smb
&lt;/h3>&lt;pre>&lt;code>apt-get install samba
&lt;/code>&lt;/pre>
&lt;h3 id="启动">启动
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl enable smbd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start smbd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart smbd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="root直接使用">root直接使用
&lt;/h3>&lt;blockquote>
&lt;p>自己用的话，直接用root用户 就好了
设置root用户的 smb的密码 &lt;code>smbpasswd -a root &lt;/code> 这个密码和root的管理密码无关&lt;/p>&lt;/blockquote>
&lt;pre>&lt;code>nano /etc/samba/smb.conf
&lt;/code>&lt;/pre>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[nvme]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> comment = Share-rw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path = /nvme
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> available = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> browsable = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> writable = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid users = root
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置账号">配置账号
&lt;/h3>&lt;pre>&lt;code>smbpasswd -a 【用户名】
&lt;/code>&lt;/pre>
&lt;p>需要提前新建用户&lt;/p>
&lt;pre>&lt;code>addgroup wheel
useradd -m -G wheel -s /bin/bash 【用户名】
passwd 【用户名】
#最好顺带配置一下sudo https://dev.leiyanhui.com/arch/base-install/#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7
# 或者干脆 groupadd test -g 6000&amp;amp; useradd test -u 6000 -g 6000 -s /sbin/nologin -d /dev/null
&lt;/code>&lt;/pre>
&lt;h3 id="配置共享">配置共享
&lt;/h3>&lt;pre>&lt;code>nano /etc/samba/smb.conf
&lt;/code>&lt;/pre>
&lt;p>添加内容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[shareMNT]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> comment = Share-rw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ;共享目录全路径
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path = /mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> available = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> browsable = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">;写入权限
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> writable = yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">;可访问的用户
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid users = yourUserName
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="可能还需要配置权限">可能还需要配置权限
&lt;/h3>&lt;pre>&lt;code>chmod -R 777 /mnt #简单一点
&lt;/code>&lt;/pre>
&lt;h3 id="关闭默认主目录">关闭默认主目录
&lt;/h3>&lt;p>把 homes 哪段删掉就好&lt;/p>
&lt;h3 id="其他命令">其他命令
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">smbpasswd -d 冻结用户，就是这个用户不能在登录了
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbpasswd -e 恢复用户，解冻用户，让冻结的用户可以在使用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbpasswd -n 把用户的密码设置成空.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 要在global中写入 null passwords -true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl status nmbd // 查询SMB状态
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl status smbd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl enable smbd // 允许SMB开机启动
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>pve 打开sftp 直接上传文件 debian centos arch 同理</title><link>https://dev.leiyanhui.com/pve/open-sftp/</link><pubDate>Sun, 27 Nov 2022 00:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/open-sftp/</guid><description>&lt;p>客户端 可以用 winscp MobaXterm 或者 其他 支持 sftp的软件，直接上传文件。这对 新手（老手也是） 来说更方便。另外也可以挂载到alist统一管理。&lt;/p>
&lt;p>但是pve 默认是关闭 sftp的，打开方法也很简单。&lt;/p>
&lt;p>用 vim 或者 nano 编辑sshd配置文件，我这里用nano&lt;/p>
&lt;pre>&lt;code># apt install nano
# mkdir /root/other-etc-bak &amp;amp;&amp;amp; cp /etc/ssh/sshd_config /root/other-etc-bak
nano /etc/ssh/sshd_config
&lt;/code>&lt;/pre>
&lt;p>往下翻，找到&lt;code>Subsystem sftp /usr/lib/openssh/sftp-server&lt;/code> 这行，注释掉，然后添加一行&lt;code>Subsystem sftp internal-sftp&lt;/code>&lt;/p>
&lt;pre>&lt;code>#Subsystem sftp /usr/lib/openssh/sftp-server
Subsystem sftp internal-sftp
&lt;/code>&lt;/pre>
&lt;p>重启ssh&lt;/p>
&lt;pre>&lt;code>/etc/init.d/ssh restart
&lt;/code>&lt;/pre>
&lt;p>使用支持sftp的客户端 重新登录ssh&lt;/p>
&lt;p>搞定&lt;/p></description></item><item><title>在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos</title><link>https://dev.leiyanhui.com/pve/install-macos-ventura/</link><pubDate>Sat, 29 Oct 2022 08:29:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/install-macos-ventura/</guid><description>&lt;blockquote>
&lt;p>这里假定你已经安装好了pve，并且有一定的linux和macos基本基础，本文基于最新版pve7.2-11 &lt;br>
其次，pve折腾一个流畅好用的黑苹果是一个非常漫长的过程，很多参数和配置，别人的教程都是仅供你参考，尤其是硬件直通，还是很复杂，你要有时间研究折腾
我的pve 是 用ventoy启动的硬盘vhd文件放在exfat分区 所以后面一部分内容可能和ventoy有关，如果你是直接安装在硬盘上的 可以跳过这部分内容&lt;br>
我的硬盘只有两块
- 第一块硬盘 nvme ssd 512G
- 硬盘安装了ventoy
- 三个分区&lt;br>
- 第一分区 是放ventoy的启动文件也可以作为第二efi分区 分区大小800M左右fat32格式
- 第二分区是ventoyefi 32m fat16格式 ，
- 第三分区我主要数据分区也是ventoy的保留分区实际大小465G，pve系统的虚拟磁盘文件也放在这里
- 第二硬盘 1T 古董盘 存放一些备份文件&lt;/p>&lt;/blockquote>
&lt;h2 id="准备文件">准备文件
&lt;/h2>&lt;ul>
&lt;li>macos的恢复镜像Ventura-recovery.img
&lt;ul>
&lt;li>OSX-KVM 已经支持在linux下直接获取Ventura的恢复镜像了&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>opencore镜像，基于kvm优化过的OpenCore OpenCore-v19.iso &lt;a class="link" href="https://github.com/thenickdude/KVM-Opencore/releases/" target="_blank" rel="noopener"
>https://github.com/thenickdude/KVM-Opencore/releases/&lt;/a>&lt;/li>
&lt;li>可选：集成virtio的winpe，方便改错ocpencore后进pe修复， &lt;a class="link" href="https://blog.csdn.net/flydream3618/article/details/47357895" target="_blank" rel="noopener"
>https://blog.csdn.net/flydream3618/article/details/47357895&lt;/a>&lt;/li>
&lt;li>可选：win10安装盘iso 以及Windows的virtio-win.iso 驱动 &lt;a class="link" href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/" target="_blank" rel="noopener"
>https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/&lt;/a>&lt;/li>
&lt;li>可选：显卡直通需要的vbois文件 我的是uhd630 你如果是同款核显可以直接用 &lt;a class="link" href="https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm" target="_blank" rel="noopener"
>https://github.com/joyanhui/file.leiyanhui.com/tree/main/pve-unraid-kvm&lt;/a> vbios_gvt_uefi.rom&lt;/li>
&lt;/ul>
&lt;p>都放到 机械盘的 iso目录里面&lt;/p>
&lt;h2 id="pve的准备工作">pve的准备工作
&lt;/h2>&lt;h3 id="pve-删除-local-lvm非必须但是你是新手的话建议删掉">pve 删除 local-lvm（非必须，但是你是新手的话，建议删掉）
&lt;/h3>&lt;pre>&lt;code> lvremove pve/data
lvextend -l +100%FREE -r pve/root
&lt;/code>&lt;/pre>
&lt;p>在数据中心-存储中删除local-lvm分区，并编辑local，在内容一项中勾选所有可选项&lt;/p>
&lt;h3 id="更新国内源码">更新国内源码
&lt;/h3>&lt;pre>&lt;code>mkdir /root/bakfile
cp /etc/apt/sources.list //root/bakfile/sources.list
nano /etc/apt/sources.list
## deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free
## deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free
## deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free
## deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free
cp /etc/apt/sources.list.d/pve-enterprise.list /root/bakfile/pve-enterprise.list
nano /etc/apt/sources.list.d/pve-enterprise.list
https://mirrors.tuna.tsinghua.edu.cn/proxmox/debian bullseye pve-no-subscription
cp /usr/share/perl5/PVE/APLInfo.pm /root/bakfile/APLInfo.pm
sed -i 's|http://download.proxmox.com|https://mirrors.tuna.tsinghua.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm
systemctl restart pvedaemon.service
apt-get update &amp;amp;&amp;amp; apt upgrade
&lt;/code>&lt;/pre>
&lt;h3 id="处理一下kve的一点小问题">处理一下kve的一点小问题
&lt;/h3>&lt;p>这步骤非必须的，如果你的macos虚拟机一直无限重启，就要在kve执行&lt;/p>
&lt;pre>&lt;code>echo &amp;quot;options kvm ignore_msrs=Y&amp;quot; &amp;gt;&amp;gt; /etc/modprobe.d/kvm.conf &amp;amp;&amp;amp; update-initramfs -k all -u
&lt;/code>&lt;/pre>
&lt;p>提示&lt;code>No /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.&lt;/code> 没关系的，添加此行后 pve主机控制台会提示 一个 类似&lt;code>kvm [1219]: ignored &lt;/code>的信息，你如果感觉烦躁 你可以 修改成&lt;code>options kvm ignore_msrs=Y report_ignored_msrs=N&lt;/code> 忽略这个提示&lt;/p>
&lt;h3 id="重启pve">重启pve
&lt;/h3>&lt;h2 id="准备主要文件-opencore和macos的恢复镜像">准备主要文件 opencore和macos的恢复镜像
&lt;/h2>&lt;h3 id="下载-kvm-opencore目前最新版是v19">下载 kvm-opencore，目前最新版是v19
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">template&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">iso&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">ghproxy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">thenickdude&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">KVM&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Opencore&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">releases&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">v19&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">OpenCore&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">v19&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iso&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">gzip&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="n">OpenCore&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">v19&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iso&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gz&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>或者自定下载后上传到pve的iso里面&lt;/p>
&lt;blockquote>
&lt;p>注意这个虽然后缀是iso，但是实际上是raw格式的img文件，后面优化macos的时候我们还要对他进行一些处理。&lt;/p>&lt;/blockquote>
&lt;h3 id="获取-macos-13-ventura-恢复镜像">获取 macos 13 ventura 恢复镜像
&lt;/h3>&lt;h4 id="使用容器搭建一个编译环境">使用容器搭建一个编译环境
&lt;/h4>&lt;p>虽然pve也是一个完整的debian系统，但是本着各负其责的简单管理原则，尽量避免对pve本身进行太多的修改。所以建议从容器里面搞。你只要按照下面步骤操作 必定可以。&lt;/p>
&lt;h5 id="获取一个ct容器的ubuntu镜像">获取一个ct容器的ubuntu镜像
&lt;/h5>&lt;p>修改源从 pve后台： local&amp;gt;CT模板，获取一个Ubuntu18的镜像&lt;br>
或者直接下载后上传到pve&lt;/p>
&lt;pre>&lt;code>cd /var/lib/vz/template/cache/
wget https://mirrors.tuna.tsinghua.edu.cn/proxmox/images/system/ubuntu-18.04-standard_18.04.1-1_amd64.tar.gz
&lt;/code>&lt;/pre>
&lt;h5 id="创建一个ubuntu18的ct容器">创建一个ubuntu18的CT容器
&lt;/h5>&lt;pre>&lt;code>容器名称 ubuntu18 密码 记住 这个密码是容器的root密码
模板选ubuntu18这个
磁盘大小16G
cpu 给几个 无所谓给4个
内存swap都给1024
网络dhcp 其他不用设置
控制台 用root 和上面的密码登录
&lt;/code>&lt;/pre>
&lt;h4 id="更新一下这个ct容器">更新一下这个CT容器
&lt;/h4>&lt;pre>&lt;code>mv /etc/apt/sources.list /etc/apt/sources.list-bak
nano /etc/apt/sources.list
&lt;/code>&lt;/pre>
&lt;p>换国内源,清华源 应该是已经停止了对ubuntu18 的支持，建议调用 中科大的源，阿里的也可以用，但是阿里云的源从今年3月开始抽风，经常限速非常慢&lt;/p>
&lt;pre>&lt;code>#中科大源
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse
&lt;/code>&lt;/pre>
&lt;p>更新系统&lt;/p>
&lt;pre>&lt;code>apt update
apt upgrade
&lt;/code>&lt;/pre>
&lt;h4 id="安装工具包">安装工具包
&lt;/h4>&lt;pre>&lt;code>sudo apt install qemu-utils make git
&lt;/code>&lt;/pre>
&lt;h4 id="克隆">克隆 &lt;a class="link" href="https://github.com/thenickdude/OSX-KVM.git" target="_blank" rel="noopener"
>https://github.com/thenickdude/OSX-KVM.git&lt;/a>
&lt;/h4>&lt;pre>&lt;code>cd ~
#我这里用了ghproxy的代理加速，你也可以挂梯子 或者找别的代理加速
git clone https://ghproxy.com/https://github.com/thenickdude/OSX-KVM.git
&lt;/code>&lt;/pre>
&lt;h4 id="编译获取恢复镜像">编译获取恢复镜像
&lt;/h4>&lt;pre>&lt;code>cd ~/OSX-KVM/scripts/ventura
make Ventura-recovery.dmg
# 实际下载地址：http://oscdn.apple.com/content/downloads/29/26/071-09012/dt7dmh4ttm1v5ze5989bid4gkovavkykjz/RecoveryImage/BaseSystem.dmg
&lt;/code>&lt;/pre>
&lt;p>根据提示，他最后一部 有执行 qemu-img convert BaseSystem.dmg -O raw Ventura-recovery.dmg 那么这个最终的dmg其实已经是raw文件了&lt;/p>
&lt;h4 id="拉到pve里面">拉到pve里面
&lt;/h4>&lt;p>pve 执行&lt;/p>
&lt;pre>&lt;code>pct pull 101 /root/OSX-KVM/scripts/ventura/Ventura-recovery.dmg /var/lib/vz/template/iso/Ventura-recovery.img
&lt;/code>&lt;/pre>
&lt;p>这样我们就拿到了Ventura-recovery.img&lt;/p>
&lt;p>ubuntu18的 容器可以关掉，也可以删除了&lt;/p>
&lt;h2 id="创建虚拟机">创建虚拟机
&lt;/h2>&lt;p>主要参数&lt;/p>
&lt;pre>&lt;code>操作系统 ： other iso文件：就是那个 OpenCore-vXX.iso 下一步
显卡：Vmware兼容 Qemu代理：勾选 机器：q35 BIOS：UEFI UEFI下面：预注册密钥 去掉,efi储存到local
总线：VirtIO 缓存：Write Back（不安全）格式qcow2 容量 28G+,建议32G+
CPU核心: 是2的次幂 2 4 8 16 我12核心的,只能给8 ，不可以12 10 18 这样的核心数，类型：penryn Numa启用
内存 4G以上，我这里 8192
网络模型：virtIO
&lt;/code>&lt;/pre>
&lt;p>创建了虚拟主机 102（macos），102 ，你的可能是别的&lt;/p>
&lt;p>在硬件里面，添加以恶搞cdrom到Ventura-recovery.img&lt;/p>
&lt;h2 id="开机之前手动编辑虚拟机配置">开机之前手动编辑虚拟机配置
&lt;/h2>&lt;p>有两个地方需要修改 /etc/pve/qemu-server/虚拟机编号.conf&lt;/p>
&lt;ul>
&lt;li>
&lt;p>前面挂载的opencoreXX.iso 以及 Ventura-recovery.img 改为硬盘模式&lt;/p>
&lt;/li>
&lt;li>
&lt;p>添加kvm的args 硬件欺骗&lt;/p>
&lt;pre>&lt;code>nano /etc/pve/qemu-server/102.conf
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h3 id="修改两个cdrom">修改两个cdrom
&lt;/h3>&lt;p>找到前面opencoreXX.iso 以及 Ventura-recovery.img 两行，两个 &lt;code>media=cdrom&lt;/code>删掉改为 &lt;code>cache=unsafe&lt;/code>&lt;/p>
&lt;h3 id="修改args参数">修改args参数
&lt;/h3>&lt;p>在第二行添加&lt;/p>
&lt;pre>&lt;code> args: -device isa-applesmc,osk=&amp;quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&amp;quot; -smbios type=2 -device usb-kbd,bus=ehci.0,port=2 -global nec-usb-xhci.msi=off -cpu host,kvm=on,vendor=GenuineIntel,+kvm_pv_unhalt,+kvm_pv_eoi,+hypervisor,+invtsc
&lt;/code>&lt;/pre>
&lt;p>如果你是amd的cpu 写法不同&lt;/p>
&lt;pre>&lt;code> args: -device isa-applesmc,osk=&amp;quot;这里得自己找~&amp;quot; -smbios type=2 -device usb-kbd,bus=ehci.0,port=2 -global nec-usb-xhci.msi=off -cpu Penryn,kvm=on,vendor=GenuineIntel,+kvm_pv_unhalt,+kvm_pv_eoi,+hypervisor,+invtsc,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+avx2,+aes,+fma,+fma4,+bmi1,+bmi2,+xsave,+xsaveopt,check
&lt;/code>&lt;/pre>
&lt;p>osk 是白苹果的一个类似设备编号的代码，同型号的macos都有相同这个代码，你可以网上搜索一下其他的代码&lt;/p>
&lt;h3 id="参考我的">参考我的
&lt;/h3>&lt;p>&lt;a class="link" href="https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/102.%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84macos13.conf" target="_blank" rel="noopener"
>点这里查看&lt;/a>&lt;/p>
&lt;h2 id="安装基本的macos">安装基本的macos
&lt;/h2>&lt;blockquote>
&lt;p>只所以说是基本的macos，是因为macos非常依赖显卡，这里暂时只搞到一个可以启动的macos13 动画部分会比较卡，也不支持硬件加速。&lt;br>
安装过程中，第一次 启动选 macos base，然后格式硬盘 卷标输入自定义一个，比如我就输入的&lt;code>kvm&lt;/code>，后面会重启多次，有 macos installer的时候 选macos install，有前面输入的卷标&lt;code>kvm&lt;/code>的时候选择kvm
其他安装过程和白苹果一样，并不复杂，进mac桌面后，自己修改成中文
开机自动倒计时进macos的优化 看后面章节
核显直通和蓝牙直通接力 等 请看 后面的进阶教程&lt;/p>&lt;/blockquote>
&lt;h2 id="macos的简单优化">macos的简单优化
&lt;/h2>&lt;p>安装完成后，在pve里面删除 挂载的 Ventura-recovery.img&lt;/p>
&lt;h3 id="中文化和时区">中文化和时区
&lt;/h3>&lt;p>OSX-KVM拉回来的镜像是英文版的，&lt;br>
点左上角苹果，system setting，搜索 lang，添加中文 删除英文。提示重启，重启一下&lt;br>
重启后，右上角键盘位置 设置输入法，通用设置 时间日期 时区 输入上海，回车。
提示重启的时候，建议不重启直接关机&lt;/p>
&lt;h3 id="可选操作打开macos的远程桌面-方便不使用网页控制他">可选操作：打开macos的远程桌面 方便不使用网页控制他
&lt;/h3>&lt;p>系统偏好设置，搜索 共享，打开共享设置， 打开远程管理（vnc+ard） 和远程登陆（ssh）&lt;br>
可选：点击 远程管理 后面那个叹号 ，再点 电脑设置 设置一个vnc 密码&lt;br>
点网络 以太网 查看一下ip，然后用vnc客户端远程，后面的操作用vnc客户端来操作，会比pve 的vnc网页控制台好用一些。&lt;/p>
&lt;h2 id="opencore的简单优化">opencore的简单优化
&lt;/h2>&lt;h3 id="准备工作1把opencore-到硬盘-方便后续修改">准备工作1：把opencore 到硬盘 方便后续修改
&lt;/h3>&lt;blockquote>
&lt;p>为了方便，强烈建议你 吧opencore复制到一个独立的虚拟硬盘。而不是和其他人的教程一样dd到macos所在的硬盘&lt;/p>&lt;/blockquote>
&lt;p>关机，删除前面挂载的Ventura-recovery.img 恢复镜像，我们已经用不到他了 pve添加一个硬盘 大小0.5 就好我这里用0.5 用来做efi分区。 建议 ide挂载，格式raw（文件不大，兼容性比qcow2好也方便其他软件修改编辑）。&lt;br>
macos 开始会提示 不能识别按照提示初始化，选择这个500M左右的硬盘 点抹掉 卷标 OPENCORE，格式fat，分区格式主引导记录。&lt;br>
格式完成后，再方达里面推出 这个OPENCORE卷，不然没法进行下一步
打开macos的终端 &lt;code>diskutil list&lt;/code>查看所有硬盘，可以看到 500多M这个硬盘是对应的硬盘编号是disk1 分区是 disk1s1
另外有一个 150M左右的 是我们前面的opencore的iso。 对应 disk0s1。我们用dd命令把oencore 弄到这个500M的虚拟磁盘上&lt;/p>
&lt;pre>&lt;code>sudo dd if=/dev/disk0s1 of=/dev/disk1s1
&lt;/code>&lt;/pre>
&lt;p>DD会同时把卷标OPENCORE 改成disk0s1的卷标EFI这个不影响。关机，在pve中删除前面的opencoer.iso ，选项里面 启动启动顺序 只选中这个 500M的 raw ，再次开机 就ok了&lt;/p>
&lt;p>如果要编辑efi，在磁盘工具里面直接装载 这个硬盘即可。&lt;/p>
&lt;h3 id="准备工作2安装使用opencore-configurator">准备工作2：安装使用opencore configurator
&lt;/h3>&lt;p>用macos自带的safari 打开本站，然后在本站搜索本页面标题打开下面的地址下载 opencore configurator，或者你也可以用你喜欢的其他工具 比如 ProperTree也不错&lt;/p>
&lt;p>&lt;a class="link" href="https://mackie100projects.altervista.org/download-opencore-configurator/" target="_blank" rel="noopener"
>https://mackie100projects.altervista.org/download-opencore-configurator/&lt;/a>&lt;/p>
&lt;p>safari下载后会自动解压。双击运行，然后打开 ，提示安全性问题，新版macos 在设置的隐私与安全性 地方，滚动到下面 找到 对应名称的 仍要打开，输入密码打开。&lt;/p>
&lt;p>如果你前面和我一样的操作，opencore的那个虚拟磁盘，会自动挂载到 /Volumos/OPENCORE ,否则请点击工具 挂载efi&lt;/p>
&lt;p>文件打开 找到 efi目录 oc 下的 config.plist, 就可以进行一些配置编辑工作了&lt;/p>
&lt;h3 id="opencore开机打印信息">opencore开机打印信息
&lt;/h3>&lt;p>开机不再显示白苹果进度条，而且跑代码显示操作，方便后续处理
opencore configurator依次找到&lt;/p>
&lt;p>NVRAM ，里面一般有三个，找到一个带 bootarge的，在他原来的选项后面 输入 空格-v ,新版 直接右键 选择 -v 就可以了&lt;/p>
&lt;h3 id="opencore开机倒计时启动">opencore开机倒计时启动
&lt;/h3>&lt;p>opencore configurator依次找到&lt;/p>
&lt;pre>&lt;code>MISC-&amp;gt;Security-&amp;gt;AllowSetDefault 勾选
Misc-&amp;gt;Boot-&amp;gt;Timeout 倒计时 时间 输入 5
&lt;/code>&lt;/pre>
&lt;p>文件 保存&lt;/p>
&lt;p>重启以后，选择 卷标 按 ctrl+回车 以后启动就会自动选择这个了。&lt;br>
注意 倒计时 不会显示时间的，到时间 就会自动启动了&lt;br>
修改前的文件备份 &lt;a class="link" href="https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config-1.plist" target="_blank" rel="noopener"
>https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config-1.plist&lt;/a>&lt;br>
修改后的 &lt;a class="link" href="https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config.2.plist" target="_blank" rel="noopener"
>https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/config.2.plist&lt;/a>&lt;/p>
&lt;h2 id="备份-准备做硬件直通">备份 准备做硬件直通
&lt;/h2>&lt;p>查看 ：&lt;a class="link" href="https://dev.leiyanhui.com/pve/mac-bak/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/mac-bak/&lt;/a>&lt;/p>
&lt;h2 id="进阶">进阶
&lt;/h2>&lt;h3 id="板载声卡-板载wifi直通-usb设备直通">板载声卡 板载wifi直通 usb设备直通
&lt;/h3>&lt;p>最新版pve7.2-11 直接添加pci设备 就可以了，不需要额外处理&lt;/p>
&lt;p>usb3.0设备 如果使用端口模式直通的话，需要在同一个端口上分别插入usb3 和usb1-2的设备，分别添加两次，如果基于供应商设备的直通，好像不可热拔插。&lt;/p>
&lt;h3 id="显卡直通并再hdmi口输出显示">显卡直通，并再HDMI口输出显示
&lt;/h3>&lt;h4 id="显卡直通先完成win10下的直通">显卡直通先完成win10下的直通
&lt;/h4>&lt;p>在macos这个主机上，添加一个16G左右的硬盘，挂载一个win10安装盘，设置好引导顺序安装一个win10进去，&lt;/p>
&lt;p>然后查看文章 &lt;a class="link" href="https://dev.leiyanhui.com/pve/win-gpu/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/win-gpu/&lt;/a> 先搞定win10下可以点亮屏幕&lt;/p>
&lt;p>其他处理中&lt;/p>
&lt;h3 id="只有一个usb控制器的情况下的pcie蓝牙直通">只有一个usb控制器的情况下的pcie蓝牙直通
&lt;/h3>&lt;p>简单的方案 就是把唯一的一个usb控制器给到虚拟机，在硬件里面 添加pice 直接选中这个usb，就把所有usb口直通进去了。。。那就导致 你鼠标键盘 U盘 都无法在pve下宿主机使用。
。另外一个方案 就是增加硬件 另外价格pcieusb控制器 ，其他方案 可能会复杂很多
我选择直接 直通进去
查看usb控制器&lt;/p>
&lt;pre>&lt;code>lspci -nn | grep USB
00:14.0 USB controller [0c03]: Intel Corporation 100 Series/C230 Series Chipset Family USB 3.0 xHCI Controller [8086:a12f] (rev 31)
&lt;/code>&lt;/pre>
&lt;h2 id="本文参考文章">本文参考文章
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.nicksherlock.com/2021/10/installing-macos-12-monterey-on-proxmox-7/" target="_blank" rel="noopener"
>https://www.nicksherlock.com/2021/10/installing-macos-12-monterey-on-proxmox-7/&lt;/a>&lt;/p></description></item><item><title>在pve上 efi q35 直通显卡显示，以及声卡和蓝牙 wifi等的直通 win/macos</title><link>https://dev.leiyanhui.com/pve/win-gpu/</link><pubDate>Fri, 28 Oct 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/win-gpu/</guid><description>&lt;blockquote>
&lt;p>本文假定，你已经装了一个系统，机型是 q35 efi启动。&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>目标，再q35 机型上 用efi 启动win 以及 opencore efi 启动的macos 可以点亮HDMI&lt;/p>&lt;/blockquote>
&lt;p>macos安装请查看&lt;a class="link" href="https://dev.leiyanhui.com/pve/install-macos-ventura/" target="_blank" rel="noopener"
>在pve上直接安装macos13 Ventura 初步优化&lt;/a>&lt;/p>
&lt;p>本文基于 efi grub pve7.2.11 更多环境参数查看 &lt;a class="link" href="https://dev.leiyanhui.com/pve/mac-bak/" target="_blank" rel="noopener"
>本文末尾&lt;/a>&lt;/p>
&lt;p>首先搞定相对比较简单的win10的显卡直通，以便后续调试macos&lt;/p>
&lt;h2 id="显卡直通">显卡直通
&lt;/h2>&lt;h3 id="vbois文件">vbois文件
&lt;/h3>&lt;p>因为是efi启动，所以必须提取显卡的vbois，如果你是独立显卡可以去这里下载 &lt;a class="link" href="https://www.techpowerup.com/vgabios/" target="_blank" rel="noopener"
>https://www.techpowerup.com/vgabios/&lt;/a>&lt;/p>
&lt;p>如果是核显，可以网上搜一下你的核显型号，看能不能找到可用的vbios，如果 依旧没有，就需要自己提取编译，具体网上搜一下教程我这里就不重复&lt;/p>
&lt;p>我的是uhd630 ， 网上找到了一份 在unraid下测试没问题的。https://github.com/joyanhui/file.leiyanhui.com/blob/main/pve-unraid-kvm/vbios_gvt_uefi.rom&lt;/p>
&lt;p>下载到pve里面 备用&lt;/p>
&lt;pre>&lt;code>cd /usr/share/kvm/
wget https://file.leiyanhui.com/pve-unraid-kvm/vbios_gvt_uefi.rom
&lt;/code>&lt;/pre>
&lt;h2 id="开启pve的显卡直通">开启pve的显卡直通
&lt;/h2>&lt;h3 id="grub的处理-开启iommu支持">grub的处理 开启IOMMU支持
&lt;/h3>&lt;pre>&lt;code>cp /etc/default/grub /etc/default/grub-bak
nano /etc/default/grub
&lt;/code>&lt;/pre>
&lt;p>修改GRUB_CMDLINE_LINUX_DEFAULT这行为&lt;/p>
&lt;pre>&lt;code> GRUB_CMDLINE_LINUX_DEFAULT=&amp;quot;quiet intel_iommu=on&amp;quot;
&lt;/code>&lt;/pre>
&lt;p>如果是amd的cpu 前面intel_iommu=on改为 amd_iommu=on&lt;br>
如果多显卡，可能还需要再这里做一下屏蔽处理 就是 羡慕的 =on 后面添加空格 &lt;code> video=efifb:off&lt;/code>&lt;/p>
&lt;pre>&lt;code>GRUB_CMDLINE_LINUX_DEFAULT=&amp;quot;quiet intel_iommu=on video=efifb:off&amp;quot;
&lt;/code>&lt;/pre>
&lt;p>解释：&lt;/p>
&lt;pre>&lt;code>iommu开启直通分组
efifb:off 禁用efi启动的显示设备
vesafb:off 禁用legacy启动的显示设备
&lt;/code>&lt;/pre>
&lt;h3 id="modprobe的处理-vt-d功能的内核模块">modprobe的处理 VT-D功能的内核模块
&lt;/h3>&lt;pre>&lt;code>cp /etc/modules /etc/modules-bak
nano /etc/modules
&lt;/code>&lt;/pre>
&lt;p>添加&lt;/p>
&lt;pre>&lt;code>vfio
vfio_iommu_type1
vfio_pc
vfio_virqfd
&lt;/code>&lt;/pre>
&lt;h3 id="检查黑名单">检查黑名单
&lt;/h3>&lt;p>因为pve启动时会尝试加载显卡驱动，为了避免pve占用显卡，需要阻止pve的显卡驱动加载。只有显卡直通才需要这个
模块（驱动）黑名单，即让GPU设备在下次系统启动之后不使用这些驱动，把设备腾出来给vfio驱动用：
/etc/modprobe.d/pve-blacklist.conf 看看有没有下面的内容，如果你后面要用钩子函数，就需要删除下面的内容，不用的话，最好是添加进去&lt;/p>
&lt;pre>&lt;code>cp /etc/modprobe.d/pve-blacklist.conf /etc/modprobe.d/pve-blacklist.conf-bak
nano /etc/modprobe.d/pve-blacklist.conf
&lt;/code>&lt;/pre>
&lt;p>内容&lt;/p>
&lt;pre>&lt;code>blacklist i915
blacklist snd_hda_intel
blacklist snd_hda_codec_hdmi
&lt;/code>&lt;/pre>
&lt;p>其他显卡&lt;/p>
&lt;pre>&lt;code># block AMD driver
blacklist radeon
blacklist amdgpu
# block NVIDIA driver
blacklist nouveau
blacklist nvidia
blacklist nvidiafb
&lt;/code>&lt;/pre>
&lt;h2 id="处理一个kvm的配置项可以避免一些特殊问题">处理一个kvm的配置项，可以避免一些特殊问题
&lt;/h2>&lt;p>如果是N卡还需要加入下面的配置到kvm.conf（据老外说是避免一些莫名其妙的错误）,&lt;/p>
&lt;p>如果你要跑macos的话 最好也添加一下,据说也可以避免macos无限重启&lt;/p>
&lt;pre>&lt;code>echo &amp;quot;options kvm ignore_msrs=Y&amp;quot; &amp;gt; /etc/modprobe.d/kvm.conf
&lt;/code>&lt;/pre>
&lt;p>也有国外教程是&lt;/p>
&lt;pre>&lt;code>echo &amp;quot;options kvm ignore_msrs=1&amp;quot; &amp;gt; /etc/modprobe.d/kvm.conf
&lt;/code>&lt;/pre>
&lt;p>不清楚那个是最合适的，我用第一个，只添加这行的话，会却会导致pve的母鸡控制台刷屏&lt;code>kvm [2205]: vcpu0 ignored RDMSR: 0x1b8&lt;/code>类似的代码，你如果觉得烦躁。
你可以 修改成 &lt;code>options kvm ignore_msrs=Y report_ignored_msrs=N&lt;/code>&lt;/p>
&lt;p>重启生效，或者 &lt;code>echo 0 &amp;gt; /sys/module/kvm/parameters/report_ignored_msrs&lt;/code> 强制生效&lt;/p>
&lt;h3 id="允许不安全的中断">允许不安全的中断
&lt;/h3>&lt;pre>&lt;code>echo &amp;quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&amp;quot; &amp;gt; /etc/modprobe.d/iommu_unsafe_interrupts.conf
&lt;/code>&lt;/pre>
&lt;h2 id="添加显卡到直通设备中-写入vfio">添加显卡到直通设备中 写入vfio
&lt;/h2>&lt;h3 id="查看pci设备">查看pci设备
&lt;/h3>&lt;pre>&lt;code>lspci -nn | grep 显卡名称
&lt;/code>&lt;/pre>
&lt;p>例如&lt;/p>
&lt;pre>&lt;code>lspci -nn | grep UHD
00:02.0 VGA compatible controller [0300]: Intel Corporation CoffeeLake-H GT2 [UHD Graphics 630] [8086:3e9b]
&lt;/code>&lt;/pre>
&lt;p>记住前面和最后的地址 &lt;code> 00:02&lt;/code> 和 &lt;code>8086:3e9b&lt;/code>&lt;/p>
&lt;p>由于我们需要让设备直通虚拟机, 那就不能让宿主机的驱动去接管这些硬件, 我们需要一个 dummy 驱动模块去接管这些要被直通的硬件.
找到你想要直通的设备的 ID, 并且注意每个设备所在组的其他设备(编辑文件 /etc/modprobe.d/vfio.conf.&lt;/p>
&lt;pre>&lt;code>echo &amp;quot;options vfio-pci ids=8086:3e9b&amp;quot; &amp;gt; /etc/modprobe.d/vfio.conf
&lt;/code>&lt;/pre>
&lt;p>ps：执行此操作后可能无法输出到外接显示器，若出现此情况，请撤回该步骤&lt;/p>
&lt;p>另外有一个 参数 &lt;code>disable_vga=1&lt;/code> 也可能会影响&lt;/p>
&lt;pre>&lt;code>echo &amp;quot;options vfio-pci ids=8086:3e9b disable_vga=1&amp;quot; &amp;gt; /etc/modprobe.d/vfio.conf
&lt;/code>&lt;/pre>
&lt;p>但是为了避免 initrd 引入的内核模块中 vfio 位于物理驱动的后面, 这里有两套方案：
根据 lspci &amp;ndash;nnk 的内容, 找到每个设备对应的驱动,
修改 （arch） /etc/blacklist.conf 或者（pve）/etc/modprobe.d/pve-blacklist.conf 我们前面已经处理过&lt;/p>
&lt;p>另外有一个usb控制器 可能后面也要用到&lt;/p>
&lt;pre>&lt;code>lspci -nn | grep USB
00:14.0 USB controller [0c03]: Intel Corporation 100 Series/C230 Series Chipset Family USB 3.0 xHCI Controller [8086:a12f] (rev 31)
&lt;/code>&lt;/pre>
&lt;p>我主板只有一个usb控制器，直通其他usb设备没问题，pcie板载蓝牙的话，是不行的&lt;/p>
&lt;h3 id="重启">重启
&lt;/h3>&lt;p>重启之前 需要更新一下 grub和 update-initramfs -u&lt;/p>
&lt;pre>&lt;code>update-grub
update-initramfs -u
&lt;/code>&lt;/pre>
&lt;p>执行结果&lt;/p>
&lt;pre>&lt;code>update-grub
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-5.15.64-1-pve
Found initrd image: /boot/initrd.img-5.15.64-1-pve
Found linux image: /boot/vmlinuz-5.15.30-2-pve
Found initrd image: /boot/initrd.img-5.15.30-2-pve
Found memtest86+ image: /boot/memtest86+.bin
Found memtest86+ multiboot image: /boot/memtest86+_multiboot.bin
Adding boot menu entry for UEFI Firmware Settings ...
done
update-initramfs -u
update-initramfs: Generating /boot/initrd.img-5.15.64-1-pve
Running hook script 'zz-proxmox-boot'..
Re-executing '/etc/kernel/postinst.d/zz-proxmox-boot' in new private mount namespace..
No /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.
&lt;/code>&lt;/pre>
&lt;p>如果你和我一样是 ventoy引导的pve 还需要执行一下，不然就启动不起来了&lt;/p>
&lt;pre>&lt;code> cd /root/vtoyboot-1.0.24/
sh vtoyboot.sh
&lt;/code>&lt;/pre>
&lt;p>执行结果&lt;/p>
&lt;pre>&lt;code>**********************************************
vtoyboot 1.0.24
longpanda admin@ventoy.net
https://www.ventoy.net
**********************************************
Current system use initramfstool as initramfs tool
updating the initramfs, please wait ...
update-initramfs: Generating /boot/initrd.img-5.15.64-1-pve
Running hook script 'zz-proxmox-boot'..
Re-executing '/etc/kernel/postinst.d/zz-proxmox-boot' in new private mount namespace..
No /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.
grub mkconfig ...
PROBE_PATH=/usr/sbin/grub-probe MKCONFIG_PATH=/usr/sbin/grub-mkconfig
/usr/sbin/grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-5.15.64-1-pve
Found initrd image: /boot/initrd.img-5.15.64-1-pve
Found linux image: /boot/vmlinuz-5.15.30-2-pve
Found initrd image: /boot/initrd.img-5.15.30-2-pve
Found memtest86+ image: /boot/memtest86+.bin
Found memtest86+ multiboot image: /boot/memtest86+_multiboot.bin
Adding boot menu entry for UEFI Firmware Settings ...
done
This is ventoy enviroment
replace shim efi ...
shimx64.efi no need 0
vtoyboot process successfully finished.
&lt;/code>&lt;/pre>
&lt;p>重启之前，检查一下每一个文件，可以参考我的结果&lt;/p>
&lt;p>&lt;code>cat /etc/default/grub&lt;/code>&lt;/p>
&lt;p>&lt;code>cat /etc/modules&lt;/code>&lt;/p>
&lt;p>&lt;code>cat /etc/modprobe.d/pve-blacklist.conf&lt;/code>&lt;/p>
&lt;p>&lt;code>cat /etc/modprobe.d/kvm.conf&lt;/code>&lt;/p>
&lt;p>&lt;code>cat /etc/modprobe.d/iommu_unsafe_interrupts.conf&lt;/code>&lt;/p>
&lt;p>&lt;code>cat /etc/modprobe.d/vfio.conf&lt;/code>&lt;/p>
&lt;h4 id="我的检查-执行结果">我的检查 执行结果
&lt;/h4>&lt;pre>&lt;code>cat /etc/default/grub
# If you change this file, run 'update-grub' afterwards to update
# /boot/grub/grub.cfg.
# For full documentation of the options in this file, see:
# info -f grub -n 'Simple configuration'
GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR=`lsb_release -i -s 2&amp;gt; /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT=&amp;quot;quiet intel_iommu=on&amp;quot;
GRUB_CMDLINE_LINUX=&amp;quot;&amp;quot;
# Uncomment to enable BadRAM filtering, modify to suit your needs
# This works with Linux (no patch required) and with any kernel that obtains
# the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)
#GRUB_BADRAM=&amp;quot;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&amp;quot;
# Uncomment to disable graphical terminal (grub-pc only)
#GRUB_TERMINAL=console
# The resolution used on graphical terminal
# note that you can use only modes which your graphic card supports via VBE
# you can see them in real GRUB with the command `vbeinfo'
#GRUB_GFXMODE=640x480
# Uncomment if you don't want GRUB to pass &amp;quot;root=UUID=xxx&amp;quot; parameter to Linux
#GRUB_DISABLE_LINUX_UUID=true
# Uncomment to disable generation of recovery mode menu entries
#GRUB_DISABLE_RECOVERY=&amp;quot;true&amp;quot;
# Uncomment to get a beep at grub start
#GRUB_INIT_TUNE=&amp;quot;480 440 1&amp;quot;
-----------------------------------
cat /etc/modules
# /etc/modules: kernel modules to load at boot time.
#
# This file contains the names of kernel modules that should be loaded
# at boot time, one per line. Lines beginning with &amp;quot;#&amp;quot; are ignored.
vfio
vfio_iommu_type1
vfio_pc
vfio_virqfd
-----------------------------------
cat /etc/modprobe.d/pve-blacklist.conf
# This file contains a list of modules which are not supported by Proxmox VE
# nidiafb see bugreport https://bugzilla.proxmox.com/show_bug.cgi?id=701
blacklist nvidiafb
blacklist i915
blacklist snd_hda_intel
blacklist snd_hda_codec_hdmi
-----------------------------------
cat /etc/modprobe.d/kvm.conf
options kvm ignore_msrs=Y
-----------------------------------
cat /etc/modprobe.d/iommu_unsafe_interrupts.conf
options vfio_iommu_type1 allow_unsafe_interrupts=1
-----------------------------------
cat /etc/modprobe.d/vfio.conf
cat: /etc/modprobe.d/vfio.conf: No such file or directory
&lt;/code>&lt;/pre>
&lt;h2 id="检查没问题后-重启">检查没问题后 重启
&lt;/h2>&lt;p>&lt;code>reboot&lt;/code>&lt;/p>
&lt;h2 id="查看模块是否有问题">查看模块是否有问题
&lt;/h2>&lt;pre>&lt;code>lsmod | grep vfio
&lt;/code>&lt;/pre>
&lt;p>结果&lt;/p>
&lt;pre>&lt;code>vfio_virqfd 16384 0
vfio_iommu_type1 40960 0
vfio 45056 1 vfio_iommu_type1
&lt;/code>&lt;/pre>
&lt;h2 id="虚拟机添加显卡">虚拟机添加显卡
&lt;/h2>&lt;p>再这里可以直接在虚拟机里面添加硬件 选择这个显卡了。但是如果是efi启动的 虚拟机能找到设备，但是显卡输出黑屏的。
可以先进去win 用vnc或者 远程桌面 装好直通进去的显卡的驱动。
所以我们还需要手动处理一下虚拟配置文件。我要操作的虚拟机 是macos+win的这双系统主机 102。&lt;/p>
&lt;pre>&lt;code> cp /etc/pve/qemu-server/102.conf /etc/pve/qemu-server/102.conf-bak
nano /etc/pve/qemu-server/102.conf
&lt;/code>&lt;/pre>
&lt;p>在显卡那条hostpci的最后加上,romfile=vbios_gvt_uefi.rom ,如果其他显卡 前面的地址可能不太一样&lt;/p>
&lt;pre>&lt;code>hostpci0: 0000:00:02.0,pcie=1,romfile=vbios_gvt_uefi.rom
&lt;/code>&lt;/pre>
&lt;p>如果上面的方法不行，那就删掉hostpci0那行，在文件最上面加上这行，并且把 显示 设置成 无，不加romfile有可能也能用，可以先试试&lt;/p>
&lt;pre>&lt;code>args: -device vfio-pci,host=00:02.0,addr=0x02,x-igd-gms=1,romfile=vbios_gvt_uefi.rom
&lt;/code>&lt;/pre>
&lt;p>还有一种写法 是&lt;/p>
&lt;pre>&lt;code>args: -device vfio-pci,host=00:02.0,addr=0x02,x-igd-opregion=on,romfile=vbios_gvt_uefi.rom
&lt;/code>&lt;/pre>
&lt;p>经过我的测试，后者写法可以再q35 efi模式下 顺利点亮，另外 虚拟显卡 可以保留，但是win10直通的鼠标不显示指针&lt;/p>
&lt;p>如果你和我一样 要装黑苹果，可能已经有args这行，那就大概改成 下面这样&lt;/p>
&lt;pre>&lt;code>args: -device vfio-pci,host=00:02.0,addr=0x02,x-igd-opregion=on,romfile=vbios_gvt_uefi.rom -device isa-applesmc,osk=&amp;quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&amp;quot; -smbios type=2 -device usb-kbd,bus=ehci.0,port=2 -global nec-usb-xhci.msi=off -global&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>另外你可能需要把显示 设置成 无 多试试&lt;/p>
&lt;p>如果启动的时候，提示 failed to open /dev/vfio/1: No such file or directory
那是因为 我们用args的时候 系统没有自动将设备重新绑定到vfio-pci模块，&lt;/p>
&lt;p>就需要我们&lt;/p>
&lt;p>1、删除或注释/etc/modprobe.d中绑定显卡id到vfio-pci的操作，如#options vfio-pci ids=8086:3184,8086:3198&lt;/p>
&lt;pre>&lt;code>rm -rf /etc/modprobe.d/vfio.conf
&lt;/code>&lt;/pre>
&lt;p>2、编辑/etc/default/grub
添加vfio-pci.ids=8086:3184 8086:3198到 GRUB_CMDLINE_LINUX= &amp;ldquo;&amp;quot;（添加到引号内，id就是显卡id，有时需要将声卡id一并加入）&lt;/p>
&lt;pre>&lt;code> GRUB_CMDLINE_LINUX= &amp;quot;vfio-pci.ids=8086:3e9b&amp;quot;
&lt;/code>&lt;/pre>
&lt;p>3、更新重启&lt;/p>
&lt;pre>&lt;code> update-grub
&lt;/code>&lt;/pre>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">agent: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">args: -device vfio-pci,host=00:02.0,addr=0x02,x-igd-opregion=on,romfile=vbios_gvt_uefi.rom -device isa-applesmc,osk=&amp;#34;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&amp;#34; &amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bios: ovmf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot: order=virtio0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cores: 8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu: Penryn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">efidisk0: local:102/vm-102-disk-0.qcow2,efitype=4m,size=528K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine: q35
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memory: 8192
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">meta: creation-qemu=7.0.0,ctime=1667039767
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net0: virtio=EA:46:2B:E6:EF:5F,bridge=vmbr0,firewall=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">numa: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ostype: other
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sata1: none,media=cdrom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scsihw: virtio-scsi-pci
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">smbios1: uuid=cbc57782-404a-4a2c-8500-78d072f75125
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sockets: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vga: vmware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio0: local:102/vm-102-disk-2.raw,size=512M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio1: local:102/vm-102-disk-1.qcow2,size=32G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virtio3: local:102/vm-102-disk-3.qcow2,cache=unsafe,size=16G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vmgenid: f216093f-9c67-4801-934e-0a6c31fbb4fe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="其他设备的直通">其他设备的直通
&lt;/h2>&lt;p>声卡和USB的直通 pve7.2 目前已经可以直接直通进去，不需要任何额外操作
HDMI 声音的直通，参考上面显卡 的
蓝牙的直通，如果是外置的usb蓝牙简单，如果是类似笔记本 或者 黑苹果的wifi上的的蓝牙，可能不一定可以驱动，可以尝试吧整个usb控制器直通进去先试试，如果可以再想办法尝试 通过pcei usb扩展卡 或者其他方法解决&lt;/p>
&lt;p>参考：
&lt;a class="link" href="https://zhuanlan.zhihu.com/p/577161166" target="_blank" rel="noopener"
>https://zhuanlan.zhihu.com/p/577161166&lt;/a>
&lt;a class="link" href="https://zyyme.com/pve-igpu-passthrough.html" target="_blank" rel="noopener"
>https://zyyme.com/pve-igpu-passthrough.html&lt;/a>
&lt;a class="link" href="https://www.right.com.cn/forum/thread-4055200-1-1.html" target="_blank" rel="noopener"
>https://www.right.com.cn/forum/thread-4055200-1-1.html&lt;/a>
一个比较简单的显卡vbois提取教程：https://www.jianshu.com/p/3ec6891ac5c8
一个比较易懂的kvm教程 &lt;a class="link" href="https://zhuanlan.zhihu.com/p/60389508" target="_blank" rel="noopener"
>https://zhuanlan.zhihu.com/p/60389508&lt;/a>&lt;/p></description></item><item><title>pve安装的macos简单备份</title><link>https://dev.leiyanhui.com/pve/mac-bak/</link><pubDate>Fri, 28 Oct 2022 15:29:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/mac-bak/</guid><description>&lt;p>前面已经 &lt;a class="link" href="https://dev.leiyanhui.com/pve/install-macos-ventura" target="_blank" rel="noopener"
>初步安装了macos 在102上&lt;/a>，现在准备做硬件直通，关机备份一下。。&lt;/p>
&lt;h2 id="备份虚拟机">备份虚拟机
&lt;/h2>&lt;pre>&lt;code>mount /dev/sda1 /mnt
cp -r /var/lib/vz/images/102 /mnt/pve-maco-base
&lt;/code>&lt;/pre>
&lt;h2 id="备份虚拟机配置文件">备份虚拟机配置文件
&lt;/h2>&lt;pre>&lt;code>cp /etc/pve/qemu-server/102.conf /mnt/pve-maco-base/102.conf
&lt;/code>&lt;/pre>
&lt;h2 id="备份改动过的一个配置项">备份改动过的一个配置项
&lt;/h2>&lt;pre>&lt;code>cp /etc/modprobe.d/kvm.conf /mnt/pve-maco-base/kvm.conf
&lt;/code>&lt;/pre>
&lt;h2 id="记录环境信息">记录环境信息
&lt;/h2>&lt;pre>&lt;code>#内核
cat /proc/version &amp;gt; /mnt/pve-maco-base/pveinfo.txt
#版本
cat /etc/debian_version &amp;gt;&amp;gt; /mnt/pve-maco-base/pveinfo.txt
# pve版本
pveversion -v &amp;gt;&amp;gt; /mnt/pve-maco-base/pveinfo.txt
&lt;/code>&lt;/pre>
&lt;h3 id="我的最终环境信息">我的最终环境信息
&lt;/h3>&lt;pre>&lt;code>Linux version 5.15.64-1-pve (build@proxmox) (gcc (Debian 10.2.1-6) 10.2.1 20210110, GNU ld (GNU Binutils for Debian) 2.35.2) #1 SMP PVE 5.15.64-1 (Thu, 13 Oct 2022 10:30:34 +0200)
debian 11.5
proxmox-ve: 7.2-1 (running kernel: 5.15.64-1-pve)
pve-manager: 7.2-11 (running version: 7.2-11/b76d3178)
pve-kernel-5.15: 7.2-13
pve-kernel-helper: 7.2-13
pve-kernel-5.15.64-1-pve: 5.15.64-1
pve-kernel-5.15.30-2-pve: 5.15.30-3
ceph-fuse: 15.2.16-pve1
corosync: 3.1.5-pve2
criu: 3.15-1+pve-1
glusterfs-client: 9.2-1
ifupdown2: 3.1.0-1+pmx3
ksm-control-daemon: 1.4-1
libjs-extjs: 7.0.0-1
libknet1: 1.24-pve1
libproxmox-acme-perl: 1.4.2
libproxmox-backup-qemu0: 1.3.1-1
libpve-access-control: 7.2-4
libpve-apiclient-perl: 3.2-1
libpve-common-perl: 7.2-3
libpve-guest-common-perl: 4.1-4
libpve-http-server-perl: 4.1-4
libpve-storage-perl: 7.2-10
libspice-server1: 0.14.3-2.1
lvm2: 2.03.11-2.1
lxc-pve: 5.0.0-3
lxcfs: 4.0.12-pve1
novnc-pve: 1.3.0-3
proxmox-backup-client: 2.2.7-1
proxmox-backup-file-restore: 2.2.7-1
proxmox-mini-journalreader: 1.3-1
proxmox-widget-toolkit: 3.5.1
pve-cluster: 7.2-2
pve-container: 4.2-3
pve-docs: 7.2-2
pve-edk2-firmware: 3.20220526-1
pve-firewall: 4.2-6
pve-firmware: 3.5-6
pve-ha-manager: 3.4.0
pve-i18n: 2.7-2
pve-qemu-kvm: 7.0.0-4
pve-xtermjs: 4.16.0-1
qemu-server: 7.2-4
smartmontools: 7.2-pve3
spiceterm: 3.2-2
swtpm: 0.7.1~bpo11+1
vncterm: 1.7-1
zfsutils-linux: 2.1.6-pve1
&lt;/code>&lt;/pre></description></item></channel></rss>