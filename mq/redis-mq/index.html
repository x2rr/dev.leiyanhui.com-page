<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本文只针对笔者自己的项目情况，不使用redis，而且使用更专业的消息队列服务器的存在有更充分的理由。\n选择的原因 性能天花板 从树莓派到志强，redis是所有mq服务器的天花板。\n自己手撸的简单hash map查询 业务添加一些 都比不过redis，而且在大量数据的情况下，查询和操作速度更是直线下滑。想做到极致的性能优化需要大量繁重工作，不如直接拿来就用\n简单灵活的高可用性集群 哨兵模式和主从模式也不是不能用。\ncluster 虽然必须要最少3主3从才能实现高可用性，但是很容易满足。3台云服务器即可 互为主从 并集群，可以在线扩容，在线收缩，简单灵活可靠。\n低流量消耗的轻量化协议 redis 是基于tcp的简单文本协议，没有协议头，没有校验码，没有封装，每一个字节都是有效必须的数据，大大节省服务器带宽资源\n活跃的老项目良好的向上兼容 redis至今依旧维持较为频繁的功能和性能更新\n免中间件 1、工作量小 服务器上不需要再运行太多程序，开发工作小很多（在大并发环境一个中间件 真的很需要时间调试优化）\n2、节省服务器开支\n性能下限高 团队里面的实习生，只要不让他碰redis扩展module的代码，再烂的代码也不会影响整体运行\n不用更专业的mq的原因 现有的主流mq服务， 性能都低于redis,在集群扩展上也都远远不如redis灵活和高效。\n部分mq自带的消息持久化储存 性能更是一般，外部储存方式 多了一层转换。很多mq可能已经很轻量，但是相对 redis 还是差了一些。 Kafka RocketMQ Apollo ZeroMQ ActiveMQ RabbitMQ emqx Mosquitto 情况差不多，不展开细说\n集群方面，要么死板复杂不能热扩容收缩，要么集群后单机性能会掉\n不使用 loTDB的原因 没有看到loTDB的压测数据，自己简单测试过后性能不理想\n不自己开发私有协议的原因 私有协议 可以灵活使用 tcp/udp 包括上层websocket。但是集群部署 还有大量map的操作 开发工作量比较大。\n另外 golang在 大并发情况下 资源占用要比C高很多，引入epoll可以降低一些，但是开发工作量还是不低。\n物联网设备通讯要求 基本 包括多数物联网设备的的要求 我手上的项目情况有以下要求：\n低成本、可快速扩展、高可用性集群 部分功能要求消息必须送达：例如 报警信息 部分消息 要求 只可以送达1次，不可重复送达：例如 提醒消息 部分数据允许少量丢失: 例如设备实时采集的数据 设备24小时开机，不停上报数据。对服务器处理和记录能力有一定要求（最主要是服务器成本要低） 设备离线通知和报警 设备和用户app可以直接进行通讯，当然 这里指的还是服务器转发消息 qps的严格限制，防止服务器被拉垮 部分功能需要 tls加密通讯 消息需要选择性的持久化和转存 tcp和udp 国内环境下 部分地区部分时段udp 丢包严重。另外udp每次都需要带一定字数的token信息 虽然减少了握手环节，但是对于 少量频繁的数据通讯 就会明显增加服务器流量开支\nws协议，有更好，没有可以接受，毕竟物联网设备直接tcp udp是没问题的。\n"><title>redis 替代 mqtt 和自定义协议 作为物联网设备通讯的 可行性</title><link rel=canonical href=https://dev.leiyanhui.com/mq/redis-mq/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="redis 替代 mqtt 和自定义协议 作为物联网设备通讯的 可行性"><meta property='og:description' content="本文只针对笔者自己的项目情况，不使用redis，而且使用更专业的消息队列服务器的存在有更充分的理由。\n选择的原因 性能天花板 从树莓派到志强，redis是所有mq服务器的天花板。\n自己手撸的简单hash map查询 业务添加一些 都比不过redis，而且在大量数据的情况下，查询和操作速度更是直线下滑。想做到极致的性能优化需要大量繁重工作，不如直接拿来就用\n简单灵活的高可用性集群 哨兵模式和主从模式也不是不能用。\ncluster 虽然必须要最少3主3从才能实现高可用性，但是很容易满足。3台云服务器即可 互为主从 并集群，可以在线扩容，在线收缩，简单灵活可靠。\n低流量消耗的轻量化协议 redis 是基于tcp的简单文本协议，没有协议头，没有校验码，没有封装，每一个字节都是有效必须的数据，大大节省服务器带宽资源\n活跃的老项目良好的向上兼容 redis至今依旧维持较为频繁的功能和性能更新\n免中间件 1、工作量小 服务器上不需要再运行太多程序，开发工作小很多（在大并发环境一个中间件 真的很需要时间调试优化）\n2、节省服务器开支\n性能下限高 团队里面的实习生，只要不让他碰redis扩展module的代码，再烂的代码也不会影响整体运行\n不用更专业的mq的原因 现有的主流mq服务， 性能都低于redis,在集群扩展上也都远远不如redis灵活和高效。\n部分mq自带的消息持久化储存 性能更是一般，外部储存方式 多了一层转换。很多mq可能已经很轻量，但是相对 redis 还是差了一些。 Kafka RocketMQ Apollo ZeroMQ ActiveMQ RabbitMQ emqx Mosquitto 情况差不多，不展开细说\n集群方面，要么死板复杂不能热扩容收缩，要么集群后单机性能会掉\n不使用 loTDB的原因 没有看到loTDB的压测数据，自己简单测试过后性能不理想\n不自己开发私有协议的原因 私有协议 可以灵活使用 tcp/udp 包括上层websocket。但是集群部署 还有大量map的操作 开发工作量比较大。\n另外 golang在 大并发情况下 资源占用要比C高很多，引入epoll可以降低一些，但是开发工作量还是不低。\n物联网设备通讯要求 基本 包括多数物联网设备的的要求 我手上的项目情况有以下要求：\n低成本、可快速扩展、高可用性集群 部分功能要求消息必须送达：例如 报警信息 部分消息 要求 只可以送达1次，不可重复送达：例如 提醒消息 部分数据允许少量丢失: 例如设备实时采集的数据 设备24小时开机，不停上报数据。对服务器处理和记录能力有一定要求（最主要是服务器成本要低） 设备离线通知和报警 设备和用户app可以直接进行通讯，当然 这里指的还是服务器转发消息 qps的严格限制，防止服务器被拉垮 部分功能需要 tls加密通讯 消息需要选择性的持久化和转存 tcp和udp 国内环境下 部分地区部分时段udp 丢包严重。另外udp每次都需要带一定字数的token信息 虽然减少了握手环节，但是对于 少量频繁的数据通讯 就会明显增加服务器流量开支\nws协议，有更好，没有可以接受，毕竟物联网设备直接tcp udp是没问题的。\n"><meta property='og:url' content='https://dev.leiyanhui.com/mq/redis-mq/'><meta property='og:site_name' content='小类随手记'><meta property='og:type' content='article'><meta property='article:section' content='Mq'><meta property='article:published_time' content='2023-08-18T05:14:20+08:00'><meta property='article:modified_time' content='2023-08-18T05:14:20+08:00'><meta name=twitter:title content="redis 替代 mqtt 和自定义协议 作为物联网设备通讯的 可行性"><meta name=twitter:description content="本文只针对笔者自己的项目情况，不使用redis，而且使用更专业的消息队列服务器的存在有更充分的理由。\n选择的原因 性能天花板 从树莓派到志强，redis是所有mq服务器的天花板。\n自己手撸的简单hash map查询 业务添加一些 都比不过redis，而且在大量数据的情况下，查询和操作速度更是直线下滑。想做到极致的性能优化需要大量繁重工作，不如直接拿来就用\n简单灵活的高可用性集群 哨兵模式和主从模式也不是不能用。\ncluster 虽然必须要最少3主3从才能实现高可用性，但是很容易满足。3台云服务器即可 互为主从 并集群，可以在线扩容，在线收缩，简单灵活可靠。\n低流量消耗的轻量化协议 redis 是基于tcp的简单文本协议，没有协议头，没有校验码，没有封装，每一个字节都是有效必须的数据，大大节省服务器带宽资源\n活跃的老项目良好的向上兼容 redis至今依旧维持较为频繁的功能和性能更新\n免中间件 1、工作量小 服务器上不需要再运行太多程序，开发工作小很多（在大并发环境一个中间件 真的很需要时间调试优化）\n2、节省服务器开支\n性能下限高 团队里面的实习生，只要不让他碰redis扩展module的代码，再烂的代码也不会影响整体运行\n不用更专业的mq的原因 现有的主流mq服务， 性能都低于redis,在集群扩展上也都远远不如redis灵活和高效。\n部分mq自带的消息持久化储存 性能更是一般，外部储存方式 多了一层转换。很多mq可能已经很轻量，但是相对 redis 还是差了一些。 Kafka RocketMQ Apollo ZeroMQ ActiveMQ RabbitMQ emqx Mosquitto 情况差不多，不展开细说\n集群方面，要么死板复杂不能热扩容收缩，要么集群后单机性能会掉\n不使用 loTDB的原因 没有看到loTDB的压测数据，自己简单测试过后性能不理想\n不自己开发私有协议的原因 私有协议 可以灵活使用 tcp/udp 包括上层websocket。但是集群部署 还有大量map的操作 开发工作量比较大。\n另外 golang在 大并发情况下 资源占用要比C高很多，引入epoll可以降低一些，但是开发工作量还是不低。\n物联网设备通讯要求 基本 包括多数物联网设备的的要求 我手上的项目情况有以下要求：\n低成本、可快速扩展、高可用性集群 部分功能要求消息必须送达：例如 报警信息 部分消息 要求 只可以送达1次，不可重复送达：例如 提醒消息 部分数据允许少量丢失: 例如设备实时采集的数据 设备24小时开机，不停上报数据。对服务器处理和记录能力有一定要求（最主要是服务器成本要低） 设备离线通知和报警 设备和用户app可以直接进行通讯，当然 这里指的还是服务器转发消息 qps的严格限制，防止服务器被拉垮 部分功能需要 tls加密通讯 消息需要选择性的持久化和转存 tcp和udp 国内环境下 部分地区部分时段udp 丢包严重。另外udp每次都需要带一定字数的token信息 虽然减少了握手环节，但是对于 少量频繁的数据通讯 就会明显增加服务器流量开支\nws协议，有更好，没有可以接受，毕竟物联网设备直接tcp udp是没问题的。\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_6049d840d4e2d14.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐟</span></figure><div class=site-meta><h1 class=site-name><a href=/>小类随手记</a></h1><h2 class=site-description>just so so.</h2></div></header><ol class=menu-social><li><a href=https://github.com/joyanhui/dev.leiyanhui.com-src target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>列表</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>站内搜索</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>links</span></a></li><li><a href=/contact/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>contact</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#选择的原因>选择的原因</a><ol><li><a href=#性能天花板>性能天花板</a></li><li><a href=#简单灵活的高可用性集群>简单灵活的高可用性集群</a></li><li><a href=#低流量消耗的轻量化协议>低流量消耗的轻量化协议</a></li><li><a href=#活跃的老项目良好的向上兼容>活跃的老项目良好的向上兼容</a></li><li><a href=#免中间件>免中间件</a></li><li><a href=#性能下限高>性能下限高</a></li></ol></li><li><a href=#不用更专业的mq的原因>不用更专业的mq的原因</a></li><li><a href=#不使用-lotdb的原因>不使用 loTDB的原因</a></li><li><a href=#不自己开发私有协议的原因>不自己开发私有协议的原因</a></li><li><a href=#物联网设备通讯要求>物联网设备通讯要求</a><ol><li><a href=#基本>基本</a></li><li><a href=#tcp和udp>tcp和udp</a></li><li><a href=#自定义协议和现有协议的选择>自定义协议和现有协议的选择</a></li><li><a href=#数据的序列化和反序列化>数据的序列化和反序列化</a></li></ol></li><li><a href=#用redis实现上面的功能的逐一说明>用redis实现上面的功能的逐一说明</a></li><li><a href=#关于权限控制和防恶意用户>关于权限控制和防恶意用户</a></li><li><a href=#其他安全措施>其他安全措施</a></li><li><a href=#优点>优点</a></li><li><a href=#最后说一下缺点>最后说一下缺点</a></li><li><a href=#权衡后>权衡后</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/redis/>Redis</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/mq/redis-mq/>redis 替代 mqtt 和自定义协议 作为物联网设备通讯的 可行性</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-08-18</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><p>本文只针对笔者自己的项目情况，不使用redis，而且使用更专业的消息队列服务器的存在有更充分的理由。</p><h2 id=选择的原因>选择的原因</h2><h3 id=性能天花板>性能天花板</h3><p>从树莓派到志强，redis是所有mq服务器的天花板。<br>自己手撸的简单hash map查询 业务添加一些 都比不过redis，而且在大量数据的情况下，查询和操作速度更是直线下滑。想做到极致的性能优化需要大量繁重工作，不如直接拿来就用</p><h3 id=简单灵活的高可用性集群>简单灵活的高可用性集群</h3><p>哨兵模式和主从模式也不是不能用。<br>cluster 虽然必须要最少3主3从才能实现高可用性，但是很容易满足。3台云服务器即可 互为主从 并集群，可以在线扩容，在线收缩，简单灵活可靠。</p><h3 id=低流量消耗的轻量化协议>低流量消耗的轻量化协议</h3><p>redis 是基于tcp的简单文本协议，没有协议头，没有校验码，没有封装，每一个字节都是有效必须的数据，大大节省服务器带宽资源</p><h3 id=活跃的老项目良好的向上兼容>活跃的老项目良好的向上兼容</h3><p>redis至今依旧维持较为频繁的功能和性能更新</p><h3 id=免中间件>免中间件</h3><p>1、工作量小 服务器上不需要再运行太多程序，开发工作小很多（在大并发环境一个中间件 真的很需要时间调试优化）<br>2、节省服务器开支</p><h3 id=性能下限高>性能下限高</h3><p>团队里面的实习生，只要不让他碰redis扩展module的代码，再烂的代码也不会影响整体运行</p><h2 id=不用更专业的mq的原因>不用更专业的mq的原因</h2><p>现有的主流mq服务， 性能都低于redis,在集群扩展上也都远远不如redis灵活和高效。<br>部分mq自带的消息持久化储存 性能更是一般，外部储存方式 多了一层转换。很多mq可能已经很轻量，但是相对 redis 还是差了一些。 Kafka RocketMQ Apollo ZeroMQ ActiveMQ RabbitMQ emqx Mosquitto 情况差不多，不展开细说<br>集群方面，要么死板复杂不能热扩容收缩，要么集群后单机性能会掉</p><h2 id=不使用-lotdb的原因>不使用 loTDB的原因</h2><p>没有看到loTDB的压测数据，自己简单测试过后性能不理想</p><h2 id=不自己开发私有协议的原因>不自己开发私有协议的原因</h2><p>私有协议 可以灵活使用 tcp/udp 包括上层websocket。但是集群部署 还有大量map的操作 开发工作量比较大。<br>另外 golang在 大并发情况下 资源占用要比C高很多，引入epoll可以降低一些，但是开发工作量还是不低。</p><h2 id=物联网设备通讯要求>物联网设备通讯要求</h2><h3 id=基本>基本</h3><p>包括多数物联网设备的的要求 我手上的项目情况有以下要求：</p><ul><li>低成本、可快速扩展、高可用性集群</li><li>部分功能要求消息必须送达：例如 报警信息</li><li>部分消息 要求 只可以送达1次，不可重复送达：例如 提醒消息</li><li>部分数据允许少量丢失: 例如设备实时采集的数据</li><li>设备24小时开机，不停上报数据。对服务器处理和记录能力有一定要求（最主要是服务器成本要低）</li><li>设备离线通知和报警</li><li>设备和用户app可以直接进行通讯，当然 这里指的还是服务器转发消息</li><li>qps的严格限制，防止服务器被拉垮</li><li>部分功能需要 tls加密通讯</li><li>消息需要选择性的持久化和转存</li></ul><h3 id=tcp和udp>tcp和udp</h3><p>国内环境下 部分地区部分时段udp 丢包严重。另外udp每次都需要带一定字数的token信息 虽然减少了握手环节，但是对于 少量频繁的数据通讯 就会明显增加服务器流量开支<br>ws协议，有更好，没有可以接受，毕竟物联网设备直接tcp udp是没问题的。</p><h3 id=自定义协议和现有协议的选择>自定义协议和现有协议的选择</h3><p>自定义协议tcp/udp 自然是更好，但是之前的项目开发经验让我明白 还是要权衡利弊一下。</p><h3 id=数据的序列化和反序列化>数据的序列化和反序列化</h3><p>考虑到服务器资源的占用，json 肯定是最不可取的。msgpack反序列化性能还可以，但是比json并不能降低太多带宽。 所以开发阶段用json或者msgpack,后期还是要换成protobuf。</p><h2 id=用redis实现上面的功能的逐一说明>用redis实现上面的功能的逐一说明</h2><p>因为redis 本身不适合作为面向用户的消息队列服务，所以有一些问题需要额外处理。</p><ul><li>使用redis6.0 以后的tls 解决加密通讯</li><li>务必使用redis7.0以后版本的 acl 精确控制到key和指令</li><li>使用stream 处理 必到达的消息 和 之发送一次的消息</li><li>使用sub 处理一次性不需要储存 可以容许丢失的消息</li><li>redis开启数据持久化，但是后端需要定期把历史消息转储存到sql，防止redis内的历史消息占用内存多大</li><li>集群 cluster 解决高可用性和灵活扩展性</li><li>redis 集群客户端 在物联网设备 和 app端 socket 手撸。使用{key}标识符，把单一个物联网设备的数据固定到一个节点上即可，然后客户端自动从任意一个节点得到负责的节点地址。</li><li>设备离线通知： 后端程序 连到redis 定时扫描 客户端连接信息，找出应在线但是未连接的客户端</li></ul><h2 id=关于权限控制和防恶意用户>关于权限控制和防恶意用户</h2><ul><li>key访问权限和指令限制：使用redis7.0以后版本的 acl 限制 物联网客户端可用指令和可写key</li><li>后端程序 通过扫描redis客户端信息，拉黑频繁多次连接的用户</li><li>key 内容大小限制：简单的方案 依旧是后端程序定期扫描bigkey。我的方案，自己开发一个简单的redis 模块 来限制，比如 用 lyh.get 限制客户端请求太大的字符串 key lyh.set限制 写入太大的数据</li><li>客户端qps限制：1是后端定时扫描 hot key 找到异常用户 拉黑 2、自定义模块 创建全局hash map记录用户操作频率 进行限制</li></ul><h2 id=其他安全措施>其他安全措施</h2><p>毕竟redis 不是设计为了面向非可信用户的mq服务器。 一些防患措施还是是要做一下。</p><ul><li>配置 maxmemory-clients 并经常监控</li><li>tls和明文tcp 都使用，优先使用tls,在负载过大情况下，临时切换到明文，并紧急扩容集群。</li><li>为了避免可能的安全隐患，客户端应该预留一组redis服务器地址：
这组服务器 应该由可以过滤转发tcp指令的程序反代redis 在redis出现未知漏洞的情况下使用</li><li>关键性指令 重命名 或者禁用掉</li><li>redis 使用普通无ssh权限的用户运行</li><li>iptable，限制单ip连接频率和连接数</li><li>如果内容很重要，记得定时备份 redis的持久化文件</li><li>核心数据如果使用redis储存，需要和客户端可以访问的redis 做隔离。</li></ul><h2 id=优点>优点</h2><p>1、高性能<br>2、高可用性<br>3、高扩展性<br>4、没有中间件，只有后台整理和维护件，后端工作量很少<br>5、低服务器成本，cpu、内存、带宽占用都不会太高</p><h2 id=最后说一下缺点>最后说一下缺点</h2><ul><li>在嵌入式设备上 因为没有支持redis集群的客户端（甚至部分环境也没有可用的redis客户端），需要自己实现 ，不过因为我们允许这部分客户端能使用指令很少，所以并不复杂。知道redis 就是 命令+换行 来通讯的就够了</li><li>需要redis自定义模块 进行高阶防护 不过真的不难，尤其是对熟悉C的嵌入式开发人员，当然其他语言也可以</li><li>云厂商的redis通常不可以导入自定义模块</li><li>redis目前不支持websocket 官方说后续有可能会支持，在确实需要的情况下可以起一个后端程序转发ws到redis<br>golang实现的：https://dev.leiyanhui.com/golang/ws-redis/<br>官方进展关注: <a class=link href="https://github.com/orgs/redis/projects/4/views/1?filterQuery=http&amp;pane=issue&amp;itemId=24785018" target=_blank rel=noopener>https://github.com/orgs/redis/projects/4/views/1?filterQuery=http&pane=issue&itemId=24785018</a></li><li>redis目前不支持auth验证次数限制 8年了还没添加的功能 ，8年后的今天我们依旧需要自己在防火墙限制过滤auth指令<br>官方进展关注：https://github.com/redis/redis/pull/1241</li><li>redis目前不能避免单一用户多次连接，需要自己后端扫描，官方没有支持计划,暂时可以用iptable略微临时限制 和后台扫描。我已经自己修改完成redis的自动离线重复登陆的用户 目前运行良好。</li><li>redis目前不能尽快自动踢出 没有进行 auth 的空连接 ，暂时只能自己在iptable限制，不过根据我的使用 多数mq服务器 都不支持。</li><li>redis acl的持久化在rdb/aof文件中，目前是可以手动保持到acl文本文件的，不过这里有一个pull 是 等待批准 状态 <a class=link href=https://github.com/redis/redis/pull/10369 target=_blank rel=noopener>https://github.com/redis/redis/pull/10369</a></li><li>redis auth 没有防止穷举的措施 目前暂时没有解决办法，客户端可以在一秒内发起几万次auth请求，拖垮redis，只能等待官方更新 <a class=link href=https://github.com/redis/redis/pull/11554 target=_blank rel=noopener>https://github.com/redis/redis/pull/11554</a></li></ul><h2 id=权衡后>权衡后</h2><p>因为现有app和小程序端，依赖http/ws协议，不能直接连接redis 所以app端是无法直接引入，通过服务器端口搭建ws转发到redis又再次引入了中间件<br>auth 指令没有使用限制，以及 auth之前不能通过自定义模块的方式来替代auth,所以导致此问题 除了修改redis源码和等待官方更新之外，可以通过防火墙适当防止一下，然后暂时无解（云厂商的公网redis一般直接限制了最大连接数）</p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/web/mcloud/><div class=article-details><h2 class=article-title>低成本高可用性异地多活跨云部署方案</h2></div></a></article><article><a href=/redis/gossipoptimization/><div class=article-details><h2 class=article-title>redis集群Gossip协议占用带宽过大的优化</h2></div></a></article><article><a href=/golang/getkeyswithprefixforcluster/><div class=article-details><h2 class=article-title>golang 从redis cluster获取所有keys</h2></div></a></article><article><a href=/golang/webview/><div class=article-details><h2 class=article-title>golang 比较靠谱的 webview</h2></div></a></article><article><a href=/lot/coredb-select/><div class=article-details><h2 class=article-title>物联网设备的 核心数据的维护和使用 有没有必要上sql、redis</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//xiao-lei-sui-shou-ji.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 小类随手记</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>