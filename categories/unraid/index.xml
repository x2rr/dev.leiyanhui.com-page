<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Unraid on 小类随手记</title><link>https://dev.leiyanhui.com/categories/unraid/</link><description>Recent content in Unraid on 小类随手记</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 31 Jan 2023 11:14:20 +0800</lastBuildDate><atom:link href="https://dev.leiyanhui.com/categories/unraid/index.xml" rel="self" type="application/rss+xml"/><item><title>padaven 固件端口转发配置无效的问题</title><link>https://dev.leiyanhui.com/openwrt/padaven-port-rule/</link><pubDate>Tue, 31 Jan 2023 11:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/openwrt/padaven-port-rule/</guid><description>&lt;p>具体表现，padaven路由器打开允许外网访问，外网可以访问到路由器web管理界面。然后端口转发的内网的服务器 均无法访问。&lt;br>
有人说是网关问题，测试后发现 应该就是 固件的bug，修改端口转发协议也无效。。。&lt;/p>
&lt;p>因为我内网还有一个旁路由，所以 干脆就不辛苦这个10年老古董的k2p（padaven）了，开dmz 到旁路由，端口转发转移到旁路由来处理。。。&lt;/p>
&lt;p>因为我这个旁路由 性能过得去，所以这里也就干脆 用 Socat 在旁路由上处理了。&lt;/p>
&lt;p>Socat 的优点，设置简单，支持ipv6 ipv4 缺点：比防火墙转发更加消耗cpu性能，不适合太低配置的路由器使用。&lt;/p>
&lt;p>也可以用op自带的防火墙&lt;/p></description></item><item><title>我的all in one 以及路由器 nas 的纠结和最终的方案</title><link>https://dev.leiyanhui.com/all-in-one/my-jiujie/</link><pubDate>Tue, 31 Jan 2023 11:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/my-jiujie/</guid><description>&lt;h2 id="设备情况如下">设备情况如下：
&lt;/h2>&lt;p>1、AP： 小米路由器 AP 2个 1个是访客网络 一个是北厂区的AP，还有一个K2P 在用
2、x86 ： 两台 一个i7 8850h 装的pve 另外一个是信步的N2600 装的openwrt
3、终端：几十个2.4G的物联网设备 14个ppoe监控 监控硬盘机 手机 笔记本若干&lt;/p>
&lt;p>一直没扔的k2p 是因为他的2.4G信号很稳，适合物联网设备覆盖。之前也是拿他当作主路由使用了10多年。&lt;/p>
&lt;p>一直以来的纠结 就是 软路由和 pve 的功能重叠，以及信步这个板子的一些问题。&lt;/p>
&lt;h2 id="纠结的地方">纠结的地方
&lt;/h2>&lt;h3 id="关于-信步这个板子">关于 信步这个板子
&lt;/h3>&lt;p>断电后偶尔会出现不能自动启动，另外N2600 不支持虚拟化，自带显卡也无法在linux下驱动 这就导致很多限制。&lt;/p>
&lt;p>还是想去掉他，卖掉的钱还能换一个 1-2T矿场硬盘。&lt;/p>
&lt;h3 id="路由的思考">路由的思考
&lt;/h3>&lt;p>在不添加新硬件（穷）的情况下，想用靠谱的网络。 最终的解决方案 可能还是 旁路由（旁网关）方案。
我的k2p 在不跑科学软件的情况下，实际是可以跑满带宽，内网有交换机不需要他。驼子里面拔将军，还是尝试用他做主路由。然后再尝试指定ip的网关到pve上的旁路由。
这就需要，k2p刷的固件的dhcp支持这个功能.&lt;br>
因为 运行pve的aio本身是不需要科学的。 为了全局科学（物联网设备可以在openwrt排除） 考虑方案如下&lt;/p>
&lt;h3 id="新方案">新方案
&lt;/h3>&lt;p>尽量不影响现有设备的情况下快速平滑过度。&lt;/p>
&lt;h4 id="k2p-固件">k2p 固件
&lt;/h4>&lt;p>k2p 是肯定不能刷爱快的，硬改后可以但是不少人说内网都会掉到500M。剩下的就是高ge 官改 openwrt 和 Padavan。&lt;br>
openwrt 熟悉很多，但是padaven 有人说 是可以跑满1000M 的，而openwrt 不太清楚，本着能用就行的态度。我决定 还是 用 padaven ，只是dhcp静态绑定的迁移有一点麻烦。两者的配置文件不通用。&lt;/p>
&lt;h4 id="旁路由网关">旁路由网关
&lt;/h4>&lt;p>系统肯定是op了。 用pve的虚拟机跑吧 省心。然后除了跑openclash ipsec 其他基本都不需要。dhcp也暂定关掉。&lt;/p>
&lt;h4 id="最重要的-自动网关文末">最重要的： 自动网关（文末）
&lt;/h4>&lt;p>因为我主路由受固件限制无法指定部分设备走旁路由网关，手动处理确实也比较麻烦，并且我需要 新设备加入后可以自动科学 ipsec拨进来的设备也可以。 所以打算在主路由上定时（1分钟）ping一下旁路由，如果不通，那么就把dhcp的网关切换回主路由，并重启 dhcp服务器。
另外 dhcp的生命周期也尽可能短一些 这样才能尽快生效。 （虽然对padaven不熟悉，但是好在他也提供ssh的，总可以搞定。 ）&lt;br>
这样就完美实现了，全局都走科学，部分不需要科学的设备，单独从openclash里面用规则处理掉即可。&lt;/p>
&lt;p>这样带来的好处就是 ，无论怎么折腾 主路由都可以提供基本的上网服务。旁路由上线 后 就提供科学和ipsec等。&lt;/p>
&lt;h4 id="小问题的处理">小问题的处理
&lt;/h4>&lt;h5 id="padaven-的内置ddns">padaven 的内置ddns
&lt;/h5>&lt;p>不支持我常用的3322（自定义可以） 和 dnspod 以及 cloudfare， 暂时注册一个它支持的，然后用cname解决。&lt;/p>
&lt;h5 id="padaven-的静态dhcp的备份">padaven 的静态dhcp的备份
&lt;/h5>&lt;p>喜欢备份是一个好习惯。。 系统管理 - 配置管理 直接备份&lt;/p>
&lt;h5 id="padaven--的ipv6">padaven 的ipv6
&lt;/h5>&lt;p>可以开启 ，以及 padaven 详情：https://www.jianshu.com/p/cb51fb0fb2ac&lt;/p>
&lt;h5 id="padaven-p段的迁移">padaven p段的迁移
&lt;/h5>&lt;p>之前的ip段是10.1.1.1 自定义的op固件，但padaven 默认的ip&lt;/p>
&lt;h5 id="vlmcsd">vlmcsd
&lt;/h5>&lt;p>padaven 有自带&lt;/p>
&lt;h5 id="alist">alist
&lt;/h5>&lt;p>挪到pve里面，单独一个容器/vm运行&lt;/p>
&lt;h5 id="nginxwebui">nginxWebUI
&lt;/h5>&lt;p>挪到pve里面，单独一个容器/vm运行&lt;/p>
&lt;h5 id="rustdesk服务">rustdesk服务
&lt;/h5>&lt;p>挪到pve里面，单独一个容器/vm运行&lt;/p>
&lt;h5 id="内网穿透">内网穿透
&lt;/h5>&lt;p>因为我有公网ip所以不需要其他穿透，仅需要80个443的穿透映射。
pve 和 路由器的 web界面 用 ddnsto 直接弄 简单省心。
3389 之类的端口可以直接用不费心。
80和443端口穿透 有两个解决，是备案过的域名 用 腾讯cdn穿透，未备案的域名用cloudfare穿透&lt;br>
一些应用级的，直接用非标端口解决&lt;/p>
&lt;h5 id="端口转发">端口转发
&lt;/h5>&lt;p>怎么都没想到，会在端口转发的上遇到问题 padaven 的固件的端口转发竟然有问题。&lt;br>
临时解决方案：dmz 到旁路由，在旁路由上 直接上 socat&lt;/p>
&lt;h5 id="pve的自动备份">pve的自动备份
&lt;/h5>&lt;p>qm stop 后，直接cp磁盘出来。&lt;/p>
&lt;h5 id="nas的处理">nas的处理
&lt;/h5>&lt;p>暂时用黑群晖简单很多，核心数据定时导出备份，影片等数据外挂直通的矿渣机械盘&lt;/p>
&lt;h4 id="自动检测旁路由脚本">自动检测旁路由脚本
&lt;/h4>&lt;p>实现：全局科学，去广告等，外网可以用ipsec协议链回家并科学。指定ip段 禁止科学。
旁路由离线后1-2分钟内，全局改为普通模式上网。 旁路由上限后 自动恢复。
&lt;a class="link" href="https://dev.leiyanhui.com/openwrt/auto-change-gatway" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/openwrt/auto-change-gatway&lt;/a>&lt;/p></description></item><item><title>docker运行nginx 并反代内网的一些服务2(nginxwebui修改版)</title><link>https://dev.leiyanhui.com/openwrt/nginx-proxy-ssl/</link><pubDate>Sat, 07 Jan 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/openwrt/nginx-proxy-ssl/</guid><description>&lt;p>家里路由器是openwrt x86，内外有跑一些服务。这里用路由器上配置nginx+ssl，然后内网的所有web服务都经过nginx到公网，因为家用宽带不只&lt;/p>
&lt;p>nginxwebui是国产基于java的开源nginx配置文件生成器，用于替代死板的nginx-proxy-manage 。&lt;/p>
&lt;p>优点是 更加灵活 强大 支持中文，几乎支持所有的nginx功能的可视化配置。&lt;/p>
&lt;p>缺点是 略微繁琐，尤其是不能自动载入配置文件，创建项目后，要手动在webui里面，点替换和重载。&lt;/p>
&lt;h2 id="docker安装">docker安装
&lt;/h2>&lt;p>nginxwebui 官网docker实例是用的host模式运行，不建议。还是自定义端口映射。&lt;/p>
&lt;p>我这里需要3个端口 nginxwebui管理端口50088，http 端口50081 https 端口50443&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run -itd --restart=always --name=nginxwebui --hostname nginxwebui -e BOOT_OPTIONS=&amp;#34;--server.port=50088&amp;#34; -p 50081:50081 -p 50088:50088 -p 50443:50443 --privileged=true cym1102/nginxwebui:latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>证书目录 是保存在： &lt;code>/home/nginxWebUI/.acme.sh/&lt;/code> 下面&lt;br>
配置文件&lt;code>/home/nginxWebUI/nginx.conf&lt;/code> 。&lt;/p>
&lt;p>如果需要对证书单独管理，可以映射出来。也恩可以用docker cp 定时复制出来。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run -itd -v /opt/docker_file/op_nginxWebUI:/home/nginxWebUI --restart=always --name=nginxwebui --hostname nginxwebui -e BOOT_OPTIONS=&amp;#34;–server.port=50088&amp;#34; -p 50081:50081 -p 50088:50088 -p 50443:50443 --privileged=true cym1102/nginxwebui:latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>而后在 nginxwebui 内部 再反代 管理端口出来 套上ssl 即可从外网ssl访问。&lt;/p>
&lt;p>为了方便备份，我这里没有映射目录出来。记得自行定时清理日志：&lt;code>/home/nginxWebUI/log/nginxWebUI.log&lt;/code>&lt;/p>
&lt;p>注意： http://10.0.0.1:50088/ web界面 打开可能会空白，这个&amp;hellip;.大概是因为java启动慢的原因，等一会 刷新一下就好了。&lt;/p>
&lt;h2 id="一个典型的反代配置">一个典型的反代配置
&lt;/h2>&lt;p>包括http自动跳转ssl&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">转发类型 http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">监听端口：这个如果要开启ssl的话要输入ssl端口 50443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">选择密码文件：这个是base的密码
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">开机ssl：是
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">选择内置证书：（提前配置）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">开启https：是
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssl协议版本：全部勾选
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">http跳转https：是
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">从该端口跳转：第一个留空 第二个输入ssl的端口后 50081
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这样就可以实现，访问http的时候自动跳转到ssl &lt;br>
最终配置文件大概如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">server {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name 域名;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 50443 ssl http2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate /home/nginxWebUI/.acme.sh/jia.leiyanhui.com/fullchain.cer;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate_key /home/nginxWebUI/.acme.sh/jia.leiyanhui.com/jia.leiyanhui.com.key;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 50081;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if ($scheme = http) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return 301 https://$host:50443$request_uri;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 自己;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://10.0.0.1:50088;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Host $host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Real-IP $remote_addr;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Forwarded-Host $http_host;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Forwarded-Port $server_port;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Forwarded-Proto $scheme;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_http_version 1.1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Upgrade $http_upgrade;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Connection &amp;#34;upgrade&amp;#34;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_redirect http:// https://;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="自动备份到阿里云镜像">自动备份到阿里云镜像
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/docker/img-to-aliyun/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/docker/img-to-aliyun/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">10 3 * * 6 sh /etc/docker_up_aliyun_nginxWebUi.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="使用nginxwebui反代-主路由的一个小问题">使用nginxWebUI反代 主路由的一个小问题
&lt;/h2>&lt;p>如果op主路由配置了 根据域名跳转（https://dev.leiyanhui.com/openwrt/acme-ssl/），op需要绑定一个不属于最终配置文件的域名 。或者 使用下面的方法。
另外 op里面的网页终端需要单独处理（我选择 直接弃用）。&lt;/p>
&lt;p>还有一个方案 是 不传递host参数，然后直接访问 https://你的域名:端口/cgi-bin/luci/ 也可以解决。&lt;/p>
&lt;h3 id="关于使用http协议访问https端口的400错误处理">关于使用http协议访问https端口的400错误处理
&lt;/h3>&lt;p>例如我正常访问我的路由器应该是&lt;code>https://域名:50443&lt;/code>如果用&lt;code>http://域名:50443&lt;/code>访问端口还是https的端口就会提示400错误。 因为服务是家人也用。 不能指望他们理解http（S）这些。所以我采取的方法是直接拦截错误，并跳转到正确的首页地址。&lt;/p>
&lt;p>首先这个错误是 497 错误，nginxWebUI支持参数模板，添加一个参数模板，名字随意，添加参数&lt;code>error_page 497&lt;/code> 值&lt;code>https://$host:50443; #解决http到ssl端口的400错误&lt;/code> 然后用默认配置应用到反向代理。完毕&lt;/p>
&lt;h3 id="最好的解决方案">最好的解决方案
&lt;/h3>&lt;p>编辑对应的ningxWebUi反向代理配置，
添加一个 &lt;code>= / &lt;/code> 自定义localtions 添加参数 &lt;code>return&lt;/code> 值&lt;code> 301 https://$host:50443/cgi-bin/luci&lt;/code> （意思就是网址后面没有东西的情况下跳转到后面地址）即可 （注意好要清理浏览器缓存不然不会生效） &lt;br>
最终代码如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">server {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name op.jia.leiyanhui.com;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 50443 ssl http2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate /home/nginxWebUI/.acme.sh/*.jia.leiyanhui.com/fullchain.cer;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_certificate_key /home/nginxWebUI/.acme.sh/*.jia.leiyanhui.com/*.jia.leiyanhui.com.key;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 50081;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if ($scheme = http) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return 301 https://$host:50443$request_uri;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> error_page 497 https://$host:50443; #解决http到ssl端口的400错误;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location = / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # op自动跳转;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return 301 https://$host:50443/cgi-bin/luci;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # op代理;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://10.1.1.1/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_redirect http:// https://;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="进阶">进阶
&lt;/h3>&lt;p>1、解决 在web界面直接点击 域名 链接打开的是不带端口的导致非标端口打不开的情况。 &lt;a class="link" href="https://github.com/joyanhui/nginxWebUI" target="_blank" rel="noopener"
>https://github.com/joyanhui/nginxWebUI&lt;/a>
2、解决 定时续签2点拥堵的问题，
下载 我自己的修改的 jar，替换到docker里面&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">exec&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">it&lt;/span> &lt;span class="n">nginxwebui&lt;/span> &lt;span class="n">rm&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginxWebUI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jar&lt;/span> &lt;span class="c1">#删除原版jar&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">joyanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginxWebUI&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">releases&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="n">st&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginxWebUI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jar&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">cp&lt;/span> &lt;span class="n">nginxWebUI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jar&lt;/span> &lt;span class="n">nginxwebui&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nginxWebUI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jar&lt;/span> &lt;span class="c1"># 复制宿主机上的修改过的jar进去&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">nginxwebui&lt;/span> &lt;span class="c1">#重启&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">nginxWebUI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jar&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="下载地址">下载地址
&lt;/h4>&lt;p>&lt;a class="link" href="https://www.123pan.com/s/EqorVv-n0nPA" target="_blank" rel="noopener"
>https://www.123pan.com/s/EqorVv-n0nPA&lt;/a> 提取码:yhjt&lt;/p>
&lt;p>详细 &lt;a class="link" href="https://github.com/joyanhui/nginxWebUI" target="_blank" rel="noopener"
>https://github.com/joyanhui/nginxWebUI&lt;/a>&lt;/p>
&lt;h3 id="其他问题">其他问题
&lt;/h3>&lt;p>nginxwebui 和 nginx-proxy-manager 都同样的问题，就是在web界面直接点击 域名 链接打开的是不带端口的。在前者的github 提交过issues但是作者没有回应。后at作者后，作者表示：&lt;code>这个界面是展示信息用，不是给你高强度使用的&lt;/code> 不知所云。&lt;/p>
&lt;blockquote>
&lt;p>已经自己修改 &lt;a class="link" href="https://github.com/joyanhui/nginxWebUI" target="_blank" rel="noopener"
>https://github.com/joyanhui/nginxWebUI&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>不过nginxwebui 相对 nginx-proxy-manager 依旧适合非标端口的
如果是内网使用，家用宽带没有标准端口的情况下，可以通过一个简单方法实现，就是在路由器上转发跳转一次，详情：https://dev.leiyanhui.com/openwrt/acme-ssl/&lt;/p>
&lt;p>另外 nginxwebui 的证书申请 有几个小遗憾，1 证书检查时间固定在凌晨2点不可以修改，还是很拥挤的。2 没有日志显示，如果出错你也不知道。。。只能等待。。。&lt;/p></description></item><item><title>docker 一个可用的完整桌面系统</title><link>https://dev.leiyanhui.com/docker/docker-linux-desktop/</link><pubDate>Sun, 01 Jan 2023 06:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/docker/docker-linux-desktop/</guid><description>&lt;p>选择 用 &lt;a class="link" href="https://hub.docker.com/r/linuxserver/webtop" target="_blank" rel="noopener"
>https://hub.docker.com/r/linuxserver/webtop&lt;/a>&lt;/p>
&lt;p>默认用户名：abc 密码：abc&lt;/p>
&lt;h2 id="3d加速-ubuntu">3D加速 Ubuntu
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">--device=/dev/dri:/dev/dri
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="fuse">fuse
&lt;/h2>&lt;p>宿主机要安装fuse&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> --privileged
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>另外一个方案 是&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">--device /dev/fuse \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --cap-add SYS_ADMIN \
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="端口">端口
&lt;/h2>&lt;p>3000 是web-vnc 3389 和22 不用多说&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">-p 10100:3000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 10101:3389
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 10102:22
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ubuntu-3d">ubuntu 3D
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">run&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ubuntu&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">privileged&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">opt&lt;/span> &lt;span class="n">seccomp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">unconfined&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">PUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1000&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">PGID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1000&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">TZ&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">SUBFOLDER&lt;/span>&lt;span class="o">=/&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">KEYBOARD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">en&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">us&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">qwerty&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">TITLE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ubuntu&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">10100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3000&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">10101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3389&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">10102&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">22&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">yanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ubuntu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">config&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sock&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">device&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dri&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dri&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">restart&lt;/span> &lt;span class="n">unless&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">stopped&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lscr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">io&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">linuxserver&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">ubuntu&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">kde&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="输入法">输入法
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo apt install fcitx5 fcitx5-rime
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>另外需要编辑 /init 实现自动启动&lt;/p>
&lt;h2 id="arch">arch
&lt;/h2>&lt;blockquote>
&lt;p>kde的镜像 有点问题，xrdp连不上&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">run&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">arch&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">privileged&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">opt&lt;/span> &lt;span class="n">seccomp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">unconfined&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">PUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1000&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">PGID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1000&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">TZ&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">SUBFOLDER&lt;/span>&lt;span class="o">=/&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">KEYBOARD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">en&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">us&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">qwerty&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">TITLE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">arch&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">10100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3000&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">10101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3389&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">10102&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">22&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">yanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">arch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">config&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sock&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">device&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dri&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dri&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">--&lt;/span>&lt;span class="n">restart&lt;/span> &lt;span class="n">unless&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">stopped&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lscr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">io&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">linuxserver&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">webtop&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">arch&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">i3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>选择arch-aio，彻底抛弃pve esxi unraid</title><link>https://dev.leiyanhui.com/all-in-one/arch-aio/</link><pubDate>Fri, 30 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/arch-aio/</guid><description>&lt;p>旧版查看 ：&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/diy/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/diy/&lt;/a>&lt;/p>
&lt;h2 id="安装和下载">安装和下载
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.123pan.com/s/EqorVv-K2nPA" target="_blank" rel="noopener"
>https://www.123pan.com/s/EqorVv-K2nPA&lt;/a> 提取码:arch
下载后解压，然后用ventoy，用支持x11转发的ssh客户端（例如 MobaXterm） 登录 用户名yanhui 密码 1 root 密码也是 1 但是root默认禁止登录。&lt;/p>
&lt;h2 id="简明使用方法">简明使用方法
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/arch-aio-use/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/arch-aio-use/&lt;/a>&lt;/p>
&lt;h2 id="部分需要你继续处理的">部分需要你继续处理的
&lt;/h2>&lt;p>仅限2022-12-29 版本 ： &lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/server-after/" target="_blank" rel="noopener"
>修改服务引导顺序&lt;/a>&lt;/p>
&lt;h2 id="使用桥接网络">使用桥接网络
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/&lt;/a>&lt;/p>
&lt;h2 id="自动挂载其他磁盘的案例">自动挂载其他磁盘的案例
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/arch/auto--dock-kvm/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/arch/auto&amp;ndash;dock-kvm/&lt;/a>&lt;/p>
&lt;h2 id="其他常见问题">其他常见问题
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/faq" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/faq&lt;/a>&lt;/p></description></item><item><title>旁路由方案，自动切换网关方案 参考</title><link>https://dev.leiyanhui.com/openwrt/auto-change-gatway/</link><pubDate>Fri, 30 Dec 2022 09:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/openwrt/auto-change-gatway/</guid><description>&lt;h2 id="旁路由方案的痛点">旁路由方案的痛点
&lt;/h2>&lt;p>旁路由在出问题的时候，会影响网关配置为旁路由的设备使用。所以需要自动检测旁路由。&lt;br>
首先 主路由要有完整权限的系统，就是有ssh权限的！ 爱快请使用分流方案 到二级路由以及环回等方式实现。&lt;br>
旁路由的自动切换方案是很多的人的刚性需求。&lt;br>
用软路由做主路由，主要问题两点，折腾过程中的失误一些不确定东西，容易断网。还有x86软路由 不少人遇到突然断电导致的无法启动后全家断网 &lt;br>
自动切换旁路由方案，更加稳定一些。&lt;/p>
&lt;blockquote>
&lt;p>本文撰写于2019年，后期虽有修改补充，但是部分内容已经落后 &lt;br>
有能力有时间的朋友，建议还是上x86 方案，不需要旁路由。 或者使用爱快分流方案。 &lt;a class="link" href="https://dev.leiyanhui.com/route/ikuai-bypass-gfw/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/route/ikuai-bypass-gfw/&lt;/a>&lt;br>
个人经验 爱快分流方案更为稳健，但是需要另外开一个op 以及docker来处理分流规则。 对设备内存要求较高（x32爱快不支持kvm docker可用镜像有限，爱快x64 需要4G内存安装 2G内存运行）。 如果内存紧张最好还是选择openwrt one only&lt;/p>&lt;/blockquote>
&lt;h3 id="实现目标">实现目标
&lt;/h3>&lt;p>主路由为硬路由负责上网和dhcp 顺带wifi，硬交换负责nas和机顶盒 台式机之间通讯。
去掉 x86 软路由 &lt;br>
nas或者aio主机 或者 N1 或者闲置手机作为旁路由/旁网关(后面统称旁路由)&lt;/p>
&lt;h4 id="重点目标">重点目标：
&lt;/h4>&lt;ul>
&lt;li>旁路由离线后，所有设备自动切换到主路由网关&lt;/li>
&lt;li>双旁路由A和B A正常运行的时候B删除不存在在需要调整的时候，复制一个独立的旁路由出来，自己手动修改主机电脑的网关到旁路由B测试没问题后替换A&lt;/li>
&lt;li>可控制部分设备科学，部分设备不科学&lt;/li>
&lt;li>ksm ipsec 科学 广告过滤 alist ddns nas 等，全部由旁路由或者aio/nas处理。&lt;/li>
&lt;/ul>
&lt;h3 id="实现原理">实现原理
&lt;/h3>&lt;p>旁路由用pve 或者 unraid 或者docker运行，关闭dhcp服务，静态ip（10.0.0.50），网关指定为主路由。也就是旁路由只是主路由下面的一个普通设备而已。&lt;/p>
&lt;blockquote>
&lt;p>双DHCP 存在抢dhcp的情况，所以dhcp本身占不了太多资源，还是主路由统一管理。
主路由10.1.1.1 开启dhcp dhcp的网关改为程序脚本控制 dhcp的租期尽可能短一些（120秒）
主路由 dhcp的ip段为 10.1.1.200-245 重点设备 静态绑定到 10.1.1.200以内的ip段。&lt;/p>&lt;/blockquote>
&lt;h4 id="逻辑如下">逻辑如下
&lt;/h4>&lt;p>主路由每隔一定时间 30秒或者1分钟，检查一次旁路由是否在线，
如果在线那么 dhcp服务的网关改为旁路由（10.0.0.50）&lt;br>
如果旁路由不在线 那么dhcp服务的网关改为主路由（10.0.0.1）&lt;/p>
&lt;blockquote>
&lt;p>如果旁路由状态发生了变化，那么重启一次dnsmasq（或者再重启wifi 或者重启整个系统）&lt;br>
科学部分，由openclash 实现分流，就是部分设备不走科学还有部分设备强制全局科学等等。 这个可以看我以前的文章 &lt;a class="link" href="https://dev.leiyanhui.com/openwrt/openclash/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/openwrt/openclash/&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h3 id="具体实现">具体实现
&lt;/h3>&lt;p>我主路由依旧用10多年前的 古董级k2p刷Padavan 固件，因为他的2.4G信号一直很好，Padavan 可以跑满1000M，5G的话也能跑到500M，另外一个5G路由器因为2.4G信号一般所以只能做ap用。 万兆由下级一个交换机处理，千兆以内众生平等 适合自己的才是最好的。&lt;br>
Padavan 也是开源linux 和openwrt使用起来在系统层面差距不是很大 ，只要有ssh权限，所有固件都大同小异。&lt;br>
旁路由 用 pve 跑的自己编译的openwrt，直接挂的vm跑的，因为我这边，8核心，64G内存 所以没用lxc和docker。&lt;/p>
&lt;h4 id="脚本测试">脚本测试
&lt;/h4>&lt;p>padvan默认是关闭ssh的，系统管理 - 服务 找到ssh 打开，客户端登录ssh&lt;/p>
&lt;h5 id="检查旁路由是否在线">检查旁路由是否在线
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">curl http://10.1.1.50
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这是openwrt的登录页面 他会自动301跳转，查看返回http代码 &lt;code>-m 3&lt;/code> 是3秒&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">curl -I -s -m 3 http://10.1.1.50 -w %{http_code} | tail -n1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>应该会自动返回一个301代码, http://10.1.1.50/cgi-bin/luci/ 的话应该是返回403，这个先不管
如果是不存在的地址，那么应该是返回 000&lt;/p>
&lt;h5 id="找dnsmasql的配置文件地址">找dnsmasql的配置文件地址
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">find / -name &amp;#34;*dnsmasq*&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>返回 结果 逐个检查后发现Padavan和openwrt一样 都是&lt;code>/etc/dnsmasq.conf&lt;/code> 这个文件，同时已经分配的列表也是&lt;code>/tmp/dnsmasq.leases&lt;/code>这个文件。&lt;br>
在主路由中 设置dhcp的网关为 旁路由地址10.1.1.50 ，然后执行 &lt;code>cat /etc/dnsmasq.conf&lt;/code>应该有一行&lt;code>dhcp-option=tag:lan,3,10.1.1.50&lt;/code>&lt;/p>
&lt;h5 id="测试配置文件的查找和替换">测试配置文件的查找和替换
&lt;/h5>&lt;p>记住上面的那段 &lt;code>dhcp-option=tag:lan,3,10.1.1.50&lt;/code> 用grep搜索试试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">grep dhcp-option=tag:lan,3,10.1.1.50 /etc/dnsmasq.conf |wc -l # 查找 如果有的话应该返回1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>替换&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sed -i &amp;#34;s/dhcp-option=tag:lan,3,10.1.1.50/dhcp-option=tag:lan,3,10.1.1.1/g&amp;#34; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">## 检查
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果padavan的话不用这么麻烦 用&lt;code>nvram set dhcp_gateway_x=10.1.1.1 &lt;/code>&lt;/p>
&lt;h5 id="重启-dnsmasq">重启 dnsmasq
&lt;/h5>&lt;p>openwrt 下面这两个命令 都一样的效果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">service dnsmasq restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Padavan 下可执行文件是 &lt;code>/usr/sbin/dnsmasq&lt;/code> 通过查询网上资料得知 Padavan把服务脚本放在/sbin 直接执行&lt;code>/sbin/restart_dhcpd&lt;/code> 即可&lt;/p>
&lt;h4 id="编写脚本">编写脚本
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">default_gateway&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;10.1.1.1&amp;#39;&lt;/span> &lt;span class="c1">#主路由 IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">up_gateway&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;10.1.1.50&amp;#39;&lt;/span> &lt;span class="c1">#旁路由 IP （需设置的主路由 DNS 地址）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check_ip_available&lt;span class="o">(){&lt;/span> &lt;span class="c1">#使用 ping 命令检测旁路由是否在线&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ping -c &lt;span class="m">3&lt;/span> &lt;span class="nv">$1&lt;/span> &lt;span class="p">|&lt;/span> grep packets &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $4}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">change_gateway_dns&lt;span class="o">(){&lt;/span> &lt;span class="c1">#网关 DNS 切换&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nvram &lt;span class="nb">set&lt;/span> &lt;span class="nv">dhcp_gateway_x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span> &lt;span class="c1">#设置网关&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nvram &lt;span class="nb">set&lt;/span> &lt;span class="nv">dhcp_dns1_x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nvram &lt;span class="nb">set&lt;/span> &lt;span class="nv">dhcp_dns2_x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="c1">#设置 DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nvram commit &lt;span class="c1">#提交修改&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rc rc_service restart_net_and_phy &lt;span class="c1">#重启主路由 网络服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> restart_dns &lt;span class="c1">#重启主路由 DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> restart_dhcpd &lt;span class="c1">#重启主路由 DHCP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># sleep 5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># reboot #自动修改后存在网络故障，可能需要直接重启路由器， 等待时间较长&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If the gateway of the up close, the network is completely unusable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">res&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>check_ip_available &lt;span class="nv">$up_gateway&lt;/span>&lt;span class="sb">`&lt;/span> &lt;span class="c1">#检测旁路由是否存在&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">current_gateway&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>nvram get dhcp_gateway_x&lt;span class="sb">`&lt;/span> &lt;span class="c1">#获取主路由当前网关&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="k">$((&lt;/span>&lt;span class="nv">$res&lt;/span>&lt;span class="k">))&lt;/span> -eq &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">#检测结果等于 0，即旁路由不存在，应设置网关和 DNS 为主路由地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$current_gateway&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$default_gateway&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span> &lt;span class="c1">#如果当前网关地址不是主路由地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;up_gateway to default&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="sb">`&lt;/span>change_gateway_dns &lt;span class="nv">$default_gateway&lt;/span>&lt;span class="sb">`&lt;/span> &lt;span class="c1">#将网关和DNS切换为主路由地址 并重启&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;use default gateway , nothing changed&amp;#34;&lt;/span> &lt;span class="c1"># 什么都不用做&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="k">$((&lt;/span>&lt;span class="nv">$res&lt;/span>&lt;span class="k">))&lt;/span> -ne &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">#检测结果不等于 0，即旁路由存在，应设置网关和 DNS 为旁路由地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$current_gateway&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$up_gateway&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span> &lt;span class="c1">#如果当前网关地址不是主路由地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;up_gateway to auxiliary_gateway&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="sb">`&lt;/span>change_gateway_dns &lt;span class="nv">$up_gateway&lt;/span>&lt;span class="sb">`&lt;/span> &lt;span class="c1">#将网关和DNS切换为旁路由地址 并重启&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;use auxiliary_gateway , nothing changed&amp;#34;&lt;/span> &lt;span class="c1"># 什么都不用做&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#将脚本置于 /etc/storage/change_gatway.sh &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设置脚本运行权限：`chmod +x /etc/storage/change_gatway.sh ` &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#保存脚本，防止重启丢失：`/sbin/mtd_storage.sh save`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#自动定时运行脚本（每一分钟检测一次）：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#`系统管理 - 服务 ` 调度任务 (Crontab) 加入 `*/1 * * * * /etc/storage/change_gatway.sh` &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最后&lt;/p>
&lt;p>将脚本置于 /etc/storage/change_gatway.sh
设置脚本运行权限：&lt;code>chmod +x /etc/storage/change_gatway.sh &lt;/code>&lt;br>
保存脚本，防止重启丢失：&lt;code>/sbin/mtd_storage.sh save&lt;/code>
自动定时运行脚本（每一分钟检测一次）：
&lt;code>系统管理 - 服务 &lt;/code> 调度任务 (Crontab) 加入 &lt;code>*/1 * * * * /etc/storage/change_gatway.sh&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>以上内容抄 自：恩山，xuezou&lt;/p>&lt;/blockquote>
&lt;h2 id="最后存在的问题">最后存在的问题
&lt;/h2>&lt;p>经过测试 无论是wifi接入还是网线加入的设备 都可以在短暂掉线后 自动切换成功&lt;/p></description></item><item><title>arch-aio 常见问题</title><link>https://dev.leiyanhui.com/all-in-one/faq/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/faq/</guid><description>&lt;h2 id="libvirtdvirt-manager-找不到磁盘">libvirtd/virt-manager 找不到磁盘
&lt;/h2>&lt;p>libvirtd 应该在rc.local 之后启动&lt;/p>
&lt;h2 id="virt-manager-弹不出界面">virt-manager 弹不出界面
&lt;/h2>&lt;p>1、 使用支持x11转发的客户端，win下使用 MobaXterm Macos和linux andriod下也又对应的客户端。如果是ios设备也有弯道解决方案
2、后台有virt-manager进程，那么先关掉 &lt;code>killall virt-manager&lt;/code>&lt;/p>
&lt;h2 id="virt-manager-无法连接">virt-manager 无法连接
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Unable to connect to libvirt qemu:///system.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="连不到virtqemud-sock">连不到virtqemud-sock
&lt;/h3>&lt;p>因为 libvirtd 没启动，可以用下面两种方式启动&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl enable libvirtd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start libvirtd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="修改dockerkvm目录后无法自动启动">修改docker/kvm目录后，无法自动启动
&lt;/h3>&lt;p>自动挂载建议放到rc-local 服务用，docker和libvirtd 在rc-local之后启动 &lt;a class="link" href="https://dev.leiyanhui.com/arch/auto-mount-dock-kvm/" target="_blank" rel="noopener"
>具体方法&lt;/a>&lt;/p></description></item><item><title>arch-aio 的 virt-manager上配置桥接网络</title><link>https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/</guid><description>&lt;p>本文基于&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/diy/" target="_blank" rel="noopener"
> arch-aio&lt;/a>，如果你是其他系统，请先处理好相关依赖。&lt;/p>
&lt;blockquote>
&lt;p>未完成&lt;/p>&lt;/blockquote>
&lt;h3 id="查看">查看
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cat /etc/qemu/bridge.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">allow virbr0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>virbr0 是自动创建的，并不能完成虚拟机 映射到外网&lt;br>
继续查看其他情况&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ip a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo brctl show
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>判断出来物理口是 &lt;code>enp1s0&lt;/code>&lt;/p>
&lt;h3 id="安装-networkmanager">安装 networkmanager
&lt;/h3>&lt;p>我这里还是选用传统的networkmanager来处理，感觉更简单无脑一些。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pacman -S networkmanager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl enable NetworkManager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start NetworkManager
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置桥接br0">配置桥接br0
&lt;/h3>&lt;p>根据你的实际情况修改ip网关dns等&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nmcli connection add type bridge ifname br0 con-name br0 ipv4.addresses 10.1.1.1/24 ipv4.gateway 10.1.1.254 ipv4.dns 114.114.114.114 ipv4.method manual
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我这里还是打算用dhcp所以执行下面的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nmcli connection add type bridge ifname br0 con-name br0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="桥接网卡子网卡-关联物理卡">桥接网卡子网卡 关联物理卡
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nmcli connection add type bridge-slave con-name br0-slave1 ifname enp1s0 master br0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="开启">开启
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">nmcli connection up br0-slave1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nmcli connection up br0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nmcli connection show
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># systemctl restart NetworkManager
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>此时网络会断开，原来ip无法连接，可以使用br0上的ip 重新连接。 如果是dhcp 可以从路由器看到多分配到br0上的ip。&lt;br>
重启 NetworkManager 后，或者重启物理机器后，两个ip都可以连接。&lt;/p>
&lt;h3 id="后续可选处理">后续可选处理
&lt;/h3>&lt;p>关闭br0的stp&lt;br>
禁止物理卡开机启动 可以避免要占用两个ip的问题&lt;/p>
&lt;h3 id="开启ip4转发">开启ip4转发
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sysctl net.ipv4.ip_forward=1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano /etc/sysctl.d/99-sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.ip_forward = 1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="加载tun">加载tun
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">modprobe&lt;/span> &lt;span class="n">tun&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">nano&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">modules&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nb">load&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tun&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tun&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="恢复之前的操作未经测试">恢复之前的操作(未经测试)
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo ip link set br0 down
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo brctl delif br0 enp1s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ip link set enp1s0 down
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ip link set up enp1s0 #重启物理网卡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ip link set dev br0 down #关闭 删除br0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo brctl delbr br0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>参考文章：&lt;/p>
&lt;p>&lt;a class="link" href="https://wiki.archlinux.org/title/Network_bridge" target="_blank" rel="noopener"
>https://wiki.archlinux.org/title/Network_bridge&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/qq_42197548/article/details/120655449" target="_blank" rel="noopener"
>https://blog.csdn.net/qq_42197548/article/details/120655449&lt;/a>&lt;/p></description></item><item><title>arch-aio 免费高扩展性灵活且开放的all in one 系统的基本使用</title><link>https://dev.leiyanhui.com/all-in-one/arch-aio-use/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/arch-aio-use/</guid><description>&lt;h3 id="下载">下载
&lt;/h3>&lt;p>1、 arch-aio：https://dev.leiyanhui.com/all-in-one/diy/ 下载后解压到硬盘或U盘，要求分区格式是（exFAT/NTFS/UDF/XFS/Ext2(3)(4) ）&lt;br>
2、 &lt;a class="link" href="https://www.ventoy.net" target="_blank" rel="noopener"
>www.ventoy.net&lt;/a> 下载 ，并安装到U盘 或者硬盘（新版支持无损安装了）&lt;br>
3、 配置ventoy的自动启动以及VTOY_LINUX_REMOUNT ，可以使用arch-aio 下载链接里面的ventoy文件的json文件，具体参考 ventoy官网说明&lt;br>
4、 配置 lnk.vtoy 等等，具体参考 ventoy官网说明，也可以在ventoy引导界面按下F2 浏览找到对应的 vhd.vtoy 文件&lt;/p>
&lt;h3 id="启动">启动
&lt;/h3>&lt;p>使用ventoy启动即可，具体参考 ventoy官网说明&lt;/p>
&lt;h3 id="登录arch-aio">登录arch-aio
&lt;/h3>&lt;p>使用默认用户 yanhui 或 root 登录。&lt;br>
win客户端登录建议使用&lt;a class="link" href="https://mobaxterm.mobatek.net/download-home-edition.html" target="_blank" rel="noopener"
>MobaXterm免费版&lt;/a>&lt;/p>
&lt;h3 id="修改密码">修改密码
&lt;/h3>&lt;p>root和yanhui的密码 都要修改,yanhui&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">passwd yanhui
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">passwd root
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="可选shell和neofetch">可选shell和neofetch
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo pacman -S fish neofetch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#编辑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano .bashrc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>添加两行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">neofetch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fish
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>neofetch 是登录后自动打印系统信息，fish是一个还不错的shell终端，命令补充和提示好用一些，另外一个不错的shell 叫做&lt;code>nushell&lt;/code> 安装后启动命令是&lt;code>nu&lt;/code>&lt;br>
&lt;code>.bashrc&lt;/code> 文件是你命令行登录后自动执行的一个文件。可以让它自动启动一些脚本方便使用。&lt;/p>
&lt;h3 id="检查和自动配置挂载">检查和自动配置挂载
&lt;/h3>&lt;h4 id="检查">检查
&lt;/h4>&lt;p>使用 &lt;code>fdisk -l &lt;/code> 和 &lt;code>lsblk&lt;/code> 查看分区情况，使用 &lt;code>df -h&lt;/code> 查看挂载情况。 值得注意的是，/dev/mapper/ventoy 的两个分区 是arch-aio 虚拟磁盘镜像的两个分区分别对应efi和&lt;code>/&lt;/code>&lt;/p>
&lt;h4 id="配置自动挂载">配置自动挂载
&lt;/h4>&lt;p>建议使用&lt;code>rc-local&lt;/code> 这个系统服务来处理，不建议使用fstab&lt;br>
以下实例直接从yanhui这个用户下处理&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p mnt/nvme mnt/efi mnt/exfat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 测试
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo mount /dev/nvme0n1p6 /home/yanhui/mnt/exfat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo mount /dev/nvme0n1p5 /home/yanhui/mnt/nvme
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo mount /dev/nvme0n1p1 /home/yanhui/mnt/efi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>没问题后修改 &lt;code>sudo nano /etc/rc.local.d/auto-mount-and-start-aio.sh&lt;/code> 内容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mount /dev/nvme0n1p6 /home/yanhui/mnt/exfat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/nvme0n1p5 /home/yanhui/mnt/nvme
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/nvme0n1p1 /home/yanhui/mnt/efi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启测试&lt;/p>
&lt;h3 id="迁移和配置docker和kvm">迁移和配置docker和kvm
&lt;/h3>&lt;h4 id="docker">docker
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">systemctl&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">rsync&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">avzP&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">yanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">mv&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bak&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">sudo&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">yanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 完成后 rm -rf /var/lib/docker.bak&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="kvmlibvirtd">kvm/libvirtd
&lt;/h4>&lt;p>此步骤 可以不处理&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">systemctl&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">libvirtd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rsync&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">avzP&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">libvirt&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">yanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">libvirt&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">libvirt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bak&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ln&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">yanhui&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">nvme&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">libvirt&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 完成后 rm -rf /var/lib/libvirt.bak&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置docker和libvirtd开机自动启动">配置docker和libvirtd开机自动启动
&lt;/h4>&lt;p>先禁止他们的开机自动启动，改为从rc.local这个服务里面启动，已方便在挂载完成后再启动对应的服务&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl disable docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl disable libvirtd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改 &lt;code>sudo nano /etc/rc.local.d/auto-mount-and-start-aio.sh&lt;/code> 内容 添加两行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl start docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start libvirtd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>2022-12-29版本这个默认文件的libvirtd少了一个字母d，注意修改以下
重启&lt;/p>&lt;/blockquote>
&lt;h3 id="安装一个系统win10为例">安装一个系统（win10为例）
&lt;/h3>&lt;h4 id="安装镜像">安装镜像
&lt;/h4>&lt;p>先去弄一个win安装镜像,我这里有了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mnt/exfat/iso/SW_DVD9_Win_Pro_10_22H2_64BIT_ChnSimp_Pro_Ent_EDU_N_MLF_X23-20012.ISO
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>对应的目录是 &lt;code>/var/lib/libvirt/images &lt;/code>&lt;/p>
&lt;h4 id="windows-virio驱动镜像">windows virio驱动镜像
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">pacman&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="n">wget&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="n">mnt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">iso&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">fedorapeople&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">groups&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">virt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">virtio&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">win&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">direct&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">downloads&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">archive&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">virtio&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">virtio&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">win&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">225&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">virtio&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">win&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">225.&lt;/span>&lt;span class="n">iso&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个网站访问速度很慢，最好挂个代理，或者下载后用MobaXterm上传到对应目录&lt;/p>
&lt;h4 id="准备安装">准备安装
&lt;/h4>&lt;p>MobaXterm或者其他支持x11的ssh客户端里面 用yanhui登录，执行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">systemctl start libvirtd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">virt-manager
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>会弹出virt-manager 图形界面窗口，先connect上默认的&lt;code>QEMU/KVM&lt;/code>&lt;br>
点 file -&amp;gt; New virual Machine 选默认的 local install，点下一步 Forward&lt;br>
点后面的浏览&lt;code>Browse&lt;/code> 弹出来一个 locate Iso 管理窗口，点左下角的 &lt;code>+&lt;/code> 号 Name 输入 ISO ，&lt;code>type&lt;/code> 保持默认 &lt;code>dir:&lt;/code> ,目标路径 Target 输入ISO储存路径&lt;code>/home/yanhui/mnt/exfat/iso&lt;/code> 然后点&lt;code>Finish&lt;/code> 结束&lt;/p>
&lt;p>然后选中新建的iso里面的win10安装镜像， 返回虚拟主机的配置界面 去掉&lt;code>automatically ...&lt;/code> 这个自动识别系统版本的勾号，在上面输入win10 搜索 选中对应的系统。然后 点下一步 Forward&lt;/p>
&lt;p>可能弹出一个权限的提醒，下一步忽略就好，分配cpu和内存。下一步 Forward 创建磁盘。参考前面iso的配置同样的方法创建一个专门放置vdisk的目录&lt;code>/home/yanhui/mnt/nvme/vdisk&lt;/code>，并创建一个磁盘 win10-base.qcow2 在这里个目录，大小要14G以上哦，不然不够win10安装用的，下一步 Forward ，勾选上 &lt;code>Customize configuration before install&lt;/code>&lt;/p>
&lt;p>继续配置，添加一个ide磁盘cdrom 到 驱动virtio-win-0.1.225.iso。&lt;/p>
&lt;p>默认磁盘改为 virtIO,缓存 unfase，&lt;/p>
&lt;p>如果需要和宿主机文件的交互，添加 File System，选择 virtio-9p&lt;/p>
&lt;p>网络接口等等 其他简单也配置以下，点&lt;code>begin installxxx&lt;/code>&lt;/p>
&lt;p>开始安装 就好了。
找不到磁盘 记得加载驱动，完成后 记得装完整驱动。别的都简单 不用多说。&lt;/p>
&lt;p>网络如果不会配置桥接的话，暂时先用NAT&lt;/p>
&lt;blockquote>
&lt;p>win11 的话记得添加tpm
桥接网络的配置 &lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/" target="_blank" rel="noopener"
>点这里查看&lt;/a>&lt;/p>&lt;/blockquote></description></item><item><title>pve安装群晖最新版7.2 物理机安装同理</title><link>https://dev.leiyanhui.com/pve/qunhui/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/pve/qunhui/</guid><description>&lt;p>最近开始对在线文档 和 第三方云备份有较大的需求，尝试过几次后，决定在pve上跑一个群晖来处理这些问题。&lt;br>
有很多开源免费项目都可以实现这些功能，但是群晖肯定是实现起来最简单功能也是最强的。&lt;/p>
&lt;blockquote>
&lt;p>再次感谢 群晖公司对黑群晖的容忍&lt;/p>&lt;/blockquote>
&lt;p>本文不适合linux纯小白，但是部分内容适合pve新手&lt;/p>
&lt;h1 id="pve运行群晖">pve运行群晖
&lt;/h1>&lt;h2 id="个人期望和解决方案">个人期望和解决方案
&lt;/h2>&lt;p>因为黑群晖出过问题，所以有以下需求。&lt;/p>
&lt;p>1、方便备份整机&lt;/p>
&lt;p>2、群晖挂了不影响数据访问&lt;/p>
&lt;h3 id="解决方案">解决方案
&lt;/h3>&lt;p>为了满足我上面的要求，我才用 硬盘直通一个单独的lxc容器，然后开smb和webdav/sftp，这个容器称为 filecenter 。群晖用补丁实现 smb挂载的文件的 photo audio video的支持。&lt;/p>
&lt;h3 id="额外的支持">额外的支持
&lt;/h3>&lt;p>群晖不做ssl 和 ddns 。&lt;/p>
&lt;h5 id="ssl">ssl
&lt;/h5>&lt;p>用一个单独的lxc 运行 我自己修改过的 nginxWebUI 处理。&lt;/p>
&lt;h5 id="ddns">ddns
&lt;/h5>&lt;p>用一个单独的lxc 运行 ddns-go&lt;/p>
&lt;h5 id="对象储存">对象储存
&lt;/h5>&lt;p>用一个单独的 lxc 运行 minio&lt;/p>
&lt;h5 id="git仓库">git仓库
&lt;/h5>&lt;p>可以用gitlab实现 我这里直接用阿里的codeup了&lt;/p>
&lt;h4 id="核心数据异地备份功能">核心数据异地备份功能
&lt;/h4>&lt;h6 id="群晖整机定时的备份">群晖整机定时的备份
&lt;/h6>&lt;p>lxc单独运行一个alpine，定时任务ssh到pve实现。备份出来的oma，同步到 filecenter的sftp&lt;/p>
&lt;h6 id="备份到百度云">备份到百度云
&lt;/h6>&lt;p>群晖cloud sysnc实现&lt;/p>
&lt;h6 id="备份到阿里云盘">备份到阿里云盘
&lt;/h6>&lt;p>群晖cloud sysnc + alist webdav&lt;/p>
&lt;p>‍&lt;/p>
&lt;h2 id="安装">安装
&lt;/h2>&lt;h3 id="pve准备">pve准备
&lt;/h3>&lt;h4 id="开启核显直通或者gvt-g">开启核显直通或者gvt-g。
&lt;/h4>&lt;p>过程 ： &lt;a class="link" href="https://dev.leiyanhui.com/pve/igpu-one-key/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/igpu-one-key/&lt;/a> 创建虚拟机，硬盘Sata，然后稍后删掉&lt;/p>
&lt;h4 id="准备引导镜像">准备引导镜像
&lt;/h4>&lt;p>&lt;a class="link" href="https://github.com/fbelavenuto/arpl/releases" target="_blank" rel="noopener"
>https://github.com/fbelavenuto/arpl/releases&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">qemu-img convert -p -f raw -O qcow2 arpl-1.0-beta13a.img arpl-1.0-beta13a.qcow2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 导入
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qm importdisk 5000 /exfat/vm-cnf-and-vdisk-bak/Synology/arpl-1.0-beta13a.qcow2 local --format=qcow2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="编译引导的说明">编译引导的说明
&lt;/h4>&lt;p>启动虚拟机，然后按照提示打开网页&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">m&lt;/span> &lt;span class="err">是选择机型，我这里选&lt;/span> &lt;span class="n">DS920&lt;/span>&lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">n&lt;/span> &lt;span class="err">是选择版本，选最新的&lt;/span> &lt;span class="mi">42962&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">然后随机序列号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">其他都不用改动，然后&lt;/span> &lt;span class="err">选择&lt;/span> &lt;span class="n">build&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">loader&lt;/span> &lt;span class="err">会自动编译&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>恢复引导&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">qm&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="mi">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Synology&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">arpl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">beta13a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># http://10.1.1.70:7681/&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>清理引导和系统 到空白&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">qm&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="mi">7000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">arpl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">beta13a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">temp&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">120&lt;/span>&lt;span class="n">g&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看核显&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ls /dev/dri
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>系统和引导备份&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">backuppath&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">exfat&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cnf&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="ow">and&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vdisk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Synology&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date&lt;/span> &lt;span class="o">+%&lt;/span>&lt;span class="n">Y&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">-%&lt;/span>&lt;span class="n">H&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">M&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mkdir&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">qm&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">pvevmid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">load&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">qemu&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">img&lt;/span> &lt;span class="nb">convert&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="n">qcow2&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">O&lt;/span> &lt;span class="n">qcow2&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">-$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">disk&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">qcow2&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">qcow2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">qemu&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">pvevmid&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">backuppath&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pve&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/qunhui" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/qunhui&lt;/a>&lt;/p>
&lt;p>‍&lt;/p></description></item><item><title>常见all in one 系统的一些问题</title><link>https://dev.leiyanhui.com/all-in-one/other-os/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/other-os/</guid><description>&lt;p>我选择 arch-aio的理由&lt;/p>
&lt;blockquote>
&lt;p>arch-aio的简介 &lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/diy/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/diy/&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h5 id="pve">pve
&lt;/h5>&lt;ul>
&lt;li>磁盘分区 需要12-20G左右，备份起来不方便 ，虚拟磁盘名称不方便自定义&lt;/li>
&lt;li>多了不太常用的lxc，没有原生docker 需要自己处理&lt;/li>
&lt;/ul>
&lt;h5 id="hyper-v">hyper-v
&lt;/h5>&lt;ul>
&lt;li>宿主机占用资源偏多&lt;/li>
&lt;li>部分硬件的直通存在一些问题&lt;/li>
&lt;li>hyper-v 虽然免费，但win是收费的 破解版不适合商用&lt;/li>
&lt;/ul>
&lt;h5 id="esxi">esxi
&lt;/h5>&lt;ul>
&lt;li>个人免费，商用收费&lt;/li>
&lt;li>非原生linux，功能限制太多。&lt;/li>
&lt;li>硬件要求尤其是网卡要求多&lt;/li>
&lt;/ul>
&lt;h5 id="unraid">unraid
&lt;/h5>&lt;ul>
&lt;li>占用一个usb口&lt;/li>
&lt;li>需要一个非常靠谱的u盘&lt;/li>
&lt;li>墙内使用麻烦，需要梯子&lt;/li>
&lt;li>会破坏一块硬盘的数据&lt;/li>
&lt;li>收费，破解版多数有挖矿后台&lt;/li>
&lt;/ul>
&lt;h5 id="爱快">爱快
&lt;/h5>&lt;ul>
&lt;li>这个怎么说呢&amp;hellip;也就比较适合不折腾的用户吧&lt;/li>
&lt;li>虽然支持docker，但是没有shell 扩展性太差，简直可以说是垃圾中的战斗机&lt;/li>
&lt;li>但是他的dhcp 以及流控 都很简单易用&lt;/li>
&lt;li>有黑历史 慎重&lt;/li>
&lt;/ul>
&lt;h5 id="群晖">群晖
&lt;/h5>&lt;ul>
&lt;li>要么硬件买，钱多可以&lt;/li>
&lt;li>黑群晖 有一些莫名其妙的问题，有时候可能是致命性的，不少人出现一段时间后无法启动需要接上显示器处理。&lt;/li>
&lt;/ul>
&lt;h5 id="openwrt">openwrt
&lt;/h5>&lt;ul>
&lt;li>路由器系统，不太适合宿主机折腾&lt;/li>
&lt;/ul></description></item><item><title>旧版本 arch-aio all in one系统的，docker和kvm 与挂载磁盘顺序的一个小地方需要自己处理以下</title><link>https://dev.leiyanhui.com/all-in-one/server-after/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/server-after/</guid><description>&lt;p>为了灵活管理，arch-aio 单独创建一个了rc-local服务，用来添加开机自动启动的脚本。 同时也是这个原因，建议在rc-local 里面处理自动挂载脚本。&lt;/p>
&lt;p>仅限2022-12-29 版本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /usr/lib/systemd/system/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>分别编辑 &lt;code>sudo nano libvirtd.service&lt;/code> 和 &lt;code>sudo nano docker.service&lt;/code> 在&lt;code>[Unit]&lt;/code> 段 增加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">After=rc-local.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这行是为了让docker和libvirtd 在rc-local这个服务之后启动，方便我们在 rc-local 内先挂载好磁盘
最后这两个服务设置为自动启动&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo systemctl enable libvirtd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl enable docker
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>关于和自动挂载其他分区配合的方法，可以参考这里：&lt;a class="link" href="https://dev.leiyanhui.com/arch/auto--dock-kvm/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/arch/auto&amp;ndash;dock-kvm/&lt;/a>&lt;/p></description></item><item><title>选择arch-aio，彻底抛弃pve esxi unraid</title><link>https://dev.leiyanhui.com/all-in-one/diy/</link><pubDate>Thu, 29 Dec 2022 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/diy/</guid><description>&lt;blockquote>
&lt;p>本文停止更新，新版查看 &lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/arch-aio-use" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/arch-aio/&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h2 id="前言">前言
&lt;/h2>&lt;h3 id="经历">经历
&lt;/h3>&lt;p>前前后后用过很多 all in one 系统，hyper-v pve6-7.3 unraid，esxi 还有 群晖 爱快，感觉到很多不方便的地方。所以自己做了一个基于arch 和 ventoy的all in one 母系统。&lt;/p>
&lt;p>缺点：门槛略微高一点点。你需要会用linux的基本命令。包括不限&lt;code>ln mount &lt;/code>&lt;br>
优点：灵活，免费,不占用额外分区，强大扩展，较新并非常稳定的内核&lt;/p>
&lt;h3 id="使用方法">使用方法
&lt;/h3>&lt;p>&lt;a class="link" href="https://www.123pan.com/s/EqorVv-K2nPA" target="_blank" rel="noopener"
>https://www.123pan.com/s/EqorVv-K2nPA&lt;/a> 提取码:arch&lt;br>
下载后解压，然后用ventoy，用支持x11转发的ssh客户端（例如 &lt;code>MobaXterm&lt;/code>） 登录 用户名&lt;code>yanhui&lt;/code> 密码 &lt;code>1&lt;/code>
root 密码也是 &lt;code>1&lt;/code> 但是root默认禁止登录。&lt;/p>
&lt;p>简明使用方法：&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/arch-aio-use/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/arch-aio-use/&lt;/a>&lt;/p>
&lt;h4 id="虚拟机">虚拟机
&lt;/h4>&lt;p>先挂载分区，并 &lt;code> ln -s /var/lib/libvirt/images /目录&lt;/code> 或者直接把这个目录挂载到分区
MobaXterm 中运行 &lt;code>virt-manager&lt;/code> 会弹出&lt;code>virt-manager&lt;/code>界面&lt;br>
如果你只想用命令行，也可以卸载掉它。&lt;/p>
&lt;blockquote>
&lt;p>在不支持x11 转发的设备上管理虚拟机，请继续看后面&lt;/p>&lt;/blockquote>
&lt;h4 id="docker">docker
&lt;/h4>&lt;p>先挂载分区，并ln /var/lib/docker 目录 或者直接把这个目录挂载到分区
如果要图形界面，可以安装portainer&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">run&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">8000&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8000&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">9443&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9443&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">--&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="n">portainer&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">restart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">always&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sock&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">portainer&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portainer&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ce&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">latest&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后浏览器访问：https://ip:9443&lt;/p>
&lt;h4 id="新建用户">新建用户
&lt;/h4>&lt;p>新建用户请 添加到wheel组 和 libvirt 组，例如用户名 xiaolei&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo useradd -m -G wheel -s /bin/bash xiaolei
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo usermod -a -G libvirt xiaolei
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后设置密码&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo passwd xiaolei
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="清理日志和缓存文件">清理日志和缓存文件
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sh /root/del-log.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="扩容">扩容
&lt;/h4>&lt;p>如果默认容量不够，需要扩容。请参考
&lt;a class="link" href="https://dev.leiyanhui.com/arch/ventoy-vdisk-resize" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/arch/ventoy-vdisk-resize&lt;/a>&lt;/p>
&lt;h4 id="exfat4-和ntfs支持">exfat4 和ntfs支持
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo pacman -S exfat-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman -S ntfs-3g
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>exfat 和 ntfs 在linux下性能一般，ntfs稳定性更是一般，不建议高强度使用&lt;/p>&lt;/blockquote>
&lt;h4 id="关于sudo-和-vi-vim">关于sudo 和 vi vim
&lt;/h4>&lt;p>用doas 和nano替代的 软连接对应的sudo 和 vi vim&lt;/p>
&lt;h4 id="运行浏览器和其他软件">运行浏览器和其他软件
&lt;/h4>&lt;p>请尽量挂载到其他分区后用appimages
例如火狐&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">pacman&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="n">fuse&lt;/span> &lt;span class="c1">#AppImage 依赖&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">pacman&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="n">dbus&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">glib&lt;/span> &lt;span class="c1"># 火狐依赖&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="err">挂载目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">apprepo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">de&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">appimage&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">firefox&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">document&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Firefox&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chmod&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">./*.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">./&lt;/span>&lt;span class="n">Firefox&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AppImage&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>火狐在x11转发下首次启动很卡，等一会关掉再次打开就流畅很多
中文字体支持&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo pacman -S wqy-zenhei
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>中文输入法：&lt;a class="link" href="https://wiki.archlinuxcn.org/wiki/Fcitx5" target="_blank" rel="noopener"
>https://wiki.archlinuxcn.org/wiki/Fcitx5&lt;/a>&lt;/p>
&lt;h4 id="开机自动启动脚本">开机自动启动脚本
&lt;/h4>&lt;p>rc-local服务：&lt;code>/usr/lib/systemd/system/rc-local.service&lt;/code> 和 &lt;code>/etc/rc.local&lt;/code>&lt;/p>
&lt;p>sh脚本放到 /etc/rc.local.d 目录&lt;/p>
&lt;h4 id="开机自动挂载">开机自动挂载
&lt;/h4>&lt;p>建议放到 /etc/rc.local.d目录。
参考编辑文件&lt;code>sudo nano /etc/rc.local.d/auto-mount-and-start-aio.sh&lt;/code>&lt;br>
详细说明参考这里：&lt;a class="link" href="https://dev.leiyanhui.com/arch/auto-mount-dock-kvm" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/arch/auto-mount-dock-kvm&lt;/a>&lt;/p>
&lt;h4 id="开机自动启动其他分区的vm-或者docker">开机自动启动其他分区的vm 或者docker
&lt;/h4>&lt;p>参考编辑文件&lt;code>sudo nano /etc/rc.local.d/auto-mount-and-start-aio.sh&lt;/code>&lt;br>
详细说明参考这里：&lt;a class="link" href="https://dev.leiyanhui.com/arch/auto-mount-dock-kvm" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/arch/auto-mount-dock-kvm&lt;/a>&lt;/p>
&lt;h4 id="桥接虚拟机网络">桥接虚拟机网络
&lt;/h4>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/arch-aio-use-bridge-network/&lt;/a>&lt;/p>
&lt;h4 id="关于远程访问虚拟机">关于远程访问虚拟机
&lt;/h4>&lt;p>如果客户端非ios设备，网络尚可 直接用支持x11转发的ssh客户端管理&lt;br>
如果是ios设备，因为没有可用的客户端，建议kvm 或者docker中运行一个 有桌面的win 或者linux，再远程过去.再套娃访问宿主机&lt;/p>
&lt;blockquote>
&lt;p>docker 运行linux桌面参考 &lt;a class="link" href="https://dev.leiyanhui.com/docker/run-deskto-gpu-usb/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/docker/run-deskto-gpu-usb/&lt;/a>&lt;br>
上文中的docker 支持网页vnc和xrdp微软远程链接，你甚至可以v挂载虚拟磁盘目录进去，里面有一些基本的软件，包括浏览器完成网盘备份等操作。&lt;/p>&lt;/blockquote>
&lt;p>当然，你也可以直接在宿主系统上安装一个gnome kde等桌面系统，然后开xrdp或者vnc 或者 向日葵 rustdesk 等等 尽情想想&amp;hellip;&lt;/p>
&lt;h4 id="关于winwinpe下访问">关于win/winpe下访问
&lt;/h4>&lt;p>因为镜像是vhd格式的，在win系统和多数winpe下可以直接挂载。 brtfs分区的访问请安装驱动，&lt;a class="link" href="https://dev.leiyanhui.com/win/winbtrfs/" target="_blank" rel="noopener"
>详情&lt;/a>&lt;/p>
&lt;h3 id="系统内软件包">系统内软件包
&lt;/h3>&lt;h4 id="母盘">母盘
&lt;/h4>&lt;p>archlinux-2022.12.01-x86_64.iso arch滚动更新，我用的母盘的版本不影响你 你可随意随时升级到最新版&lt;br>
用archinstall 直接安装的 minimal 模式&lt;br>
源 改为清华源，未开启archlinuxcn源，如果你需要aur软件包自行开启 &lt;a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/help/archlinuxcn/" target="_blank" rel="noopener"
>https://mirrors.tuna.tsinghua.edu.cn/help/archlinuxcn/&lt;/a> &lt;br>
内核考虑到安卓x86 选择 linux-zen&lt;/p>
&lt;h4 id="额外的软件包和配置">额外的软件包和配置
&lt;/h4>&lt;h5 id="基本">基本
&lt;/h5>&lt;p>开启了非root用户的x11转发，依赖&lt;code>xorg-xauth&lt;/code>
基本包： &lt;code>openssh dhcpcd nano doas&lt;/code>&lt;br>
ventoy依赖：&lt;code>which lvm2&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>sudo用doas替换了，但是同时ln到/bin/sudo&lt;br>
vi 未安装 如果不喜欢用nano自行处理&lt;/p>&lt;/blockquote>
&lt;h5 id="kvm和docker相关">kvm和docker相关
&lt;/h5>&lt;p>&lt;code>exfat-utils rsync &lt;/code> &lt;code>qemu-base samba dnsmasq dmidecode iptables-nft bridge-utils openbsd-netcat libvirt virt-manager docker&lt;/code>&lt;/p>
&lt;h3 id="开机自定启动的额外服务">开机自定启动的额外服务
&lt;/h3>&lt;p>&lt;code>sshd dhcpcd&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>注意 docker 和 kvm的libvirt 默认是通过 &lt;code>/etc/rc.local.d/auto-mount-and-start-aio.sh&lt;/code> 启动的&lt;/p>&lt;/blockquote>
&lt;h3 id="我对all-in-one的一点要求">我对all in one的一点要求
&lt;/h3>&lt;p>自定义、灵活、内核新，不破坏原来硬盘。&lt;/p>
&lt;h3 id="简单说一下各个系统的缺陷">简单说一下各个系统的缺陷
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/all-in-one/other-os/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/all-in-one/other-os/&lt;/a>&lt;/p>
&lt;h3 id="为什么选择arch">为什么选择arch
&lt;/h3>&lt;ul>
&lt;li>只使用qemu 等几个软件的情况下，也不存在滚挂的可能性。除非你真的大半年不更新。&lt;/li>
&lt;li>相对 debian centos系，内核新，很多新特性都可以支持&lt;/li>
&lt;li>wiki资料丰富，扩展容易&lt;/li>
&lt;/ul>
&lt;h3 id="为什么选择ventoy引导">为什么选择ventoy引导
&lt;/h3>&lt;p>ventoy新版已经有限的支持无损安装到硬盘，同时也兼容grub4dos&lt;/p>
&lt;h3 id="磁盘容量的纠结">磁盘容量的纠结
&lt;/h3>&lt;p>控制到3.7G 以内是最好的选择，但是可用空间实在是太少了。安装qemu的常用依赖后，剩余空间只有几百M。无法满足正常使用的需求。
考虑许久后，决定抛弃兼容fat32和4G U盘的不实际的想法，改为7.3G。 即便是要安装一个桌面系统 应该也勉强够用。
另外 home opt等目录都可以挂载出来。&lt;/p>
&lt;h3 id="磁盘格式的选择">磁盘格式的选择
&lt;/h3>&lt;p>ventoy只支持 固定大小的vhd vdi raw/img 三种格式 虚拟磁盘启动linux。kvm只支持其中raw，vbox支持前两者，win可以直接挂载vhd&lt;br>
linux可以用qemu-img随意转换其他格式，vhd文件也可以转换成raw/img后挂载。
综合考虑，还是选择了vhd格式&lt;/p>
&lt;h3 id="vdisk内efi分区的大小">vdisk内efi分区的大小
&lt;/h3>&lt;p>考虑到换内核的可能性和内核更新的情况，还是用多数情况适用的512M（正常只占用60m左右）&lt;/p>
&lt;h3 id="vdisk内根分区文件系统的选择">vdisk内根分区文件系统的选择
&lt;/h3>&lt;p>我这里选择brtfs，支持压缩和快照。并且几乎所有winpe下都可以 右键加载驱动后访问，虽然不够稳定但是要比其他文件系统简单一些。&lt;/p>
&lt;h3 id="swap的选择">swap的选择
&lt;/h3>&lt;p>默认不开启，如果需要自行创建swap文件即可&lt;/p></description></item><item><title>基于ventoy启动的linux虚拟磁盘的扩容</title><link>https://dev.leiyanhui.com/arch/ventoy-vdisk-resize/</link><pubDate>Thu, 29 Dec 2022 06:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/arch/ventoy-vdisk-resize/</guid><description>&lt;p>这里以 archlinux 和 vhd格式 为例，raw格式 可以用qemu-img 扩容。&lt;/p>
&lt;p>一个可以正常启动的linux镜像&lt;code>archinstall-ext4.vhd.vtoy&lt;/code> 如果不会弄，参考：https://dev.leiyanhui.com/arch/boot-vhd-ventoy/&lt;/p>
&lt;blockquote>
&lt;p>ventoy启动的linux 扩容比较麻烦&lt;/p>&lt;/blockquote>
&lt;h2 id="虚拟磁盘扩容">虚拟磁盘扩容
&lt;/h2>&lt;p>先关掉系统，然后重启到另外一个带虚拟机的系统，linux 或者win 都可以
linux下 建议用qemu-img 转换到ram后扩容 过程掠过&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mv archinstall-ext4.vhd.vtoy archinstall-ext4.vhd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pacman -S qemu-img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># vpc 是vhd格式
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qemu-img convert -p -f vpc -O raw archinstall-ext4.vhd archinstall-ext4.raw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qemu-img resize archinstall-ext4.raw +5G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv archinstall-ext4.raw archinstall-ext4.raw.vtoy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>win下 可以直接使用diskpart 或者 第三方工具扩容。比如&lt;code>Bootice.exe&lt;/code> 一般pe都有，在磁盘信息的地方输入新容量即可&lt;/p>
&lt;blockquote>
&lt;p>缩小镜像，会导致不可以预料的文件丢失 ，轻易不要尝试&lt;/p>&lt;/blockquote>
&lt;h2 id="新虚拟磁盘文件挂载到虚拟机">新虚拟磁盘文件挂载到虚拟机
&lt;/h2>&lt;p>可以用virtualbox或者kvm,root用户登录&lt;/p>
&lt;h2 id="在系统内部处理">在系统内部处理
&lt;/h2>&lt;p>用ventoy启动扩容好的虚拟磁盘系统，ssh登录&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cfdisk /dev/sdXXX
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>resize需要处理的分区，我这里是/dev/sda2，然后write写入 yes确认 退出&lt;/p>
&lt;h3 id="ext4-格式">ext4 格式
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">resize2fs /dev/sdXXX
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="btrfs格式-操作根目录">btrfs格式 操作根目录
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">btrfs filesystem resize max /
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="然后重新执行vtoyboot">然后重新执行vtoyboot
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /root/vtoyboot*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="准备重启">准备重启
&lt;/h2>&lt;p>虚拟磁盘文件重命名为 XX.vtoy ，重新用ventoy引导 完毕。&lt;/p></description></item><item><title>一个可以不动硬盘分区，直接从一个文件启动的proxmox（pve） 打造all in one</title><link>https://dev.leiyanhui.com/all-in-one/pve-ventoy-vdisk/</link><pubDate>Thu, 22 Dec 2022 03:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/all-in-one/pve-ventoy-vdisk/</guid><description>&lt;h2 id="有什么用">有什么用
&lt;/h2>&lt;ul>
&lt;li>可以在不修改你磁盘分区的情况下，只占用5G的硬盘空间(新版占用12G，剩余7G+)，使用vhd虚拟磁盘的方式 启动一个性能和功能完全不受影响在物理机运行的pve系统。&lt;/li>
&lt;li>可以和其他系统共存并不需要额外的分区&lt;/li>
&lt;li>可以同时存在多个pve系统 自由切换，例如一个开启gvt-g的一个开启核显直通的&lt;/li>
&lt;li>可以很方便的整个系统备份和恢复&lt;/li>
&lt;/ul>
&lt;h2 id="开始使用">开始使用
&lt;/h2>&lt;p>1、准备一个空白U盘，或者硬盘安装好 ventoy,下载 解压 pve.vhd 文件到 任意一个分区（exFAT/NTFS/UDF/XFS/Ext2(3)(4)格式的分区），重命名为 pve.vhd.vtoy &lt;br>
2、开机用ventoy磁盘引导，按下F2 浏览，找到 pve.vhd.vtoy，正常启动 用户名root 密码root &lt;br>
3、配置网卡和ip等 重启，&lt;a class="link" href="https://dev.leiyanhui.com/pve/changip-and-netcard" target="_blank" rel="noopener"
>详细说明看这里&lt;/a> &lt;br>
4、挂载其他磁盘修改虚拟机和ct容器目录 详细说明看后文&lt;/p>
&lt;blockquote>
&lt;p>只是修改了pve内部的引导挂载路径,使用方法 和正常安装的pve一样 ，不影响直通和其他任何功能。更不影响任何性能。&lt;/p>&lt;/blockquote>
&lt;h2 id="进阶">进阶
&lt;/h2>&lt;p>1、扩容方法（以后补 剩余7G其实足够了&amp;hellip; 先用工具扩容vhd，然后在从pve内部处理lvm即可） &lt;br>
2、配置开机启动启动pve &lt;a class="link" href="https://dev.leiyanhui.com/os/ventoy-auto-boot" target="_blank" rel="noopener"
>查看这里&lt;/a> &lt;br>
3、不使用ventoy的启动（整理中..）&lt;/p>
&lt;h2 id="pve通用进阶教程">pve通用进阶教程
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://dev.leiyanhui.com/pve/igpu-pass/" target="_blank" rel="noopener"
>开启pci直通简明教程&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.leiyanhui.com/pve/pve-vm-esxi" target="_blank" rel="noopener"
>开启虚拟化嵌套&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.leiyanhui.com/pve/install-macos-ventura" target="_blank" rel="noopener"
>安装macos&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="更新说明">更新说明
&lt;/h2>&lt;p>2022-12-23&lt;/p>
&lt;ul>
&lt;li>更新为12G 容量，剩余空间7G左右，放弃5G镜像，之所以做一个容量大一些的，是发现1.3G的剩余空间在安装几个常用软件后经常就占满了，再次去扩容过于折腾。而7G容量足够安装常用软件，甚至可以安装上一个桌面系统。&lt;/li>
&lt;li>&lt;del>安装firefox 和 hrub&lt;/del>&lt;/li>
&lt;li>为了减少体积，网盘包改为 7zip 格式 linux解压命令，debian/ubuntu:&lt;code>apt-get install p7zip &amp;amp;&amp;amp; 7z x pve20221223.vhd.vtoy.7z -r -o /目标路径 &lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="概述">概述
&lt;/h2>&lt;ul>
&lt;li>基于 Virtual Environment 7.3-3 内核最新版（目前是 5.15.74-1）&lt;/li>
&lt;li>基于vtoyboot-1.0.25（ventoy） 支持硬盘/U盘安装的 vtoyboot，也支持grub4dos插件启动，推荐用vtoyboot&lt;/li>
&lt;li>硬盘占用空间5G 剩余空间1.1G 左右（可扩容）&lt;/li>
&lt;li>默认ip：5G版：10.0.0.8 12G初始版：10.0.0.120&lt;/li>
&lt;li>默认用户名root 密码 root&lt;/li>
&lt;li>Local-lvm 默认没有启用(低容量会默认禁用)Local开启全功能&lt;/li>
&lt;li>开启x11 转发，方便在上面运行图形化软件，支持浏览器 文件管理等所有linux图形化软件&lt;/li>
&lt;li>开启了sftp 可以用alist rclone之类的软件挂载 &lt;a class="link" href="https://dev.leiyanhui.com/pve/open-sftp" target="_blank" rel="noopener"
>详情&lt;/a>&lt;/li>
&lt;li>修改为国内源&lt;/li>
&lt;li>&lt;del>显示cpu主频 cpu温度 nvme硬盘温度 sata硬盘温度&lt;/del>&lt;/li>
&lt;li>&lt;del>去掉订阅弹窗&lt;/del>&lt;/li>
&lt;li>支持升级&lt;/li>
&lt;li>不影响pci直通等操作&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>绝对没有后门，所有修改过的文件，都备份了一份在 /root/bak-sources, 所有的历史命令和操作记录 都保留，&lt;a class="link" href="https://dev.leiyanhui.com/pve/del-log" target="_blank" rel="noopener"
>你可以自行删除&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h2 id="计划中的功能">计划中的功能
&lt;/h2>&lt;p>精简到4G 以内 方便fat32 分区使用&lt;/p>
&lt;h2 id="已经处理的步骤和常见问题">已经处理的步骤和常见问题
&lt;/h2>&lt;h3 id="挂载其他分区">挂载其他分区
&lt;/h3>&lt;p>查看所有磁盘和分区&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">fdisk -l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>挂载一个分区到/mnt/nvme1&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /mnt/nvme1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/nvmen0p2 /mnt/nvme1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>开机自动挂载，修改fstab 或者 添加开机自动执行脚本。
查看本文 &lt;a class="link" href="https://dev.leiyanhui.com/pve/auto-mount-exfat" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/auto-mount-exfat&lt;/a>
更多内容请自行google &amp;ldquo;linux 挂载分区&amp;quot;关键词&lt;/p>
&lt;blockquote>
&lt;p>pve 可以挂载ntfs分区，但是不建议长期使用，性能和稳定性都有问题。&lt;/p>&lt;/blockquote>
&lt;h3 id="修改ct和虚拟机主机的路径">修改ct和虚拟机主机的路径
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/pve-mv-dir" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/pve-mv-dir&lt;/a>&lt;/p>
&lt;h3 id="国内源">国内源
&lt;/h3>&lt;p>已经更换到清华源 &lt;a class="link" href="https://dev.leiyanhui.com/pve/guonei" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/guonei&lt;/a>&lt;/p>
&lt;h3 id="显示温度">&lt;del>显示温度&lt;/del>
&lt;/h3>&lt;p>&lt;del>已经处理过，不需要你再处理&lt;/del>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cp /usr/share/perl5/PVE/API2/Nodes.pm /root/bak-sources
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /usr/share/pve-manager/js/pvemanagerlib.js /root/bak-sources
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#覆盖文件后 执行下面命令
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt-get install lm-sensors &amp;amp;&amp;amp; apt-get install nvme-cli &amp;amp;&amp;amp; apt-get install hddtemp &amp;amp;&amp;amp; chmod +s /usr/sbin/nvme &amp;amp;&amp;amp; chmod +s /usr/sbin/hddtemp &amp;amp;&amp;amp; chmod +s /usr/sbin/smartctl &amp;amp;&amp;amp; systemctl restart pveproxy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="订阅弹出窗口">&lt;del>订阅弹出窗口&lt;/del>
&lt;/h3>&lt;p>&lt;del>已经处理过，不需要你再处理&lt;/del>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">javascript&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">proxmox&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">widget&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">toolkit&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">proxmoxlib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">js&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bak&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">sources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sed&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Ezi&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bak&lt;/span> &lt;span class="s2">&amp;#34;s/(Ext.Msg.show\(\{\s+title: gettext\(&amp;#39;No valid sub)/void\(\{ \/\/&lt;/span>&lt;span class="se">\1&lt;/span>&lt;span class="s2">/g&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">javascript&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">proxmox&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">widget&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">toolkit&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">proxmoxlib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">js&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">systemctl&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">pveproxy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可能需要清理缓存&lt;/p>
&lt;h3 id="x11-转发">X11 转发
&lt;/h3>&lt;p>已经处理过，不需要你再处理：&lt;a class="link" href="https://dev.leiyanhui.com/pve/x11" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/x11&lt;/a>
用 Xming 或者MobaXterm 连接上，安装一个图形界面软件 测试，比如 &lt;code>apt install firefox-esr thunar&lt;/code> 然后执行firefox 即可打开火狐，thunar 也是一个简单的文件管理工具。&lt;/p>
&lt;blockquote>
&lt;p>注意：x11 转发 只适合简单的场景使用。如果你要流畅，还是考虑 扩容后安装一个完整的桌面系统kde gnome等，然后xrdp vnc或者todesk之类的连接上使用。&lt;/p>&lt;/blockquote>
&lt;h3 id="清理日志和历史命令">清理日志&lt;del>和历史命令&lt;/del>
&lt;/h3>&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/pve/del-log/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/pve/del-log/&lt;/a>&lt;/p>
&lt;h3 id="系统升级到最新版">系统升级到最新版
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apt update &amp;amp;&amp;amp; apt full-upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd /root/vtoyboot-*/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="更新vtoyboot">更新vtoyboot
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd /root/vtoyboot-*/ &amp;amp;&amp;amp; sh vtoyboot.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>应该在系统更新和修改grub后，重启之前执行一次，详情参考 &lt;a class="link" href="https://www.ventoy.net/cn/plugin_vtoyboot.html" target="_blank" rel="noopener"
>https://www.ventoy.net/cn/plugin_vtoyboot.html&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h3 id="怎么访问-vhd所在的分区">怎么访问 vhd所在的分区
&lt;/h3>&lt;p>参考 &lt;a class="link" href="https://www.ventoy.net/cn/faq.html" target="_blank" rel="noopener"
>ventoy faq手册&lt;/a> 启动类问题的说明第四条 &lt;code>默认情况下，Linux系统启动之后，存放ISO文件的分区无法挂载（会提示 Busy）。如果确实需要挂载，请使用 全局控制插件 中的 VTOY_LINUX_REMOUNT 选项。&lt;/code>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/os/ventoy-auto-boot" target="_blank" rel="noopener"
>也可以查看本文 关于自动启动的说明&lt;/a>&lt;/p>
&lt;h3 id="winpewin下如何备份和配置pve">winpe/win下如何备份和配置pve
&lt;/h3>&lt;h4 id="备份">备份
&lt;/h4>&lt;p>直接复制压缩 XXX.vtoy 文件&lt;/p>
&lt;h4 id="配置ventoy">配置ventoy
&lt;/h4>&lt;p>建议用完整win，或者firpe，然后 用它自带的工具 VentoyPlugson.exe ，默认地址是 http://127.0.0.1:24681&lt;/p>
&lt;h4 id="修改pve内部文件">修改pve内部文件
&lt;/h4>&lt;p>重命名为 .vhd，然后挂载到Windows，而后用支持ext4分区的软件来操作 推荐 ExtFS 最稳定，免费10天，也有XXX的版本&lt;br>
&lt;a class="link" href="https://china.paragon-software.com/home-windows/extfs-for-windows/download.html" target="_blank" rel="noopener"
>https://china.paragon-software.com/home-windows/extfs-for-windows/download.html&lt;/a>&lt;/p>
&lt;h2 id="ventoy和pve的使用需要注意">ventoy和pve的使用需要注意
&lt;/h2>&lt;ul>
&lt;li>ventoy 不支持差分vhd磁盘，不要尝试改为vhd文件后再次差分，但是可以自己转换为vdi或者img格式&lt;/li>
&lt;li>修改grub后或者内核升级后记得运行一次 vtoyboot.sh 再重启。平时不需要&lt;/li>
&lt;li>vhd.vtoy文件可以放在ntfs分区，不影响使用。但不建议pve内的虚拟机放在ntfs分区，所有的非win系统，对ntfs的支持都不够稳定。&lt;/li>
&lt;li>记得修改密码！！！！！&lt;/li>
&lt;/ul>
&lt;h2 id="下载地址">下载地址
&lt;/h2>&lt;p>如果失效，请联系 &lt;a class="link" href="mailto:joyanhui@qq.com" >joyanhui@qq.com&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.123pan.com/s/EqorVv-fPnPA" target="_blank" rel="noopener"
>https://www.123pan.com/s/EqorVv-fPnPA&lt;/a> 提取码:0pve&lt;/p>
&lt;p>其他未尽事宜 请参考ventoy手册：&lt;a class="link" href="https://www.ventoy.net/cn/doc_news.html" target="_blank" rel="noopener"
>https://www.ventoy.net/cn/doc_news.html&lt;/a>&lt;/p></description></item><item><title>docker运行 官方宝塔</title><link>https://dev.leiyanhui.com/docker/baota/</link><pubDate>Sun, 27 Nov 2022 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/docker/baota/</guid><description>&lt;p>宝塔 终于出官方docker了 基于&lt;code>CentOS 7.9.2009 x86_64&lt;/code>&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://hub.docker.com/r/btpanel/baota" target="_blank" rel="noopener"
>https://hub.docker.com/r/btpanel/baota&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.bt.cn/bbs/thread-79499-1-1.html" target="_blank" rel="noopener"
>https://www.bt.cn/bbs/thread-79499-1-1.html&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>LNMP镜像大小大概 733.3MB 解压后大概3006.51MB 。。。没得办法，宝塔的依赖项真的是太多了。。。
在软路由上搞起来先&lt;/p>
&lt;h2 id="先整理端口">先整理端口
&lt;/h2>&lt;p>不打算映射数据出来，方便转移，并预留ssh 和常用端口&lt;/p>
&lt;pre>&lt;code>#宝塔面板 22 ssl http phpmyadmin
-p 51888:8888 -p 51022:22 -p 51443:443 -p 51080:80 -p 51188:888 \
# 路由器封80 443自定义web端口 以及22重复
-p 51081:51081 -p 51444:51444 -p 51000:22 \
# mysql
-p 51306:3306 \
# redis
-p 51379:6379 \
# pgsql
-p 51432:5432 \
# MongoDB
-p 51017:27017 \
# 备用端口
-p 51200-51299:51200-51299 \
&lt;/code>&lt;/pre>
&lt;p>你问我为啥开这么多端口。。我开心我乐意，反正外网又访问不到。。。&lt;/p>
&lt;h2 id="镜像和标签的选择">镜像和标签的选择
&lt;/h2>&lt;p>latest 标签拉取的是lib标签，安装了面板并且安装集成依赖包，安装每个软件都会快一点。&lt;br>
fresh 标签表示安装了面板但是没有安装集成依赖包，安装第一个软件会比较慢，因为需要装依赖包。&lt;br>
lib 标签表示安装了面板并且安装集成依赖包，安装每个软件都会快一点。&lt;br>
lnmp 标签表示安装了面板、集成包并且集成LNMP【Nginx1.22+MySQL5.7+PHP7.4】arm标签是MySQL5.6&lt;br>
lamp 标签表示安装了面板、集成包并且集成LAMP【Apache2.4+MySQL5.7+PHP7.4】arm标签是MySQL5.6&lt;br>
我这里选择&lt;code>lnmp&lt;/code> 经过测试发现，其实还集成了ftp&lt;/p>
&lt;h2 id="目录的挂载">目录的挂载
&lt;/h2>&lt;p>/www/server/data 数据库&lt;br>
/www/wwwroot 网站目录 或者说 静态文件目录&lt;br>
/www/server/panel/vhost 虚拟机主机配置文件&lt;br>
其他目录参考宝塔官网&lt;br>
我不打算映射出来，因为可以在宝塔内挂载oss之类的网盘自动备份。&lt;br>
而且不映射任何目录的话，docker的备份和迁移更为简单简单一些。&lt;/p>
&lt;h2 id="最终命令的整理">最终命令的整理
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run -d --restart unless-stopped --name baota \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51888:8888 -p 51022:22 -p 51443:443 -p 51080:80 -p 51188:888 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51081:51081 -p 51444:51444 -p 51000:22 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51306:3306 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51379:6379 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51432:5432 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51017:27017 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-p 51200-51299:51200-51299 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btpanel/baota:lnmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="默认账户名密码-和登录地址">默认账户名密码 和登录地址
&lt;/h2>&lt;p>现在，您可以在浏览器访问默认地址 http://您的ip地址:8888/btpanel 上的宝塔面板。
默认用户：btpanel
默认密码：btpaneldocker
默认SSH密码：用户名 root 密码 btpaneldocker&lt;/p>
&lt;p>默认用户：btpanel&lt;br>
默认密码：btpaneldocker&lt;br>
容器默认SSH密码：btpaneldocker&lt;/p>
&lt;h2 id="其他">其他
&lt;/h2>&lt;h3 id="容器内的服务处理">容器内的服务处理
&lt;/h3>&lt;p>是使用的&lt;code>/bt.sh&lt;/code> 这个文件，除了默认服务之外，其他服务需要自行添加默认内容&lt;/p>
&lt;pre>&lt;code>#!/bin/bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH
init_path=/etc/init.d
Root_Path=`cat /var/bt_setupPath.conf`
Setup_Path=$Root_Path/server/mysql
Data_Path=$Root_Path/server/data
soft_start(){
${init_path}/nginx start
${init_path}/php-fpm-74 start
${init_path}/pure-ftpd start
${init_path}/bt restart
pkill crond
/sbin/crond
/usr/sbin/sshd -D &amp;amp;
}
is_empty_Data(){
return `ls -A ${Data_Path}/|wc -w`
}
init_mysql(){
# initialize_mysql
if [ -f /init_mysql.sh ];then
sh /init_mysql.sh
rm -f /init_mysql.sh
fi
}
start_mysql(){
chown -R mysql:mysql ${Data_Path}
chgrp -R mysql ${Setup_Path}/.
${init_path}/mysqld start
rm -f /init_mysql.sh
}
soft_start &amp;gt; /dev/null
is_empty_Data &amp;gt; /dev/null
if [ $? == 0 ];then
init_mysql &amp;gt; /dev/null
else
start_mysql &amp;gt; /dev/null
fi
tail -f /dev/null
&lt;/code>&lt;/pre>
&lt;h3 id="计划任务的bug">计划任务的bug
&lt;/h3>&lt;p>宿主机运行&lt;/p>
&lt;pre>&lt;code> docker exec -it 容器名称baota bash
pkill crond &amp;amp;&amp;amp; /sbin/crond
&lt;/code>&lt;/pre>
&lt;p>然后重新添加计划任务&lt;/p>
&lt;h3 id="容器内的ssh的bug">容器内的ssh的bug
&lt;/h3>&lt;p>已经默认安装了openssh，但是可能还需要处理一下才可以连接，注意 复制的时候 要看一下宿主机的情况。如果不是host模式的话不存在这个问题&lt;/p>
&lt;pre>&lt;code>#获取容器ID
docker ps|awk 'NR &amp;gt; 1{print$1}'
#复制必要密钥文件到容器内
\cp -r /etc/ssh/ssh_host_* /home/
chmod 600 /home/ssh_host_*
docker cp /home/ssh_host_rsa_key 容器ID:/etc/ssh/
docker cp /home/ssh_host_ecdsa_key 容器ID:/etc/ssh/
docker cp /home/ssh_host_ed25519_key 容器ID:/etc/ssh/
#给容器设置一个root密码，qqwwee123替换成自己想要的密码
docker exec -it 容器ID /bin/bash -c &amp;quot;echo 'qqwwee123'|passwd --stdin root&amp;quot;
#让sshd运行起来
docker exec 容器ID /usr/sbin/sshd -D &amp;amp;
rm -rf /home/ssh_host_*
&lt;/code>&lt;/pre>
&lt;h2 id="问题和其他bug">问题和其他bug
&lt;/h2>&lt;ul>
&lt;li>docker版本更新滞后，也不算大事，宝塔新版问题更多哈哈&lt;/li>
&lt;li>web控制面板卡顿，web终端卡顿 甚至打不开，不缺点是宝塔新版的问题，还是软路由器性能问题&lt;/li>
&lt;li>宝塔内置系统防火墙不可用（docker的限制。不过确实没必要）&lt;/li>
&lt;li>ssl的证书夹在某些特定情况下 无法保存的问题。这个应该是宝塔自己的bug，月经bug 宝塔反反复复，经常间隔几个版本就出现一次 .重新登录一次面板，然后续签一次证书，或者重新部署一次。运气好的话 就好了，或者整个站点都删掉重新添加，运气不好的话，。。。。删了宝塔吧。。&lt;/li>
&lt;li>innodb_log_buffer_size 的bug，这个以及是宝塔本身的月经bug 反复出现，手动设置一下就好&lt;/li>
&lt;li>web面板 配置mysql的界面 mysql状态不显示，这个应该也是宝塔自己的bug，月经bug&lt;/li>
&lt;li>web面板 终端偶尔打不开 应该是xterm和bug，宝塔本身也或许有问题，退出重新登录就好，或者清理浏览器缓存 重新登录&lt;/li>
&lt;li>通知模块偶尔显示 名称：undefined xxx，无配置。。这个也是宝塔的月经bug&lt;/li>
&lt;li>不算是问题，但一定注意第一时间修改 面板用户名密码以及ssh的root密码&lt;/li>
&lt;/ul>
&lt;h2 id="题外话">题外话
&lt;/h2>&lt;p>其实已经很久没有新装过宝塔了，然后发现 现在的宝塔 是bug成堆。。。硬硬把用户当作实验台，略有能力的情况下能不用就不用了吧&lt;br>
以前会去宝塔论坛 认真截图 说复现步骤，反馈，然后论坛客服 除了一堆毫无意义的机械回复，也没啥，有时候反馈一个bug 竟然要回帖数次。。。
基本上 修补了上一个bug 然后出现新bug&lt;/p>
&lt;p>正经的生产环境，真的不怎么建议用宝塔。。。毕竟现在docker环境可选多部署一个新环境也不难&lt;/p></description></item><item><title>docker运行nginx 并反代内网的一些服务，</title><link>https://dev.leiyanhui.com/docker/nginx-proxy-manage/</link><pubDate>Sun, 27 Nov 2022 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/docker/nginx-proxy-manage/</guid><description>&lt;p>本文停止更新，建议使用 nginxwebui ：https://dev.leiyanhui.com/openwrt/nginx-proxy-ssl&lt;/p>
&lt;p>支持中文，也支持静态站，甚至可以转发php之类的。&lt;/p>
&lt;p>&lt;code>nginx-proxy-manage&lt;/code> 是一个有web管理解决的 纯nginx管理工具，基于node开发的。类似宝塔。。自带了ssl证书管理（基于Let’s Encrypt的）&lt;/p>
&lt;p>适合 在轻量的主机上运行，例如 软路由。。。&lt;/p>
&lt;p>比宝塔来说优势有&lt;/p>
&lt;ul>
&lt;li>支持更多dns验证api，几乎支持所有的常见国内外域名和dns商，并且支持 acmedns_api&lt;/li>
&lt;li>更加轻量简单
缺点嘛，，就是没有别的功能了。只有nginx 和 ssl 。所以很适合 路由上使用&lt;/li>
&lt;/ul>
&lt;p>要求多的话，还是建议使用宝塔，&lt;a class="link" href="https://dev.leiyanhui.com/docker/baota" target="_blank" rel="noopener"
>现在宝塔官网已经发布docker&lt;/a>&lt;/p>
&lt;h2 id="基本命令">基本命令
&lt;/h2>&lt;p>参考：https://hub.docker.com/r/jlesage/nginx-proxy-manager
改动一下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker run -d \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --name=nginx-proxy-manager \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p 50181:8181 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p 50080:8080 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p 50443:4443 \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> jlesage/nginx-proxy-manager
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>web访问端口 是 50080:8080 ssl 50443:4443 管理端口 50181:8181
默认用户名密码 &lt;code>admin@example.com&lt;/code> &lt;code>changeme&lt;/code>&lt;/p>
&lt;h3 id="后续我发现真正的官网镜像实际不是这个">后续我发现真正的官网镜像实际不是这个！
&lt;/h3>&lt;p>而是 &lt;code>jc21/nginx-proxy-manager:latest&lt;/code> 文档地址：https://nginxproxymanager.com/setup/#using-mysql-mariadb-database
并且官网文档是明确支持ipv6的 只是默认禁用&lt;/p>
&lt;h2 id="基本使用">基本使用
&lt;/h2>&lt;h3 id="修改用户密码">修改用户密码
&lt;/h3>&lt;p>登录后就会自动提示修改，按照提示修改一下&lt;/p>
&lt;h3 id="试着申请个域名ssl">试着申请个域名ssl
&lt;/h3>&lt;p>很简单 不用多说，看不懂 自己开翻译软件（吐槽：软路由圈子 英语不好 还不肯开翻译软件的人。。多好。。）&lt;/p>
&lt;h2 id="这个工具存在的问题">这个工具存在的问题
&lt;/h2>&lt;ul>
&lt;li>只支持LE的证书，我本想和acme.sh的配合 使用，发现。。。这货好像把证书放在了数据库里面，，服了。。。然后自定义证书 也只能是上传。。。
&lt;ul>
&lt;li>后续发现存放到了/etc/letsencrypt ，但是格式和acme.sh 不能完全兼容。。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>dns api的配置记录不能自动保存，添加多个证书的时候 需要每次都输入一次 api接口的key信息&lt;/li>
&lt;li>下载回来的证书，只有nginx格式&lt;/li>
&lt;li>面板本身好像不可以直接启用ssl，应该需要sh进去改配置文件，或者自己代理自己一次&lt;/li>
&lt;li>没有中文界面&lt;/li>
&lt;li>镜像体积不小， 182.90MB 左右&lt;/li>
&lt;li>在主机列表页面直接打开对应的域名，是使用默认端口打开。不会帮你跳到&lt;code>50080:8080 ssl 50443:4443&lt;/code>,我node 水平一般也没有找打 队以ing的文件&lt;/li>
&lt;li>同时 在反代 pve 或 openwrt等应用的适合，会导致 vnc或者终端控制台打不开。（这个好像是 noVNC 以及xterm.js的问题）
&lt;ul>
&lt;li>pve可以用 /etc/pve/local/qemu-server/&lt;!-- raw HTML omitted -->.conf &lt;a class="link" href="https://pve.proxmox.com/wiki/VNC_Client_Access" target="_blank" rel="noopener"
>添加vnc配置的方法用客户端链接&lt;/a>&lt;/li>
&lt;li>oc的控制docker台 可以用shell登录后 &lt;code> docker exec -it 容器名 /bin/bash&lt;/code>&lt;/li>
&lt;li>或者docker 另外跑一个浏览器 来访问内网的这个web，然后nginx-proxy-manager再套上ssl 就可以了&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>其他暂未发现&lt;/li>
&lt;/ul>
&lt;h2 id="结论">结论
&lt;/h2>&lt;p>很适合要求不高的情况下使用，也适合小白。
其实 还是建议直接docker跑一个宝塔算了，自己用debian、centos基础做也行，现在宝塔官方也支持docker了&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.leiyanhui.com/docker/baota" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/docker/baota&lt;/a>&lt;/p>
&lt;h2 id="另外一个替代项目">另外一个替代项目
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.nginxwebui.cn/" target="_blank" rel="noopener"
>https://www.nginxwebui.cn/&lt;/a>&lt;/p>
&lt;p>简单看了一下 国产的，支持中文，支持负载均衡，但是证书虽然是用 acme.sh ,但是同样也是 只支持 LE的自动续期和申请。。&lt;/p>
&lt;p>使用说明 ：https://dev.leiyanhui.com/openwrt/nginx-proxy-ssl&lt;/p>
&lt;p>官网：https://github.com/cym1102/nginxWebUI#docker%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E&lt;/p></description></item><item><title>docker 运行证书管理工具acme.sh</title><link>https://dev.leiyanhui.com/docker/acme-sh/</link><pubDate>Sat, 26 Nov 2022 06:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/docker/acme-sh/</guid><description>&lt;p>支持在所有运行docker的设备上 linux系统 windows macos openwrt unraid pve等 自动申请签发证书（爱快这种畸形的除外）&lt;/p>
&lt;h2 id="简单的运行">简单的运行
&lt;/h2>&lt;pre>&lt;code>docker run --rm -itd \
-v &amp;quot;$(pwd)/out&amp;quot;:/acme.sh \
--net=host \
--name=acme.sh \
neilpang/acme.sh daemon
&lt;/code>&lt;/pre>
&lt;h2 id="使用方法">使用方法
&lt;/h2>&lt;pre>&lt;code>docker exec acme.sh --help
docker exec acme.sh --issue --dns dns_cf -d *.example.com -d example.com
&lt;/code>&lt;/pre>
&lt;h2 id="指定dns的api">指定dns的api
&lt;/h2>&lt;p>走dns验证的，例如cf家的&lt;/p>
&lt;pre>&lt;code>docker run --rm -itd \
-v &amp;quot;$(pwd)/ssl_out&amp;quot;:/acme.sh \
-e CF_Email=&amp;quot;example@example.com&amp;quot; \
-e CF_Key=&amp;quot;asasasasasadasasas&amp;quot; \
--net=host \
--name=acme.sh \
neilpang/acme.sh daemon
&lt;/code>&lt;/pre>
&lt;p>如果是 dnspod&lt;/p>
&lt;pre>&lt;code>export DP_Key=&amp;quot;sADDsdasdgdsf&amp;quot;
docker run --rm -itd \
-v &amp;quot;$(pwd)/ssl_out&amp;quot;:/acme.sh \
-e DP_Id=&amp;quot;1234&amp;quot; \
-e DP_Key=&amp;quot;sADDsdasdgdsf&amp;quot; \
--net=host \
--name=acme.sh \
neilpang/acme.sh daemon
&lt;/code>&lt;/pre>
&lt;p>其他的dns 的api参考 &lt;a class="link" href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi" target="_blank" rel="noopener"
>https://github.com/acmesh-official/acme.sh/wiki/dnsapi&lt;/a>&lt;/p>
&lt;p>如果不支持自动api的话，参考他官网的别名解析验证 &lt;a class="link" href="https://github.com/acmesh-official/acme.sh/wiki/DNS-alias-mode" target="_blank" rel="noopener"
>https://github.com/acmesh-official/acme.sh/wiki/DNS-alias-mode&lt;/a>&lt;/p>
&lt;h2 id="进阶">进阶
&lt;/h2>&lt;p>可以和其他容器 包括 宝塔 或者 nginx-proxy-manager 配合使用（这两个只支持LE的免费域名，兼容性极差）&lt;/p>
&lt;h2 id="其他资源">其他资源
&lt;/h2>&lt;p>支持180天的 （半年的）泛域名 以及 ip申请 ，应该 还是不支持内网ip的&lt;/p>
&lt;p>&lt;a class="link" href="https://hostloc.com/forum.php?mod=viewthread&amp;amp;tid=1050449" target="_blank" rel="noopener"
>https://hostloc.com/forum.php?mod=viewthread&amp;tid=1050449&lt;/a>&lt;/p>
&lt;p>作者主页：https://github.com/Neilpang&lt;/p></description></item><item><title>docker5.7</title><link>https://dev.leiyanhui.com/docker/mysql5-7/</link><pubDate>Sat, 26 Nov 2022 06:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/docker/mysql5-7/</guid><description>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="n">run&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="n">mysql5&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">7&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="mi">3306&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3306&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="n">MYSQL_ROOT_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">123456&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker_data&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mysql&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker_data&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">conf&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">/&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker_data&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">logs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mysql&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mysql&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mf">5.7&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>输入法的选择，win linux macos 安卓 ios</title><link>https://dev.leiyanhui.com/c/inputexe/</link><pubDate>Sat, 22 Oct 2022 06:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/c/inputexe/</guid><description>&lt;h1 id="输入法的选择">输入法的选择
&lt;/h1>&lt;h2 id="输入法的选择-1">输入法的选择
&lt;/h2>&lt;h2 id="先说结论">先说结论
&lt;/h2>&lt;blockquote>
&lt;p>rime为主，独立帐号的百度输入法 辅助&lt;/p>&lt;/blockquote>
&lt;h2 id="本文最后一次更新2022年11月29日">本文最后一次更新2022年11月29日。
&lt;/h2>&lt;p>win linux 已经 全部切换到 rime。安卓有客户端，但是研究过怎么用，我安卓是备用电话机。。
ios 暂时还是用的百度输入法。 美区有&lt;code>iRime&lt;/code> (没开源国区下架了)1.99刀，可以用。
linux下偶尔也用&lt;code>fcitx-googlepinyin&lt;/code> 比较轻量&lt;/p>
&lt;p>优点:&lt;/p>
&lt;ul>
&lt;li>流畅 非常非常流畅，哪怕momo7w这种N年前都百元平板上都可以流畅输入&lt;/li>
&lt;li>无隐私问题&lt;/li>
&lt;li>字库可以自己git 或者 坚果云 备份&lt;/li>
&lt;li>除了ios之外所有平台可用&lt;/li>
&lt;li>皮肤可以自定义 可以自行配置&lt;/li>
&lt;li>扩展性很强&lt;/li>
&lt;li>开源 快平台&lt;/li>
&lt;li>标准词库格式&lt;/li>
&lt;/ul>
&lt;p>缺点：&lt;/p>
&lt;ul>
&lt;li>新人初次上手难度大 需要设置的地方多 部分配置需要自行修改配置文件&lt;/li>
&lt;li>没有云输入，也就是新鲜热词词库是没有的&lt;/li>
&lt;li>linux不支持&lt;code>fcitx-cloudpinyin&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>官网地址：https://rime.im 下载链接：&lt;a class="link" href="https://rime.im/download/" target="_blank" rel="noopener"
>https://rime.im/download/&lt;/a>
win下叫做 小狼毫 linux下可选 fcitx-rime(第三方) 或者 ibus-rime
===========以下是旧文章================&lt;/p>
&lt;h2 id="再说原因">再说原因
&lt;/h2>&lt;blockquote>
&lt;p>win mac ios 安卓 部分Linux桌面版可以用 词库过得去 ios下基本完美 语音识别准确率过得去&lt;/p>&lt;/blockquote>
&lt;h2 id="不选择其他的原因">不选择其他的原因
&lt;/h2>&lt;blockquote>
&lt;p>· QQ拼音 不支持非Linux 和mac 不考虑 · 搜狗拼音且不说广告【百度拼音可以说没有】，ios下频繁消失的问题频繁出现 · 讯飞 mac和linux支持不好 · 搜狗 另外在多数linux发行版上面没有词库同步&lt;/p>&lt;/blockquote>
&lt;p>#再说缺点&lt;/p>
&lt;blockquote>
&lt;p>· 李彦宏家的 这货&amp;hellip; 隐私问题 独立账号登陆吧 · 设置同步 好像有逻辑问题，比如候选词9个，就不行 · 有时候按错键莫名其妙插入emjo表情，在一些在线编辑器就成了上传图片 · 没有错键识别纠正，比如 jiuzheng 我如果按成kiuzheng 不会自动纠正&lt;/p>&lt;/blockquote></description></item></channel></rss>