<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Webs on 小类随手记</title><link>https://dev.leiyanhui.com/web/</link><description>Recent content in Webs on 小类随手记</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Wed, 06 Mar 2024 08:14:20 +0800</lastBuildDate><atom:link href="https://dev.leiyanhui.com/web/index.xml" rel="self" type="application/rss+xml"/><item><title>私有化笔记软件从思源迁移到outline</title><link>https://dev.leiyanhui.com/web/siyuan-to-outline/</link><pubDate>Wed, 06 Mar 2024 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/siyuan-to-outline/</guid><description>&lt;p>前后尝试了一圈笔记软件 最后停留在思源，但是因为除了思源的黑历史的膈应和最近的同步收费问题。思源本身也有一些问题。所以尝试了一下outline。&lt;/p>
&lt;h3 id="迁移过程说明">迁移过程说明
&lt;/h3>&lt;p>思源逐个导出md.zip 逐个解压到同一个文件夹。然后压缩成zip 导入到outline。
如果文档笔记多，可以现在思源把多个文档合并到3-5个文档的子文档里面再导出md。&lt;/p>
&lt;p>::: 丢失部分内联变成纯文本了。 部分图片地址有误。&lt;/p>
&lt;h3 id="体验不好的地方">体验不好的地方
&lt;/h3>&lt;ul>
&lt;li>没有多文件编辑 需要用收藏功能或者浏览器的多标签替代多标签切换，&lt;/li>
&lt;li>&lt;del>两个连续的区块（代码库 提示 引用之类的）中间无法插入新内容，需要删除后面的内容加空行后重新粘贴（或者是我不会） 在上一个区块的末行空行回车即可&lt;/del>&lt;/li>
&lt;li>需要pgsql redis 还有强制s3储存 第三方登陆等 部署麻烦一丢丢，用了vicalloy/outline-docker-compose 直接搞也还好&lt;/li>
&lt;li>貌似没有ai支持 试了试Codeium的浏览器插件好像识别不了，暂时没有找到解决办法先忍一下。&lt;/li>
&lt;li>也没有纯md代码编辑模式&lt;/li>
&lt;/ul>
&lt;h3 id="爽点">爽点
&lt;/h3>&lt;ul>
&lt;li>多人协作&lt;/li>
&lt;li>评论功能&lt;/li>
&lt;li>url分享&lt;/li>
&lt;li>历史记录&lt;/li>
&lt;li>模板功能直观易用，可以在outline直接写hugo hexo vuepress的草稿&lt;/li>
&lt;li>整个工作区导出为md&lt;/li>
&lt;li>复制md到剪切板（思源的需要单独的主题插件才支持，貌似那个主题也被下架了）&lt;/li>
&lt;li>和思源一样支持web部署，移动版多平台可以直接webapp，更是支持多用户&lt;/li>
&lt;/ul>
&lt;h3 id="安装过程">安装过程
&lt;/h3>&lt;h4 id="clone-vicalloy的脚本">clone vicalloy的脚本
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir -p /myfile/outline &amp;amp;&amp;amp; cd /myfile/outline
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;#34;https://github.com/vicalloy/outline-docker-compose.git&amp;#34;&amp;gt;/myfile/outline/README_outline-docker-compose.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/vicalloy/outline-docker-compose.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd outline-docker-compose
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp scripts/config.sh.sample scripts/config.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="简单修改">简单修改
&lt;/h4>&lt;p>修改点&lt;/p>
&lt;ul>
&lt;li>语言 &lt;code>DEFAULT_LANGUAGE&lt;/code>&lt;/li>
&lt;li>时区 &lt;code>TIME_ZONE&lt;/code>&lt;/li>
&lt;li>nginx端口和ip &lt;code>HTTP_PORT_IP&lt;/code> &lt;code>HTTP_IP&lt;/code>&lt;/li>
&lt;li>outline版本 &lt;code>OUTLINE_VERSION&lt;/code>&lt;/li>
&lt;li>nas上统一的管理的https域名和端口 &lt;code>URL&lt;/code> 这个和这里的nginx无关，是外部访问用的，我这里是caddy+dnspods&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update config file: vim scripts/config.sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">cat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">myfile&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">outline&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">outline&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">compose&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">scripts&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sh&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">EOF&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># Outline Wiki 0.72.0-1 supports local file storage.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Specify what storage system to use. Possible value is one of &amp;#34;s3&amp;#34; or &amp;#34;local&amp;#34;.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># For &amp;#34;local&amp;#34;, the avatar images and document attachments will be saved on local disk.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">FILE_STORAGE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># The url used to vist this web site.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">XXXXXXX&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">leiyanhui&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">XXX&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># The default interface language. See translate.getoutline.com for a list of
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># available language codes and their rough percentage translated.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">DEFAULT_LANGUAGE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zh_CN&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># https://docs.djangoproject.com/en/2.2/ref/settings/#language-code
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">LANGUAGE_CODE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">en&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">us&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">TIME_ZONE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Asia&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Shanghai&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">FORCE_HTTPS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="no">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># The domain in you email.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Comma separated list of domains to be allowed (optional).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If not set, the first user&amp;#39;s domain is allowed by default.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">ALLOWED_DOMAINS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># Docker image version
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">OUTLINE_VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">75&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">POSTGRES_VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">alpine3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">MINIO_VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">RELEASE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">2022&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="n">T23&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">09&lt;/span>&lt;span class="n">Z&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">MINIO_MC_VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">RELEASE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">2022&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="n">T21&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">39&lt;/span>&lt;span class="n">Z&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># Nginx
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># The nginx bind ip and port.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If you use ip address to access outline, this ip and port should be same as the URL.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If this server behind a proxy(nginx), you can bind to `127.0.0.1`.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">HTTP_IP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">HTTP_PORT_IP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># Docker
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If you server behind a proxy(nginx), and the proxy created by docker. You can use the proxy&amp;#39;s network. Set the `NETWORKS` to proxy&amp;#39;s network name, and set `NETWORKS_EXTERNAL` to `true` .
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># The sample config for host nginx can be find in `config/sample/nginx_outline.conf`.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">NETWORKS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">outlinewiki&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">NETWORKS_EXTERNAL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="no">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1"># Secret keys, update by script.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># You shouldn&amp;#39;t edit it.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">MINIO_ACCESS_KEY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">MINIO_SECRET_KEY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">OIDC_CLIENT_SECRET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">OUTLINE_SECRET_KEY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">OUTLINE_UTILS_SECRET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">DJANGO_SECRET_KEY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">EOF&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="常用命令">常用命令
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make start #start outline
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make stop #stop outline 也会删除容器
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make clean #remove all config file generated by script.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make clean-data # You will lose all your data
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="数据备份">数据备份
&lt;/h4>&lt;p>/myfile/outline/outline-docker-compose/data 目录
或者 outline内直接导出&lt;/p></description></item><item><title>低成本高可用性异地多活跨云部署方案</title><link>https://dev.leiyanhui.com/web/mcloud/</link><pubDate>Wed, 20 Dec 2023 18:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/mcloud/</guid><description>&lt;p>在跨云异地多活部署遇到的最大的两个问题 1 是复杂度 2是成本。 一个项目想达到99.9%的高可用性，并且不依赖云厂商还是非常困难。 &lt;br>
异地多活有很多实现方法，下面分享一种 较为简单并尽可能的降低成本的方案。以阿里云 腾讯云 华为云，分别 上海 广州 北京 三城。以阿里（上海）和腾讯（广州）为主，华为为辅。&lt;br>
下文中所有的redis所指均为keydb6.x。&lt;/p>
&lt;h2 id="主要内容">主要内容
&lt;/h2>&lt;p>负载均衡 路由层 业务层 缓存层 数据层 定时备份&lt;/p>
&lt;h2 id="负载均衡和路由层">负载均衡和路由层
&lt;/h2>&lt;p>因为非传统web项目，有客户端，这部分内容集成到客户端。由客户端根据预置规则选择 请求到某一个机房。&lt;/p>
&lt;h2 id="业务层">业务层
&lt;/h2>&lt;p>要全部改造为无状态服务， 部分业务需要完全兼容华为/阿里/腾讯的函数计算，并在对应的云厂商和自己的机器上都有部署。 &lt;br>
部分业务有读写冲突的情况，虽然多活部署，但是使用消息中间件确保只有一个实例处在运行状态，其他实例等待抢占上位。&lt;/p>
&lt;h2 id="缓存层和数据层">缓存层和数据层
&lt;/h2>&lt;p>应用层对数据库的读写 都在redis中，少数在pgsql。pgsql的数据只作为分析和统计使用。 &lt;br>
其他需要储存的数据采用云厂商的对象储存。（要优化一下）&lt;/p>
&lt;h3 id="redis-使用多个集群">redis 使用多个集群
&lt;/h3>&lt;h4 id="核心集群跨云跨机房">核心集群跨云跨机房
&lt;/h4>&lt;p>读多写少全局写入集群 储存核心数据 至少3主三从分散部署到 三云三城市。&lt;br>
核心数据主要用于储存一些增长缓慢但是读取频繁的数据。例如 用户信息 物联网设备配置信息等。&lt;br>
为了防止频繁跨云读取，应用层需要针对性的做一些改造，针对读写非常频繁的数据，本地机房应该开一个redis实例来缓存核心集群的数据降低核心集群压力。&lt;br>
1、应用层在启动的时候从redis按需要读取数据到本地全局map，并在每次处理请求的时候或者用定时器/消息订阅等方式来判断是否需要重新从redis读取数据。&lt;br>
2、对读取非常频繁的数据，需要在本机机房搭建一个redis实例用来作为核心集群的从库，核心集群的部分数据，降低核心集群压力，并降低核心集群公网通讯开支。&lt;br>
3、应用层在写入数据的是，需要按需判断本地redis同步库是否已经同步成功。&lt;/p>
&lt;h4 id="机房内部缓存">机房内部缓存
&lt;/h4>&lt;h5 id="读缓存">读缓存
&lt;/h5>&lt;p>上文已经提到，机房内应该增加至少一个redis实例或者集群，用来作为核心集群的从库，作为本地部分数据的读取使用。以降低核心集群的公网通讯开支。&lt;br>
一致性要求非常高的数据，依旧是从核心集群读取。&lt;/p>
&lt;h5 id="写缓存的实现">写缓存的实现
&lt;/h5>&lt;p>一致性要求不高的数据，写入到本地的redis集群，并安需定时同步到核心集群。例如：设备的在线状态和传感器数据（容许1-2秒延迟，故障时容许10-15秒延迟）&lt;br>
需要落地持久化的数据，并容许短时间丢失的数据（设备传感器的历史数据容许丢失3-5分钟的）先写入到本地的keydb 开启flash持久化，并定时同步flash文件和rdb aof文件到 本云的对象储存（因为数据庞大，后文针对此方案做了进一步优化降低开支）。
一致性要求高的数据，直接写入到核心集群。&lt;/p>
&lt;h4 id="redis同步">redis同步
&lt;/h4>&lt;p>除了redis cluster之外使用阿里的RedisShake来做单向同步。&lt;/p>
&lt;h4 id="pgsql">pgsql
&lt;/h4>&lt;h3 id="时序数据kv持久化储存">时序数据/kv持久化储存
&lt;/h3>&lt;h4 id="实现">实现
&lt;/h4>&lt;p>项目以写为主，读取较少，所以这里直接使用keydb替代redis。同时部署多个集群来作为纯redis 和kv硬盘储存使用。&lt;br>
没有引入时序数据库，是因为数量没有那么庞大，keddb的flash方案可以满足。&lt;/p>
&lt;h4 id="容灾和数据合并">容灾和数据合并
&lt;/h4>&lt;h5 id="数据合并">数据合并
&lt;/h5>&lt;p>因为此项目的这部分数据都是基于设备或用户的，所以同一个设备和同一个数据的历史数据可以合并到同一个key里面 以减少RocksDB（keydb的flash功能基于RocksDB）的小文件数量降低对象储存成本。&lt;br>
通过k8s/swarm 在阿里云和腾讯云分别 分别部署一个实例。两个实例先查询本地要处理的数据量，并协商以数据量较多的为主实例。两个实例分别合并前一天的历史数据到数组/map ，主实例在处理的时候询问从实例是否有同一个设备/用户的数据，如果有数据交付给主实例处理。如果没有从实例自己处理。 阿里云走内网数据持久到oss 腾讯云云走内网数据持久化到cos。另外一台不限制带宽的服务器同步合并两家对象储存数据保持一致。&lt;br>
查询的时候，当日数据从keydb查询，前一日数据从对象储存查询。&lt;/p>
&lt;h2 id="负载均衡和历史数据的处理">负载均衡和历史数据的处理
&lt;/h2>&lt;h3 id="设备和app的负载均衡">设备和app的负载均衡
&lt;/h3>&lt;p>设备实时数据 接受的应用层 分别部署到阿里云和腾讯云的多台机器上，由客户端先询问服务上的入口应用程序自己应该请求那台服务，并在一定周期内（未断电重启）持续请求这台服务。如果对应的机器负载较大，会通知客户端更换一个别的地址，或者地址连不同的时候客户端也会更换一个地址。（用户的app同样的规则）&lt;/p>
&lt;h3 id="数据的储存">数据的储存
&lt;/h3>&lt;h4 id="实时数据">实时数据
&lt;/h4>&lt;p>因为容许部分数据丢失，所以实时数据由对应的devConn服务直接储存到map，而不写入redis。用户端app在查询的时候，会先根据核心redis的从库中的对应设备的记录获取对应设备的服务器地址，直接查询map.&lt;/p>
&lt;h4 id="历史数据">历史数据
&lt;/h4>&lt;p>实时数据需要及时落盘，容许丢失一小部分，但是不能产生大量碎文件，不然会导致后续储存费用太高。&lt;br>
为了降低io,由devConn自己处理储存问题。储存后如何同步到云储存参考上文。&lt;/p>
&lt;h2 id="其他">其他
&lt;/h2>&lt;p>推荐阅读 &lt;a class="link" href="http://kaito-kidd.com/2021/10/15/what-is-the-multi-site-high-availability-design/" target="_blank" rel="noopener"
>http://kaito-kidd.com/2021/10/15/what-is-the-multi-site-high-availability-design/&lt;/a>&lt;/p></description></item><item><title>关于跨云部署的一些思路和困扰</title><link>https://dev.leiyanhui.com/web/clouds-migrate/</link><pubDate>Wed, 15 Nov 2023 01:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/clouds-migrate/</guid><description>&lt;p>阿里云在这次（2023年11月12日）大规模故障时间中，可以说给所有人迎头一击。&lt;br>
得益处这些年遇到的太多灾难，我们在业务开展初期就考虑到了跨地区跨机房跨云跨域名跨dns跨主体,但是依旧有部分业务被影响。&lt;/p>
&lt;h2 id="各种跨的必要性和方案">各种跨的必要性和方案
&lt;/h2>&lt;h3 id="跨云厂商">跨云厂商
&lt;/h3>&lt;p>必要性这个不用说了，这次事情都知道了。&lt;br>
一般情况下，核心业务最好一律跨厂商多活部署。&lt;br>
尤其是是核心数据 在隐藏好ip的情况下（能上ipv6一定上ipv6）,公网加密主从同步自动切换是必须的。&lt;br>
对于redis数据库来说来Cluster是一开始就要准备的&lt;/p>
&lt;h3 id="跨地区和机房">跨地区和机房
&lt;/h3>&lt;p>在同一家云厂商，尽量跨地区/机房部署多活部署。&lt;/p>
&lt;h3 id="跨域名跨dns">跨域名跨dns
&lt;/h3>&lt;p>数年前的dnspod时间不知道还有人记得吗？&lt;br>
域名被暂停解析不知道有多少人遇到过，数年前更有人遇到域名过户/转移等奇葩事件。&lt;br>
所以 除非是网站的网址，其他地方一定有多个域名&lt;br>
另外域名的dns不要只使用一家的&lt;/p>
&lt;h3 id="跨主体">跨主体
&lt;/h3>&lt;p>因为国内目前的政策因素，即便是你合法合规的运营，能100%确定自己不会遇到备案吊销域名暂停解析。单一主体依旧存在风险。&lt;br>
因为备案制度，任何人都可以查到你公司或者个人名下的所有域名，进一步拿到你部分api地址，更是可以直接看到你域名dns地址（dns一锅端也是可以的）。&lt;/p>
&lt;h3 id="关于无状态服务">关于无状态服务
&lt;/h3>&lt;p>微服务在规划的时候，注意能无状态服务的就用无状态的。&lt;/p>
&lt;h3 id="和域名相关的">和域名相关的
&lt;/h3>&lt;h4 id="用谁的域名">用谁的域名
&lt;/h4>&lt;p>如果不会产生额外的费用，并且接口地址你可以随时更换的的情况下，尽量用云厂商送的域名（例如阿里云函数计算的http触发器域名）。&lt;br>
因为云厂商的域名dns防护程度都比较高，免费的在某些时候比你花钱的更好。&lt;br>
当然如果你没有办法随时切换接口的地址，那么还是用自己有控制权的域名。&lt;/p>
&lt;h4 id="泛域名">泛域名
&lt;/h4>&lt;p>对于可以捆绑域名的http类业务，泛域名解析虽然不能避免解析记录泄露，但是可以避免通过域名dns历史解析记录拿到接口绑定的hostname。而且这个操作并不麻烦。&lt;br>
例如你 一个 接口 为 &lt;a class="link" href="http://usercenter-aliyun.leiyanhui.com" target="_blank" rel="noopener"
>http://usercenter-aliyun.leiyanhui.com&lt;/a> ，原来cname或者A记录 usercenter-aliyun，之需要修改为 *.usercenter-aliyun 同时在业务上绑定的域名修改为 &lt;a class="link" href="http://run1.usercenter-aliyun.leiyanhui.com" target="_blank" rel="noopener"
>http://run1.usercenter-aliyun.leiyanhui.com&lt;/a>（不要绑定泛域名） 如果发生针对这个地址的一些攻击，去业务那边修改为 &lt;a class="link" href="http://run2.usercenter-aliyun.leiyanhui.com" target="_blank" rel="noopener"
>http://run2.usercenter-aliyun.leiyanhui.com&lt;/a> 即可临时规避一下&lt;/p>
&lt;h2 id="关于entrypoint">关于entrypoint
&lt;/h2>&lt;p>这里定义的项目的entrypoint 主要是面向客户端的（app/物联网设备/html内的api）。即客户端需要先连接entrypoint查询后端api接口，再连接api处理后续工作。&lt;/p>
&lt;p>entrypoint应该跨云跨域名跨主体部署 。 相关业务在运行中或如果和其他业务通信故障，去这些地址里面查询可用的节点。&lt;/p>
&lt;p>比较经典的例子，比如一般情况 app的后端api地址为 &lt;a class="link" href="http://api.app.com" target="_blank" rel="noopener"
>http://api.app.com&lt;/a> ，一般可能还会预留一个 &lt;a class="link" href="http://api2.app.com" target="_blank" rel="noopener"
>http://api2.app.com&lt;/a> 作为备用地址。&lt;/p>
&lt;p>修改后的方案为&lt;/p>
&lt;p>app应该 &lt;a class="link" href="http://entrypoint1.url.com" target="_blank" rel="noopener"
>http://entrypoint1.url.com&lt;/a> &lt;a class="link" href="http://entrypoint.url2.com" target="_blank" rel="noopener"
>http://entrypoint.url2.com&lt;/a> &lt;a class="link" href="http://entrypoint.url3.com" target="_blank" rel="noopener"
>http://entrypoint.url3.com&lt;/a> &lt;a class="link" href="http://entrypoint.urlNNN.com" target="_blank" rel="noopener"
>http://entrypoint.urlNNN.com&lt;/a> 等多个地址并发查询 a 通过上面的entrypoint返回的 api地址，再继续操作。&lt;/p>
&lt;p>entrypoint 虽然多地跨云跨域名甚至跨主体部署，但是因为只是一个简单的json静态文件服务器，甚至可以部署到cdn，以及servless 所以维护成本很低。&lt;/p>
&lt;p>另外 entrypoint的地址，最好其中有预留1-3个云厂商/大厂的域名，例如 阿里云的 函数计算 的url， 以及 各个云厂商的对象储存的文件访问地址，因为他们的域名都做好了dns防护，可用性要比我们的dns高很多。 为了节省开支放置servless和对象储存被刷，平时禁止访问即可，在需要的时候开启允许公网访问即可。&lt;br>
不过华为云函数计算就算了，他给的域名公网访问次数限制1000次/天&lt;/p>
&lt;h2 id="困扰">困扰
&lt;/h2>&lt;p>跨云部署最大的困扰 就是 成本，带宽占用 服务器闲置 管理成本。&lt;br>
尤其是大量数据 在 公网上加密同步。。。&lt;/p></description></item><item><title>传统项目上serverless 函数计算的 初步说明</title><link>https://dev.leiyanhui.com/web/up-serverless/</link><pubDate>Mon, 13 Nov 2023 00:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/up-serverless/</guid><description>&lt;p>项目逐步切换到golang后 部分项目想逐步迁移到serverless。但是第一次折腾 遇到一些问题，而文档很乱看的云里雾里。慢慢解决后，这里简单记录一下。&lt;/p>
&lt;p>下文主要是以aliyun为例&lt;/p>
&lt;h2 id="传统迁移serverless的几个注意点">传统迁移serverless的几个注意点
&lt;/h2>&lt;h3 id="关于脱离对云厂商的依赖">关于脱离对云厂商的依赖
&lt;/h3>&lt;p>之前以为必须要引入厂商的sdk才可以，后来发现 多数云厂商已经不需要。&lt;/p>
&lt;h3 id="关于冻结">关于冻结
&lt;/h3>&lt;p>在处理完成一个事件后（http请求、定时器、消息等），整个进程都会被冻结。直到下次事件执行。&lt;br>
这也是所谓的无状态服务，也会同时导致，你没有完成的协程被冻结！&lt;/p>
&lt;h3 id="关于http类程序">关于http类程序
&lt;/h3>&lt;p>可以直接用http事件触发，大概就是函数计算 算是一个nginx,转发客户请求到到你的后端程序(http://:9000)。
这里需要注意的是，函数计算会附加一些header信息大概有1.5k的数据过来，除了前置网关没有办法关闭这些信息。&lt;br>
如果你和我一样私有协议并严格限制了信息长度， 这里是一个小坑。&lt;/p>
&lt;h3 id="关于非http类程序">关于非http类程序
&lt;/h3>&lt;p>比如 定时器触发的一个功能。我之前理解以为 定时器事件触发 我们的程序，然后执行完成程序推出，资源回收/冻结。&lt;br>
期间遇到 code 0的坑，也出现程序一直被多次反复不按照预期的执行。 在阿里云售后群和发工单后依旧没有头绪。&lt;br>
最后才弄明白，针对这类应用，阿里云有两种处理方式：任务处理函数 和 服务&amp;gt;函数。而我主要用的区域是阿里云的华北1青岛，不支持任务处理函数，也没注意到这点。所以我看的文档是任务处理函数，但是却在服务&amp;gt;函数里面 调试的&amp;hellip;.&lt;/p>
&lt;h4 id="任务处理函数">任务处理函数
&lt;/h4>&lt;p>&lt;a class="link" href="https://fcnext.console.aliyun.com/cn-" target="_blank" rel="noopener"
>https://fcnext.console.aliyun.com/cn-&lt;/a>区域/tasks&lt;br>
如果采用docker部署，我们的程序在正常执行完成后 进程 exit 0 即可。&lt;/p>
&lt;blockquote>
&lt;p>阿里云官网提示: 在使用非 Web Server 模式时，成功处理完请求后，您需要主动退出进程，并且 ExitCode 需要为 0。此外，请求的“事件参数”会以环境变量 FC_CUSTOM_CONTAINER_EVENT 的形式传递给函数。&lt;/p>&lt;/blockquote>
&lt;p>而任务处理函数，又分为 运行时和docker两种方案。这里特指docker方案。运行时方案我没有尝试，但是看起来和服务函数的差距不大。&lt;/p>
&lt;h4 id="服务函数">服务函数
&lt;/h4>&lt;p>&lt;a class="link" href="https://fcnext.console.aliyun.com/cn-" target="_blank" rel="noopener"
>https://fcnext.console.aliyun.com/cn-&lt;/a>区域/services &lt;br>
这里依旧是 需要开httpserver响应/invoke 路径的post&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/invoke&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//这里处理 业务功能&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Hello 定时器&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:9000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="两者的区别">两者的区别
&lt;/h4>&lt;p>个人体验后看法，如果不想改动代码，你原来的程序就是执行完成后自动推出的。那么就用 任务处理函数。 &lt;br>
如果你方便修改代码 而且 你程序在初始化的时候 需要进行一些消耗性能的操作，那么尽量迁移到服务模式。&lt;br>
另外一点 ：服务模式的函数，如果你请求频繁，比如 定时器事件 1分钟 执行一次，那么，你的实例基本不会被释放。虽然闲置cpu不计费，但是你还需要为内存买单。在咨询阿里云技术后得知，你需要为整个实例的内存（最小128m）买单。&lt;br>
这是和任务处理函数 的一个很大的区别。&lt;/p>
&lt;h3 id="关于消息订阅">关于消息订阅
&lt;/h3>&lt;p>基本上是没法用了。暂时不知道怎么处理。&lt;br>
一些简单实时性要求不高的数据更新，可以在每次响应http的时候 检查上次执行时间然后再从数据库/oss/nas复查的方式。&lt;/p>
&lt;h3 id="关于异步的协程">关于异步的协程
&lt;/h3>&lt;p>暂时只能由http唤起，然后等协程执行完成后再fmt.Fprintf(w,&amp;quot;&amp;quot;) 回去&lt;/p>
&lt;h2 id="关于阿里云的fc-30">关于阿里云的fc 3.0
&lt;/h2>&lt;p>3.0去掉了服务的概念，只剩下 应用和函数 两个概念。应用 没研究，应该是需要绑定云厂商。 &lt;br>
函数 对应之前的 服务函数，概念变为： 事件函数 web函数 docker镜像（青岛地区不支持，其他地区不清楚）。 &lt;br>
我目前只测试成功了他的web函数方式，我自己上传zip包的方法。docker方式，因为我们的docker目前都在青岛地区，所以无从测试。关于3.0的事件函数 因为我没有打算引入阿里云的sdk,按照http server /invoke 的方式没测试成功。&lt;br>
然后在2.0 里面的 自定义运行时的任务函数概念 好像取消了。&lt;br>
同时他的web函数方式，兼容 httpserver 的 /invoke 模式。不过他会自动创建一个http触发器，自己去关闭即可。&lt;br>
但&lt;/p>
&lt;h3 id="关于30带来的好处">关于3.0带来的好处
&lt;/h3>&lt;ul>
&lt;li>关于3.0 目前感觉最大的好处就是 可以用 其他事件 + http的方式触发 。例如：&lt;br>
定时器1小时运行一次 /invoke ，然后我们需要强制运行的时候，可以外部访问 http://url//invoke?token=jwt的方式来主动触发。&lt;/li>
&lt;li>可以单独为一个函数关闭日志。阿里云的日志服务是要钱的&lt;/li>
&lt;/ul>
&lt;h3 id="关于其他厂商">关于其他厂商
&lt;/h3>&lt;p>aws 那边没有弄明白，腾讯这个和阿里云相差不大，但是腾讯那边有月租费，但是不打算花时间和精力去测试。&lt;br>
Azure 那边支持有状态服务，没有仔细去看。&lt;/p>
&lt;p>而华为云这边，貌似事件/触发器函数 必须要引入华为的sdk,http类的 强制入口文件 是bootstrap 貌似是一个类似shell的脚本。
虽然如此，不过可以用内置的nodejs py等方式配置事件函数，然后在时间函数中去curl（带token） 另外一个http的函数来实现不引用sdk的方式实现事件函数. 同时 阿里云那边支持 jwt认证，而华为这边是 Appkey&amp;amp;Appsecret 认证。&lt;/p>
&lt;p>另外华为云这边事件函数的 需要&lt;br>
响应 curl -sS -LD &amp;ldquo;$HEADERS&amp;rdquo; -X GET &amp;ldquo;http://$RUNTIME_API_ADDR/v1/runtime/invocation/request&lt;br>
返回 curl -X POST &amp;ldquo;http://$RUNTIME_API_ADDR/v1/runtime/invocation/response/$REQUEST_ID&amp;rdquo; -d &amp;ldquo;$RESPONSE&amp;rdquo;
华为有给出实例 &lt;a class="link" href="https://support.huaweicloud.com/usermanual-functiongraph/functiongraph_01_0406.html#section4" target="_blank" rel="noopener"
>https://support.huaweicloud.com/usermanual-functiongraph/functiongraph_01_0406.html#section4&lt;/a>
最方便的无痛迁移方式，就是直接用华为给的实例代码 一次性运行 ,不然就要在原始代码中二次修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">cat &amp;gt;bootstrap&lt;span class="s">&amp;lt;&amp;lt; \EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">set -o pipefail
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">while true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">do
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> HEADERS=&amp;#34;$(mktemp)&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> EVENT_DATA=$(curl -sS -LD &amp;#34;$HEADERS&amp;#34; -X GET &amp;#34;http://$RUNTIME_API_ADDR/v1/runtime/invocation/request&amp;#34;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> REQUEST_ID=$(grep -Fi x-cff-request-id &amp;#34;$HEADERS&amp;#34; | tr -d &amp;#39;[:space:]&amp;#39; | cut -d: -f2)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> if [ -z &amp;#34;$REQUEST_ID&amp;#34; ]; then
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> continue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> fi
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> $RUNTIME_CODE_ROOT/你的golang编译后的可执行文件
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> RESPONSE=&amp;#34;Echoing request: &amp;#39;$EVENT_DATA&amp;#39;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> curl -sS -X POST &amp;#34;http://$RUNTIME_API_ADDR/v1/runtime/invocation/response/$REQUEST_ID&amp;#34; -d &amp;#34;$RESPONSE&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">done
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="关于接口被刷的问题">关于接口被刷的问题
&lt;/h2>&lt;h3 id="弹性伸缩限制规则">弹性伸缩限制规则
&lt;/h3>&lt;p>可以设置上限，并通过报警规则处理。&lt;/p>
&lt;h3 id="被ddos-cc">被ddos cc
&lt;/h3>&lt;p>短期jwt 最简单，jwt失败的好像不会计费。 &lt;br>
但是负责分发的jwt的服务依旧存在风险。&lt;/p>
&lt;h2 id="什么业务适合上serverless">什么业务适合上serverless
&lt;/h2>&lt;p>一句话主要是 边缘微服务 其次一些比较特殊的。可以达到省钱 省精力 高可用性目的情况下才适合切换&lt;/p>
&lt;ul>
&lt;li>一定是一些非核心的业务并且不把sevless作为主服务：云也大面积宕机&lt;/li>
&lt;li>一些会不定期占用大量资源的业务，免得影响主业务&lt;/li>
&lt;li>代码迭代不是很频繁的业务：函数计算调试困难，日志分析功能非常依赖云厂商&lt;/li>
&lt;li>某些对实时性要求不高的异步业务： 常见的比如邮件发送、数据库整理 等&lt;/li>
&lt;li>核心业务主服务器的备用节点： 主服务器全部宕机的情况下可以临时顶上，这算是最大的诱惑了。毕竟平时不用维护&lt;/li>
&lt;li>监控类业务：比如定时监控各个服务的状态，自动处理或者报警&lt;/li>
&lt;li>其他一些特殊的，平时没访问量的：例如，企业网站的cdn回源端&lt;/li>
&lt;li>线上临时使用的GPU业务&lt;/li>
&lt;li>其他一些需要临时线上执行但是可能会影响自己的服务器资源占用或者会导致管理混乱的&lt;/li>
&lt;li>不想暴露自己的域名和ip等信息的业务，可以用函数计算的http触发器的域名和证书&lt;/li>
&lt;/ul>
&lt;h3 id="我目前适合迁移的">我目前适合迁移的
&lt;/h3>&lt;ul>
&lt;li>入口文件自动部署： 自动检索所有api节点，创建json文件分发到cdn 供物联网设备端和app搜索可以用节点&lt;/li>
&lt;li>物联网设备上线离线检测功能：这个请求数和并发都不低，可用性要求极高，但是带宽占用非常低，serverless这边做备用节点。&lt;/li>
&lt;li>物联网设备的历史数据上报功能：并发不高，可用性要求不高，但是带宽占用有一些，serverless这边依旧是 备用节点。&lt;/li>
&lt;li>app段的接口： 并发和带宽都不高，可用性要求高，servless这边依旧是备用节点。&lt;/li>
&lt;/ul>
&lt;h3 id="完全不适合迁移servless">完全不适合迁移servless
&lt;/h3>&lt;ul>
&lt;li>平台管理类：这个只能内网访问，部署到servless没太大意义&lt;/li>
&lt;li>消息队列服务：不适合，但是部分实时性要求不高的可以简单修改一下逻辑用servless处理。&lt;/li>
&lt;li>&lt;/li>
&lt;/ul>
&lt;h2 id="部署方式">部署方式
&lt;/h2>&lt;p>nodejs python 之类的都是可以在线编辑在线部署的，go java rust之类的就只能上传二进制或者docker。&lt;br>
当然 go 因为编译速度飞快 非生产部署 也可以 用 go run 。&lt;br>
亚马逊那边 貌似不支持 zip和文件夹上传的方式部署，只能在线编辑和docker部署。&lt;/p>
&lt;h2 id="一些有趣的想法">一些有趣的想法
&lt;/h2>&lt;h3 id="gitea-等-web为主的应用">gitea 等 web为主的应用
&lt;/h3>&lt;p>之前看到有人在serverless 部署gitea,数据持久化问题好解决，但是gitea实际上是有很多后台任务需要执行的。&lt;br>
注意到 弹性伸缩限制规则 里面可以配置某一个时段保活一个实例，好像就可以解决一部分情况了。&lt;br>
不过 数据每次传输量不能超过32M&lt;/p>
&lt;h3 id="对象储存转webdav">对象储存转webdav
&lt;/h3>&lt;p>同上&lt;/p>
&lt;h3 id="私有化-bitwarden">私有化 bitwarden
&lt;/h3>&lt;p>同上&lt;/p>
&lt;h2 id="对云厂商以及serverless的一些看法">对云厂商以及serverless的一些看法
&lt;/h2>&lt;h3 id="跨云部署">跨云部署
&lt;/h3>&lt;p>在我调试期间 再次遇到 阿里云大面积宕机事件（2023-12-12），控制面板无法登出(2023-11-14) 腾讯云那边也不是一次两次出问题，所以跨云部署已经是必不可少的方案。&lt;/p>
&lt;h3 id="serverless和云厂商的绑定">serverless和云厂商的绑定
&lt;/h3>&lt;p>而传统的servless 对云厂商深度绑定，只是近几年开始有一些内卷，已经可以二进制或docker 不修改任何代码直接部署，所以如果可以尽量不绑定云厂商的sdk以及相关业务的的情况下，可以跨云部署一些函数上去。&lt;/p></description></item><item><title>firefox自定义搜索引擎</title><link>https://dev.leiyanhui.com/web/firefox-search-diy/</link><pubDate>Fri, 10 Nov 2023 20:40:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/firefox-search-diy/</guid><description>&lt;p>firefox的新版本目前已经不支持自定义任意搜索引擎，即 自定义 https://url?keyword={关键词} 这种格式。 而 chrome和edge都可以灵活自定义。&lt;/p>
&lt;p>firefox 旧版本是支持的，但是知道什么时候 更新后就不支持了。只能用插件方式安装，但是插件是支持的搜索引擎就那么几个也不是我们常用需要自定义的。&lt;/p>
&lt;p>找到一个曲线解决方法。 利用firefox的地址栏可以搜索书签 以及 书签可以定义关键词的功能。&lt;/p>
&lt;p>以bing 换到cn.bing.com为例，firefox默认是调用 &lt;a class="link" href="https://www.bing.com" target="_blank" rel="noopener"
>www.bing.com&lt;/a> 在某些环境中很卡。&lt;/p>
&lt;p>网址如下： &lt;a class="link" href="https://cn.bing.com/search?q=111" target="_blank" rel="noopener"
>https://cn.bing.com/search?q=111&lt;/a>&lt;/p>
&lt;p>把这个地址添加到书签，名称随意，地址修改为 &lt;a class="link" href="https://cn.bing.com/search?q=%25s" target="_blank" rel="noopener"
>https://cn.bing.com/search?q=%s&lt;/a> 关键词输入 cnbing（和其他的不冲突即可）&lt;/p>
&lt;p>然后地址栏输入 cnbing+空格+关键词 即可调用cn.bing.com 搜索对应关键词&lt;/p>
&lt;p>同样可以添加 github 个人博客 等等 所有支持get方式的搜索&lt;/p>
&lt;p>这个方案的缺点是 没法省略前面的关键词和空格 作为默认搜索引擎使用。&lt;/p>
&lt;p>吐槽：
firefox 真的能砍，砍掉了渐变app（webapp）又砍自定义搜索引擎，如果不是因为他在linux下支持硬解，真的够够的的。&lt;/p>
&lt;p>edge的linux版本的垂直标签功能已经非常完善，不经常在线看视频的话，早点离开吧。&lt;/p>
&lt;p>附：&lt;br>
跨浏览器 跨设备同步书签和密码插件推荐：&lt;/p>
&lt;ul>
&lt;li>floccus（需要一个webdav同步 可以用nas或者坚果云）&lt;/li>
&lt;li>bitwarden （可以自建服务端，全平台可用 ios端为数不多的体验不错的密码管理器）&lt;/li>
&lt;/ul></description></item><item><title>自签名证书的使用，以及辟谣：自签名证书其实非常安全，但是需要你处理好客户端信任的问题</title><link>https://dev.leiyanhui.com/web/ssl/</link><pubDate>Tue, 12 Sep 2023 08:30:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/ssl/</guid><description>&lt;h2 id="安全性">安全性
&lt;/h2>&lt;p>简中很多文章说自签名证书不安全，这要看你怎么用。&lt;/p>
&lt;p>如果你是搭建面向公众的服务，例如网站 那么肯定不够安全的。 这是因为 普通用户无法通过简单并安全的方法验证你的证书是否真的是你的。因为没有权威ca存在了。&lt;/p>
&lt;p>而如果是面向内部使用的，我们可以通过权威ca 或者 其他加密途径分发证书。或者通过证书指纹验证的方法来确保安全。&lt;/p>
&lt;p>当然指纹验证严格说 也不够安全，虽然指纹被伪造的可能性也几乎没有。&lt;/p>
&lt;p>我们只要 保证 证书分发的过程是安全的，那么自签名证书的安全性 甚至可以超过 可信ca颁发的证书（参考我朝某衙）。&lt;/p>
&lt;h2 id="碎碎念">碎碎念
&lt;/h2>&lt;p>ca机构运营是有成本的，所有权威证书需要付费无可厚非。但是自签证书并非不安全，资本的文章看看就好，多读书。&lt;br>
同样类似 ssh协议，默认情况下，和自签名证书的过程其实并无差距。那么ssh不安全吗？&lt;/p>
&lt;h2 id="自签名证书的优点">自签名证书的优点
&lt;/h2>&lt;ul>
&lt;li>和商业收费证书同样安全性，某些方便甚至超过收费证书&lt;/li>
&lt;li>可以灵活控制有效期，例如在某些特殊情况下，需要超长的有效期&lt;/li>
&lt;li>自主可控&lt;/li>
&lt;li>可以省略OCSP服务，速度会更快&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>OCSP 主要是方便检查证书是否有效的情况，也就是可以吊销掉已经签发出去的证书。但是OCSP会多了一个网络验证的操作，这也是某些在国内没有OCSP服务器的一些商业证书速度很慢的 原因。&lt;/p>&lt;/blockquote>
&lt;h2 id="自签名ca和域名ip证书的过程">自签名ca和域名/ip证书的过程
&lt;/h2>&lt;p>下面一个简单说一下，自己用openssl实现 自己的ca 并签发证书的过程&lt;/p>
&lt;h3 id="ca">ca
&lt;/h3>&lt;p>CA私钥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">openssl genpkey -algorithm RSA -out ca_private.key
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>CA请求文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">openssl req -new -key ca_private.key -out ca_request.csr
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>CA证书&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">openssl x509 -req -in ca_request.csr -signkey ca_private.key -out ca_certificate.crt -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="用ca签发证书">用ca签发证书
&lt;/h3>&lt;h4 id="生成域名-私钥和-证书请求文件">生成域名 私钥和 证书请求文件：
&lt;/h4>&lt;p>openssl genpkey -algorithm RSA -out domain_private.key
openssl req -new -key domain_private.key -out domain_request.csr&lt;/p>
&lt;h4 id="从ca证书-签发证书">从ca证书 签发证书
&lt;/h4>&lt;p>简单创建 一个 10年的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">openssl x509 -req -in domain_request.csr -CA ca_certificate.crt -CAkey ca_private.key -CAcreateserial -out domain_certificate.crt -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>但是这个证书里面没有域名，客户端依旧会伪造，创建一个包含域名的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">openssl x509 -req -in domain_request.csr -CA ca_certificate.crt -CAkey ca_private.key -CAcreateserial -out domain_certificate.crt -days &lt;span class="m">3650&lt;/span> -extfile &amp;lt;&lt;span class="o">(&lt;/span>&lt;span class="nb">printf&lt;/span> &lt;span class="s2">&amp;#34;subjectAltName=DNS:*.leiyanhui.com,DNS:leiyanhui.com,DNS:*.baidu.com,DNS:baidu.com&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="创建一个包含域名和ip范围的">创建一个包含域名和ip范围的
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IP_LIST&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(for&lt;/span> i in &lt;span class="o">{&lt;/span>1..254&lt;span class="o">}&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> -n &lt;span class="s2">&amp;#34;IP:10.1.1.&lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2">,&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span> &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;s/,$//&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="c1"># ip 10.1.1.1-10.1.1.254&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl x509 -req -in domain_request.csr -CA ca_certificate.crt -CAkey ca_private.key -CAcreateserial -out domain_certificate.crt -days &lt;span class="m">3650&lt;/span> -extfile &amp;lt;&lt;span class="o">(&lt;/span>&lt;span class="nb">printf&lt;/span> &lt;span class="s2">&amp;#34;subjectAltName=DNS:*.leiyanhui.com,DNS:*.shiyuxin.work,&lt;/span>&lt;span class="nv">$IP_LIST&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="域名私钥和证书合并到一个-pem">域名私钥和证书合并到一个 .pem
&lt;/h3>&lt;p>有部分软件是使用的 all in one的 pem格式，例如monit&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cat domain_private.key domain_certificate.crt &amp;gt; domain_aio.pem
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="客户端应该如何信任">客户端应该如何信任
&lt;/h3>&lt;p>上面命令中的 ca_certificate.crt 和 domain_certificate.crt 都是包含公钥的证书文件，服务器会自动分发给客户端。但是这个过程是无法保证安全的。&lt;/p>
&lt;p>那么 这个两个文件，可以通过其他可信的途径分发给客户端。 例如： 可信ca的 https webdav email 甚至vpn 线下 内网 等方式&lt;/p>
&lt;p>一般情况下，建议客户端信任 ca_certificate.crt 即可。那么所有使用 ca_certificate.crt 签发的证书，只要ip/域名 能对应 客户端就会认为是安全的。&lt;/p>
&lt;p>如果只是信任 domain_certificate.crt 的话，那么自己的ca证书签发的别的证书就无法可信了。这个很好理解。&lt;/p>
&lt;h3 id="那些文件是可以公开的">那些文件是可以公开的
&lt;/h3>&lt;p>只有 ca_certificate.crt 和 domain_certificate.crt 这两个文件 可以公开的。其他文件务必妥善保管。
尤其是 ca_private.key 这个文件，如果泄漏 就等于 天朝某衙门作恶了。&lt;/p></description></item><item><title>redis 整个集群导出到json的方法</title><link>https://dev.leiyanhui.com/web/redis-dump/</link><pubDate>Wed, 16 Aug 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/redis-dump/</guid><description>&lt;p>有时候 我们的集群可能只是为了高可用，数据并不是那么大，那么可以不用aof rdp 直接导出虽然慢一些但是json可能更直观&lt;/p>
&lt;p>redis-dump 不好用，所以为 自己写了一个 ： &lt;a class="link" href="https://dev.leiyanhui.com/mq/redis-json/" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/mq/redis-json/&lt;/a>&lt;/p>
&lt;h1 id="安装">安装
&lt;/h1>&lt;p>基于debian12&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo apt install ruby ruby-dev gcc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo gem install redis-dump
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="确定节点分别情况">确定节点分别情况
&lt;/h1>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">CLUSTER NODES
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="暂停你redis的写入业务">暂停你redis的写入业务
&lt;/h1>&lt;p>或者你容许部分丢失的话，也无所谓&lt;/p>
&lt;h1 id="分别导出每一个节点的数据">分别导出每一个节点的数据
&lt;/h1>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">redis-dump -u:ut97WiD9SvUQtJ@127.0.0.1:6001 &amp;gt; /tmp/6001.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-dump -u:ut97WiD9SvUQtJ@127.0.0.1:6001 -d 0 &amp;gt; 6001.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-dump -u:ut97WiD9SvUQtJ@127.0.0.1:6002 -d 0 &amp;gt; 6002.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-dump -u:ut97WiD9SvUQtJ@127.0.0.1:6003 -d 0 &amp;gt; 6003.json
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果运行的时候出错，可能需要安装rvm和新版ruby。或者直接用docker版的&lt;/p>
&lt;p>所以 。。。可能直接 scp 回来更方便&lt;/p></description></item><item><title>firefox火狐浏览器隐藏顶部标签/标题栏：windows/linux/flatpak</title><link>https://dev.leiyanhui.com/web/firefox-hidden-top-tab/</link><pubDate>Wed, 05 Jul 2023 00:15:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/firefox-hidden-top-tab/</guid><description>&lt;p>在使用树状标签后，屏幕顶部横向的标签就无用了，可以考虑隐藏掉。&lt;/p>
&lt;p>我使用了 tree-style-tab/：https://addons.mozilla.org/zh-CN/firefox/addon/tree-style-tab/&lt;/p>
&lt;p>但是和edge不一样的是，这个扩展并不能自动隐藏横向的标签。这就需要我们自己处理。&lt;/p>
&lt;p>火狐支持用css的方式来定义外观，所以我们这里先打开这个功能。&lt;/p>
&lt;h2 id="启用-userchromecss">启用 userChrome.css
&lt;/h2>&lt;p>在火狐地址栏输入&lt;code>about:config&lt;/code>回车，跳过警告信息后，输入 &lt;code>toolkit.legacyUserProfileCustomizations.stylesheets&lt;/code> 设置为 &lt;code>true&lt;/code>&lt;/p>
&lt;h2 id="创建userchromecss">创建userChrome.css
&lt;/h2>&lt;h3 id="查看">查看
&lt;/h3>&lt;p>点击 火狐浏览器 右侧的 &lt;code>三&lt;/code> 点帮助，排除更多故障信息 ，找到 配置文件夹(Profile Folder) 打开目录。 或者地址栏输入&lt;code>about:support&lt;/code>&lt;/p>
&lt;h3 id="常规情况下">常规情况下
&lt;/h3>&lt;p>比如 ，我的目录是 &lt;code>~/.mozilla/firefox/aiqooixw.default-esr&lt;/code>&lt;/p>
&lt;h3 id="windows--portable">Windows portable
&lt;/h3>&lt;p>这个目录在 XXXX\FirefoxPortable\Data\profile\&lt;/p>
&lt;h3 id="在flatpak版本下">在flatpak版本下
&lt;/h3>&lt;p>因为沙盒原理，这个路径可能不存在 可以通过查看这个地址后，然后搜索对应的目录的实际路径。比如我的是&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">find&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="o">/&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="s2">&amp;#34;8wxcq01f.default-release&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="o">/.&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mozilla&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">firefox&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mozilla&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">firefox&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="n">wxcq01f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">default&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="o">/.&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mozilla&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">firefox&lt;/span>&lt;span class="o">/.&lt;/span>&lt;span class="n">mozilla&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">firefox&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="n">wxcq01f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">default&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">release&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>/home/XXXX/.var/app/org.mozilla.firefox/.mozilla/firefox/8wxcq01f.default-release 这个路径就是了&lt;/p>
&lt;h3 id="创建子目录和文件">创建子目录和文件
&lt;/h3>&lt;p>再这个目录下 新建一个文件夹 名字叫做 &lt;code>chrome&lt;/code> ,然后再 chrome目录里面 新建一个css文件名称为&lt;code>userChrome.css&lt;/code>&lt;/p>
&lt;h2 id="userchromecss-文件内容">userChrome.css 文件内容
&lt;/h2>&lt;p>注意，这部分内容要根据你的情况做适当的调整，主要是 &lt;code>/* leftTop drag area */&lt;/code> 这行 以及 &lt;code>#titlebar &lt;/code> 的 margin-bottom 才可以&lt;br>
经过测试，96-130版本均可以实现，我主力用的firefox-esr 115 ，桌面环境是 i3w 下面css内容是我测试正常的。&lt;/p>
&lt;p>在windows11 下只需要把titlebar的 margin-bottom: -0px !important;修改为 margin-bottom: -35px !important; 即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-css" data-lang="css">&lt;span class="line">&lt;span class="cl">&lt;span class="p">#&lt;/span>&lt;span class="nn">main-window&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nd">not&lt;/span>&lt;span class="o">([&lt;/span>&lt;span class="nt">drawtitle&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="o">])&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nd">not&lt;/span>&lt;span class="o">([&lt;/span>&lt;span class="nt">inFullscreen&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="o">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">#&lt;/span>&lt;span class="nn">nav-bar&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-left&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="kt">px&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c">/* leftTop drag area */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">border-right&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">140&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="kc">solid&lt;/span> &lt;span class="nf">var&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">toolbar&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bgcolor&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="nd">root&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="nt">sizemode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;maximized&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">#&lt;/span>&lt;span class="nn">nav-bar&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-top&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c">/* Top drag area */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-left&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c">/* hidden leftTop drag area in Fullscreen mode*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">border-right&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">140&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="kc">solid&lt;/span> &lt;span class="nf">var&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">toolbar&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bgcolor&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="nd">root&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="nt">privatebrowsingmode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;temporary&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">#&lt;/span>&lt;span class="nn">nav-bar&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">border-right&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">180&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="kc">solid&lt;/span> &lt;span class="nf">var&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">toolbar&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">bgcolor&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">/* 主要是修改这里的 margin-bottom 支持负数 例如 margin-bottom: -30px !important; */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">#&lt;/span>&lt;span class="nn">titlebar&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-bottom&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">-0&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">/* move down 3 button on rightTop */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span>&lt;span class="nc">titlebar-buttonbox-container&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-bottom&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">-5&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="nd">root&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="nt">sizemode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;maximized&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">.&lt;/span>&lt;span class="nc">titlebar-buttonbox-container&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-bottom&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">-15&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">/* move down private icon */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span>&lt;span class="nc">private-browsing-indicator&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-bottom&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">-8&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="nd">root&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="nt">sizemode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;maximized&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">.&lt;/span>&lt;span class="nc">private-browsing-indicator&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin-bottom&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">-18&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">/* hidden horizontal tabbar on top */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">#&lt;/span>&lt;span class="nn">tabbrowser-tabs&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="nt">orient&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;horizontal&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">visibility&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">collapse&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">#&lt;/span>&lt;span class="nn">sidebar-box&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="nt">sidebarcommand&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;_0ad88674-2b41-4cfb-99e3-e206c74a0076_-sidebar-action&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">sidebarheader&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">visibility&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">collapse&lt;/span> &lt;span class="cp">!important&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="其他">其他
&lt;/h2>&lt;h3 id="火狐默认快捷键">火狐默认快捷键
&lt;/h3>&lt;p>&lt;a class="link" href="https://support.mozilla.org/zh-CN/kb/%E9%94%AE%E7%9B%98%E5%BF%AB%E6%8D%B7%E9%94%AE" target="_blank" rel="noopener"
>https://support.mozilla.org/zh-CN/kb/%E9%94%AE%E7%9B%98%E5%BF%AB%E6%8D%B7%E9%94%AE&lt;/a>&lt;/p>
&lt;h3 id="windows下protable版设置默认浏览器">windows下protable版设置默认浏览器
&lt;/h3>&lt;p>用PortableRegistrator 这个软件 &lt;a class="link" href="https://github.com/SiL3NC3/PortableRegistrator" target="_blank" rel="noopener"
>https://github.com/SiL3NC3/PortableRegistrator&lt;/a>&lt;/p></description></item><item><title>国内使用 适合重要文件的备份同步</title><link>https://dev.leiyanhui.com/web/free-small-netdisk/</link><pubDate>Thu, 13 Apr 2023 04:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/free-small-netdisk/</guid><description>&lt;p>我们都有一些核心的数据文件，一些可能是配置文件，一些可能是密码文件，或者可能是笔记软件的备份库。 &lt;br>
这部分文件 小的话几M 大的话几个G，自己搭建私有盘或者nas是可以备份，但是这部分文件显然还是需要异地备份的。 &lt;br>
而且需要多平台能用。&lt;/p>
&lt;p>肯定付费的话，肯定是选择 国内云厂商的s3储存，可以用rclone加密备份过去，速度也很理想。&lt;br>
那么免费的怎么选？&lt;/p>
&lt;h2 id="几个免费方案的对比和选">几个免费方案的对比和选
&lt;/h2>&lt;h3 id="坚果云">坚果云
&lt;/h3>&lt;p>看起来很美好，支持webdav 但是流量限制离谱，而且webdav限制也离谱，几乎是无法使用状态。即便是是付费版本速度也很垃圾，webdav照样限制，且不可以退款&lt;/p>
&lt;h3 id="阿里云盘-百度云盘-等">阿里云盘 百度云盘 等
&lt;/h3>&lt;p>可以用alist挂载，但是百度云盘限速离谱 阿里云盘在alist上也不够稳定经常存在掉盘，当我们需要操作这部分文件的时候，发现网盘挂载掉了，这真的还是挺痛苦的事情&lt;/p>
&lt;h3 id="google-drive--dropbox">google drive 、 dropbox
&lt;/h3>&lt;p>很稳定 ，免费容量够用，但是国内需要挂梯子。&lt;/p>
&lt;h3 id="那么">那么？
&lt;/h3>&lt;p>1 &lt;a class="link" href="https://k00.fr/yw6x7c26" target="_blank" rel="noopener"
>koofr&lt;/a> 免费10g 国内速度可以,Koofr网盘 在线管理你的Dropbox、Onedrive、Google Drive 文件，并且支持WebDAV &lt;br>
2 &lt;a class="link" href="https://u.pcloud.com/#page=register&amp;amp;invite=fC6W7ZeJDnNy" target="_blank" rel="noopener"
>pcloud &lt;/a> ，免费8G，国内速度也还凑合&lt;br>
pcloud 优点：&lt;/p>
&lt;ul>
&lt;li>全平台支持&lt;/li>
&lt;li>linux ui支持和 cil支持 ！&lt;/li>
&lt;li>rclone支持&lt;/li>
&lt;li>国内不需要梯子就可以用&lt;/li>
&lt;li>免费容量 8G&lt;/li>
&lt;li>网站有繁体中文，英语不好的小伙伴不用担心&lt;/li>
&lt;li>客户端有文件同步支持，就是尊贵的同步盘功能&lt;br>
缺点：&lt;/li>
&lt;li>免费容量 就8G，再想更大需要邀请人，如果只是备份核心文件的话，其实也够用了&lt;/li>
&lt;li>国内访问速度一般般啦，Ping 218.80ms 下載 93.89Mbps (11.74 MB/s) 上傳 5.80Mbps (0.72 MB/s)小文件备份可以，或者自己科学上网哦&lt;/li>
&lt;/ul>
&lt;h3 id="rclone-挂载说明">rclone 挂载说明
&lt;/h3>&lt;p>rclone新建的pcloud的时候 client_id 和 client_secret 留空即可，然后会打开网页让你授权&lt;br>
最终配置文件格式参考&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[pcloud]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">type = pcloud
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostname = api.pcloud.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">token = {&amp;#34;access_token&amp;#34;:&amp;#34;XXXXXXXXXXXXXXXXXXXX&amp;#34;,&amp;#34;token_type&amp;#34;:&amp;#34;bearer&amp;#34;,&amp;#34;expiry&amp;#34;:&amp;#34;XXXXXXXXXXXX&amp;#34;}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[pcloud-jiami]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">type = crypt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote = pcloud:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">filename_encryption = obfuscate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">directory_name_encryption = false
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">password = XXXXXXXXXXXXXXXX
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rclone lsf pcloud: --config /root/rclone-sh-cfg/rclone.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="补充-cloudflare的r2">补充 cloudflare的r2
&lt;/h3>&lt;p>另外一个推荐是 cloudflare的r2 目前国内没有墙 正常可用，如果被墙了，也可以用自己域名绕过（gwf对cf的业务 目前基本都是墙域名，这几年很少墙ip）
cloudflare的r2 r2 10G储存 每月百万次操作，其他操作限制千万次，单次操作限制 5G流量，流量免费&lt;/p></description></item><item><title>cloudreve 使用几个月的感受</title><link>https://dev.leiyanhui.com/web/cloudreve-bug/</link><pubDate>Tue, 11 Apr 2023 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/cloudreve-bug/</guid><description>&lt;p>cloudreve 是一个真的不错的网盘程序，并且支持webdav哈，虽然ios客户端收费，但是支持webdav的客户端app太多了。不一定非要买。&lt;/p>
&lt;p>尤其是 cloudreve新版支持 onlyoffice后，我开始用他作为主力网盘使用。&lt;/p>
&lt;p>长期使用后发现 他的webui 还是，有一些不方便的地方。&lt;/p>
&lt;h2 id="遗憾">遗憾
&lt;/h2>&lt;ul>
&lt;li>文件预览 没有返回按钮&lt;/li>
&lt;li>无法直接复制文档和目录的路径&lt;/li>
&lt;li>多选功能要点右键&lt;/li>
&lt;/ul>
&lt;h2 id="webdav的问题">webdav的问题
&lt;/h2>&lt;p>在使用kopia 直连cloudreve的时候 出现405错误，暂时没有找到解决方法，临时的方案是通过rclone中转，尚不知有没有问题。&lt;br>
这个问题比较严重，正在考虑了要不要切换到 filerun 或者 nextcloud&lt;/p>
&lt;h2 id="优势">优势
&lt;/h2>&lt;ul>
&lt;li>golang 轻量没啥依赖 高性能&lt;/li>
&lt;li>webdav 账户独立&lt;/li>
&lt;li>对onlyoffice的完美支持&lt;/li>
&lt;li>文档齐全，tg群活跃，作者也经常在tg群出没&lt;/li>
&lt;li>可以和nextcloud一样 保持原目录结构储存文件，迁移方便&lt;/li>
&lt;/ul>
&lt;h2 id="为什么不选其他的">为什么不选其他的
&lt;/h2>&lt;p>nextcloud 基于php 依赖太多了，而且 真的吃性能。但是真的很强大&lt;br>
seafile 丑出天际，webui难用的要死，资源占用比nextcloud好，和cloudreve没法比&lt;br>
其他 试用一圈 要么简陋 要么吃性能&lt;/p>
&lt;h2 id="未来">未来
&lt;/h2>&lt;p>期待作者继续优化webui吧 ，暂时还是用他做主力网盘。&lt;/p></description></item><item><title>国产思源笔记和joplin 对比使用感受</title><link>https://dev.leiyanhui.com/web/siyuan-vs-joplin/</link><pubDate>Tue, 11 Apr 2023 17:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/siyuan-vs-joplin/</guid><description>&lt;p>先说结论，两个都长时间使用过，整体我倾向于思源，目前也是思源。&lt;/p>
&lt;p>202403 已经迁移到 &lt;a class="link" href="https://dev.leiyanhui.com/web/siyuan-to-outline/" target="_blank" rel="noopener"
>outline&lt;/a>&lt;/p>
&lt;h3 id="共同点">共同点
&lt;/h3>&lt;ul>
&lt;li>都支持云同步和私有同步，这也是区别于 我来 语雀等不同的地方&lt;/li>
&lt;li>都支持s3对象储存同步和webdav同步，并且都支持良好&lt;/li>
&lt;li>都支持加密同步&lt;/li>
&lt;li>都对坚果云支持不好，因为坚果云的限制实在是太狠了。 joplin会丢文档，思源会同步失败。&lt;/li>
&lt;li>pc客户端 都是 Electron，吃内存吃硬盘，不过一般办公机没啥压力。思源另外有webapp功能。&lt;/li>
&lt;/ul>
&lt;h3 id="joplin-的一些问题或者比思源缺点">joplin 的一些问题或者比思源缺点
&lt;/h3>&lt;ul>
&lt;li>代码片段没有 复制按钮，需要拿鼠标拖&lt;/li>
&lt;li>没有webapp功能 思源有一个docker版本 可以浏览器部署&lt;/li>
&lt;li>同步时间5分钟 不能做到保存即同步&lt;/li>
&lt;li>同步目录中的md文件全部放一个目录里面，某些情况下会有问题，比如会导致同步服务器资源占用比较大&lt;/li>
&lt;li>没有多标签管理功能，只能编辑同一个文档里面的？&lt;/li>
&lt;li>二级 文档只是一个目录 不是文档 ，不算缺点吧&lt;/li>
&lt;li>没有内置思维导图流程图之类的支持，但是支持相关插件&lt;/li>
&lt;li>全部导出压缩包功能，默认的文件名称 是 日 月 年，然后还没有时分秒。。&lt;/li>
&lt;/ul>
&lt;h3 id="思源的一些问题或者对joplin的缺点">思源的一些问题或者对joplin的缺点
&lt;/h3>&lt;ul>
&lt;li>貌似没有分享功能 ，或许收费版有&lt;/li>
&lt;li>网页剪辑功能，貌似也是收费版本才有&lt;/li>
&lt;li>md文档的导出 导出来是压缩包，需要解压一次 ，很烦很烦这个！！！！&lt;/li>
&lt;li>无法全部导出为md ，需要逐个文档导出zip然后解压，joplin 这点要比思源好太多了&lt;/li>
&lt;li>二级文档 本身是一个文档，不算缺点吧&lt;/li>
&lt;li>内置思维导图流程图比较简陋，好像不支持相关插件，简单的图可以胜任,复杂一点的因使用率不高没有仔细研究。&lt;/li>
&lt;li>文档移动的时候，全屏提示需要重建索引，这个比较烦。新版好像修复了，我一直用2.7.1&lt;/li>
&lt;li>md文档的 编辑，虽然所见所得，但是没有选择显示源码的选项 有时候不太方便&lt;/li>
&lt;li>joplin 比思源支持更多的云端，比如 OneDriv googledrive等，这个。。国内环境别想了&lt;/li>
&lt;/ul>
&lt;h3 id="思源docker部署">思源docker部署
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mkdir /root/siyuan_date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -R 1000:1000 /root/siyuan_date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -itd --restart=always --name=sy --hostname sy -v /root/siyuan_date:/root/siyuan_date -p 6806:6806 b3log/siyuan --workspace=/root/siyuan_date
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>更新命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="综合">综合
&lt;/h3>&lt;p>因为我主要是纯笔记，思源的一些小问题也有，但是没有影响到日常使用效率&lt;br>
而且目前更新非常频繁，小问题或许以后会修复。只是我甚至懒得升级，一直在用docker 2.7.2
尤其是docker部署的 web app （功能齐全的），在新设备上 可以直接用，省去一堆麻烦。 配合edge 和 chrome 直接创建应用也舒服，ipad上 safari也可以直接创建&lt;/p>
&lt;p>网上有一个叫 完美公社 的一直在喷思源，感觉不是水军，只是一个智力发育不太好的病人，身残志坚带病上网 还是很佩服 。&lt;/p></description></item><item><title>redis hash list set zset 的对比和使用</title><link>https://dev.leiyanhui.com/web/redis-hash-set-list/</link><pubDate>Fri, 17 Mar 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/redis-hash-set-list/</guid><description>&lt;h2 id="速度">速度
&lt;/h2>&lt;h3 id="遍历速度">遍历速度
&lt;/h3>&lt;p>Set = list &amp;gt; hash&lt;/p>
&lt;h3 id="插入删除速度">插入删除速度
&lt;/h3>&lt;p>Hash = set &amp;gt; list&lt;/p>
&lt;h3 id="随机访问速度">随机访问速度
&lt;/h3>&lt;p>hash = list &amp;gt; set&lt;/p>
&lt;h2 id="重复">重复
&lt;/h2>&lt;p>list 有序可重复,存入顺序和取出顺序完全相同 &lt;br>
set 无序不可重复,存入的顺序和取出的顺序不一定一致 会自动去重 &lt;br>
zset 有序 &lt;br>
hash key不可重复，value可以重复&lt;/p></description></item><item><title>uniapp的bug和坑真的是太多太多了</title><link>https://dev.leiyanhui.com/web/uniapp-bug/</link><pubDate>Mon, 06 Mar 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/uniapp-bug/</guid><description>&lt;p>项目一开始选择了uniapp来做，因为js语法 加上vue。并且是oneman项目&lt;/p>
&lt;p>但是没想到uniapp的坑如此之多&lt;/p>
&lt;p>每一个坑 基本上都要 查搜索搜索引擎，或者 自己重写一个替代， 一个坑 折腾几个小时甚至一整天。&lt;/p>
&lt;p>因为没打算做小程序平台，一度打算 切换到futter上。&lt;/p>
&lt;p>考虑到学习成本 又数次放弃。。。&lt;/p>
&lt;p>还有 hbuilderx 这个编辑器，就是王婆卖瓜 ，难用的很&lt;/p>
&lt;p>还有各种月经bug 这个版本修复，下个版本 不指定什么适合 又出现。。。&lt;/p>
&lt;p>虽然是国产的，但是官网 文档 压根不全，很多问题的解决方案官网文档里面并未提供。&lt;/p>
&lt;p>你去论坛问，官网的技术，可能都是机器人。。。。不是手册里面提到的问题，你也问不到，手册里面有的问题，也犯不上去问。。。bug或者非常规的问题你问几个月也不见得问到答案。&lt;/p>
&lt;p>官方QQ 群里面，全部是死人 和新手。 每天只有新手发问，偶尔冒一个半拉新手出来解答，或者私聊你收费帮你处理（水平烂，付费并不能搞定）。 官方的技术管理员 就是尸体号。。。&lt;/p>
&lt;p>还有 对 他自己家的unicloud的深度绑定，你不用 他一直提示，甚至 报 err！！！ ，你用 不是今天到期 就是明天整改,后天维护。&lt;/p>
&lt;p>uniapp 这家公司，属于 那种吹牛无边无际的&amp;hellip; 官网明目张胆的 写 很多上线项目稳定使用他家的各种bug何种问题的 unicloud！ 不知道那个正规项目脑子被驴踢了。。。&lt;/p>
&lt;p>ide里面 加广告这事 就不说多恶心的，如果你产品真好用，可以忍。但是你..&lt;/p>
&lt;p>更多 真的不想列举。。。&lt;/p>
&lt;p>其实 单纯的 h5 也非常不建议用 uniapp开发，看起来简单上手快，实际上 坑一个接一个。。。。&lt;/p>
&lt;p>如果你弄app 或者 小程序 或者 真的多端。。。你会发现，每天都在踩坑的路上。。。。&lt;/p>
&lt;p>有人说，我就做一个简单的功能。 也不是不可以，但是要看要做多简单的。。。简单到一个Hello, world ,那自然没问题。。。&lt;/p>
&lt;p>略微复杂一点点的。。。。必定 ，100% 有坑等着你。。。。&lt;/p>
&lt;p>比如 简单的注册登录，注册的时候 表单验证，用自带的 form.validate()。 没问题对吧? 然后你会发现，在低分屏幕设备上，错误提示消息显示不全！
然后我们自然而然的想到，重写一下css，然后你又会发现 ，你写到页面里面 压根不生效！ 然后 慢慢去啃他uni-forms-item组件吧。。
你技术还过得去，等弄好 1个多小时过去了。&lt;/p>
&lt;p>诸如此类的小坑 ，你做完一个app 你会发现 几十个 ！
有的坑可能需要你自己写原生代码，甚至有的坑 无法解决！&lt;/p>
&lt;p>uniapp就是这么神奇的东西&lt;/p></description></item><item><title>alpine挂载 阿里云oss 腾讯cos 亚马逊s3 等对象储存方法</title><link>https://dev.leiyanhui.com/web/alpine-s3/</link><pubDate>Thu, 23 Feb 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/alpine-s3/</guid><description>&lt;p>alpine 轻量，适合很多场景使用。但是目前除了很多人用他来做docker基础镜像之外，还是小众了一些。所以很多软件包没有提供编译好的安装包。
而alpine的官方仓库，一直控制在10000以内，所以&amp;hellip;&lt;/p>
&lt;p>比如 阿里云的 ossfs 腾讯的 cosfs 都不行，连s3fs 也没有。。。&lt;/p>
&lt;p>自己编译？？？ 要装一堆依赖，，，（其实 可以docker里面编译完了删除就行）不符合 我们需求.. 还是用rclone吧。 可以用国产的alist cloudreve，我这个场景更适合rclone，因为我只是同步备份数据，不做本地储存用。&lt;/p>
&lt;h3 id="安装获取">安装获取
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">apk&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">unzip&lt;/span> &lt;span class="n">wget&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">downloads&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rclone&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">v1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">61.1&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rclone&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">v1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">61.1&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">unzip&lt;/span> &lt;span class="n">rclone&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">v1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">61.1&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mv&lt;/span> &lt;span class="n">rclone&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">v1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">61.1&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">amd64&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">rclone&lt;/span> &lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>rclone默认的配置文件 是在 ~/.config/rclone/rclone.conf ，你可以用命令 查看 &lt;code>rclone config paths &lt;/code>&lt;/p>
&lt;p>我这里手动指定 &lt;code>./rclone config --config /root/rclone.conf&lt;/code> 是进入交互引导模式 帮你创建储存点。简单点&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cat &amp;gt; /root/rclone.conf &amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[oss]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">type = s3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">provider = Alibaba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access_key_id = 你的access_key_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">secret_access_key = 你的secret_access_key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">endpoint = oss-cn-地区.aliyuncs.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">acl = public-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">storage_class = STANDARD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bucket_acl = public-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EOF
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#./rclone ls oss:你的存储桶名称 --config /root/rclone.conf #列出所有文件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./rclone lsd oss:你的存储桶名称 --config /root/rclone.conf #列出指定的目录的子目录
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./rclone lsf oss:你的存储桶名称 --config /root/rclone.conf #列出文件个目录的文件和目录
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./rclone copy /root/rclone.conf oss:你的存储桶名称/ --config /root/rclone.conf # 复制一个文件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./rclone lsf oss:你的存储桶名称 --config /root/rclone.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>腾讯cos 和 亚马逊s3 同理&lt;/p>
&lt;p>rclone 还内置 删除 sync 等操作 ，具体 ./rcone -h 查看&lt;/p>
&lt;h3 id="挂载到本地">挂载到本地
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add fuse # 必须的，如果你在容器里面，宿主和容器 都要有fuse权限
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rclone mount cos:/你的存储桶名称/子目录或者不需要 /mnt/本地挂载路径 --no-check-certificate --allow-other --allow-non-empty
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>还有其他一些更丰富的参数 这里不说了&lt;/p>
&lt;h3 id="开机自动挂载">开机自动挂载？
&lt;/h3>&lt;p>rc-local 处理就好了。&lt;/p></description></item><item><title>同一台机器搭建多个redis实例 并测试主从同步</title><link>https://dev.leiyanhui.com/web/redis-more/</link><pubDate>Thu, 23 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/redis-more/</guid><description>&lt;p>场景：
核心数据 主从同步 持久化&lt;br>
非核心 大并发 可以接受丢失但是尽量不丢失的，主从同步 ，从机持久化&lt;br>
日志类数据 需要转存 但是可以接受丢失 不开主从 不持久化&lt;/p>
&lt;p>最简单的方法 还是创建多个实例来处理。下面记录过程。&lt;/p>
&lt;h5 id="redis">redis
&lt;/h5>&lt;h6 id="准备配置文件">准备配置文件
&lt;/h6>&lt;p>需要三个实例，分别 是 ①核心数据 需要同步容灾 需要持久化 需要oss转存 ②临时数据 处理一些 limt 验证码等 不持久 不同步 ③设备日志临时存储 限制大小可丢一部分&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">wget http://repo.huaweicloud.com/redis/redis-7.0.8.tar.gz &lt;span class="c1">#菊花家 官网https://github.com/redis/redis/archive/7.0.8.tar.gz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxvf redis-7.0.8.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp ./redis-7.0.8/redis.conf /root/redis/redis-template.conf &lt;span class="c1">#备份一份&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf redis-7.0.8*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h6 id="修改配置">修改配置
&lt;/h6>&lt;p>持久化 ，只有main节点需要 并且是混合持久化 即：1秒aof一次 根据规则再压缩，默认配置文件 是关闭 rdb的但是开了 appendfsync everysec 1秒一次 以及 aof-use-rdb-preamble ，增长比例 &lt;code>auto-aof-rewrite-percentage&lt;/code> 为100 文件大小 auto-aof-rewrite-min-size 64mb ，no-appendfsync-on-rewrite 默认为 no 就是 主线程和和子线程冲突 的时候，等待 会偶发堵塞但是不会丢数据。cache的 也默认开持久化，暂时不关闭，no-appendfsync-on-rewrite 改为yes 就是冲突的时候用硬盘缓存解决。 默认持久化文件：dump.rdb appendonly.aof&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">redisName&lt;/span>&lt;span class="o">=&lt;/span>db
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /data/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">main&lt;/span>&lt;span class="si">}&lt;/span>* &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cp /root/redis/redis-template.conf /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# requirepass foobared@requirepass cx6hYJcCpZybXT112233@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#修改密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@appendonly no@appendonly yes@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># appendonly 打开混合持久化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@bind 127.0.0.1 -::1@#bind 127.0.0.1 -::1@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># ip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#启动 新版docker的redis 需要手动指定配置文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker stop &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> docker rm &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -itd --name &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> --hostname &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> -p 6381:6379 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf:/redis.conf -v /root/redis/date-&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>:/data --restart&lt;span class="o">=&lt;/span>always &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> redis:7.0.8-alpine3.17 redis-server /redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f -t --since&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2020-02-08&amp;#34;&lt;/span> --tail&lt;span class="o">=&lt;/span>&lt;span class="m">50&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#其他&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@no-appendfsync-on-rewrite no@no-appendfsync-on-rewrite yes@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#避开堵塞但是可能会丢数据 &amp;lt;不建议&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ram&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">redisName&lt;/span>&lt;span class="o">=&lt;/span>ram
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /data/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">main&lt;/span>&lt;span class="si">}&lt;/span>* &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cp /root/redis/redis-template.conf /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# requirepass foobared@requirepass cx6hYJcCpZybXT112233@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#修改密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@bind 127.0.0.1 -::1@#bind 127.0.0.1 -::1@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># ip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s@# save &amp;#34;&amp;#34;@save &amp;#34;&amp;#34;@g&amp;#39;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># 取消持久化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker stop &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> docker rm &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -itd --name &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> --hostname &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> -p 6382:6379 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf:/redis.conf --restart&lt;span class="o">=&lt;/span>always &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> redis:7.0.8-alpine3.17 redis-server /redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>devlog&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">redisName&lt;/span>&lt;span class="o">=&lt;/span>devlog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /data/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>* &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cp /root/redis/redis-template.conf /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# requirepass foobared@requirepass cx6hYJcCpZybXT112233@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#修改密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@bind 127.0.0.1 -::1@#bind 127.0.0.1 -::1@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># ip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s@# save &amp;#34;&amp;#34;@save &amp;#34;&amp;#34;@g&amp;#39;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># 取消持久化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 执行 ram的命令创建docker之前 再 限制一下大小&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# maxmemory &amp;lt;bytes&amp;gt;@maxmemory 268435456@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#限制 256M&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# maxmemory &amp;lt;bytes&amp;gt;@maxmemory 536870912@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#限制 512M&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# maxmemory &amp;lt;bytes&amp;gt;@maxmemory 1073741824@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#限制 1G&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker stop &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> docker rm &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -itd --name &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> --hostname &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> -p 6383:6379 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf:/redis.conf --restart&lt;span class="o">=&lt;/span>always &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> redis:7.0.8-alpine3.17 redis-server /redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis命令查看限制：info memory
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最后 创建一个 slave-test 作为从机测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">redisName&lt;/span>&lt;span class="o">=&lt;/span>slave-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /data/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>* &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cp /root/redis/redis-template.conf /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@# requirepass foobared@requirepass cx6hYJcCpZybXT112233@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1">#修改密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;s@bind 127.0.0.1 -::1@#bind 127.0.0.1 -::1@g&amp;#34;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># ip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s@# save &amp;#34;&amp;#34;@save &amp;#34;&amp;#34;@g&amp;#39;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># 取消持久化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s@# masterauth &amp;lt;master-password&amp;gt;@masterauth cx6hYJcCpZybXT112233@g&amp;#39;&lt;/span> /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf &lt;span class="c1"># 设置主的密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker stop &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> docker rm &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -itd --name &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> --hostname &lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span> -p 6389:6379 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v /root/redis/&lt;span class="si">${&lt;/span>&lt;span class="nv">redisName&lt;/span>&lt;span class="si">}&lt;/span>.conf:/redis.conf --restart&lt;span class="o">=&lt;/span>always &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> redis:7.0.8-alpine3.17 redis-server /redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart slave-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 切换为 从机&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it slave-test redis-cli -h localhost -p &lt;span class="m">6379&lt;/span> -a cx6hYJcCpZybXT112233 SLAVEOF 10.1.1.111 &lt;span class="m">6381&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 切换为 主机&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it slave-test redis-cli -h localhost -p &lt;span class="m">6379&lt;/span> -a cx6hYJcCpZybXT112233 slaveof NO ONE
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>从机 从主机 同步的数据，如果主机是持久化，从级没有开启，但是丛机 会持久化这部分数据。&lt;/li>
&lt;li>从机可以从0数据 或者有一部分数据 或者 有其他数据 开始切换为从机模式&lt;/li>
&lt;li>从机 的数据 在开启 主从 后 会丢失，从机进入从模式后 无法写入数据&lt;/li>
&lt;/ul>&lt;/blockquote>
&lt;p>在简单的逻辑下，可以用shell脚本 免登录处理。&lt;/p>
&lt;p>强制关闭 程序后，再进行切换操作。&lt;/p></description></item><item><title>从自己的github上自动获取证书并部署到本地</title><link>https://dev.leiyanhui.com/web/auto-updatessl-form-github/</link><pubDate>Thu, 16 Feb 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/auto-updatessl-form-github/</guid><description>&lt;p>之前在github 下用两个库实现了自动更新 地址 ：&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-get-ssl" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/web/auto-get-ssl&lt;/a>&lt;/p>
&lt;p>这里记录下 使用的时候自动部署的方法
以alpine下为例&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">apk add nano wget p7zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rc-update add crond boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service crond start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cd /root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nano auto-updatessl-form-github.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>内容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cat&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">auto&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">updatessl&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">form&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sh&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rm&lt;/span> &lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span>&lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wget&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">cdn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jsdelivr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">gh&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">XXXX&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">sXXXX&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span> &lt;span class="c1">#https://github.com/XXXXXXXXXXXXX.zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="o">!&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="s2">&amp;#34;/root/ssl.zip&amp;#34;&lt;/span> &lt;span class="p">];&lt;/span> &lt;span class="n">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wget&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">O&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">null&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">q&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">day&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="err">你的&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">SSL&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">err&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">mino&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">?&lt;/span>&lt;span class="n">sound&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">birdsong&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">amp&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">isArchive&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">rf&lt;/span> &lt;span class="n">ssl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">7&lt;/span>&lt;span class="n">z&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zip&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p密码&lt;/span> &lt;span class="c1">#密码和p之间不能有空格&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">supervisorctl&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">minio&lt;/span> &lt;span class="c1">#根据情况修改&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nginx&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="n">reload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;15 8 * * * sh /root/auto-updatessl-form-github.sh&amp;#34;&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">crontabs&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">cat&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">crontabs&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">root&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>添加计划任务 crontab -e 每天7点50&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="m">50&lt;/span> &lt;span class="m">7&lt;/span> * * * sh /root/auto-updatessl-form-github.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>私有仓库GitHub actions运行acme.sh 并加密推送到公开仓库</title><link>https://dev.leiyanhui.com/web/auto-get-ssl/</link><pubDate>Tue, 14 Feb 2023 07:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/auto-get-ssl/</guid><description>&lt;p>考虑到使用方便，把证书加密后 发送到公开仓库。部署的时候，只需要定时从公开仓库wget下来即可使用。&lt;/p>
&lt;p>后续会考虑自动推送到cdn，因为cdn那边是生产环境，暂时还是不用免费证书。&lt;/p>
&lt;h1 id="github自动申请-域名证书加密推送到公开库以及自动部署等">github自动申请 域名证书，加密推送到公开库以及自动部署等
&lt;/h1>&lt;h3 id="自动申请">自动申请
&lt;/h3>&lt;h4 id="准备">准备
&lt;/h4>&lt;p>1、两个github仓库 1个私有库 存放 自动脚本，另外一个公开仓库存放加密的证书压缩包 公开就好，可以开pages 或者套cdn 默认分支为main&lt;/p>
&lt;p>2、申请域名证书的域名dns服务器的api，我这里都是用dnspods为例&lt;/p>
&lt;p>3、一对ssh公私钥。公钥匙要配置到 公开仓库 的Deploy keys，私玥部署到 私有库的Secret&lt;/p>
&lt;p>4、一个16位以上足够复杂的密码（zip包可以穷举，所以务必要高强度的密码）&lt;/p>
&lt;p>5、少许linux基础知识&lt;/p>
&lt;h4 id="配置加密信息">配置加密信息
&lt;/h4>&lt;h5 id="配置公私玥">配置公私玥
&lt;/h5>&lt;p>公开库的在仓库的 Settings 中Deploy keys添加 填写 ssh公钥，勾选上 Allow write access 名字随意&lt;/p>
&lt;p>私钥部署到私有库的Secret 名称为 MYGITHUBKEY&lt;/p>
&lt;h5 id="dns-api">dns api
&lt;/h5>&lt;p>在仓库的 Settings 中添加 Secret，创建 DNSAPI 填写上文获取的 API KEY 格式如下，具体格式 查看 acme.sh 的文档&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">DP_Id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;214234234&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">DP_Key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;XXXXXXXXXX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CF_Token&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;XXXXXXXXXXXXXX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CF_Account_ID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;XXXXXXXXXXXX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="压缩包密码">压缩包密码
&lt;/h5>&lt;p>再创建一个 ZIPPASSWORD 输入压缩包解压密码，一定必须要超级高强度的密码。比如 16位以上 包含数字字母特殊符号汉字&lt;/p>
&lt;h5 id="配置github-actions">配置github actions
&lt;/h5>&lt;p>在私有仓库中创建 &lt;code>​ .github/workflows/AutoACME.yml ​&lt;/code>​ 配置文件,参考复制粘贴如下.&lt;/p>
&lt;blockquote>
&lt;p>cron 是 UTC时间 每月26日下午17点7分 自动执行
完整内容参考 ：https://github.com/joyanhui/file.leiyanhui.com/blob/main/github-actions/%E8%87%AA%E5%8A%A8%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6%E5%B9%B6%E6%8E%A8%E9%80%81%E5%88%B0%E5%85%AC%E5%BC%80%E4%BB%93%E5%BA%93.yml&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">name: Auto ACME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">on:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> workflow_dispatch:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> schedule:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cron: &lt;span class="s2">&amp;#34;7 17 20 * *&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> watch:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> types: &lt;span class="o">[&lt;/span>started&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">env:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ACME: /home/runner/.acme.sh/acme.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PUBHUB: /你的用户名/仓库地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> DNSAPI: &lt;span class="si">${&lt;/span>&lt;span class="p">{ secrets.DNSAPI &lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ZIPPASSWORD: &lt;span class="si">${&lt;/span>&lt;span class="p">{ secrets.ZIPPASSWORD &lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> MYGITHUBKEY: &lt;span class="si">${&lt;/span>&lt;span class="p">{ secrets.MYGITHUBKEY &lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EMAIL: 你的邮箱地址@qq.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> TZ: Asia/Shanghai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">jobs:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> build:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> runs-on: ubuntu-latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>: github.event.repository.owner.id &lt;span class="o">==&lt;/span> github.event.sender.id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> steps:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: Checkout
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uses: actions/checkout@v2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> with:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ref: main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> github_token: &lt;span class="si">${&lt;/span>&lt;span class="p">{ secrets.GITHUB_TOKEN &lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: 安装和初始化acme.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> run: &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> curl https://get.acme.sh &lt;span class="p">|&lt;/span> sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$DNSAPI&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;&amp;gt; /home/runner/.acme.sh/account.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ACME&lt;/span> --register-account -m &lt;span class="nv">$EMAIL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: 开始获取证书
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> run: &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkdir -p ./ssl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#如果要处理多个域名，复制后面三行即可 默认使用zerossl的证书 其他参数参考acme.sh文档&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">mydomian&lt;/span>&lt;span class="o">=&lt;/span>你的域名.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ACME&lt;/span> --issue --dns dns_dp -d &lt;span class="si">${&lt;/span>&lt;span class="nv">mydomian&lt;/span>&lt;span class="si">}&lt;/span> -d *.&lt;span class="si">${&lt;/span>&lt;span class="nv">mydomian&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ACME&lt;/span> --installcert -d &lt;span class="si">${&lt;/span>&lt;span class="nv">mydomian&lt;/span>&lt;span class="si">}&lt;/span> --key-file ./ssl/&lt;span class="si">${&lt;/span>&lt;span class="nv">mydomian&lt;/span>&lt;span class="si">}&lt;/span>.key --fullchain-file ./ssl/&lt;span class="si">${&lt;/span>&lt;span class="nv">mydomian&lt;/span>&lt;span class="si">}&lt;/span>.cer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: 带密码打包证书
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> run: &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> zip -r acme.zip /home/runner/.acme.sh -P &lt;span class="nv">$ZIPPASSWORD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> zip -r ssl.zip ssl -P &lt;span class="nv">$ZIPPASSWORD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: 提交加密后的证书到公开库
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> run: &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkdir -p ~/.ssh/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$MYGITHUBKEY&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt; ~/.ssh/id_rsa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> chmod &lt;span class="m">600&lt;/span> ~/.ssh/id_rsa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-keyscan github.com &amp;gt;&amp;gt; ~/.ssh/known_hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rm -rf .git* &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -rf README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;处理公开库的readme文件&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> wget https://raw.githubusercontent.com/&lt;span class="nv">$PUBHUB&lt;/span>/main/README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;\n证书最后更新： &lt;/span>&lt;span class="k">$(&lt;/span>date &lt;span class="s1">&amp;#39;+%Y-%m-%d %H:%M:%S&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&amp;gt;&amp;gt;README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git config --global user.name &lt;span class="s2">&amp;#34;githubactions bot&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git config --global user.email &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ACME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git add ./ssl.zip ./README.md ./acme.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git commit -m &lt;span class="s2">&amp;#34;证书自动更新 on &lt;/span>&lt;span class="k">$(&lt;/span>date &lt;span class="s1">&amp;#39;+%Y-%m-%d %H:%M:%S&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git remote add origin git@github.com:&lt;span class="nv">$PUBHUB&lt;/span>.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git remote -v
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git push origin master:main -f -q
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>‍&lt;/p>
&lt;p>‍&lt;/p>
&lt;p>客户端使用 wget 后 7z -P 密码 ，然后 nginx -s reload即可&lt;/p>
&lt;p>自动更新 参考 ：&lt;a class="link" href="https://dev.leiyanhui.com/web/auto-updatessl-form-github" target="_blank" rel="noopener"
>https://dev.leiyanhui.com/web/auto-updatessl-form-github&lt;/a>&lt;/p>
&lt;p>自动部署到国内cdn 后续处理&lt;/p></description></item><item><title>nginx 非标端口 http强制跳转https</title><link>https://dev.leiyanhui.com/web/nginx-http-https-no443/</link><pubDate>Fri, 06 Jan 2023 08:14:20 +0800</pubDate><guid>https://dev.leiyanhui.com/web/nginx-http-https-no443/</guid><description>&lt;p>nginx标准端口下，我们常用rewrite把80端口强制调整到https，那么在非标准端口下，应该如何处理？&lt;/p>
&lt;p>其实也很简单&lt;/p>
&lt;p>修改站点配置文件 大概内容如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # http端口
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 8880;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # https端口
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 8443 ssl http2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name 你的域名;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> index index.php index.html index.htm default.php default.htm default.html;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /www/wwwroot/Sites/site-vod;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> #error_page 404/404.html;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> #HTTP_TO_HTTPS_START
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if ($server_port !~ 8443){
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rewrite ^(/.*)$ https://$host:8443$1 permanent;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> #HTTP_TO_HTTPS_END
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item></channel></rss>